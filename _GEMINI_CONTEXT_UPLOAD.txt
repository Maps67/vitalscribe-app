DOCUMENTACIÃ“N DE CONTEXTO TÃ‰CNICO - MEDISCRIBE AI
GENERADO: 2025-12-11T01:15:29.788Z
==================================================


--------------------------------------------------
ðŸ“ PATH: dev-dist\sw.js
--------------------------------------------------
/**
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// If the loader is already loaded, just stop.
if (!self.define) {
  let registry = {};

  // Used for `eval` and `importScripts` where we can't get script URL by other means.
  // In both cases, it's safe to use a global var because those functions are synchronous.
  let nextDefineUri;

  const singleRequire = (uri, parentUri) => {
    uri = new URL(uri + ".js", parentUri).href;
    return registry[uri] || (
      
        new Promise(resolve => {
          if ("document" in self) {
            const script = document.createElement("script");
            script.src = uri;
            script.onload = resolve;
            document.head.appendChild(script);
          } else {
            nextDefineUri = uri;
            importScripts(uri);
            resolve();
          }
        })
      
      .then(() => {
        let promise = registry[uri];
        if (!promise) {
          throw new Error(`Module ${uri} didnâ€™t register its module`);
        }
        return promise;
      })
    );
  };

  self.define = (depsNames, factory) => {
    const uri = nextDefineUri || ("document" in self ? document.currentScript.src : "") || location.href;
    if (registry[uri]) {
      // Module is already loading or loaded.
      return;
    }
    let exports = {};
    const require = depUri => singleRequire(depUri, uri);
    const specialDeps = {
      module: { uri },
      exports,
      require
    };
    registry[uri] = Promise.all(depsNames.map(
      depName => specialDeps[depName] || require(depName)
    )).then(deps => {
      factory(...deps);
      return exports;
    });
  };
}
define(['./workbox-5a5d9309'], (function (workbox) { 'use strict';

  self.skipWaiting();
  workbox.clientsClaim();

  /**
   * The precacheAndRoute() method efficiently caches and responds to
   * requests for URLs in the manifest.
   * See https://goo.gl/S9QRab
   */
  workbox.precacheAndRoute([{
    "url": "index.html",
    "revision": "0.3g8s8kb9bo8"
  }], {});
  workbox.cleanupOutdatedCaches();
  workbox.registerRoute(new workbox.NavigationRoute(workbox.createHandlerBoundToURL("index.html"), {
    allowlist: [/^\/$/]
  }));

}));


--------------------------------------------------
ðŸ“ PATH: dev-dist\workbox-5a5d9309.js
--------------------------------------------------
define(['exports'], (function (exports) { 'use strict';

    // @ts-ignore
    try {
      self['workbox:core:7.3.0'] && _();
    } catch (e) {}

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Claim any currently available clients once the service worker
     * becomes active. This is normally used in conjunction with `skipWaiting()`.
     *
     * @memberof workbox-core
     */
    function clientsClaim() {
      self.addEventListener('activate', () => self.clients.claim());
    }

    /*
      Copyright 2019 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const logger = (() => {
      // Don't overwrite this value if it's already set.
      // See https://github.com/GoogleChrome/workbox/pull/2284#issuecomment-560470923
      if (!('__WB_DISABLE_DEV_LOGS' in globalThis)) {
        self.__WB_DISABLE_DEV_LOGS = false;
      }
      let inGroup = false;
      const methodToColorMap = {
        debug: `#7f8c8d`,
        log: `#2ecc71`,
        warn: `#f39c12`,
        error: `#c0392b`,
        groupCollapsed: `#3498db`,
        groupEnd: null // No colored prefix on groupEnd
      };
      const print = function (method, args) {
        if (self.__WB_DISABLE_DEV_LOGS) {
          return;
        }
        if (method === 'groupCollapsed') {
          // Safari doesn't print all console.groupCollapsed() arguments:
          // https://bugs.webkit.org/show_bug.cgi?id=182754
          if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) {
            console[method](...args);
            return;
          }
        }
        const styles = [`background: ${methodToColorMap[method]}`, `border-radius: 0.5em`, `color: white`, `font-weight: bold`, `padding: 2px 0.5em`];
        // When in a group, the workbox prefix is not displayed.
        const logPrefix = inGroup ? [] : ['%cworkbox', styles.join(';')];
        console[method](...logPrefix, ...args);
        if (method === 'groupCollapsed') {
          inGroup = true;
        }
        if (method === 'groupEnd') {
          inGroup = false;
        }
      };
      // eslint-disable-next-line @typescript-eslint/ban-types
      const api = {};
      const loggerMethods = Object.keys(methodToColorMap);
      for (const key of loggerMethods) {
        const method = key;
        api[method] = (...args) => {
          print(method, args);
        };
      }
      return api;
    })();

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const messages = {
      'invalid-value': ({
        paramName,
        validValueDescription,
        value
      }) => {
        if (!paramName || !validValueDescription) {
          throw new Error(`Unexpected input to 'invalid-value' error.`);
        }
        return `The '${paramName}' parameter was given a value with an ` + `unexpected value. ${validValueDescription} Received a value of ` + `${JSON.stringify(value)}.`;
      },
      'not-an-array': ({
        moduleName,
        className,
        funcName,
        paramName
      }) => {
        if (!moduleName || !className || !funcName || !paramName) {
          throw new Error(`Unexpected input to 'not-an-array' error.`);
        }
        return `The parameter '${paramName}' passed into ` + `'${moduleName}.${className}.${funcName}()' must be an array.`;
      },
      'incorrect-type': ({
        expectedType,
        paramName,
        moduleName,
        className,
        funcName
      }) => {
        if (!expectedType || !paramName || !moduleName || !funcName) {
          throw new Error(`Unexpected input to 'incorrect-type' error.`);
        }
        const classNameStr = className ? `${className}.` : '';
        return `The parameter '${paramName}' passed into ` + `'${moduleName}.${classNameStr}` + `${funcName}()' must be of type ${expectedType}.`;
      },
      'incorrect-class': ({
        expectedClassName,
        paramName,
        moduleName,
        className,
        funcName,
        isReturnValueProblem
      }) => {
        if (!expectedClassName || !moduleName || !funcName) {
          throw new Error(`Unexpected input to 'incorrect-class' error.`);
        }
        const classNameStr = className ? `${className}.` : '';
        if (isReturnValueProblem) {
          return `The return value from ` + `'${moduleName}.${classNameStr}${funcName}()' ` + `must be an instance of class ${expectedClassName}.`;
        }
        return `The parameter '${paramName}' passed into ` + `'${moduleName}.${classNameStr}${funcName}()' ` + `must be an instance of class ${expectedClassName}.`;
      },
      'missing-a-method': ({
        expectedMethod,
        paramName,
        moduleName,
        className,
        funcName
      }) => {
        if (!expectedMethod || !paramName || !moduleName || !className || !funcName) {
          throw new Error(`Unexpected input to 'missing-a-method' error.`);
        }
        return `${moduleName}.${className}.${funcName}() expected the ` + `'${paramName}' parameter to expose a '${expectedMethod}' method.`;
      },
      'add-to-cache-list-unexpected-type': ({
        entry
      }) => {
        return `An unexpected entry was passed to ` + `'workbox-precaching.PrecacheController.addToCacheList()' The entry ` + `'${JSON.stringify(entry)}' isn't supported. You must supply an array of ` + `strings with one or more characters, objects with a url property or ` + `Request objects.`;
      },
      'add-to-cache-list-conflicting-entries': ({
        firstEntry,
        secondEntry
      }) => {
        if (!firstEntry || !secondEntry) {
          throw new Error(`Unexpected input to ` + `'add-to-cache-list-duplicate-entries' error.`);
        }
        return `Two of the entries passed to ` + `'workbox-precaching.PrecacheController.addToCacheList()' had the URL ` + `${firstEntry} but different revision details. Workbox is ` + `unable to cache and version the asset correctly. Please remove one ` + `of the entries.`;
      },
      'plugin-error-request-will-fetch': ({
        thrownErrorMessage
      }) => {
        if (!thrownErrorMessage) {
          throw new Error(`Unexpected input to ` + `'plugin-error-request-will-fetch', error.`);
        }
        return `An error was thrown by a plugins 'requestWillFetch()' method. ` + `The thrown error message was: '${thrownErrorMessage}'.`;
      },
      'invalid-cache-name': ({
        cacheNameId,
        value
      }) => {
        if (!cacheNameId) {
          throw new Error(`Expected a 'cacheNameId' for error 'invalid-cache-name'`);
        }
        return `You must provide a name containing at least one character for ` + `setCacheDetails({${cacheNameId}: '...'}). Received a value of ` + `'${JSON.stringify(value)}'`;
      },
      'unregister-route-but-not-found-with-method': ({
        method
      }) => {
        if (!method) {
          throw new Error(`Unexpected input to ` + `'unregister-route-but-not-found-with-method' error.`);
        }
        return `The route you're trying to unregister was not  previously ` + `registered for the method type '${method}'.`;
      },
      'unregister-route-route-not-registered': () => {
        return `The route you're trying to unregister was not previously ` + `registered.`;
      },
      'queue-replay-failed': ({
        name
      }) => {
        return `Replaying the background sync queue '${name}' failed.`;
      },
      'duplicate-queue-name': ({
        name
      }) => {
        return `The Queue name '${name}' is already being used. ` + `All instances of backgroundSync.Queue must be given unique names.`;
      },
      'expired-test-without-max-age': ({
        methodName,
        paramName
      }) => {
        return `The '${methodName}()' method can only be used when the ` + `'${paramName}' is used in the constructor.`;
      },
      'unsupported-route-type': ({
        moduleName,
        className,
        funcName,
        paramName
      }) => {
        return `The supplied '${paramName}' parameter was an unsupported type. ` + `Please check the docs for ${moduleName}.${className}.${funcName} for ` + `valid input types.`;
      },
      'not-array-of-class': ({
        value,
        expectedClass,
        moduleName,
        className,
        funcName,
        paramName
      }) => {
        return `The supplied '${paramName}' parameter must be an array of ` + `'${expectedClass}' objects. Received '${JSON.stringify(value)},'. ` + `Please check the call to ${moduleName}.${className}.${funcName}() ` + `to fix the issue.`;
      },
      'max-entries-or-age-required': ({
        moduleName,
        className,
        funcName
      }) => {
        return `You must define either config.maxEntries or config.maxAgeSeconds` + `in ${moduleName}.${className}.${funcName}`;
      },
      'statuses-or-headers-required': ({
        moduleName,
        className,
        funcName
      }) => {
        return `You must define either config.statuses or config.headers` + `in ${moduleName}.${className}.${funcName}`;
      },
      'invalid-string': ({
        moduleName,
        funcName,
        paramName
      }) => {
        if (!paramName || !moduleName || !funcName) {
          throw new Error(`Unexpected input to 'invalid-string' error.`);
        }
        return `When using strings, the '${paramName}' parameter must start with ` + `'http' (for cross-origin matches) or '/' (for same-origin matches). ` + `Please see the docs for ${moduleName}.${funcName}() for ` + `more info.`;
      },
      'channel-name-required': () => {
        return `You must provide a channelName to construct a ` + `BroadcastCacheUpdate instance.`;
      },
      'invalid-responses-are-same-args': () => {
        return `The arguments passed into responsesAreSame() appear to be ` + `invalid. Please ensure valid Responses are used.`;
      },
      'expire-custom-caches-only': () => {
        return `You must provide a 'cacheName' property when using the ` + `expiration plugin with a runtime caching strategy.`;
      },
      'unit-must-be-bytes': ({
        normalizedRangeHeader
      }) => {
        if (!normalizedRangeHeader) {
          throw new Error(`Unexpected input to 'unit-must-be-bytes' error.`);
        }
        return `The 'unit' portion of the Range header must be set to 'bytes'. ` + `The Range header provided was "${normalizedRangeHeader}"`;
      },
      'single-range-only': ({
        normalizedRangeHeader
      }) => {
        if (!normalizedRangeHeader) {
          throw new Error(`Unexpected input to 'single-range-only' error.`);
        }
        return `Multiple ranges are not supported. Please use a  single start ` + `value, and optional end value. The Range header provided was ` + `"${normalizedRangeHeader}"`;
      },
      'invalid-range-values': ({
        normalizedRangeHeader
      }) => {
        if (!normalizedRangeHeader) {
          throw new Error(`Unexpected input to 'invalid-range-values' error.`);
        }
        return `The Range header is missing both start and end values. At least ` + `one of those values is needed. The Range header provided was ` + `"${normalizedRangeHeader}"`;
      },
      'no-range-header': () => {
        return `No Range header was found in the Request provided.`;
      },
      'range-not-satisfiable': ({
        size,
        start,
        end
      }) => {
        return `The start (${start}) and end (${end}) values in the Range are ` + `not satisfiable by the cached response, which is ${size} bytes.`;
      },
      'attempt-to-cache-non-get-request': ({
        url,
        method
      }) => {
        return `Unable to cache '${url}' because it is a '${method}' request and ` + `only 'GET' requests can be cached.`;
      },
      'cache-put-with-no-response': ({
        url
      }) => {
        return `There was an attempt to cache '${url}' but the response was not ` + `defined.`;
      },
      'no-response': ({
        url,
        error
      }) => {
        let message = `The strategy could not generate a response for '${url}'.`;
        if (error) {
          message += ` The underlying error is ${error}.`;
        }
        return message;
      },
      'bad-precaching-response': ({
        url,
        status
      }) => {
        return `The precaching request for '${url}' failed` + (status ? ` with an HTTP status of ${status}.` : `.`);
      },
      'non-precached-url': ({
        url
      }) => {
        return `createHandlerBoundToURL('${url}') was called, but that URL is ` + `not precached. Please pass in a URL that is precached instead.`;
      },
      'add-to-cache-list-conflicting-integrities': ({
        url
      }) => {
        return `Two of the entries passed to ` + `'workbox-precaching.PrecacheController.addToCacheList()' had the URL ` + `${url} with different integrity values. Please remove one of them.`;
      },
      'missing-precache-entry': ({
        cacheName,
        url
      }) => {
        return `Unable to find a precached response in ${cacheName} for ${url}.`;
      },
      'cross-origin-copy-response': ({
        origin
      }) => {
        return `workbox-core.copyResponse() can only be used with same-origin ` + `responses. It was passed a response with origin ${origin}.`;
      },
      'opaque-streams-source': ({
        type
      }) => {
        const message = `One of the workbox-streams sources resulted in an ` + `'${type}' response.`;
        if (type === 'opaqueredirect') {
          return `${message} Please do not use a navigation request that results ` + `in a redirect as a source.`;
        }
        return `${message} Please ensure your sources are CORS-enabled.`;
      }
    };

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const generatorFunction = (code, details = {}) => {
      const message = messages[code];
      if (!message) {
        throw new Error(`Unable to find message for code '${code}'.`);
      }
      return message(details);
    };
    const messageGenerator = generatorFunction;

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Workbox errors should be thrown with this class.
     * This allows use to ensure the type easily in tests,
     * helps developers identify errors from workbox
     * easily and allows use to optimise error
     * messages correctly.
     *
     * @private
     */
    class WorkboxError extends Error {
      /**
       *
       * @param {string} errorCode The error code that
       * identifies this particular error.
       * @param {Object=} details Any relevant arguments
       * that will help developers identify issues should
       * be added as a key on the context object.
       */
      constructor(errorCode, details) {
        const message = messageGenerator(errorCode, details);
        super(message);
        this.name = errorCode;
        this.details = details;
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /*
     * This method throws if the supplied value is not an array.
     * The destructed values are required to produce a meaningful error for users.
     * The destructed and restructured object is so it's clear what is
     * needed.
     */
    const isArray = (value, details) => {
      if (!Array.isArray(value)) {
        throw new WorkboxError('not-an-array', details);
      }
    };
    const hasMethod = (object, expectedMethod, details) => {
      const type = typeof object[expectedMethod];
      if (type !== 'function') {
        details['expectedMethod'] = expectedMethod;
        throw new WorkboxError('missing-a-method', details);
      }
    };
    const isType = (object, expectedType, details) => {
      if (typeof object !== expectedType) {
        details['expectedType'] = expectedType;
        throw new WorkboxError('incorrect-type', details);
      }
    };
    const isInstance = (object,
    // Need the general type to do the check later.
    // eslint-disable-next-line @typescript-eslint/ban-types
    expectedClass, details) => {
      if (!(object instanceof expectedClass)) {
        details['expectedClassName'] = expectedClass.name;
        throw new WorkboxError('incorrect-class', details);
      }
    };
    const isOneOf = (value, validValues, details) => {
      if (!validValues.includes(value)) {
        details['validValueDescription'] = `Valid values are ${JSON.stringify(validValues)}.`;
        throw new WorkboxError('invalid-value', details);
      }
    };
    const isArrayOfClass = (value,
    // Need general type to do check later.
    expectedClass,
    // eslint-disable-line
    details) => {
      const error = new WorkboxError('not-array-of-class', details);
      if (!Array.isArray(value)) {
        throw error;
      }
      for (const item of value) {
        if (!(item instanceof expectedClass)) {
          throw error;
        }
      }
    };
    const finalAssertExports = {
      hasMethod,
      isArray,
      isInstance,
      isOneOf,
      isType,
      isArrayOfClass
    };

    // @ts-ignore
    try {
      self['workbox:routing:7.3.0'] && _();
    } catch (e) {}

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * The default HTTP method, 'GET', used when there's no specific method
     * configured for a route.
     *
     * @type {string}
     *
     * @private
     */
    const defaultMethod = 'GET';
    /**
     * The list of valid HTTP methods associated with requests that could be routed.
     *
     * @type {Array<string>}
     *
     * @private
     */
    const validMethods = ['DELETE', 'GET', 'HEAD', 'PATCH', 'POST', 'PUT'];

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * @param {function()|Object} handler Either a function, or an object with a
     * 'handle' method.
     * @return {Object} An object with a handle method.
     *
     * @private
     */
    const normalizeHandler = handler => {
      if (handler && typeof handler === 'object') {
        {
          finalAssertExports.hasMethod(handler, 'handle', {
            moduleName: 'workbox-routing',
            className: 'Route',
            funcName: 'constructor',
            paramName: 'handler'
          });
        }
        return handler;
      } else {
        {
          finalAssertExports.isType(handler, 'function', {
            moduleName: 'workbox-routing',
            className: 'Route',
            funcName: 'constructor',
            paramName: 'handler'
          });
        }
        return {
          handle: handler
        };
      }
    };

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A `Route` consists of a pair of callback functions, "match" and "handler".
     * The "match" callback determine if a route should be used to "handle" a
     * request by returning a non-falsy value if it can. The "handler" callback
     * is called when there is a match and should return a Promise that resolves
     * to a `Response`.
     *
     * @memberof workbox-routing
     */
    class Route {
      /**
       * Constructor for Route class.
       *
       * @param {workbox-routing~matchCallback} match
       * A callback function that determines whether the route matches a given
       * `fetch` event by returning a non-falsy value.
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resolving to a Response.
       * @param {string} [method='GET'] The HTTP method to match the Route
       * against.
       */
      constructor(match, handler, method = defaultMethod) {
        {
          finalAssertExports.isType(match, 'function', {
            moduleName: 'workbox-routing',
            className: 'Route',
            funcName: 'constructor',
            paramName: 'match'
          });
          if (method) {
            finalAssertExports.isOneOf(method, validMethods, {
              paramName: 'method'
            });
          }
        }
        // These values are referenced directly by Router so cannot be
        // altered by minificaton.
        this.handler = normalizeHandler(handler);
        this.match = match;
        this.method = method;
      }
      /**
       *
       * @param {workbox-routing-handlerCallback} handler A callback
       * function that returns a Promise resolving to a Response
       */
      setCatchHandler(handler) {
        this.catchHandler = normalizeHandler(handler);
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * RegExpRoute makes it easy to create a regular expression based
     * {@link workbox-routing.Route}.
     *
     * For same-origin requests the RegExp only needs to match part of the URL. For
     * requests against third-party servers, you must define a RegExp that matches
     * the start of the URL.
     *
     * @memberof workbox-routing
     * @extends workbox-routing.Route
     */
    class RegExpRoute extends Route {
      /**
       * If the regular expression contains
       * [capture groups]{@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp#grouping-back-references},
       * the captured values will be passed to the
       * {@link workbox-routing~handlerCallback} `params`
       * argument.
       *
       * @param {RegExp} regExp The regular expression to match against URLs.
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resulting in a Response.
       * @param {string} [method='GET'] The HTTP method to match the Route
       * against.
       */
      constructor(regExp, handler, method) {
        {
          finalAssertExports.isInstance(regExp, RegExp, {
            moduleName: 'workbox-routing',
            className: 'RegExpRoute',
            funcName: 'constructor',
            paramName: 'pattern'
          });
        }
        const match = ({
          url
        }) => {
          const result = regExp.exec(url.href);
          // Return immediately if there's no match.
          if (!result) {
            return;
          }
          // Require that the match start at the first character in the URL string
          // if it's a cross-origin request.
          // See https://github.com/GoogleChrome/workbox/issues/281 for the context
          // behind this behavior.
          if (url.origin !== location.origin && result.index !== 0) {
            {
              logger.debug(`The regular expression '${regExp.toString()}' only partially matched ` + `against the cross-origin URL '${url.toString()}'. RegExpRoute's will only ` + `handle cross-origin requests if they match the entire URL.`);
            }
            return;
          }
          // If the route matches, but there aren't any capture groups defined, then
          // this will return [], which is truthy and therefore sufficient to
          // indicate a match.
          // If there are capture groups, then it will return their values.
          return result.slice(1);
        };
        super(match, handler, method);
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const getFriendlyURL = url => {
      const urlObj = new URL(String(url), location.href);
      // See https://github.com/GoogleChrome/workbox/issues/2323
      // We want to include everything, except for the origin if it's same-origin.
      return urlObj.href.replace(new RegExp(`^${location.origin}`), '');
    };

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * The Router can be used to process a `FetchEvent` using one or more
     * {@link workbox-routing.Route}, responding with a `Response` if
     * a matching route exists.
     *
     * If no route matches a given a request, the Router will use a "default"
     * handler if one is defined.
     *
     * Should the matching Route throw an error, the Router will use a "catch"
     * handler if one is defined to gracefully deal with issues and respond with a
     * Request.
     *
     * If a request matches multiple routes, the **earliest** registered route will
     * be used to respond to the request.
     *
     * @memberof workbox-routing
     */
    class Router {
      /**
       * Initializes a new Router.
       */
      constructor() {
        this._routes = new Map();
        this._defaultHandlerMap = new Map();
      }
      /**
       * @return {Map<string, Array<workbox-routing.Route>>} routes A `Map` of HTTP
       * method name ('GET', etc.) to an array of all the corresponding `Route`
       * instances that are registered.
       */
      get routes() {
        return this._routes;
      }
      /**
       * Adds a fetch event listener to respond to events when a route matches
       * the event's request.
       */
      addFetchListener() {
        // See https://github.com/Microsoft/TypeScript/issues/28357#issuecomment-436484705
        self.addEventListener('fetch', event => {
          const {
            request
          } = event;
          const responsePromise = this.handleRequest({
            request,
            event
          });
          if (responsePromise) {
            event.respondWith(responsePromise);
          }
        });
      }
      /**
       * Adds a message event listener for URLs to cache from the window.
       * This is useful to cache resources loaded on the page prior to when the
       * service worker started controlling it.
       *
       * The format of the message data sent from the window should be as follows.
       * Where the `urlsToCache` array may consist of URL strings or an array of
       * URL string + `requestInit` object (the same as you'd pass to `fetch()`).
       *
       * ```
       * {
       *   type: 'CACHE_URLS',
       *   payload: {
       *     urlsToCache: [
       *       './script1.js',
       *       './script2.js',
       *       ['./script3.js', {mode: 'no-cors'}],
       *     ],
       *   },
       * }
       * ```
       */
      addCacheListener() {
        // See https://github.com/Microsoft/TypeScript/issues/28357#issuecomment-436484705
        self.addEventListener('message', event => {
          // event.data is type 'any'
          // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
          if (event.data && event.data.type === 'CACHE_URLS') {
            // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
            const {
              payload
            } = event.data;
            {
              logger.debug(`Caching URLs from the window`, payload.urlsToCache);
            }
            const requestPromises = Promise.all(payload.urlsToCache.map(entry => {
              if (typeof entry === 'string') {
                entry = [entry];
              }
              const request = new Request(...entry);
              return this.handleRequest({
                request,
                event
              });
              // TODO(philipwalton): TypeScript errors without this typecast for
              // some reason (probably a bug). The real type here should work but
              // doesn't: `Array<Promise<Response> | undefined>`.
            })); // TypeScript
            event.waitUntil(requestPromises);
            // If a MessageChannel was used, reply to the message on success.
            if (event.ports && event.ports[0]) {
              void requestPromises.then(() => event.ports[0].postMessage(true));
            }
          }
        });
      }
      /**
       * Apply the routing rules to a FetchEvent object to get a Response from an
       * appropriate Route's handler.
       *
       * @param {Object} options
       * @param {Request} options.request The request to handle.
       * @param {ExtendableEvent} options.event The event that triggered the
       *     request.
       * @return {Promise<Response>|undefined} A promise is returned if a
       *     registered route can handle the request. If there is no matching
       *     route and there's no `defaultHandler`, `undefined` is returned.
       */
      handleRequest({
        request,
        event
      }) {
        {
          finalAssertExports.isInstance(request, Request, {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'handleRequest',
            paramName: 'options.request'
          });
        }
        const url = new URL(request.url, location.href);
        if (!url.protocol.startsWith('http')) {
          {
            logger.debug(`Workbox Router only supports URLs that start with 'http'.`);
          }
          return;
        }
        const sameOrigin = url.origin === location.origin;
        const {
          params,
          route
        } = this.findMatchingRoute({
          event,
          request,
          sameOrigin,
          url
        });
        let handler = route && route.handler;
        const debugMessages = [];
        {
          if (handler) {
            debugMessages.push([`Found a route to handle this request:`, route]);
            if (params) {
              debugMessages.push([`Passing the following params to the route's handler:`, params]);
            }
          }
        }
        // If we don't have a handler because there was no matching route, then
        // fall back to defaultHandler if that's defined.
        const method = request.method;
        if (!handler && this._defaultHandlerMap.has(method)) {
          {
            debugMessages.push(`Failed to find a matching route. Falling ` + `back to the default handler for ${method}.`);
          }
          handler = this._defaultHandlerMap.get(method);
        }
        if (!handler) {
          {
            // No handler so Workbox will do nothing. If logs is set of debug
            // i.e. verbose, we should print out this information.
            logger.debug(`No route found for: ${getFriendlyURL(url)}`);
          }
          return;
        }
        {
          // We have a handler, meaning Workbox is going to handle the route.
          // print the routing details to the console.
          logger.groupCollapsed(`Router is responding to: ${getFriendlyURL(url)}`);
          debugMessages.forEach(msg => {
            if (Array.isArray(msg)) {
              logger.log(...msg);
            } else {
              logger.log(msg);
            }
          });
          logger.groupEnd();
        }
        // Wrap in try and catch in case the handle method throws a synchronous
        // error. It should still callback to the catch handler.
        let responsePromise;
        try {
          responsePromise = handler.handle({
            url,
            request,
            event,
            params
          });
        } catch (err) {
          responsePromise = Promise.reject(err);
        }
        // Get route's catch handler, if it exists
        const catchHandler = route && route.catchHandler;
        if (responsePromise instanceof Promise && (this._catchHandler || catchHandler)) {
          responsePromise = responsePromise.catch(async err => {
            // If there's a route catch handler, process that first
            if (catchHandler) {
              {
                // Still include URL here as it will be async from the console group
                // and may not make sense without the URL
                logger.groupCollapsed(`Error thrown when responding to: ` + ` ${getFriendlyURL(url)}. Falling back to route's Catch Handler.`);
                logger.error(`Error thrown by:`, route);
                logger.error(err);
                logger.groupEnd();
              }
              try {
                return await catchHandler.handle({
                  url,
                  request,
                  event,
                  params
                });
              } catch (catchErr) {
                if (catchErr instanceof Error) {
                  err = catchErr;
                }
              }
            }
            if (this._catchHandler) {
              {
                // Still include URL here as it will be async from the console group
                // and may not make sense without the URL
                logger.groupCollapsed(`Error thrown when responding to: ` + ` ${getFriendlyURL(url)}. Falling back to global Catch Handler.`);
                logger.error(`Error thrown by:`, route);
                logger.error(err);
                logger.groupEnd();
              }
              return this._catchHandler.handle({
                url,
                request,
                event
              });
            }
            throw err;
          });
        }
        return responsePromise;
      }
      /**
       * Checks a request and URL (and optionally an event) against the list of
       * registered routes, and if there's a match, returns the corresponding
       * route along with any params generated by the match.
       *
       * @param {Object} options
       * @param {URL} options.url
       * @param {boolean} options.sameOrigin The result of comparing `url.origin`
       *     against the current origin.
       * @param {Request} options.request The request to match.
       * @param {Event} options.event The corresponding event.
       * @return {Object} An object with `route` and `params` properties.
       *     They are populated if a matching route was found or `undefined`
       *     otherwise.
       */
      findMatchingRoute({
        url,
        sameOrigin,
        request,
        event
      }) {
        const routes = this._routes.get(request.method) || [];
        for (const route of routes) {
          let params;
          // route.match returns type any, not possible to change right now.
          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
          const matchResult = route.match({
            url,
            sameOrigin,
            request,
            event
          });
          if (matchResult) {
            {
              // Warn developers that using an async matchCallback is almost always
              // not the right thing to do.
              if (matchResult instanceof Promise) {
                logger.warn(`While routing ${getFriendlyURL(url)}, an async ` + `matchCallback function was used. Please convert the ` + `following route to use a synchronous matchCallback function:`, route);
              }
            }
            // See https://github.com/GoogleChrome/workbox/issues/2079
            // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
            params = matchResult;
            if (Array.isArray(params) && params.length === 0) {
              // Instead of passing an empty array in as params, use undefined.
              params = undefined;
            } else if (matchResult.constructor === Object &&
            // eslint-disable-line
            Object.keys(matchResult).length === 0) {
              // Instead of passing an empty object in as params, use undefined.
              params = undefined;
            } else if (typeof matchResult === 'boolean') {
              // For the boolean value true (rather than just something truth-y),
              // don't set params.
              // See https://github.com/GoogleChrome/workbox/pull/2134#issuecomment-513924353
              params = undefined;
            }
            // Return early if have a match.
            return {
              route,
              params
            };
          }
        }
        // If no match was found above, return and empty object.
        return {};
      }
      /**
       * Define a default `handler` that's called when no routes explicitly
       * match the incoming request.
       *
       * Each HTTP method ('GET', 'POST', etc.) gets its own default handler.
       *
       * Without a default handler, unmatched requests will go against the
       * network as if there were no service worker present.
       *
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resulting in a Response.
       * @param {string} [method='GET'] The HTTP method to associate with this
       * default handler. Each method has its own default.
       */
      setDefaultHandler(handler, method = defaultMethod) {
        this._defaultHandlerMap.set(method, normalizeHandler(handler));
      }
      /**
       * If a Route throws an error while handling a request, this `handler`
       * will be called and given a chance to provide a response.
       *
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resulting in a Response.
       */
      setCatchHandler(handler) {
        this._catchHandler = normalizeHandler(handler);
      }
      /**
       * Registers a route with the router.
       *
       * @param {workbox-routing.Route} route The route to register.
       */
      registerRoute(route) {
        {
          finalAssertExports.isType(route, 'object', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route'
          });
          finalAssertExports.hasMethod(route, 'match', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route'
          });
          finalAssertExports.isType(route.handler, 'object', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route'
          });
          finalAssertExports.hasMethod(route.handler, 'handle', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route.handler'
          });
          finalAssertExports.isType(route.method, 'string', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route.method'
          });
        }
        if (!this._routes.has(route.method)) {
          this._routes.set(route.method, []);
        }
        // Give precedence to all of the earlier routes by adding this additional
        // route to the end of the array.
        this._routes.get(route.method).push(route);
      }
      /**
       * Unregisters a route with the router.
       *
       * @param {workbox-routing.Route} route The route to unregister.
       */
      unregisterRoute(route) {
        if (!this._routes.has(route.method)) {
          throw new WorkboxError('unregister-route-but-not-found-with-method', {
            method: route.method
          });
        }
        const routeIndex = this._routes.get(route.method).indexOf(route);
        if (routeIndex > -1) {
          this._routes.get(route.method).splice(routeIndex, 1);
        } else {
          throw new WorkboxError('unregister-route-route-not-registered');
        }
      }
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    let defaultRouter;
    /**
     * Creates a new, singleton Router instance if one does not exist. If one
     * does already exist, that instance is returned.
     *
     * @private
     * @return {Router}
     */
    const getOrCreateDefaultRouter = () => {
      if (!defaultRouter) {
        defaultRouter = new Router();
        // The helpers that use the default Router assume these listeners exist.
        defaultRouter.addFetchListener();
        defaultRouter.addCacheListener();
      }
      return defaultRouter;
    };

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Easily register a RegExp, string, or function with a caching
     * strategy to a singleton Router instance.
     *
     * This method will generate a Route for you if needed and
     * call {@link workbox-routing.Router#registerRoute}.
     *
     * @param {RegExp|string|workbox-routing.Route~matchCallback|workbox-routing.Route} capture
     * If the capture param is a `Route`, all other arguments will be ignored.
     * @param {workbox-routing~handlerCallback} [handler] A callback
     * function that returns a Promise resulting in a Response. This parameter
     * is required if `capture` is not a `Route` object.
     * @param {string} [method='GET'] The HTTP method to match the Route
     * against.
     * @return {workbox-routing.Route} The generated `Route`.
     *
     * @memberof workbox-routing
     */
    function registerRoute(capture, handler, method) {
      let route;
      if (typeof capture === 'string') {
        const captureUrl = new URL(capture, location.href);
        {
          if (!(capture.startsWith('/') || capture.startsWith('http'))) {
            throw new WorkboxError('invalid-string', {
              moduleName: 'workbox-routing',
              funcName: 'registerRoute',
              paramName: 'capture'
            });
          }
          // We want to check if Express-style wildcards are in the pathname only.
          // TODO: Remove this log message in v4.
          const valueToCheck = capture.startsWith('http') ? captureUrl.pathname : capture;
          // See https://github.com/pillarjs/path-to-regexp#parameters
          const wildcards = '[*:?+]';
          if (new RegExp(`${wildcards}`).exec(valueToCheck)) {
            logger.debug(`The '$capture' parameter contains an Express-style wildcard ` + `character (${wildcards}). Strings are now always interpreted as ` + `exact matches; use a RegExp for partial or wildcard matches.`);
          }
        }
        const matchCallback = ({
          url
        }) => {
          {
            if (url.pathname === captureUrl.pathname && url.origin !== captureUrl.origin) {
              logger.debug(`${capture} only partially matches the cross-origin URL ` + `${url.toString()}. This route will only handle cross-origin requests ` + `if they match the entire URL.`);
            }
          }
          return url.href === captureUrl.href;
        };
        // If `capture` is a string then `handler` and `method` must be present.
        route = new Route(matchCallback, handler, method);
      } else if (capture instanceof RegExp) {
        // If `capture` is a `RegExp` then `handler` and `method` must be present.
        route = new RegExpRoute(capture, handler, method);
      } else if (typeof capture === 'function') {
        // If `capture` is a function then `handler` and `method` must be present.
        route = new Route(capture, handler, method);
      } else if (capture instanceof Route) {
        route = capture;
      } else {
        throw new WorkboxError('unsupported-route-type', {
          moduleName: 'workbox-routing',
          funcName: 'registerRoute',
          paramName: 'capture'
        });
      }
      const defaultRouter = getOrCreateDefaultRouter();
      defaultRouter.registerRoute(route);
      return route;
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const _cacheNameDetails = {
      googleAnalytics: 'googleAnalytics',
      precache: 'precache-v2',
      prefix: 'workbox',
      runtime: 'runtime',
      suffix: typeof registration !== 'undefined' ? registration.scope : ''
    };
    const _createCacheName = cacheName => {
      return [_cacheNameDetails.prefix, cacheName, _cacheNameDetails.suffix].filter(value => value && value.length > 0).join('-');
    };
    const eachCacheNameDetail = fn => {
      for (const key of Object.keys(_cacheNameDetails)) {
        fn(key);
      }
    };
    const cacheNames = {
      updateDetails: details => {
        eachCacheNameDetail(key => {
          if (typeof details[key] === 'string') {
            _cacheNameDetails[key] = details[key];
          }
        });
      },
      getGoogleAnalyticsName: userCacheName => {
        return userCacheName || _createCacheName(_cacheNameDetails.googleAnalytics);
      },
      getPrecacheName: userCacheName => {
        return userCacheName || _createCacheName(_cacheNameDetails.precache);
      },
      getPrefix: () => {
        return _cacheNameDetails.prefix;
      },
      getRuntimeName: userCacheName => {
        return userCacheName || _createCacheName(_cacheNameDetails.runtime);
      },
      getSuffix: () => {
        return _cacheNameDetails.suffix;
      }
    };

    /*
      Copyright 2020 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A utility method that makes it easier to use `event.waitUntil` with
     * async functions and return the result.
     *
     * @param {ExtendableEvent} event
     * @param {Function} asyncFn
     * @return {Function}
     * @private
     */
    function waitUntil(event, asyncFn) {
      const returnPromise = asyncFn();
      event.waitUntil(returnPromise);
      return returnPromise;
    }

    // @ts-ignore
    try {
      self['workbox:precaching:7.3.0'] && _();
    } catch (e) {}

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    // Name of the search parameter used to store revision info.
    const REVISION_SEARCH_PARAM = '__WB_REVISION__';
    /**
     * Converts a manifest entry into a versioned URL suitable for precaching.
     *
     * @param {Object|string} entry
     * @return {string} A URL with versioning info.
     *
     * @private
     * @memberof workbox-precaching
     */
    function createCacheKey(entry) {
      if (!entry) {
        throw new WorkboxError('add-to-cache-list-unexpected-type', {
          entry
        });
      }
      // If a precache manifest entry is a string, it's assumed to be a versioned
      // URL, like '/app.abcd1234.js'. Return as-is.
      if (typeof entry === 'string') {
        const urlObject = new URL(entry, location.href);
        return {
          cacheKey: urlObject.href,
          url: urlObject.href
        };
      }
      const {
        revision,
        url
      } = entry;
      if (!url) {
        throw new WorkboxError('add-to-cache-list-unexpected-type', {
          entry
        });
      }
      // If there's just a URL and no revision, then it's also assumed to be a
      // versioned URL.
      if (!revision) {
        const urlObject = new URL(url, location.href);
        return {
          cacheKey: urlObject.href,
          url: urlObject.href
        };
      }
      // Otherwise, construct a properly versioned URL using the custom Workbox
      // search parameter along with the revision info.
      const cacheKeyURL = new URL(url, location.href);
      const originalURL = new URL(url, location.href);
      cacheKeyURL.searchParams.set(REVISION_SEARCH_PARAM, revision);
      return {
        cacheKey: cacheKeyURL.href,
        url: originalURL.href
      };
    }

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A plugin, designed to be used with PrecacheController, to determine the
     * of assets that were updated (or not updated) during the install event.
     *
     * @private
     */
    class PrecacheInstallReportPlugin {
      constructor() {
        this.updatedURLs = [];
        this.notUpdatedURLs = [];
        this.handlerWillStart = async ({
          request,
          state
        }) => {
          // TODO: `state` should never be undefined...
          if (state) {
            state.originalRequest = request;
          }
        };
        this.cachedResponseWillBeUsed = async ({
          event,
          state,
          cachedResponse
        }) => {
          if (event.type === 'install') {
            if (state && state.originalRequest && state.originalRequest instanceof Request) {
              // TODO: `state` should never be undefined...
              const url = state.originalRequest.url;
              if (cachedResponse) {
                this.notUpdatedURLs.push(url);
              } else {
                this.updatedURLs.push(url);
              }
            }
          }
          return cachedResponse;
        };
      }
    }

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A plugin, designed to be used with PrecacheController, to translate URLs into
     * the corresponding cache key, based on the current revision info.
     *
     * @private
     */
    class PrecacheCacheKeyPlugin {
      constructor({
        precacheController
      }) {
        this.cacheKeyWillBeUsed = async ({
          request,
          params
        }) => {
          // Params is type any, can't change right now.
          /* eslint-disable */
          const cacheKey = (params === null || params === void 0 ? void 0 : params.cacheKey) || this._precacheController.getCacheKeyForURL(request.url);
          /* eslint-enable */
          return cacheKey ? new Request(cacheKey, {
            headers: request.headers
          }) : request;
        };
        this._precacheController = precacheController;
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * @param {string} groupTitle
     * @param {Array<string>} deletedURLs
     *
     * @private
     */
    const logGroup = (groupTitle, deletedURLs) => {
      logger.groupCollapsed(groupTitle);
      for (const url of deletedURLs) {
        logger.log(url);
      }
      logger.groupEnd();
    };
    /**
     * @param {Array<string>} deletedURLs
     *
     * @private
     * @memberof workbox-precaching
     */
    function printCleanupDetails(deletedURLs) {
      const deletionCount = deletedURLs.length;
      if (deletionCount > 0) {
        logger.groupCollapsed(`During precaching cleanup, ` + `${deletionCount} cached ` + `request${deletionCount === 1 ? ' was' : 's were'} deleted.`);
        logGroup('Deleted Cache Requests', deletedURLs);
        logger.groupEnd();
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * @param {string} groupTitle
     * @param {Array<string>} urls
     *
     * @private
     */
    function _nestedGroup(groupTitle, urls) {
      if (urls.length === 0) {
        return;
      }
      logger.groupCollapsed(groupTitle);
      for (const url of urls) {
        logger.log(url);
      }
      logger.groupEnd();
    }
    /**
     * @param {Array<string>} urlsToPrecache
     * @param {Array<string>} urlsAlreadyPrecached
     *
     * @private
     * @memberof workbox-precaching
     */
    function printInstallDetails(urlsToPrecache, urlsAlreadyPrecached) {
      const precachedCount = urlsToPrecache.length;
      const alreadyPrecachedCount = urlsAlreadyPrecached.length;
      if (precachedCount || alreadyPrecachedCount) {
        let message = `Precaching ${precachedCount} file${precachedCount === 1 ? '' : 's'}.`;
        if (alreadyPrecachedCount > 0) {
          message += ` ${alreadyPrecachedCount} ` + `file${alreadyPrecachedCount === 1 ? ' is' : 's are'} already cached.`;
        }
        logger.groupCollapsed(message);
        _nestedGroup(`View newly precached URLs.`, urlsToPrecache);
        _nestedGroup(`View previously precached URLs.`, urlsAlreadyPrecached);
        logger.groupEnd();
      }
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    let supportStatus;
    /**
     * A utility function that determines whether the current browser supports
     * constructing a new `Response` from a `response.body` stream.
     *
     * @return {boolean} `true`, if the current browser can successfully
     *     construct a `Response` from a `response.body` stream, `false` otherwise.
     *
     * @private
     */
    function canConstructResponseFromBodyStream() {
      if (supportStatus === undefined) {
        const testResponse = new Response('');
        if ('body' in testResponse) {
          try {
            new Response(testResponse.body);
            supportStatus = true;
          } catch (error) {
            supportStatus = false;
          }
        }
        supportStatus = false;
      }
      return supportStatus;
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Allows developers to copy a response and modify its `headers`, `status`,
     * or `statusText` values (the values settable via a
     * [`ResponseInit`]{@link https://developer.mozilla.org/en-US/docs/Web/API/Response/Response#Syntax}
     * object in the constructor).
     * To modify these values, pass a function as the second argument. That
     * function will be invoked with a single object with the response properties
     * `{headers, status, statusText}`. The return value of this function will
     * be used as the `ResponseInit` for the new `Response`. To change the values
     * either modify the passed parameter(s) and return it, or return a totally
     * new object.
     *
     * This method is intentionally limited to same-origin responses, regardless of
     * whether CORS was used or not.
     *
     * @param {Response} response
     * @param {Function} modifier
     * @memberof workbox-core
     */
    async function copyResponse(response, modifier) {
      let origin = null;
      // If response.url isn't set, assume it's cross-origin and keep origin null.
      if (response.url) {
        const responseURL = new URL(response.url);
        origin = responseURL.origin;
      }
      if (origin !== self.location.origin) {
        throw new WorkboxError('cross-origin-copy-response', {
          origin
        });
      }
      const clonedResponse = response.clone();
      // Create a fresh `ResponseInit` object by cloning the headers.
      const responseInit = {
        headers: new Headers(clonedResponse.headers),
        status: clonedResponse.status,
        statusText: clonedResponse.statusText
      };
      // Apply any user modifications.
      const modifiedResponseInit = modifier ? modifier(responseInit) : responseInit;
      // Create the new response from the body stream and `ResponseInit`
      // modifications. Note: not all browsers support the Response.body stream,
      // so fall back to reading the entire body into memory as a blob.
      const body = canConstructResponseFromBodyStream() ? clonedResponse.body : await clonedResponse.blob();
      return new Response(body, modifiedResponseInit);
    }

    /*
      Copyright 2020 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    function stripParams(fullURL, ignoreParams) {
      const strippedURL = new URL(fullURL);
      for (const param of ignoreParams) {
        strippedURL.searchParams.delete(param);
      }
      return strippedURL.href;
    }
    /**
     * Matches an item in the cache, ignoring specific URL params. This is similar
     * to the `ignoreSearch` option, but it allows you to ignore just specific
     * params (while continuing to match on the others).
     *
     * @private
     * @param {Cache} cache
     * @param {Request} request
     * @param {Object} matchOptions
     * @param {Array<string>} ignoreParams
     * @return {Promise<Response|undefined>}
     */
    async function cacheMatchIgnoreParams(cache, request, ignoreParams, matchOptions) {
      const strippedRequestURL = stripParams(request.url, ignoreParams);
      // If the request doesn't include any ignored params, match as normal.
      if (request.url === strippedRequestURL) {
        return cache.match(request, matchOptions);
      }
      // Otherwise, match by comparing keys
      const keysOptions = Object.assign(Object.assign({}, matchOptions), {
        ignoreSearch: true
      });
      const cacheKeys = await cache.keys(request, keysOptions);
      for (const cacheKey of cacheKeys) {
        const strippedCacheKeyURL = stripParams(cacheKey.url, ignoreParams);
        if (strippedRequestURL === strippedCacheKeyURL) {
          return cache.match(cacheKey, matchOptions);
        }
      }
      return;
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * The Deferred class composes Promises in a way that allows for them to be
     * resolved or rejected from outside the constructor. In most cases promises
     * should be used directly, but Deferreds can be necessary when the logic to
     * resolve a promise must be separate.
     *
     * @private
     */
    class Deferred {
      /**
       * Creates a promise and exposes its resolve and reject functions as methods.
       */
      constructor() {
        this.promise = new Promise((resolve, reject) => {
          this.resolve = resolve;
          this.reject = reject;
        });
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    // Callbacks to be executed whenever there's a quota error.
    // Can't change Function type right now.
    // eslint-disable-next-line @typescript-eslint/ban-types
    const quotaErrorCallbacks = new Set();

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Runs all of the callback functions, one at a time sequentially, in the order
     * in which they were registered.
     *
     * @memberof workbox-core
     * @private
     */
    async function executeQuotaErrorCallbacks() {
      {
        logger.log(`About to run ${quotaErrorCallbacks.size} ` + `callbacks to clean up caches.`);
      }
      for (const callback of quotaErrorCallbacks) {
        await callback();
        {
          logger.log(callback, 'is complete.');
        }
      }
      {
        logger.log('Finished running callbacks.');
      }
    }

    /*
      Copyright 2019 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Returns a promise that resolves and the passed number of milliseconds.
     * This utility is an async/await-friendly version of `setTimeout`.
     *
     * @param {number} ms
     * @return {Promise}
     * @private
     */
    function timeout(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // @ts-ignore
    try {
      self['workbox:strategies:7.3.0'] && _();
    } catch (e) {}

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    function toRequest(input) {
      return typeof input === 'string' ? new Request(input) : input;
    }
    /**
     * A class created every time a Strategy instance calls
     * {@link workbox-strategies.Strategy~handle} or
     * {@link workbox-strategies.Strategy~handleAll} that wraps all fetch and
     * cache actions around plugin callbacks and keeps track of when the strategy
     * is "done" (i.e. all added `event.waitUntil()` promises have resolved).
     *
     * @memberof workbox-strategies
     */
    class StrategyHandler {
      /**
       * Creates a new instance associated with the passed strategy and event
       * that's handling the request.
       *
       * The constructor also initializes the state that will be passed to each of
       * the plugins handling this request.
       *
       * @param {workbox-strategies.Strategy} strategy
       * @param {Object} options
       * @param {Request|string} options.request A request to run this strategy for.
       * @param {ExtendableEvent} options.event The event associated with the
       *     request.
       * @param {URL} [options.url]
       * @param {*} [options.params] The return value from the
       *     {@link workbox-routing~matchCallback} (if applicable).
       */
      constructor(strategy, options) {
        this._cacheKeys = {};
        /**
         * The request the strategy is performing (passed to the strategy's
         * `handle()` or `handleAll()` method).
         * @name request
         * @instance
         * @type {Request}
         * @memberof workbox-strategies.StrategyHandler
         */
        /**
         * The event associated with this request.
         * @name event
         * @instance
         * @type {ExtendableEvent}
         * @memberof workbox-strategies.StrategyHandler
         */
        /**
         * A `URL` instance of `request.url` (if passed to the strategy's
         * `handle()` or `handleAll()` method).
         * Note: the `url` param will be present if the strategy was invoked
         * from a workbox `Route` object.
         * @name url
         * @instance
         * @type {URL|undefined}
         * @memberof workbox-strategies.StrategyHandler
         */
        /**
         * A `param` value (if passed to the strategy's
         * `handle()` or `handleAll()` method).
         * Note: the `param` param will be present if the strategy was invoked
         * from a workbox `Route` object and the
         * {@link workbox-routing~matchCallback} returned
         * a truthy value (it will be that value).
         * @name params
         * @instance
         * @type {*|undefined}
         * @memberof workbox-strategies.StrategyHandler
         */
        {
          finalAssertExports.isInstance(options.event, ExtendableEvent, {
            moduleName: 'workbox-strategies',
            className: 'StrategyHandler',
            funcName: 'constructor',
            paramName: 'options.event'
          });
        }
        Object.assign(this, options);
        this.event = options.event;
        this._strategy = strategy;
        this._handlerDeferred = new Deferred();
        this._extendLifetimePromises = [];
        // Copy the plugins list (since it's mutable on the strategy),
        // so any mutations don't affect this handler instance.
        this._plugins = [...strategy.plugins];
        this._pluginStateMap = new Map();
        for (const plugin of this._plugins) {
          this._pluginStateMap.set(plugin, {});
        }
        this.event.waitUntil(this._handlerDeferred.promise);
      }
      /**
       * Fetches a given request (and invokes any applicable plugin callback
       * methods) using the `fetchOptions` (for non-navigation requests) and
       * `plugins` defined on the `Strategy` object.
       *
       * The following plugin lifecycle methods are invoked when using this method:
       * - `requestWillFetch()`
       * - `fetchDidSucceed()`
       * - `fetchDidFail()`
       *
       * @param {Request|string} input The URL or request to fetch.
       * @return {Promise<Response>}
       */
      async fetch(input) {
        const {
          event
        } = this;
        let request = toRequest(input);
        if (request.mode === 'navigate' && event instanceof FetchEvent && event.preloadResponse) {
          const possiblePreloadResponse = await event.preloadResponse;
          if (possiblePreloadResponse) {
            {
              logger.log(`Using a preloaded navigation response for ` + `'${getFriendlyURL(request.url)}'`);
            }
            return possiblePreloadResponse;
          }
        }
        // If there is a fetchDidFail plugin, we need to save a clone of the
        // original request before it's either modified by a requestWillFetch
        // plugin or before the original request's body is consumed via fetch().
        const originalRequest = this.hasCallback('fetchDidFail') ? request.clone() : null;
        try {
          for (const cb of this.iterateCallbacks('requestWillFetch')) {
            request = await cb({
              request: request.clone(),
              event
            });
          }
        } catch (err) {
          if (err instanceof Error) {
            throw new WorkboxError('plugin-error-request-will-fetch', {
              thrownErrorMessage: err.message
            });
          }
        }
        // The request can be altered by plugins with `requestWillFetch` making
        // the original request (most likely from a `fetch` event) different
        // from the Request we make. Pass both to `fetchDidFail` to aid debugging.
        const pluginFilteredRequest = request.clone();
        try {
          let fetchResponse;
          // See https://github.com/GoogleChrome/workbox/issues/1796
          fetchResponse = await fetch(request, request.mode === 'navigate' ? undefined : this._strategy.fetchOptions);
          if ("development" !== 'production') {
            logger.debug(`Network request for ` + `'${getFriendlyURL(request.url)}' returned a response with ` + `status '${fetchResponse.status}'.`);
          }
          for (const callback of this.iterateCallbacks('fetchDidSucceed')) {
            fetchResponse = await callback({
              event,
              request: pluginFilteredRequest,
              response: fetchResponse
            });
          }
          return fetchResponse;
        } catch (error) {
          {
            logger.log(`Network request for ` + `'${getFriendlyURL(request.url)}' threw an error.`, error);
          }
          // `originalRequest` will only exist if a `fetchDidFail` callback
          // is being used (see above).
          if (originalRequest) {
            await this.runCallbacks('fetchDidFail', {
              error: error,
              event,
              originalRequest: originalRequest.clone(),
              request: pluginFilteredRequest.clone()
            });
          }
          throw error;
        }
      }
      /**
       * Calls `this.fetch()` and (in the background) runs `this.cachePut()` on
       * the response generated by `this.fetch()`.
       *
       * The call to `this.cachePut()` automatically invokes `this.waitUntil()`,
       * so you do not have to manually call `waitUntil()` on the event.
       *
       * @param {Request|string} input The request or URL to fetch and cache.
       * @return {Promise<Response>}
       */
      async fetchAndCachePut(input) {
        const response = await this.fetch(input);
        const responseClone = response.clone();
        void this.waitUntil(this.cachePut(input, responseClone));
        return response;
      }
      /**
       * Matches a request from the cache (and invokes any applicable plugin
       * callback methods) using the `cacheName`, `matchOptions`, and `plugins`
       * defined on the strategy object.
       *
       * The following plugin lifecycle methods are invoked when using this method:
       * - cacheKeyWillBeUsed()
       * - cachedResponseWillBeUsed()
       *
       * @param {Request|string} key The Request or URL to use as the cache key.
       * @return {Promise<Response|undefined>} A matching response, if found.
       */
      async cacheMatch(key) {
        const request = toRequest(key);
        let cachedResponse;
        const {
          cacheName,
          matchOptions
        } = this._strategy;
        const effectiveRequest = await this.getCacheKey(request, 'read');
        const multiMatchOptions = Object.assign(Object.assign({}, matchOptions), {
          cacheName
        });
        cachedResponse = await caches.match(effectiveRequest, multiMatchOptions);
        {
          if (cachedResponse) {
            logger.debug(`Found a cached response in '${cacheName}'.`);
          } else {
            logger.debug(`No cached response found in '${cacheName}'.`);
          }
        }
        for (const callback of this.iterateCallbacks('cachedResponseWillBeUsed')) {
          cachedResponse = (await callback({
            cacheName,
            matchOptions,
            cachedResponse,
            request: effectiveRequest,
            event: this.event
          })) || undefined;
        }
        return cachedResponse;
      }
      /**
       * Puts a request/response pair in the cache (and invokes any applicable
       * plugin callback methods) using the `cacheName` and `plugins` defined on
       * the strategy object.
       *
       * The following plugin lifecycle methods are invoked when using this method:
       * - cacheKeyWillBeUsed()
       * - cacheWillUpdate()
       * - cacheDidUpdate()
       *
       * @param {Request|string} key The request or URL to use as the cache key.
       * @param {Response} response The response to cache.
       * @return {Promise<boolean>} `false` if a cacheWillUpdate caused the response
       * not be cached, and `true` otherwise.
       */
      async cachePut(key, response) {
        const request = toRequest(key);
        // Run in the next task to avoid blocking other cache reads.
        // https://github.com/w3c/ServiceWorker/issues/1397
        await timeout(0);
        const effectiveRequest = await this.getCacheKey(request, 'write');
        {
          if (effectiveRequest.method && effectiveRequest.method !== 'GET') {
            throw new WorkboxError('attempt-to-cache-non-get-request', {
              url: getFriendlyURL(effectiveRequest.url),
              method: effectiveRequest.method
            });
          }
          // See https://github.com/GoogleChrome/workbox/issues/2818
          const vary = response.headers.get('Vary');
          if (vary) {
            logger.debug(`The response for ${getFriendlyURL(effectiveRequest.url)} ` + `has a 'Vary: ${vary}' header. ` + `Consider setting the {ignoreVary: true} option on your strategy ` + `to ensure cache matching and deletion works as expected.`);
          }
        }
        if (!response) {
          {
            logger.error(`Cannot cache non-existent response for ` + `'${getFriendlyURL(effectiveRequest.url)}'.`);
          }
          throw new WorkboxError('cache-put-with-no-response', {
            url: getFriendlyURL(effectiveRequest.url)
          });
        }
        const responseToCache = await this._ensureResponseSafeToCache(response);
        if (!responseToCache) {
          {
            logger.debug(`Response '${getFriendlyURL(effectiveRequest.url)}' ` + `will not be cached.`, responseToCache);
          }
          return false;
        }
        const {
          cacheName,
          matchOptions
        } = this._strategy;
        const cache = await self.caches.open(cacheName);
        const hasCacheUpdateCallback = this.hasCallback('cacheDidUpdate');
        const oldResponse = hasCacheUpdateCallback ? await cacheMatchIgnoreParams(
        // TODO(philipwalton): the `__WB_REVISION__` param is a precaching
        // feature. Consider into ways to only add this behavior if using
        // precaching.
        cache, effectiveRequest.clone(), ['__WB_REVISION__'], matchOptions) : null;
        {
          logger.debug(`Updating the '${cacheName}' cache with a new Response ` + `for ${getFriendlyURL(effectiveRequest.url)}.`);
        }
        try {
          await cache.put(effectiveRequest, hasCacheUpdateCallback ? responseToCache.clone() : responseToCache);
        } catch (error) {
          if (error instanceof Error) {
            // See https://developer.mozilla.org/en-US/docs/Web/API/DOMException#exception-QuotaExceededError
            if (error.name === 'QuotaExceededError') {
              await executeQuotaErrorCallbacks();
            }
            throw error;
          }
        }
        for (const callback of this.iterateCallbacks('cacheDidUpdate')) {
          await callback({
            cacheName,
            oldResponse,
            newResponse: responseToCache.clone(),
            request: effectiveRequest,
            event: this.event
          });
        }
        return true;
      }
      /**
       * Checks the list of plugins for the `cacheKeyWillBeUsed` callback, and
       * executes any of those callbacks found in sequence. The final `Request`
       * object returned by the last plugin is treated as the cache key for cache
       * reads and/or writes. If no `cacheKeyWillBeUsed` plugin callbacks have
       * been registered, the passed request is returned unmodified
       *
       * @param {Request} request
       * @param {string} mode
       * @return {Promise<Request>}
       */
      async getCacheKey(request, mode) {
        const key = `${request.url} | ${mode}`;
        if (!this._cacheKeys[key]) {
          let effectiveRequest = request;
          for (const callback of this.iterateCallbacks('cacheKeyWillBeUsed')) {
            effectiveRequest = toRequest(await callback({
              mode,
              request: effectiveRequest,
              event: this.event,
              // params has a type any can't change right now.
              params: this.params // eslint-disable-line
            }));
          }
          this._cacheKeys[key] = effectiveRequest;
        }
        return this._cacheKeys[key];
      }
      /**
       * Returns true if the strategy has at least one plugin with the given
       * callback.
       *
       * @param {string} name The name of the callback to check for.
       * @return {boolean}
       */
      hasCallback(name) {
        for (const plugin of this._strategy.plugins) {
          if (name in plugin) {
            return true;
          }
        }
        return false;
      }
      /**
       * Runs all plugin callbacks matching the given name, in order, passing the
       * given param object (merged ith the current plugin state) as the only
       * argument.
       *
       * Note: since this method runs all plugins, it's not suitable for cases
       * where the return value of a callback needs to be applied prior to calling
       * the next callback. See
       * {@link workbox-strategies.StrategyHandler#iterateCallbacks}
       * below for how to handle that case.
       *
       * @param {string} name The name of the callback to run within each plugin.
       * @param {Object} param The object to pass as the first (and only) param
       *     when executing each callback. This object will be merged with the
       *     current plugin state prior to callback execution.
       */
      async runCallbacks(name, param) {
        for (const callback of this.iterateCallbacks(name)) {
          // TODO(philipwalton): not sure why `any` is needed. It seems like
          // this should work with `as WorkboxPluginCallbackParam[C]`.
          await callback(param);
        }
      }
      /**
       * Accepts a callback and returns an iterable of matching plugin callbacks,
       * where each callback is wrapped with the current handler state (i.e. when
       * you call each callback, whatever object parameter you pass it will
       * be merged with the plugin's current state).
       *
       * @param {string} name The name fo the callback to run
       * @return {Array<Function>}
       */
      *iterateCallbacks(name) {
        for (const plugin of this._strategy.plugins) {
          if (typeof plugin[name] === 'function') {
            const state = this._pluginStateMap.get(plugin);
            const statefulCallback = param => {
              const statefulParam = Object.assign(Object.assign({}, param), {
                state
              });
              // TODO(philipwalton): not sure why `any` is needed. It seems like
              // this should work with `as WorkboxPluginCallbackParam[C]`.
              return plugin[name](statefulParam);
            };
            yield statefulCallback;
          }
        }
      }
      /**
       * Adds a promise to the
       * [extend lifetime promises]{@link https://w3c.github.io/ServiceWorker/#extendableevent-extend-lifetime-promises}
       * of the event associated with the request being handled (usually a
       * `FetchEvent`).
       *
       * Note: you can await
       * {@link workbox-strategies.StrategyHandler~doneWaiting}
       * to know when all added promises have settled.
       *
       * @param {Promise} promise A promise to add to the extend lifetime promises
       *     of the event that triggered the request.
       */
      waitUntil(promise) {
        this._extendLifetimePromises.push(promise);
        return promise;
      }
      /**
       * Returns a promise that resolves once all promises passed to
       * {@link workbox-strategies.StrategyHandler~waitUntil}
       * have settled.
       *
       * Note: any work done after `doneWaiting()` settles should be manually
       * passed to an event's `waitUntil()` method (not this handler's
       * `waitUntil()` method), otherwise the service worker thread may be killed
       * prior to your work completing.
       */
      async doneWaiting() {
        while (this._extendLifetimePromises.length) {
          const promises = this._extendLifetimePromises.splice(0);
          const result = await Promise.allSettled(promises);
          const firstRejection = result.find(i => i.status === 'rejected');
          if (firstRejection) {
            throw firstRejection.reason;
          }
        }
      }
      /**
       * Stops running the strategy and immediately resolves any pending
       * `waitUntil()` promises.
       */
      destroy() {
        this._handlerDeferred.resolve(null);
      }
      /**
       * This method will call cacheWillUpdate on the available plugins (or use
       * status === 200) to determine if the Response is safe and valid to cache.
       *
       * @param {Request} options.request
       * @param {Response} options.response
       * @return {Promise<Response|undefined>}
       *
       * @private
       */
      async _ensureResponseSafeToCache(response) {
        let responseToCache = response;
        let pluginsUsed = false;
        for (const callback of this.iterateCallbacks('cacheWillUpdate')) {
          responseToCache = (await callback({
            request: this.request,
            response: responseToCache,
            event: this.event
          })) || undefined;
          pluginsUsed = true;
          if (!responseToCache) {
            break;
          }
        }
        if (!pluginsUsed) {
          if (responseToCache && responseToCache.status !== 200) {
            responseToCache = undefined;
          }
          {
            if (responseToCache) {
              if (responseToCache.status !== 200) {
                if (responseToCache.status === 0) {
                  logger.warn(`The response for '${this.request.url}' ` + `is an opaque response. The caching strategy that you're ` + `using will not cache opaque responses by default.`);
                } else {
                  logger.debug(`The response for '${this.request.url}' ` + `returned a status code of '${response.status}' and won't ` + `be cached as a result.`);
                }
              }
            }
          }
        }
        return responseToCache;
      }
    }

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * An abstract base class that all other strategy classes must extend from:
     *
     * @memberof workbox-strategies
     */
    class Strategy {
      /**
       * Creates a new instance of the strategy and sets all documented option
       * properties as public instance properties.
       *
       * Note: if a custom strategy class extends the base Strategy class and does
       * not need more than these properties, it does not need to define its own
       * constructor.
       *
       * @param {Object} [options]
       * @param {string} [options.cacheName] Cache name to store and retrieve
       * requests. Defaults to the cache names provided by
       * {@link workbox-core.cacheNames}.
       * @param {Array<Object>} [options.plugins] [Plugins]{@link https://developers.google.com/web/tools/workbox/guides/using-plugins}
       * to use in conjunction with this caching strategy.
       * @param {Object} [options.fetchOptions] Values passed along to the
       * [`init`](https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch#Parameters)
       * of [non-navigation](https://github.com/GoogleChrome/workbox/issues/1796)
       * `fetch()` requests made by this strategy.
       * @param {Object} [options.matchOptions] The
       * [`CacheQueryOptions`]{@link https://w3c.github.io/ServiceWorker/#dictdef-cachequeryoptions}
       * for any `cache.match()` or `cache.put()` calls made by this strategy.
       */
      constructor(options = {}) {
        /**
         * Cache name to store and retrieve
         * requests. Defaults to the cache names provided by
         * {@link workbox-core.cacheNames}.
         *
         * @type {string}
         */
        this.cacheName = cacheNames.getRuntimeName(options.cacheName);
        /**
         * The list
         * [Plugins]{@link https://developers.google.com/web/tools/workbox/guides/using-plugins}
         * used by this strategy.
         *
         * @type {Array<Object>}
         */
        this.plugins = options.plugins || [];
        /**
         * Values passed along to the
         * [`init`]{@link https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch#Parameters}
         * of all fetch() requests made by this strategy.
         *
         * @type {Object}
         */
        this.fetchOptions = options.fetchOptions;
        /**
         * The
         * [`CacheQueryOptions`]{@link https://w3c.github.io/ServiceWorker/#dictdef-cachequeryoptions}
         * for any `cache.match()` or `cache.put()` calls made by this strategy.
         *
         * @type {Object}
         */
        this.matchOptions = options.matchOptions;
      }
      /**
       * Perform a request strategy and returns a `Promise` that will resolve with
       * a `Response`, invoking all relevant plugin callbacks.
       *
       * When a strategy instance is registered with a Workbox
       * {@link workbox-routing.Route}, this method is automatically
       * called when the route matches.
       *
       * Alternatively, this method can be used in a standalone `FetchEvent`
       * listener by passing it to `event.respondWith()`.
       *
       * @param {FetchEvent|Object} options A `FetchEvent` or an object with the
       *     properties listed below.
       * @param {Request|string} options.request A request to run this strategy for.
       * @param {ExtendableEvent} options.event The event associated with the
       *     request.
       * @param {URL} [options.url]
       * @param {*} [options.params]
       */
      handle(options) {
        const [responseDone] = this.handleAll(options);
        return responseDone;
      }
      /**
       * Similar to {@link workbox-strategies.Strategy~handle}, but
       * instead of just returning a `Promise` that resolves to a `Response` it
       * it will return an tuple of `[response, done]` promises, where the former
       * (`response`) is equivalent to what `handle()` returns, and the latter is a
       * Promise that will resolve once any promises that were added to
       * `event.waitUntil()` as part of performing the strategy have completed.
       *
       * You can await the `done` promise to ensure any extra work performed by
       * the strategy (usually caching responses) completes successfully.
       *
       * @param {FetchEvent|Object} options A `FetchEvent` or an object with the
       *     properties listed below.
       * @param {Request|string} options.request A request to run this strategy for.
       * @param {ExtendableEvent} options.event The event associated with the
       *     request.
       * @param {URL} [options.url]
       * @param {*} [options.params]
       * @return {Array<Promise>} A tuple of [response, done]
       *     promises that can be used to determine when the response resolves as
       *     well as when the handler has completed all its work.
       */
      handleAll(options) {
        // Allow for flexible options to be passed.
        if (options instanceof FetchEvent) {
          options = {
            event: options,
            request: options.request
          };
        }
        const event = options.event;
        const request = typeof options.request === 'string' ? new Request(options.request) : options.request;
        const params = 'params' in options ? options.params : undefined;
        const handler = new StrategyHandler(this, {
          event,
          request,
          params
        });
        const responseDone = this._getResponse(handler, request, event);
        const handlerDone = this._awaitComplete(responseDone, handler, request, event);
        // Return an array of promises, suitable for use with Promise.all().
        return [responseDone, handlerDone];
      }
      async _getResponse(handler, request, event) {
        await handler.runCallbacks('handlerWillStart', {
          event,
          request
        });
        let response = undefined;
        try {
          response = await this._handle(request, handler);
          // The "official" Strategy subclasses all throw this error automatically,
          // but in case a third-party Strategy doesn't, ensure that we have a
          // consistent failure when there's no response or an error response.
          if (!response || response.type === 'error') {
            throw new WorkboxError('no-response', {
              url: request.url
            });
          }
        } catch (error) {
          if (error instanceof Error) {
            for (const callback of handler.iterateCallbacks('handlerDidError')) {
              response = await callback({
                error,
                event,
                request
              });
              if (response) {
                break;
              }
            }
          }
          if (!response) {
            throw error;
          } else {
            logger.log(`While responding to '${getFriendlyURL(request.url)}', ` + `an ${error instanceof Error ? error.toString() : ''} error occurred. Using a fallback response provided by ` + `a handlerDidError plugin.`);
          }
        }
        for (const callback of handler.iterateCallbacks('handlerWillRespond')) {
          response = await callback({
            event,
            request,
            response
          });
        }
        return response;
      }
      async _awaitComplete(responseDone, handler, request, event) {
        let response;
        let error;
        try {
          response = await responseDone;
        } catch (error) {
          // Ignore errors, as response errors should be caught via the `response`
          // promise above. The `done` promise will only throw for errors in
          // promises passed to `handler.waitUntil()`.
        }
        try {
          await handler.runCallbacks('handlerDidRespond', {
            event,
            request,
            response
          });
          await handler.doneWaiting();
        } catch (waitUntilError) {
          if (waitUntilError instanceof Error) {
            error = waitUntilError;
          }
        }
        await handler.runCallbacks('handlerDidComplete', {
          event,
          request,
          response,
          error: error
        });
        handler.destroy();
        if (error) {
          throw error;
        }
      }
    }
    /**
     * Classes extending the `Strategy` based class should implement this method,
     * and leverage the {@link workbox-strategies.StrategyHandler}
     * arg to perform all fetching and cache logic, which will ensure all relevant
     * cache, cache options, fetch options and plugins are used (per the current
     * strategy instance).
     *
     * @name _handle
     * @instance
     * @abstract
     * @function
     * @param {Request} request
     * @param {workbox-strategies.StrategyHandler} handler
     * @return {Promise<Response>}
     *
     * @memberof workbox-strategies.Strategy
     */

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A {@link workbox-strategies.Strategy} implementation
     * specifically designed to work with
     * {@link workbox-precaching.PrecacheController}
     * to both cache and fetch precached assets.
     *
     * Note: an instance of this class is created automatically when creating a
     * `PrecacheController`; it's generally not necessary to create this yourself.
     *
     * @extends workbox-strategies.Strategy
     * @memberof workbox-precaching
     */
    class PrecacheStrategy extends Strategy {
      /**
       *
       * @param {Object} [options]
       * @param {string} [options.cacheName] Cache name to store and retrieve
       * requests. Defaults to the cache names provided by
       * {@link workbox-core.cacheNames}.
       * @param {Array<Object>} [options.plugins] {@link https://developers.google.com/web/tools/workbox/guides/using-plugins|Plugins}
       * to use in conjunction with this caching strategy.
       * @param {Object} [options.fetchOptions] Values passed along to the
       * {@link https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch#Parameters|init}
       * of all fetch() requests made by this strategy.
       * @param {Object} [options.matchOptions] The
       * {@link https://w3c.github.io/ServiceWorker/#dictdef-cachequeryoptions|CacheQueryOptions}
       * for any `cache.match()` or `cache.put()` calls made by this strategy.
       * @param {boolean} [options.fallbackToNetwork=true] Whether to attempt to
       * get the response from the network if there's a precache miss.
       */
      constructor(options = {}) {
        options.cacheName = cacheNames.getPrecacheName(options.cacheName);
        super(options);
        this._fallbackToNetwork = options.fallbackToNetwork === false ? false : true;
        // Redirected responses cannot be used to satisfy a navigation request, so
        // any redirected response must be "copied" rather than cloned, so the new
        // response doesn't contain the `redirected` flag. See:
        // https://bugs.chromium.org/p/chromium/issues/detail?id=669363&desc=2#c1
        this.plugins.push(PrecacheStrategy.copyRedirectedCacheableResponsesPlugin);
      }
      /**
       * @private
       * @param {Request|string} request A request to run this strategy for.
       * @param {workbox-strategies.StrategyHandler} handler The event that
       *     triggered the request.
       * @return {Promise<Response>}
       */
      async _handle(request, handler) {
        const response = await handler.cacheMatch(request);
        if (response) {
          return response;
        }
        // If this is an `install` event for an entry that isn't already cached,
        // then populate the cache.
        if (handler.event && handler.event.type === 'install') {
          return await this._handleInstall(request, handler);
        }
        // Getting here means something went wrong. An entry that should have been
        // precached wasn't found in the cache.
        return await this._handleFetch(request, handler);
      }
      async _handleFetch(request, handler) {
        let response;
        const params = handler.params || {};
        // Fall back to the network if we're configured to do so.
        if (this._fallbackToNetwork) {
          {
            logger.warn(`The precached response for ` + `${getFriendlyURL(request.url)} in ${this.cacheName} was not ` + `found. Falling back to the network.`);
          }
          const integrityInManifest = params.integrity;
          const integrityInRequest = request.integrity;
          const noIntegrityConflict = !integrityInRequest || integrityInRequest === integrityInManifest;
          // Do not add integrity if the original request is no-cors
          // See https://github.com/GoogleChrome/workbox/issues/3096
          response = await handler.fetch(new Request(request, {
            integrity: request.mode !== 'no-cors' ? integrityInRequest || integrityInManifest : undefined
          }));
          // It's only "safe" to repair the cache if we're using SRI to guarantee
          // that the response matches the precache manifest's expectations,
          // and there's either a) no integrity property in the incoming request
          // or b) there is an integrity, and it matches the precache manifest.
          // See https://github.com/GoogleChrome/workbox/issues/2858
          // Also if the original request users no-cors we don't use integrity.
          // See https://github.com/GoogleChrome/workbox/issues/3096
          if (integrityInManifest && noIntegrityConflict && request.mode !== 'no-cors') {
            this._useDefaultCacheabilityPluginIfNeeded();
            const wasCached = await handler.cachePut(request, response.clone());
            {
              if (wasCached) {
                logger.log(`A response for ${getFriendlyURL(request.url)} ` + `was used to "repair" the precache.`);
              }
            }
          }
        } else {
          // This shouldn't normally happen, but there are edge cases:
          // https://github.com/GoogleChrome/workbox/issues/1441
          throw new WorkboxError('missing-precache-entry', {
            cacheName: this.cacheName,
            url: request.url
          });
        }
        {
          const cacheKey = params.cacheKey || (await handler.getCacheKey(request, 'read'));
          // Workbox is going to handle the route.
          // print the routing details to the console.
          logger.groupCollapsed(`Precaching is responding to: ` + getFriendlyURL(request.url));
          logger.log(`Serving the precached url: ${getFriendlyURL(cacheKey instanceof Request ? cacheKey.url : cacheKey)}`);
          logger.groupCollapsed(`View request details here.`);
          logger.log(request);
          logger.groupEnd();
          logger.groupCollapsed(`View response details here.`);
          logger.log(response);
          logger.groupEnd();
          logger.groupEnd();
        }
        return response;
      }
      async _handleInstall(request, handler) {
        this._useDefaultCacheabilityPluginIfNeeded();
        const response = await handler.fetch(request);
        // Make sure we defer cachePut() until after we know the response
        // should be cached; see https://github.com/GoogleChrome/workbox/issues/2737
        const wasCached = await handler.cachePut(request, response.clone());
        if (!wasCached) {
          // Throwing here will lead to the `install` handler failing, which
          // we want to do if *any* of the responses aren't safe to cache.
          throw new WorkboxError('bad-precaching-response', {
            url: request.url,
            status: response.status
          });
        }
        return response;
      }
      /**
       * This method is complex, as there a number of things to account for:
       *
       * The `plugins` array can be set at construction, and/or it might be added to
       * to at any time before the strategy is used.
       *
       * At the time the strategy is used (i.e. during an `install` event), there
       * needs to be at least one plugin that implements `cacheWillUpdate` in the
       * array, other than `copyRedirectedCacheableResponsesPlugin`.
       *
       * - If this method is called and there are no suitable `cacheWillUpdate`
       * plugins, we need to add `defaultPrecacheCacheabilityPlugin`.
       *
       * - If this method is called and there is exactly one `cacheWillUpdate`, then
       * we don't have to do anything (this might be a previously added
       * `defaultPrecacheCacheabilityPlugin`, or it might be a custom plugin).
       *
       * - If this method is called and there is more than one `cacheWillUpdate`,
       * then we need to check if one is `defaultPrecacheCacheabilityPlugin`. If so,
       * we need to remove it. (This situation is unlikely, but it could happen if
       * the strategy is used multiple times, the first without a `cacheWillUpdate`,
       * and then later on after manually adding a custom `cacheWillUpdate`.)
       *
       * See https://github.com/GoogleChrome/workbox/issues/2737 for more context.
       *
       * @private
       */
      _useDefaultCacheabilityPluginIfNeeded() {
        let defaultPluginIndex = null;
        let cacheWillUpdatePluginCount = 0;
        for (const [index, plugin] of this.plugins.entries()) {
          // Ignore the copy redirected plugin when determining what to do.
          if (plugin === PrecacheStrategy.copyRedirectedCacheableResponsesPlugin) {
            continue;
          }
          // Save the default plugin's index, in case it needs to be removed.
          if (plugin === PrecacheStrategy.defaultPrecacheCacheabilityPlugin) {
            defaultPluginIndex = index;
          }
          if (plugin.cacheWillUpdate) {
            cacheWillUpdatePluginCount++;
          }
        }
        if (cacheWillUpdatePluginCount === 0) {
          this.plugins.push(PrecacheStrategy.defaultPrecacheCacheabilityPlugin);
        } else if (cacheWillUpdatePluginCount > 1 && defaultPluginIndex !== null) {
          // Only remove the default plugin; multiple custom plugins are allowed.
          this.plugins.splice(defaultPluginIndex, 1);
        }
        // Nothing needs to be done if cacheWillUpdatePluginCount is 1
      }
    }
    PrecacheStrategy.defaultPrecacheCacheabilityPlugin = {
      async cacheWillUpdate({
        response
      }) {
        if (!response || response.status >= 400) {
          return null;
        }
        return response;
      }
    };
    PrecacheStrategy.copyRedirectedCacheableResponsesPlugin = {
      async cacheWillUpdate({
        response
      }) {
        return response.redirected ? await copyResponse(response) : response;
      }
    };

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Performs efficient precaching of assets.
     *
     * @memberof workbox-precaching
     */
    class PrecacheController {
      /**
       * Create a new PrecacheController.
       *
       * @param {Object} [options]
       * @param {string} [options.cacheName] The cache to use for precaching.
       * @param {string} [options.plugins] Plugins to use when precaching as well
       * as responding to fetch events for precached assets.
       * @param {boolean} [options.fallbackToNetwork=true] Whether to attempt to
       * get the response from the network if there's a precache miss.
       */
      constructor({
        cacheName,
        plugins = [],
        fallbackToNetwork = true
      } = {}) {
        this._urlsToCacheKeys = new Map();
        this._urlsToCacheModes = new Map();
        this._cacheKeysToIntegrities = new Map();
        this._strategy = new PrecacheStrategy({
          cacheName: cacheNames.getPrecacheName(cacheName),
          plugins: [...plugins, new PrecacheCacheKeyPlugin({
            precacheController: this
          })],
          fallbackToNetwork
        });
        // Bind the install and activate methods to the instance.
        this.install = this.install.bind(this);
        this.activate = this.activate.bind(this);
      }
      /**
       * @type {workbox-precaching.PrecacheStrategy} The strategy created by this controller and
       * used to cache assets and respond to fetch events.
       */
      get strategy() {
        return this._strategy;
      }
      /**
       * Adds items to the precache list, removing any duplicates and
       * stores the files in the
       * {@link workbox-core.cacheNames|"precache cache"} when the service
       * worker installs.
       *
       * This method can be called multiple times.
       *
       * @param {Array<Object|string>} [entries=[]] Array of entries to precache.
       */
      precache(entries) {
        this.addToCacheList(entries);
        if (!this._installAndActiveListenersAdded) {
          self.addEventListener('install', this.install);
          self.addEventListener('activate', this.activate);
          this._installAndActiveListenersAdded = true;
        }
      }
      /**
       * This method will add items to the precache list, removing duplicates
       * and ensuring the information is valid.
       *
       * @param {Array<workbox-precaching.PrecacheController.PrecacheEntry|string>} entries
       *     Array of entries to precache.
       */
      addToCacheList(entries) {
        {
          finalAssertExports.isArray(entries, {
            moduleName: 'workbox-precaching',
            className: 'PrecacheController',
            funcName: 'addToCacheList',
            paramName: 'entries'
          });
        }
        const urlsToWarnAbout = [];
        for (const entry of entries) {
          // See https://github.com/GoogleChrome/workbox/issues/2259
          if (typeof entry === 'string') {
            urlsToWarnAbout.push(entry);
          } else if (entry && entry.revision === undefined) {
            urlsToWarnAbout.push(entry.url);
          }
          const {
            cacheKey,
            url
          } = createCacheKey(entry);
          const cacheMode = typeof entry !== 'string' && entry.revision ? 'reload' : 'default';
          if (this._urlsToCacheKeys.has(url) && this._urlsToCacheKeys.get(url) !== cacheKey) {
            throw new WorkboxError('add-to-cache-list-conflicting-entries', {
              firstEntry: this._urlsToCacheKeys.get(url),
              secondEntry: cacheKey
            });
          }
          if (typeof entry !== 'string' && entry.integrity) {
            if (this._cacheKeysToIntegrities.has(cacheKey) && this._cacheKeysToIntegrities.get(cacheKey) !== entry.integrity) {
              throw new WorkboxError('add-to-cache-list-conflicting-integrities', {
                url
              });
            }
            this._cacheKeysToIntegrities.set(cacheKey, entry.integrity);
          }
          this._urlsToCacheKeys.set(url, cacheKey);
          this._urlsToCacheModes.set(url, cacheMode);
          if (urlsToWarnAbout.length > 0) {
            const warningMessage = `Workbox is precaching URLs without revision ` + `info: ${urlsToWarnAbout.join(', ')}\nThis is generally NOT safe. ` + `Learn more at https://bit.ly/wb-precache`;
            {
              logger.warn(warningMessage);
            }
          }
        }
      }
      /**
       * Precaches new and updated assets. Call this method from the service worker
       * install event.
       *
       * Note: this method calls `event.waitUntil()` for you, so you do not need
       * to call it yourself in your event handlers.
       *
       * @param {ExtendableEvent} event
       * @return {Promise<workbox-precaching.InstallResult>}
       */
      install(event) {
        // waitUntil returns Promise<any>
        // eslint-disable-next-line @typescript-eslint/no-unsafe-return
        return waitUntil(event, async () => {
          const installReportPlugin = new PrecacheInstallReportPlugin();
          this.strategy.plugins.push(installReportPlugin);
          // Cache entries one at a time.
          // See https://github.com/GoogleChrome/workbox/issues/2528
          for (const [url, cacheKey] of this._urlsToCacheKeys) {
            const integrity = this._cacheKeysToIntegrities.get(cacheKey);
            const cacheMode = this._urlsToCacheModes.get(url);
            const request = new Request(url, {
              integrity,
              cache: cacheMode,
              credentials: 'same-origin'
            });
            await Promise.all(this.strategy.handleAll({
              params: {
                cacheKey
              },
              request,
              event
            }));
          }
          const {
            updatedURLs,
            notUpdatedURLs
          } = installReportPlugin;
          {
            printInstallDetails(updatedURLs, notUpdatedURLs);
          }
          return {
            updatedURLs,
            notUpdatedURLs
          };
        });
      }
      /**
       * Deletes assets that are no longer present in the current precache manifest.
       * Call this method from the service worker activate event.
       *
       * Note: this method calls `event.waitUntil()` for you, so you do not need
       * to call it yourself in your event handlers.
       *
       * @param {ExtendableEvent} event
       * @return {Promise<workbox-precaching.CleanupResult>}
       */
      activate(event) {
        // waitUntil returns Promise<any>
        // eslint-disable-next-line @typescript-eslint/no-unsafe-return
        return waitUntil(event, async () => {
          const cache = await self.caches.open(this.strategy.cacheName);
          const currentlyCachedRequests = await cache.keys();
          const expectedCacheKeys = new Set(this._urlsToCacheKeys.values());
          const deletedURLs = [];
          for (const request of currentlyCachedRequests) {
            if (!expectedCacheKeys.has(request.url)) {
              await cache.delete(request);
              deletedURLs.push(request.url);
            }
          }
          {
            printCleanupDetails(deletedURLs);
          }
          return {
            deletedURLs
          };
        });
      }
      /**
       * Returns a mapping of a precached URL to the corresponding cache key, taking
       * into account the revision information for the URL.
       *
       * @return {Map<string, string>} A URL to cache key mapping.
       */
      getURLsToCacheKeys() {
        return this._urlsToCacheKeys;
      }
      /**
       * Returns a list of all the URLs that have been precached by the current
       * service worker.
       *
       * @return {Array<string>} The precached URLs.
       */
      getCachedURLs() {
        return [...this._urlsToCacheKeys.keys()];
      }
      /**
       * Returns the cache key used for storing a given URL. If that URL is
       * unversioned, like `/index.html', then the cache key will be the original
       * URL with a search parameter appended to it.
       *
       * @param {string} url A URL whose cache key you want to look up.
       * @return {string} The versioned URL that corresponds to a cache key
       * for the original URL, or undefined if that URL isn't precached.
       */
      getCacheKeyForURL(url) {
        const urlObject = new URL(url, location.href);
        return this._urlsToCacheKeys.get(urlObject.href);
      }
      /**
       * @param {string} url A cache key whose SRI you want to look up.
       * @return {string} The subresource integrity associated with the cache key,
       * or undefined if it's not set.
       */
      getIntegrityForCacheKey(cacheKey) {
        return this._cacheKeysToIntegrities.get(cacheKey);
      }
      /**
       * This acts as a drop-in replacement for
       * [`cache.match()`](https://developer.mozilla.org/en-US/docs/Web/API/Cache/match)
       * with the following differences:
       *
       * - It knows what the name of the precache is, and only checks in that cache.
       * - It allows you to pass in an "original" URL without versioning parameters,
       * and it will automatically look up the correct cache key for the currently
       * active revision of that URL.
       *
       * E.g., `matchPrecache('index.html')` will find the correct precached
       * response for the currently active service worker, even if the actual cache
       * key is `'/index.html?__WB_REVISION__=1234abcd'`.
       *
       * @param {string|Request} request The key (without revisioning parameters)
       * to look up in the precache.
       * @return {Promise<Response|undefined>}
       */
      async matchPrecache(request) {
        const url = request instanceof Request ? request.url : request;
        const cacheKey = this.getCacheKeyForURL(url);
        if (cacheKey) {
          const cache = await self.caches.open(this.strategy.cacheName);
          return cache.match(cacheKey);
        }
        return undefined;
      }
      /**
       * Returns a function that looks up `url` in the precache (taking into
       * account revision information), and returns the corresponding `Response`.
       *
       * @param {string} url The precached URL which will be used to lookup the
       * `Response`.
       * @return {workbox-routing~handlerCallback}
       */
      createHandlerBoundToURL(url) {
        const cacheKey = this.getCacheKeyForURL(url);
        if (!cacheKey) {
          throw new WorkboxError('non-precached-url', {
            url
          });
        }
        return options => {
          options.request = new Request(url);
          options.params = Object.assign({
            cacheKey
          }, options.params);
          return this.strategy.handle(options);
        };
      }
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    let precacheController;
    /**
     * @return {PrecacheController}
     * @private
     */
    const getOrCreatePrecacheController = () => {
      if (!precacheController) {
        precacheController = new PrecacheController();
      }
      return precacheController;
    };

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Removes any URL search parameters that should be ignored.
     *
     * @param {URL} urlObject The original URL.
     * @param {Array<RegExp>} ignoreURLParametersMatching RegExps to test against
     * each search parameter name. Matches mean that the search parameter should be
     * ignored.
     * @return {URL} The URL with any ignored search parameters removed.
     *
     * @private
     * @memberof workbox-precaching
     */
    function removeIgnoredSearchParams(urlObject, ignoreURLParametersMatching = []) {
      // Convert the iterable into an array at the start of the loop to make sure
      // deletion doesn't mess up iteration.
      for (const paramName of [...urlObject.searchParams.keys()]) {
        if (ignoreURLParametersMatching.some(regExp => regExp.test(paramName))) {
          urlObject.searchParams.delete(paramName);
        }
      }
      return urlObject;
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Generator function that yields possible variations on the original URL to
     * check, one at a time.
     *
     * @param {string} url
     * @param {Object} options
     *
     * @private
     * @memberof workbox-precaching
     */
    function* generateURLVariations(url, {
      ignoreURLParametersMatching = [/^utm_/, /^fbclid$/],
      directoryIndex = 'index.html',
      cleanURLs = true,
      urlManipulation
    } = {}) {
      const urlObject = new URL(url, location.href);
      urlObject.hash = '';
      yield urlObject.href;
      const urlWithoutIgnoredParams = removeIgnoredSearchParams(urlObject, ignoreURLParametersMatching);
      yield urlWithoutIgnoredParams.href;
      if (directoryIndex && urlWithoutIgnoredParams.pathname.endsWith('/')) {
        const directoryURL = new URL(urlWithoutIgnoredParams.href);
        directoryURL.pathname += directoryIndex;
        yield directoryURL.href;
      }
      if (cleanURLs) {
        const cleanURL = new URL(urlWithoutIgnoredParams.href);
        cleanURL.pathname += '.html';
        yield cleanURL.href;
      }
      if (urlManipulation) {
        const additionalURLs = urlManipulation({
          url: urlObject
        });
        for (const urlToAttempt of additionalURLs) {
          yield urlToAttempt.href;
        }
      }
    }

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A subclass of {@link workbox-routing.Route} that takes a
     * {@link workbox-precaching.PrecacheController}
     * instance and uses it to match incoming requests and handle fetching
     * responses from the precache.
     *
     * @memberof workbox-precaching
     * @extends workbox-routing.Route
     */
    class PrecacheRoute extends Route {
      /**
       * @param {PrecacheController} precacheController A `PrecacheController`
       * instance used to both match requests and respond to fetch events.
       * @param {Object} [options] Options to control how requests are matched
       * against the list of precached URLs.
       * @param {string} [options.directoryIndex=index.html] The `directoryIndex` will
       * check cache entries for a URLs ending with '/' to see if there is a hit when
       * appending the `directoryIndex` value.
       * @param {Array<RegExp>} [options.ignoreURLParametersMatching=[/^utm_/, /^fbclid$/]] An
       * array of regex's to remove search params when looking for a cache match.
       * @param {boolean} [options.cleanURLs=true] The `cleanURLs` option will
       * check the cache for the URL with a `.html` added to the end of the end.
       * @param {workbox-precaching~urlManipulation} [options.urlManipulation]
       * This is a function that should take a URL and return an array of
       * alternative URLs that should be checked for precache matches.
       */
      constructor(precacheController, options) {
        const match = ({
          request
        }) => {
          const urlsToCacheKeys = precacheController.getURLsToCacheKeys();
          for (const possibleURL of generateURLVariations(request.url, options)) {
            const cacheKey = urlsToCacheKeys.get(possibleURL);
            if (cacheKey) {
              const integrity = precacheController.getIntegrityForCacheKey(cacheKey);
              return {
                cacheKey,
                integrity
              };
            }
          }
          {
            logger.debug(`Precaching did not find a match for ` + getFriendlyURL(request.url));
          }
          return;
        };
        super(match, precacheController.strategy);
      }
    }

    /*
      Copyright 2019 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Add a `fetch` listener to the service worker that will
     * respond to
     * [network requests]{@link https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers#Custom_responses_to_requests}
     * with precached assets.
     *
     * Requests for assets that aren't precached, the `FetchEvent` will not be
     * responded to, allowing the event to fall through to other `fetch` event
     * listeners.
     *
     * @param {Object} [options] See the {@link workbox-precaching.PrecacheRoute}
     * options.
     *
     * @memberof workbox-precaching
     */
    function addRoute(options) {
      const precacheController = getOrCreatePrecacheController();
      const precacheRoute = new PrecacheRoute(precacheController, options);
      registerRoute(precacheRoute);
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Adds items to the precache list, removing any duplicates and
     * stores the files in the
     * {@link workbox-core.cacheNames|"precache cache"} when the service
     * worker installs.
     *
     * This method can be called multiple times.
     *
     * Please note: This method **will not** serve any of the cached files for you.
     * It only precaches files. To respond to a network request you call
     * {@link workbox-precaching.addRoute}.
     *
     * If you have a single array of files to precache, you can just call
     * {@link workbox-precaching.precacheAndRoute}.
     *
     * @param {Array<Object|string>} [entries=[]] Array of entries to precache.
     *
     * @memberof workbox-precaching
     */
    function precache(entries) {
      const precacheController = getOrCreatePrecacheController();
      precacheController.precache(entries);
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * This method will add entries to the precache list and add a route to
     * respond to fetch events.
     *
     * This is a convenience method that will call
     * {@link workbox-precaching.precache} and
     * {@link workbox-precaching.addRoute} in a single call.
     *
     * @param {Array<Object|string>} entries Array of entries to precache.
     * @param {Object} [options] See the
     * {@link workbox-precaching.PrecacheRoute} options.
     *
     * @memberof workbox-precaching
     */
    function precacheAndRoute(entries, options) {
      precache(entries);
      addRoute(options);
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const SUBSTRING_TO_FIND = '-precache-';
    /**
     * Cleans up incompatible precaches that were created by older versions of
     * Workbox, by a service worker registered under the current scope.
     *
     * This is meant to be called as part of the `activate` event.
     *
     * This should be safe to use as long as you don't include `substringToFind`
     * (defaulting to `-precache-`) in your non-precache cache names.
     *
     * @param {string} currentPrecacheName The cache name currently in use for
     * precaching. This cache won't be deleted.
     * @param {string} [substringToFind='-precache-'] Cache names which include this
     * substring will be deleted (excluding `currentPrecacheName`).
     * @return {Array<string>} A list of all the cache names that were deleted.
     *
     * @private
     * @memberof workbox-precaching
     */
    const deleteOutdatedCaches = async (currentPrecacheName, substringToFind = SUBSTRING_TO_FIND) => {
      const cacheNames = await self.caches.keys();
      const cacheNamesToDelete = cacheNames.filter(cacheName => {
        return cacheName.includes(substringToFind) && cacheName.includes(self.registration.scope) && cacheName !== currentPrecacheName;
      });
      await Promise.all(cacheNamesToDelete.map(cacheName => self.caches.delete(cacheName)));
      return cacheNamesToDelete;
    };

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Adds an `activate` event listener which will clean up incompatible
     * precaches that were created by older versions of Workbox.
     *
     * @memberof workbox-precaching
     */
    function cleanupOutdatedCaches() {
      // See https://github.com/Microsoft/TypeScript/issues/28357#issuecomment-436484705
      self.addEventListener('activate', event => {
        const cacheName = cacheNames.getPrecacheName();
        event.waitUntil(deleteOutdatedCaches(cacheName).then(cachesDeleted => {
          {
            if (cachesDeleted.length > 0) {
              logger.log(`The following out-of-date precaches were cleaned up ` + `automatically:`, cachesDeleted);
            }
          }
        }));
      });
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * NavigationRoute makes it easy to create a
     * {@link workbox-routing.Route} that matches for browser
     * [navigation requests]{@link https://developers.google.com/web/fundamentals/primers/service-workers/high-performance-loading#first_what_are_navigation_requests}.
     *
     * It will only match incoming Requests whose
     * {@link https://fetch.spec.whatwg.org/#concept-request-mode|mode}
     * is set to `navigate`.
     *
     * You can optionally only apply this route to a subset of navigation requests
     * by using one or both of the `denylist` and `allowlist` parameters.
     *
     * @memberof workbox-routing
     * @extends workbox-routing.Route
     */
    class NavigationRoute extends Route {
      /**
       * If both `denylist` and `allowlist` are provided, the `denylist` will
       * take precedence and the request will not match this route.
       *
       * The regular expressions in `allowlist` and `denylist`
       * are matched against the concatenated
       * [`pathname`]{@link https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/pathname}
       * and [`search`]{@link https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/search}
       * portions of the requested URL.
       *
       * *Note*: These RegExps may be evaluated against every destination URL during
       * a navigation. Avoid using
       * [complex RegExps](https://github.com/GoogleChrome/workbox/issues/3077),
       * or else your users may see delays when navigating your site.
       *
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resulting in a Response.
       * @param {Object} options
       * @param {Array<RegExp>} [options.denylist] If any of these patterns match,
       * the route will not handle the request (even if a allowlist RegExp matches).
       * @param {Array<RegExp>} [options.allowlist=[/./]] If any of these patterns
       * match the URL's pathname and search parameter, the route will handle the
       * request (assuming the denylist doesn't match).
       */
      constructor(handler, {
        allowlist = [/./],
        denylist = []
      } = {}) {
        {
          finalAssertExports.isArrayOfClass(allowlist, RegExp, {
            moduleName: 'workbox-routing',
            className: 'NavigationRoute',
            funcName: 'constructor',
            paramName: 'options.allowlist'
          });
          finalAssertExports.isArrayOfClass(denylist, RegExp, {
            moduleName: 'workbox-routing',
            className: 'NavigationRoute',
            funcName: 'constructor',
            paramName: 'options.denylist'
          });
        }
        super(options => this._match(options), handler);
        this._allowlist = allowlist;
        this._denylist = denylist;
      }
      /**
       * Routes match handler.
       *
       * @param {Object} options
       * @param {URL} options.url
       * @param {Request} options.request
       * @return {boolean}
       *
       * @private
       */
      _match({
        url,
        request
      }) {
        if (request && request.mode !== 'navigate') {
          return false;
        }
        const pathnameAndSearch = url.pathname + url.search;
        for (const regExp of this._denylist) {
          if (regExp.test(pathnameAndSearch)) {
            {
              logger.log(`The navigation route ${pathnameAndSearch} is not ` + `being used, since the URL matches this denylist pattern: ` + `${regExp.toString()}`);
            }
            return false;
          }
        }
        if (this._allowlist.some(regExp => regExp.test(pathnameAndSearch))) {
          {
            logger.debug(`The navigation route ${pathnameAndSearch} ` + `is being used.`);
          }
          return true;
        }
        {
          logger.log(`The navigation route ${pathnameAndSearch} is not ` + `being used, since the URL being navigated to doesn't ` + `match the allowlist.`);
        }
        return false;
      }
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Helper function that calls
     * {@link PrecacheController#createHandlerBoundToURL} on the default
     * {@link PrecacheController} instance.
     *
     * If you are creating your own {@link PrecacheController}, then call the
     * {@link PrecacheController#createHandlerBoundToURL} on that instance,
     * instead of using this function.
     *
     * @param {string} url The precached URL which will be used to lookup the
     * `Response`.
     * @param {boolean} [fallbackToNetwork=true] Whether to attempt to get the
     * response from the network if there's a precache miss.
     * @return {workbox-routing~handlerCallback}
     *
     * @memberof workbox-precaching
     */
    function createHandlerBoundToURL(url) {
      const precacheController = getOrCreatePrecacheController();
      return precacheController.createHandlerBoundToURL(url);
    }

    exports.NavigationRoute = NavigationRoute;
    exports.cleanupOutdatedCaches = cleanupOutdatedCaches;
    exports.clientsClaim = clientsClaim;
    exports.createHandlerBoundToURL = createHandlerBoundToURL;
    exports.precacheAndRoute = precacheAndRoute;
    exports.registerRoute = registerRoute;

}));


--------------------------------------------------
ðŸ“ PATH: metadata.json
--------------------------------------------------
{
  "name": "Copy of MediScribe AI",
  "description": "Asistente mÃ©dico inteligente que automatiza la creaciÃ³n de expedientes y la comunicaciÃ³n con pacientes vÃ­a WhatsApp.",
  "requestFramePermissions": [
    "microphone"
  ]
}

--------------------------------------------------
ðŸ“ PATH: package.json
--------------------------------------------------
{
  "name": "copy-of-mediscribe-ai",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.30.0",
    "@google/generative-ai": "^0.21.0",
    "@react-pdf/renderer": "^4.3.1",
    "@supabase/supabase-js": "^2.84.0",
    "@types/react-big-calendar": "^1.16.3",
    "browser-image-compression": "^2.0.2",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.554.0",
    "react": "^19.2.0",
    "react-big-calendar": "^1.19.4",
    "react-dom": "^19.2.0",
    "react-markdown": "^10.1.0",
    "react-qr-code": "^2.0.18",
    "react-router-dom": "^7.9.6",
    "sonner": "^2.0.7"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "autoprefixer": "^10.4.18",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "~5.8.2",
    "vite": "^6.2.0",
    "vite-plugin-pwa": "^1.1.0"
  }
}


--------------------------------------------------
ðŸ“ PATH: postcss.config.js
--------------------------------------------------
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

--------------------------------------------------
ðŸ“ PATH: RESTORE_GUIDE.md
--------------------------------------------------
GuÃ­a de RestauraciÃ³n - Proyecto MediScribe (v3.2)Este documento detalla cÃ³mo generar puntos de restauraciÃ³n y cÃ³mo recuperar el proyecto en caso de error crÃ­tico.1. CÃ³mo crear un Punto de RestauraciÃ³n (Backup)Cada vez que alcances un hito estable, ejecuta el script de respaldo.Desde la Terminal de Visual Studio Code:AsegÃºrate de estar en la raÃ­z del proyecto.Ejecuta el comando:.\scripts\create_restore_point.ps1
(Si PowerShell bloquea el script, ejecuta primero: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass)Resultado:Se crearÃ¡ un Git Tag (ej. restore-point-v3.2-20231126-1200).Se crearÃ¡ un archivo .zip en la carpeta /backups.2. MÃ©todo de RestauraciÃ³n (En caso de emergencia)Si una nueva funcionalidad rompe el proyecto, tienes dos formas de volver atrÃ¡s.OpciÃ³n A: RestauraciÃ³n vÃ­a Git (Recomendada)Este mÃ©todo revierte el cÃ³digo a un punto exacto en el tiempo sin perder el historial posterior (te mueve a un estado "detatched").Listar puntos disponibles:git tag
Restaurar al punto deseado:# Reemplaza con el nombre exacto del tag que quieres usar
git checkout restore-point-v3.2-YYYYMMDD-HHMM
Reinstalar dependencias limpias:npm ci
(Para volver al presente/Ãºltima versiÃ³n despuÃ©s de revisar, usa: git checkout main)OpciÃ³n B: RestauraciÃ³n FÃ­sica (Emergencia Total)Si Git estÃ¡ corrupto o prefieres empezar de cero desde el respaldo:Ve a la carpeta /backups.Descomprime el archivo restore-point-v3.2-....zip.Copia el contenido descomprimido y reemplaza los archivos en tu carpeta de proyecto.Ejecuta en la terminal:npm install
3. ProtecciÃ³n contra SobrescrituraLos puntos de restauraciÃ³n generados usan git tag. Las etiquetas en Git son inmutables por defecto; no se pueden "sobrescribir" con un simple commit, lo que protege este estado del cÃ³digo contra errores accidentales de ediciÃ³n.

--------------------------------------------------
ðŸ“ PATH: src\App.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { Session } from '@supabase/supabase-js'; 
import { supabase } from './lib/supabase';
import { Toaster } from 'sonner';
import { ThemeProvider } from './context/ThemeContext';
import { Moon, Sun, CloudSun } from 'lucide-react'; 

// Components & Pages
import Sidebar from './components/Sidebar';
import ConsultationView from './components/ConsultationView';
import DigitalCard from './components/DigitalCard';
import PatientsView from './components/PatientsView';
import SettingsView from './components/SettingsView';
import AuthView from './components/AuthView';
import Dashboard from './pages/Dashboard';
import ReportsView from './pages/ReportsView';
import AgendaView from './pages/AgendaView';
import PrivacyPolicy from './pages/PrivacyPolicy';
import ReloadPrompt from './components/ReloadPrompt';
import SplashScreen from './components/SplashScreen';
import MobileTabBar from './components/MobileTabBar';
import TermsOfService from './pages/TermsOfService';
import { TrialMonitor } from './components/TrialMonitor';
// PÃGINA NUEVA
import UpdatePassword from './pages/UpdatePassword';

interface MainLayoutProps {
  session: Session | null;
  onLogout: (name?: string) => Promise<void>;
}

const MainLayout: React.FC<MainLayoutProps> = ({ session, onLogout }) => {
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  
  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex flex-col font-sans text-slate-900 dark:text-slate-100 transition-colors duration-300 relative">
      <TrialMonitor />
      <div className="flex flex-1 overflow-hidden relative">
          <div className="hidden md:flex z-20 h-full">
            <Sidebar isOpen={true} onClose={() => {}} onLogout={onLogout} />
          </div>
          <div className="md:hidden">
              <Sidebar isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} onLogout={onLogout} />
          </div>
          <main className="flex-1 md:ml-64 transition-all duration-300 flex flex-col h-full bg-gray-50 dark:bg-slate-950 overflow-hidden">
            <div className="flex-1 overflow-y-auto pb-20 md:pb-0"> 
              <Routes>
                <Route path="/" element={<Dashboard />} />
                <Route path="/consultation" element={<ConsultationView />} />
                <Route path="/agenda" element={<AgendaView />} />
                <Route path="/calendar" element={<Navigate to="/agenda" replace />} />
                <Route path="/patients" element={<PatientsView />} />
                <Route path="/reports" element={<ReportsView />} />
                <Route path="/card" element={<DigitalCard />} />
                <Route path="/settings" element={<SettingsView />} />
                <Route path="/privacy" element={<PrivacyPolicy />} />
                <Route path="/terms" element={<TermsOfService />} />
                <Route path="*" element={<Navigate to="/" replace />} />
              </Routes>
            </div>
            <div className="md:hidden shrink-0">
              <MobileTabBar onMenuClick={() => setIsSidebarOpen(true)} />
            </div>
          </main>
      </div>
    </div>
  );
};

const App: React.FC = () => {
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);
  const [showSplash, setShowSplash] = useState(true);
  
  const [isClosing, setIsClosing] = useState(false);
  const [closingName, setClosingName] = useState('');

  // DETECCIÃ“N SÃNCRONA
  const isUpdatePasswordRoute = window.location.pathname === '/update-password';

  useEffect(() => {
    let mounted = true;
    const initSession = async () => {
        const { data: { session: initialSession } } = await supabase.auth.getSession();
        if (mounted) {
          setSession(initialSession);
          setLoading(false);
        }
    };
    initSession();

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, newSession) => {
      if (!mounted) return;
      setSession(newSession);
      setLoading(false);
    });

    const splashTimer = setTimeout(() => { if (mounted) setShowSplash(false); }, 2500);
    return () => { mounted = false; subscription.unsubscribe(); clearTimeout(splashTimer); };
  }, []);

  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour < 12) return { text: "Buenos dÃ­as", icon: <CloudSun className="text-yellow-400" size={48}/> };
    if (hour < 19) return { text: "Buenas tardes", icon: <Sun className="text-orange-500" size={48}/> };
    return { text: "Buenas noches", icon: <Moon className="text-indigo-400" size={48}/> };
  };

  const handleGlobalLogout = async (name?: string) => {
    setClosingName(name || 'Doctor(a)');
    setIsClosing(true);
    await new Promise(resolve => setTimeout(resolve, 2000));
    await supabase.auth.signOut();
    setIsClosing(false);
  };

  if (showSplash) return <ThemeProvider><SplashScreen /></ThemeProvider>;

  if (isClosing) {
      const greeting = getGreeting();
      return (
        <ThemeProvider>
            <div className="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center z-50 animate-fade-in px-4 text-center">
                <div className="p-8 bg-slate-800/50 backdrop-blur-md rounded-3xl shadow-2xl flex flex-col items-center border border-slate-700 max-w-sm w-full">
                    <div className="mb-6 animate-bounce-slow">{greeting.icon}</div>
                    <h2 className="text-2xl font-bold text-white mb-1">{greeting.text},</h2>
                    <h3 className="text-xl font-medium text-brand-teal mb-6 truncate w-full">{closingName}</h3>
                    <div className="flex items-center gap-3 text-slate-400 text-sm bg-slate-900/50 px-4 py-2 rounded-full border border-slate-700/50">
                        <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span>Cerrando sistema de forma segura...</span>
                    </div>
                </div>
            </div>
        </ThemeProvider>
      );
  }

  // --- LÃ“GICA DE RENDERIZADO MAESTRA ---
  
  // 1. RUTA DE RECUPERACIÃ“N (Prioridad Absoluta)
  // Renderiza la pÃ¡gina UpdatePassword que usa AuthView con tu diseÃ±o bonito.
  if (isUpdatePasswordRoute) {
      return (
        <ThemeProvider>
            <Toaster position="top-center" richColors />
            <UpdatePassword onSuccess={() => window.location.href = '/'} />
        </ThemeProvider>
      );
  }

  // 2. NO LOGUEADO -> PANTALLA DE ACCESO (Tu AuthView con diseÃ±o)
  if (!session) {
    return (
      <ThemeProvider>
        <Toaster position="top-center" richColors />
        <ReloadPrompt />
        <AuthView onLoginSuccess={() => {}} />
      </ThemeProvider>
    );
  }

  // 3. LOGUEADO Y RUTA NORMAL -> APP
  return (
    <ThemeProvider>
      <BrowserRouter>
        <Toaster position="top-center" richColors closeButton />
        <ReloadPrompt />
        <MainLayout session={session} onLogout={handleGlobalLogout} />
      </BrowserRouter>
    </ThemeProvider>
  );
};

export default App;

--------------------------------------------------
ðŸ“ PATH: src\components\AuthView.tsx
--------------------------------------------------
/*
Â  ðŸ›‘ ðŸ›‘ ðŸ›‘ ZONA BLINDADA - NO TOCAR ðŸ›‘ ðŸ›‘ ðŸ›‘
Â  
Â  Este componente maneja el Registro CrÃ­tico de MÃ©dicos.
Â  Estado: FUNCIONANDO (Validado el 03/12/2025).
Â  
Â  ADVERTENCIA:
Â  - No cambiar la lÃ³gica de 'handleAuth' sin hacer un backup completo antes.
Â  - El registro depende del Trigger 'handle_new_user_automatizado' en Supabase.
Â  - Si cambias los nombres de los campos en 'options.data', romperÃ¡s el Trigger.
*/

import React, { useState, useEffect } from 'react';
import { 
Â  Mail, Lock, User, Stethoscope, ArrowRight, AlertTriangle, 
Â  KeyRound, ArrowLeft, CheckCircle2, BookOpen,
Â  Eye, EyeOff, FileBadge, Loader2
} from 'lucide-react';
import { supabase } from '../lib/supabase';
import { toast } from 'sonner';

// LISTA MAESTRA DE ESPECIALIDADES
const SPECIALTIES = [
Â  "Medicina General", "CardiologÃ­a", "CirugÃ­a General", "CirugÃ­a de Columna", "CirugÃ­a de Mano", 
Â  "CirugÃ­a OncolÃ³gica", "CirugÃ­a PediÃ¡trica", "CirugÃ­a PlÃ¡stica y Reconstructiva", "DermatologÃ­a", 
Â  "EndocrinologÃ­a", "GastroenterologÃ­a", "GeriatrÃ­a", "GinecologÃ­a y Obstetricia", "Medicina del Deporte", 
Â  "Medicina Interna", "NefrologÃ­a", "NeumologÃ­a", "NeurocirugÃ­a", "NeurologÃ­a", "OftalmologÃ­a", 
Â  "OtorrinolaringologÃ­a", "PediatrÃ­a", "PsiquiatrÃ­a", "ReumatologÃ­a", "TraumatologÃ­a y Ortopedia", 
Â  "TraumatologÃ­a: Artroscopia", "UrologÃ­a", "Urgencias MÃ©dicas"
];

interface AuthProps {
Â  authService?: any;
Â  onLoginSuccess?: () => void;
Â  forceResetMode?: boolean;
Â  onPasswordResetSuccess?: () => void;
}

const AuthView: React.FC<AuthProps> = ({ 
Â  onLoginSuccess, 
Â  forceResetMode = false, 
Â  onPasswordResetSuccess 
}) => {
Â  const [isRegistering, setIsRegistering] = useState(false);
Â  const [isRecovering, setIsRecovering] = useState(false);
Â  const [isResettingPassword, setIsResettingPassword] = useState(forceResetMode);
Â  
Â  const [loading, setLoading] = useState(false);
Â  const [showPassword, setShowPassword] = useState(false);
Â  const [verificationSent, setVerificationSent] = useState(false);
Â  const [recoverySent, setRecoverySent] = useState(false);

Â  const [formData, setFormData] = useState({
Â  Â  email: '',
Â  Â  password: '',
Â  Â  newPassword: '',
Â  Â  fullName: '',
Â  Â  specialty: 'Medicina General',
Â  Â  cedula: '', 
Â  Â  termsAccepted: false 
Â  });

Â  useEffect(() => {
Â  Â  if (forceResetMode) {
Â  Â  Â  setIsResettingPassword(true);
Â  Â  Â  setIsRecovering(false);
Â  Â  Â  setIsRegistering(false);
Â  Â  }
Â  }, [forceResetMode]);

Â  const validatePasswordStrength = (pass: string): string | null => {
Â  Â  if (pass.length < 8) return "La contraseÃ±a debe tener al menos 8 caracteres.";
Â  Â  if (!/[A-Z]/.test(pass)) return "La contraseÃ±a debe incluir al menos una MayÃºscula.";
Â  Â  if (!/[0-9]/.test(pass)) return "La contraseÃ±a debe incluir al menos un NÃºmero.";
Â  Â  if (!/[!@#$%^&*(),.?":{}|<>]/.test(pass)) return "La contraseÃ±a debe incluir un SÃ­mbolo (!@#$%).";
Â  Â  return null;
Â  };

Â  const handleAuth = async (e: React.FormEvent) => {
Â  Â  e.preventDefault();
Â  Â  setLoading(true);

Â  Â  try {
Â  Â  Â  if (isRegistering) {
Â  Â  Â  Â  // --- REGISTRO SIMPLIFICADO Y CORREGIDO ---
Â  Â  Â  Â  
Â  Â  Â  Â  // 1. Validaciones
Â  Â  Â  Â  const cedulaLimpia = formData.cedula.trim();
Â  Â  Â  Â  if (!/^\d+$/.test(cedulaLimpia) || cedulaLimpia.length < 7 || cedulaLimpia.length > 8) {
Â  Â  Â  Â  Â  Â  Â toast.error("CÃ©dula invÃ¡lida. Debe tener 7 u 8 dÃ­gitos numÃ©ricos.");
Â  Â  Â  Â  Â  Â  Â setLoading(false); return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const passError = validatePasswordStrength(formData.password);
Â  Â  Â  Â  if (passError) { toast.error(passError); setLoading(false); return; }

Â  Â  Â  Â  if (!formData.termsAccepted) {
Â  Â  Â  Â  Â  Â  toast.error("Debe aceptar los tÃ©rminos para continuar.");
Â  Â  Â  Â  Â  Â  setLoading(false); return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. CREAR CUENTA 
Â  Â  Â  Â  // Nota: Ya NO intentamos guardar en 'profiles' manualmente aquÃ­.
Â  Â  Â  Â  // El Trigger 'handle_new_user_automatizado' en la base de datos lo harÃ¡ por nosotros
Â  Â  Â  Â  // usando los metadatos que enviamos aquÃ­ abajo (data: { ... }).
Â  Â  Â  Â  const { error } = await supabase.auth.signUp({
Â  Â  Â  Â  Â  email: formData.email,
Â  Â  Â  Â  Â  password: formData.password,
Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  emailRedirectTo: window.location.origin, 
Â  Â  Â  Â  Â  Â  data: { 
Â  Â  Â  Â  Â  Â  Â  Â  full_name: formData.fullName, 
Â  Â  Â  Â  Â  Â  Â  Â  specialty: formData.specialty, 
Â  Â  Â  Â  Â  Â  Â  Â  cedula: cedulaLimpia 
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  });

Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  
Â  Â  Â  Â  setVerificationSent(true);
Â  Â  Â  Â  toast.success("Cuenta creada exitosamente. Revise su correo.");

Â  Â  Â  } else {
Â  Â  Â  Â  // --- INICIO DE SESIÃ“N (Sin Cambios) ---
Â  Â  Â  Â  const { error } = await supabase.auth.signInWithPassword({
Â  Â  Â  Â  Â  Â  email: formData.email,
Â  Â  Â  Â  Â  Â  password: formData.password,
Â  Â  Â  Â  });
Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  if (onLoginSuccess && !isResettingPassword) onLoginSuccess();
Â  Â  Â  }
Â  Â  } catch (error: any) {
Â  Â  Â  console.error(error);
Â  Â  Â  let msg = error.message;
Â  Â  Â  if (msg === "Invalid login credentials") msg = "Correo o contraseÃ±a incorrectos";
Â  Â  Â  if (msg.includes("User already registered")) msg = "Este correo ya estÃ¡ registrado. Intente iniciar sesiÃ³n.";
Â  Â  Â  toast.error(msg);
Â  Â  } finally {
Â  Â  Â  setLoading(false);
Â  Â  }
Â  };

Â  const handleRecoveryRequest = async (e: React.FormEvent) => {
Â  Â  e.preventDefault();
Â  Â  setLoading(true);
Â  Â  try {
Â  Â  Â  const redirectUrl = `${window.location.origin}/update-password`;
Â  Â  Â  const { error } = await supabase.auth.resetPasswordForEmail(formData.email, {
Â  Â  Â  Â  redirectTo: redirectUrl, 
Â  Â  Â  });
Â  Â  Â  if (error) throw error;
Â  Â  Â  setRecoverySent(true);
Â  Â  Â  toast.success("Correo de recuperaciÃ³n enviado.");
Â  Â  } catch (error: any) {
Â  Â  Â  toast.error(error.message);
Â  Â  } finally {
Â  Â  Â  setLoading(false);
Â  Â  }
Â  };

Â  const handlePasswordUpdate = async (e: React.FormEvent) => {
Â  Â  e.preventDefault();
Â  Â  const passError = validatePasswordStrength(formData.newPassword);
Â  Â  if (passError) return toast.error(passError);
Â  Â  setLoading(true);
Â  Â  try {
Â  Â  Â  const { error } = await supabase.auth.updateUser({ password: formData.newPassword });
Â  Â  Â  if (error) throw error;
Â  Â  Â  toast.success("ContraseÃ±a actualizada exitosamente.");
Â  Â  Â  if (onPasswordResetSuccess) onPasswordResetSuccess();
Â  Â  Â  else if (onLoginSuccess) onLoginSuccess();
Â  Â  } catch (error: any) {
Â  Â  Â  toast.error("Error al actualizar: " + error.message);
Â  Â  } finally {
Â  Â  Â  setLoading(false);
Â  Â  }
Â  };

Â  // --- RENDERIZADO (Sin cambios visuales) ---
Â  if (verificationSent) {
Â  Â  return (
Â  Â  Â  <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4 animate-fade-in-up">
Â  Â  Â  Â  <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center border border-slate-100">
Â  Â  Â  Â  Â  <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6"><Mail size={40} /></div>
Â  Â  Â  Â  Â  <h2 className="text-2xl font-bold text-slate-800 mb-2">Â¡Casi listo!</h2>
Â  Â  Â  Â  Â  <p className="text-slate-600 mb-6">Hemos enviado confirmaciÃ³n a: <span className="font-bold text-brand-teal">{formData.email}</span></p>
Â  Â  Â  Â  Â  <p className="text-xs text-slate-400 mb-6">Si no llega en 1 minuto, revise SPAM.</p>
Â  Â  Â  Â  Â  <button onClick={() => { setVerificationSent(false); setIsRegistering(false); }} className="w-full bg-brand-teal text-white py-3 rounded-xl font-bold hover:bg-teal-600 transition-all">Ir a Iniciar SesiÃ³n</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  );
Â  }

Â  if (recoverySent) {
Â  Â  return (
Â  Â  Â  <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4 animate-fade-in-up">
Â  Â  Â  Â  <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center border border-slate-100">
Â  Â  Â  Â  Â  <div className="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6"><KeyRound size={40} /></div>
Â  Â  Â  Â  Â  <h2 className="text-2xl font-bold text-slate-800 mb-2">Revise su Correo</h2>
Â  Â  Â  Â  Â  <p className="text-slate-600 mb-6">Si el correo existe, recibirÃ¡ instrucciones.</p>
Â  Â  Â  Â  Â  <button onClick={() => { setRecoverySent(false); setIsRecovering(false); }} className="w-full bg-brand-teal text-white py-3 rounded-xl font-bold hover:bg-teal-600 transition-all">Volver</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  </div>
Â  Â  );
Â  }

Â  return (
Â  Â  <div className="min-h-screen bg-slate-50 flex flex-col lg:flex-row font-sans">
Â  Â  Â  <div className="hidden lg:flex lg:w-1/2 bg-slate-900 text-white flex-col justify-center p-12 relative overflow-hidden">
Â  Â  Â  Â  <div className="absolute top-0 left-0 w-full h-full opacity-40">
Â  Â  Â  Â  Â  Â  <img src="https://images.unsplash.com/photo-1622253692010-333f2da6031d?q=80&w=1964&auto=format&fit=crop" className="w-full h-full object-cover grayscale" alt="Medical Tech" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div className="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-900/90 to-teal-900/80 z-10" />
Â  Â  Â  Â  <div className="relative z-10 max-w-lg">
Â  Â  Â  Â  Â  <div className="flex items-center gap-4 mb-8">
Â  Â  Â  Â  Â  Â  <img src="/pwa-192x192.png" alt="Logo MediScribe" className="w-20 h-20 rounded-2xl bg-white p-1 shadow-lg object-cover" />
Â  Â  Â  Â  Â  Â  <h1 className="text-5xl font-bold tracking-tight">MediScribe AI</h1>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <h2 className="text-3xl font-bold mb-4 leading-tight">El asistente clÃ­nico inteligente para mÃ©dicos modernos.</h2>
Â  Â  Â  Â  Â  <p className="text-slate-400 text-lg">Automatice sus notas clÃ­nicas, gestione su agenda y recupere su tiempo con el poder de la IA.</p>
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  <div className="mt-12 flex gap-8">
Â  Â  Â  Â  Â  Â  <div className="flex flex-col gap-2"><span className="text-2xl font-bold text-brand-teal">NOM-004</span><span className="text-sm text-slate-400">Compliance</span></div>
Â  Â  Â  Â  Â  Â  <div className="flex flex-col gap-2"><span className="text-2xl font-bold text-brand-teal">IA 2.0</span><span className="text-sm text-slate-400">Voz</span></div>
Â  Â  Â  Â  Â  Â  <div className="flex flex-col gap-2"><span className="text-2xl font-bold text-brand-teal">100%</span><span className="text-sm text-slate-400">Seguro</span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div className="flex-1 flex items-center justify-center p-6 relative bg-white dark:bg-slate-950">
Â  Â  Â  Â  <a 
Â  Â  Â  Â  Â  Â  href="/manual.html" 
Â  Â  Â  Â  Â  Â  target="_blank" 
Â  Â  Â  Â  Â  Â  rel="noopener noreferrer" 
Â  Â  Â  Â  Â  Â  className="absolute top-6 right-6 flex items-center gap-2 text-xs font-bold text-slate-500 hover:text-brand-teal transition-colors bg-slate-50 hover:bg-white px-4 py-2 rounded-full border border-slate-200 shadow-sm hover:shadow-md"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  <BookOpen className="w-4 h-4" />
Â  Â  Â  Â  Â  <span>Manual de Usuario</span>
Â  Â  Â  Â  </a>

Â  Â  Â  Â  <div className="w-full max-w-md space-y-8 animate-fade-in-up">
Â  Â  Â  Â  Â  {isResettingPassword ? (
Â  Â  Â  Â  Â  Â  Â <>
Â  Â  Â  Â  Â  Â  Â  Â <div className="text-center lg:text-left">
Â  Â  Â  Â  Â  Â  Â  Â  <div className="w-12 h-12 bg-brand-teal/10 text-brand-teal rounded-full flex items-center justify-center mb-4"><CheckCircle2 size={24} /></div>
Â  Â  Â  Â  Â  Â  Â  Â  <h2 className="text-3xl font-bold text-slate-900">Nueva ContraseÃ±a</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p className="mt-2 text-slate-500">Establezca su nueva clave de acceso.</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <form className="space-y-5" onSubmit={handlePasswordUpdate}>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label className="block text-sm font-medium text-slate-700 mb-1">Nueva ContraseÃ±a</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Lock size={18} /></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input required type={showPassword ? "text" : "password"} className="block w-full pl-10 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-teal outline-none transition-all" placeholder="Min 8 car, 1 Mayus, 1 Num, 1 SÃ­mbolo" value={formData.newPassword} onChange={e => setFormData({...formData, newPassword: e.target.value})}/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">{showPassword ? <EyeOff size={18}/> : <Eye size={18}/>}</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" disabled={loading} className="w-full bg-brand-teal text-white py-3 rounded-xl font-bold hover:bg-teal-600 transition-all flex justify-center items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  {loading ? <Loader2 className="animate-spin" /> : 'Actualizar y Entrar'}
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â </>
Â  Â  Â  Â  Â  ) : isRecovering ? (
Â  Â  Â  Â  Â  Â  Â <>
Â  Â  Â  Â  Â  Â  Â  Â <div className="text-center lg:text-left">
Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={() => setIsRecovering(false)} className="mb-4 text-slate-500 hover:text-slate-700 flex items-center gap-2 text-sm font-medium transition-colors"><ArrowLeft size={16} /> Volver</button>
Â  Â  Â  Â  Â  Â  Â  Â  <h2 className="text-3xl font-bold text-slate-900">Recuperar Acceso</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p className="mt-2 text-slate-500">Le enviaremos un enlace seguro.</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <form className="space-y-5" onSubmit={handleRecoveryRequest}>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label className="block text-sm font-medium text-slate-700 mb-1">Correo ElectrÃ³nico</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Mail size={18} /></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input required type="email" className="block w-full pl-10 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-teal outline-none transition-all" placeholder="doctor@hospital.com" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})}/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" disabled={loading} className="w-full bg-brand-teal text-white py-3 rounded-xl font-bold hover:bg-teal-600 transition-all flex justify-center items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  {loading ? <Loader2 className="animate-spin" /> : 'Enviar Enlace'}
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â </>
Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â <>
Â  Â  Â  Â  Â  Â  Â  Â <div className="text-center lg:text-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â <h2 className="text-3xl font-bold text-slate-900">{isRegistering ? 'Alta de MÃ©dico' : 'Bienvenido de nuevo'}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p className="mt-2 text-slate-500">{isRegistering ? 'Ãšnase a la red profesional.' : 'Ingrese sus credenciales para acceder.'}</p>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <form className="space-y-5" onSubmit={handleAuth}>
Â  Â  Â  Â  Â  Â  Â  Â  Â {isRegistering && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div className="space-y-4 animate-fade-in-up">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label className="block text-sm font-medium text-slate-700 mb-1">Nombre Completo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div className="relative"><User size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input required type="text" className="block w-full pl-10 p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-brand-teal" value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value})} placeholder="Dr. Juan PÃ©rez"/></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div className="grid grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label className="block text-sm font-medium text-slate-700 mb-1">Especialidad</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div className="relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <Stethoscope size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <select 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â className="block w-full pl-10 p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-brand-teal appearance-none bg-white text-slate-700 cursor-pointer text-sm" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â value={formData.specialty} 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onChange={e => setFormData({...formData, specialty: e.target.value})}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â {SPECIALTIES.map(s => <option key={s} value={s}>{s}</option>)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label className="block text-sm font-medium text-slate-700 mb-1">CÃ©dula</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div className="relative"><FileBadge size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input required type="text" className="block w-full pl-10 p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-brand-teal" value={formData.cedula} onChange={e => setFormData({...formData, cedula: e.target.value.replace(/\D/g,'')})} maxLength={8}/></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â )}
Â  Â  Â  Â  Â  Â  Â  Â  Â <div className="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label className="block text-sm font-medium text-slate-700 mb-1">Correo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Mail size={18} /></div><input required type="email" className="block w-full pl-10 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-teal outline-none" placeholder="doctor@hospital.com" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})}/></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label className="block text-sm font-medium text-slate-700 mb-1">ContraseÃ±a</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Lock size={18} /></div><input required type={showPassword ? "text" : "password"} className="block w-full pl-10 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-teal outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})}/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">{showPassword ? <EyeOff size={18} /> : <Eye size={18} />}</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â {!isRegistering && (<div className="flex justify-end mt-2"><button type="button" onClick={() => setIsRecovering(true)} className="text-xs font-medium text-brand-teal hover:text-teal-700">Â¿Olvidaste tu contraseÃ±a?</button></div>)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â {isRegistering && <p className="text-[10px] text-slate-400 mt-1 pl-1 flex items-center gap-1"><AlertTriangle size={10}/> Requiere: 8+ car, 1 Mayus, 1 Num, 1 SÃ­mbolo.</p>}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â {isRegistering && (<div className="flex items-start gap-3 bg-blue-50 p-3 rounded-lg border border-blue-100"><input type="checkbox" required className="mt-1 w-4 h-4 text-brand-teal rounded cursor-pointer" checked={formData.termsAccepted} onChange={e => setFormData({...formData, termsAccepted: e.target.checked})}/><label className="text-xs text-slate-600">Acepto la verificaciÃ³n de mi <strong>CÃ©dula Profesional</strong>. Datos falsos suspenden la cuenta.</label></div>)}
Â  Â  Â  Â  Â  Â  Â  Â  Â <button type="submit" disabled={loading} className="w-full flex justify-center items-center gap-2 py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-bold text-white bg-brand-teal hover:bg-teal-600 transition-all disabled:opacity-50">{loading ? <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> : <>{isRegistering ? 'Registrarse' : 'Iniciar SesiÃ³n'} <ArrowRight size={20} /></>}</button>
Â  Â  Â  Â  Â  Â  Â  Â </form>
Â  Â  Â  Â  Â  Â  Â  Â <div className="text-center"><button type="button" onClick={() => setIsRegistering(!isRegistering)} className="text-sm font-medium text-brand-teal hover:text-teal-700">{isRegistering ? 'Â¿Ya tienes cuenta? Inicia sesiÃ³n' : 'Â¿Eres nuevo? Crea tu cuenta'}</button></div>
Â  Â  Â  Â  Â  Â  Â </>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  
          {/* INICIO DEL BLOQUE REEMPLAZADO */}
          <div className="mt-8 pt-6 border-t border-slate-100 text-center text-xs text-slate-400">
            <p>
              &copy; {new Date().getFullYear()} <strong>MediScribe AIâ„¢</strong>. Todos los derechos reservados.
            </p>
            <p className="mt-1 text-[10px] text-slate-300">
              Desarrollado por <span className="font-bold text-slate-500">PixelArte Studio</span>. 
              Uso exclusivo autorizado. Prohibida su reproducciÃ³n parcial o total.
            </p>
          </div>
          {/* FIN DEL BLOQUE REEMPLAZADO */}
          
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
};

export default AuthView;

--------------------------------------------------
ðŸ“ PATH: src\components\CalendarDarkOverrides.css
--------------------------------------------------
/* Ajustes para React Big Calendar en Modo Oscuro */
.dark .rbc-btn-group button {
    color: #e2e8f0; /* Texto claro */
    background-color: #1e293b; /* Fondo oscuro */
    border-color: #334155;
}
.dark .rbc-btn-group button:hover {
    background-color: #334155;
}
.dark .rbc-btn-group button.rbc-active {
    background-color: #0d9488; /* Brand Teal */
    color: white;
    border-color: #0d9488;
}
.dark .rbc-header {
    color: #cbd5e1; /* Texto cabecera */
}
.dark .rbc-off-range-bg {
    background-color: #0f172a; /* DÃ­as fuera de rango */
}

--------------------------------------------------
ðŸ“ PATH: src\components\CalendarView.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { Calendar, dateFnsLocalizer, ToolbarProps, EventProps } from 'react-big-calendar';
// CORRECCIÃ“N DE IMPORTACIONES DATE-FNS
import { format, parse, startOfWeek, getDay } from 'date-fns';
import { es } from 'date-fns/locale';
import 'react-big-calendar/lib/css/react-big-calendar.css';
import { AppointmentService } from '../services/AppointmentService';
import { Appointment, Patient } from '../types';
import { supabase } from '../lib/supabase';
import { toast } from 'sonner';
import { Plus, X, Calendar as CalendarIcon, Smartphone, Trash2, ChevronLeft, ChevronRight } from 'lucide-react';
import './CalendarDarkOverrides.css';
import { generateGoogleCalendarUrl, downloadIcsFile } from '../utils/calendarUtils';

const locales = { 'es': es };
const localizer = dateFnsLocalizer({
  format, parse, startOfWeek, getDay, locales,
});

const PRESET_COLORS = [
  '#3b82f6', '#ec4899', '#f59e0b', '#8b5cf6', '#10b981', 
  '#ef4444', '#06b6d4', '#6366f1', '#d946ef', '#f97316'
];

// --- COMPONENTES DE UI PERSONALIZADOS ---
const CustomToolbar: React.FC<ToolbarProps> = (props) => {
    const goToBack = () => { props.onNavigate('PREV'); };
    const goToNext = () => { props.onNavigate('NEXT'); };
    const goToToday = () => { props.onNavigate('TODAY'); };
  
    const label = () => {
      const date = props.date;
      return <span className="capitalize">{format(date, 'MMMM yyyy', { locale: es })}</span>;
    };
  
    return (
      <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-3 bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
        <div className="flex items-center gap-2">
            <div className="bg-brand-teal/10 text-brand-teal p-2 rounded-xl">
                <CalendarIcon size={20} />
            </div>
            <span className="text-lg font-bold text-slate-800 dark:text-white tracking-tight">{label()}</span>
        </div>
        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
            {['month', 'week', 'day', 'agenda'].map(view => (
                <button
                    key={view}
                    onClick={() => props.onView(view as any)}
                    className={`px-3 py-1.5 text-xs font-bold rounded-lg transition-all capitalize ${props.view === view ? 'bg-white dark:bg-slate-600 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}
                >
                    {view === 'month' ? 'Mes' : view === 'week' ? 'Semana' : view === 'day' ? 'DÃ­a' : 'Agenda'}
                </button>
            ))}
        </div>
        <div className="flex gap-1">
            <button onClick={goToBack} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-600 dark:text-slate-300 transition-colors"><ChevronLeft size={20}/></button>
            <button onClick={goToToday} className="px-3 py-1 text-xs font-bold text-brand-teal hover:bg-teal-50 dark:hover:bg-teal-900/20 rounded-lg transition-colors">Hoy</button>
            <button onClick={goToNext} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-600 dark:text-slate-300 transition-colors"><ChevronRight size={20}/></button>
        </div>
      </div>
    );
};

const CustomEvent = ({ event }: EventProps<any>) => {
    return (
        <div className="flex flex-col h-full justify-center px-1">
            <div className="text-xs font-bold truncate flex items-center gap-1">{event.title}</div>
            <div className="text-[9px] opacity-80 truncate hidden sm:block">
                 {format(event.start, 'h:mm a')}
            </div>
        </div>
    );
};

const CalendarView: React.FC = () => {
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [patients, setPatients] = useState<Patient[]>([]);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  
  const [formData, setFormData] = useState({
    id: '', patientId: '', patientName: '', title: '', notes: '', startTime: '', endTime: ''
  });
  const [isSaving, setIsSaving] = useState(false);

  useEffect(() => { loadData(); }, []);

  const loadData = async () => {
    setLoading(true);
    try {
      const { data: patientsData } = await supabase.from('patients').select('*').order('name');
      setPatients(patientsData || []);
      const appointmentsData = await AppointmentService.getAppointments();
      setAppointments(appointmentsData);
    } catch (error) { toast.error("Error de conexiÃ³n"); } 
    finally { setLoading(false); }
  };

  const getPatientColor = (name: string) => {
    if (!name) return '#64748b';
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    const index = Math.abs(hash % PRESET_COLORS.length);
    return PRESET_COLORS[index];
  };

  const eventStyleGetter = (event: any) => {
    const patientName = event.resource.patient?.name || '';
    const bgColor = getPatientColor(patientName);
    return {
      style: {
        backgroundColor: bgColor,
        borderRadius: '6px',
        opacity: 1,
        color: 'white',
        border: '0px',
        borderLeft: `4px solid rgba(0,0,0,0.2)`,
        display: 'block',
        fontSize: '0.8rem',
        padding: '2px 4px',
        boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
      }
    };
  };

  const calendarEvents = appointments.map(app => ({
    id: app.id,
    title: `${app.patient?.name || 'Paciente'}`,
    start: new Date(app.start_time),
    end: new Date(app.end_time),
    resource: app
  }));

  const handleSelectSlot = ({ start, end, action }: { start: Date; end: Date; action: string }) => {
    const toLocalISO = (date: Date) => {
      const offset = date.getTimezoneOffset() * 60000;
      return new Date(date.getTime() - offset).toISOString().slice(0, 16);
    };

    let finalStart = start;
    let finalEnd = end;

    if (action === 'click' || action === 'select') {
        const isMidnight = start.getHours() === 0 && start.getMinutes() === 0;
        if (isMidnight) {
            finalStart = new Date(start);
            finalStart.setHours(9, 0, 0); 
            finalEnd = new Date(finalStart);
            finalEnd.setMinutes(30); 
        }
    }

    setFormData({
      id: '', patientId: '', patientName: '', title: 'Consulta General', notes: '',
      startTime: toLocalISO(finalStart), 
      endTime: toLocalISO(finalEnd)
    });
    setIsModalOpen(true);
  };

  const handleSelectEvent = (event: any) => {
    const app = event.resource as Appointment;
    const toLocalISO = (dateString: string) => {
        const date = new Date(dateString);
        const offset = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() - offset).toISOString().slice(0, 16);
    };
    setFormData({
        id: app.id,
        patientId: app.patient_id,
        patientName: app.patient?.name || '',
        title: app.title,
        notes: app.notes || '',
        startTime: toLocalISO(app.start_time),
        endTime: toLocalISO(app.end_time)
    });
    setIsModalOpen(true);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSaving(true);
    try {
      const payload = {
        patient_id: formData.patientId,
        title: formData.title,
        start_time: new Date(formData.startTime).toISOString(),
        end_time: new Date(formData.endTime).toISOString(),
        notes: formData.notes,
        // CORRECCIÃ“N: Forzamos el tipado literal para evitar error de string genÃ©rico
        status: 'scheduled' as 'scheduled' 
      };

      if(formData.id) {
          await AppointmentService.updateAppointment(formData.id, payload);
      } else {
          await AppointmentService.createAppointment(payload);
      }
      toast.success(formData.id ? "Cita actualizada" : "Cita agendada");
      setIsModalOpen(false);
      const refresh = await AppointmentService.getAppointments();
      setAppointments(refresh);
    } catch (error) { toast.error("Error al guardar"); } 
    finally { setIsSaving(false); }
  };

  const handleDelete = async () => {
      if (!formData.id || !confirm("Â¿Eliminar esta cita?")) return;
      try {
          await AppointmentService.deleteAppointment(formData.id);
          toast.success("Cita eliminada");
          setIsModalOpen(false);
          const refresh = await AppointmentService.getAppointments();
          setAppointments(refresh);
      } catch (e) { toast.error("Error al eliminar"); }
  };

  const handleGoogleSync = () => {
      if (!formData.startTime || !formData.endTime) return;
      const url = generateGoogleCalendarUrl({
          title: `Cita: ${formData.patientName}`,
          description: formData.notes || 'Consulta mÃ©dica',
          startTime: formData.startTime,
          endTime: formData.endTime
      });
      window.open(url, '_blank');
  };

  const handleAppleSync = () => {
      if (!formData.startTime || !formData.endTime) return;
      downloadIcsFile({
          title: `Cita: ${formData.patientName}`,
          description: formData.notes || 'Consulta mÃ©dica',
          startTime: formData.startTime,
          endTime: formData.endTime
      }, `cita-${formData.patientName}`);
      toast.success("Archivo generado");
  };

  return (
    <div className="h-full p-2 md:p-6 animate-fade-in-up flex flex-col font-sans">
      
      <div className="flex justify-between items-center mb-2 md:mb-6 shrink-0">
        <div>
          <h2 className="text-xl md:text-2xl font-bold text-slate-800 dark:text-white">Agenda MÃ©dica</h2>
          <p className="text-slate-500 dark:text-slate-400 text-sm hidden md:block">GestiÃ³n visual de pacientes.</p>
        </div>
        <button 
          onClick={() => {
            const now = new Date();
            const end = new Date(now.getTime() + 30*60*1000);
            handleSelectSlot({ start: now, end: end, action: 'click' });
          }}
          className="bg-brand-teal text-white px-3 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2 text-sm hover:bg-teal-600 transition-all"
        >
          <Plus size={18} /> <span className="hidden sm:inline">Nueva Cita</span> <span className="sm:hidden">Nueva</span>
        </button>
      </div>

      <div className="flex-1 bg-white dark:bg-slate-900 p-1 md:p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-slate-200 overflow-hidden flex flex-col">
        {loading ? (
          <div className="h-full flex items-center justify-center text-slate-400">Cargando...</div>
        ) : (
          <Calendar
            localizer={localizer}
            events={calendarEvents}
            startAccessor="start"
            endAccessor="end"
            style={{ height: '100%' }}
            messages={{ next: "Sig", previous: "Ant", today: "Hoy", month: "Mes", week: "Semana", day: "DÃ­a", agenda: "Agenda" }}
            culture='es'
            selectable={true} 
            onSelectSlot={handleSelectSlot} 
            onSelectEvent={handleSelectEvent}
            eventPropGetter={eventStyleGetter}
            defaultView='month'
            components={{ toolbar: CustomToolbar, event: CustomEvent }}
            longPressThreshold={10} 
          />
        )}
      </div>

      {isModalOpen && (
        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-200 dark:border-slate-700 animate-fade-in-up">
            <div className="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
              <h3 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                <CalendarIcon className="text-brand-teal" size={20}/> {formData.id ? 'Detalles' : 'Agendar'}
              </h3>
              <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-red-500"><X size={24} /></button>
            </div>
            
            <form onSubmit={handleSave} className="p-6 space-y-4 text-slate-700 dark:text-slate-200">
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Paciente</label>
                <select 
                  required disabled={!!formData.id}
                  className="w-full p-3 border border-slate-200 dark:border-slate-700 rounded-lg outline-none bg-slate-50 dark:bg-slate-800 focus:ring-2 focus:ring-brand-teal transition-colors disabled:opacity-60"
                  value={formData.patientId}
                  onChange={e => {
                      const selected = patients.find(p => p.id === e.target.value);
                      setFormData({...formData, patientId: e.target.value, patientName: selected?.name || ''})
                  }}
                >
                  <option value="">-- Seleccionar --</option>
                  {patients.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Motivo</label>
                <input type="text" required className="w-full p-3 border border-slate-200 dark:border-slate-700 rounded-lg outline-none bg-white dark:bg-slate-800 focus:ring-2 focus:ring-brand-teal" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})}/>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Inicio</label>
                  <input type="datetime-local" required className="w-full p-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm bg-slate-50 dark:bg-slate-800" value={formData.startTime} onChange={e => setFormData({...formData, startTime: e.target.value})}/>
                </div>
                <div>
                  <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Fin</label>
                  <input type="datetime-local" required className="w-full p-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm bg-slate-50 dark:bg-slate-800" value={formData.endTime} onChange={e => setFormData({...formData, endTime: e.target.value})}/>
                </div>
              </div>

              {formData.id && (
                  <div className="mt-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800/50">
                      <p className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-3 uppercase tracking-wider">Sincronizar con:</p>
                      <div className="grid grid-cols-2 gap-3">
                          <button type="button" onClick={handleGoogleSync} className="flex items-center justify-center gap-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 p-2 rounded-lg text-xs font-bold text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                              <span className="text-blue-500 font-black">G</span> Google
                          </button>
                          <button type="button" onClick={handleAppleSync} className="flex items-center justify-center gap-2 bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300 p-2 rounded-lg text-xs font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/60 transition-colors">
                              <Smartphone size={16} /> Otros
                          </button>
                      </div>
                  </div>
              )}

              <div className="flex gap-3 pt-4 border-t border-slate-100 dark:border-slate-800">
                  {formData.id && (
                      <button type="button" onClick={handleDelete} className="p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Borrar"><Trash2 size={20}/></button>
                  )}
                  <button type="submit" disabled={isSaving} className="flex-1 bg-brand-teal text-white py-3 rounded-lg font-bold hover:bg-teal-600 shadow-md flex justify-center items-center gap-2">
                    {isSaving ? 'Guardando...' : formData.id ? 'Guardar' : 'Agendar'}
                  </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

export default CalendarView;

--------------------------------------------------
ðŸ“ PATH: src\components\ClinicalHistoryPDF.tsx
--------------------------------------------------
import React from 'react';
import { 
  Page, 
  Text, 
  View, 
  Document, 
  StyleSheet, 
  Image, 
  Font 
} from '@react-pdf/renderer';

// ----------------------------------------------------------------------
// 1. CONFIGURACIÃ“N DE FUENTES
// ----------------------------------------------------------------------
// Registramos Helvetica (estÃ¡ndar seguro) para soportar acentos y Ã±
Font.register({
  family: 'Helvetica',
  fonts: [
    { 
      src: 'https://cdn.jsdelivr.net/npm/@canvas-fonts/helvetica@1.0.4/Helvetica.ttf' 
    },
    { 
      src: 'https://cdn.jsdelivr.net/npm/@canvas-fonts/helvetica@1.0.4/Helvetica-Bold.ttf', 
      fontWeight: 'bold' 
    }
  ]
});

// ----------------------------------------------------------------------
// 2. ESTILOS DETALLADOS Y EXPANDIDOS (NO COMPACTADOS)
// ----------------------------------------------------------------------
const styles = StyleSheet.create({
  page: {
    paddingTop: 40,
    paddingBottom: 40,
    paddingLeft: 40,
    paddingRight: 40,
    fontFamily: 'Helvetica',
    fontSize: 10,
    lineHeight: 1.5,
    color: '#334155', // Slate-700
    backgroundColor: '#ffffff'
  },
  
  // --- Encabezado del Doctor ---
  header: {
    flexDirection: 'row',
    marginBottom: 25,
    borderBottomWidth: 2,
    borderBottomColor: '#0f766e', // Brand Teal (Teal-700)
    paddingBottom: 15,
    alignItems: 'center',
    justifyContent: 'space-between'
  },
  headerLeft: {
    flexGrow: 1,
    paddingRight: 10,
    flexDirection: 'column'
  },
  logo: {
    width: 70,
    height: 70,
    borderRadius: 4,
    objectFit: 'contain'
  },
  drName: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#0f766e',
    textTransform: 'uppercase',
    marginBottom: 4
  },
  drSpecialty: {
    fontSize: 10,
    color: '#475569', // Slate-600
    fontWeight: 'bold',
    textTransform: 'uppercase',
    marginBottom: 2
  },
  drInfo: {
    fontSize: 9,
    color: '#64748b', // Slate-500
    marginBottom: 1
  },

  // --- SecciÃ³n de Datos del Paciente ---
  patientSection: {
    backgroundColor: '#f8fafc', // Slate-50
    paddingTop: 15,
    paddingBottom: 15,
    paddingLeft: 15,
    paddingRight: 15,
    borderRadius: 6,
    marginBottom: 25,
    borderLeftWidth: 4,
    borderLeftColor: '#0f766e'
  },
  sectionTitle: {
    fontSize: 12,
    fontWeight: 'bold',
    color: '#0f766e',
    marginBottom: 10,
    textTransform: 'uppercase',
    letterSpacing: 1,
    borderBottomWidth: 1,
    borderBottomColor: '#e2e8f0',
    paddingBottom: 4
  },
  row: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 6
  },
  column: {
    flexDirection: 'column',
    width: '48%'
  },
  label: {
    fontSize: 8,
    fontWeight: 'bold',
    color: '#94a3b8', // Slate-400
    textTransform: 'uppercase',
    marginBottom: 2
  },
  value: {
    fontSize: 10,
    fontWeight: 'bold',
    color: '#1e293b' // Slate-800
  },

  // --- SecciÃ³n de Antecedentes ---
  historySection: {
    marginBottom: 25,
    paddingBottom: 10,
    borderBottomWidth: 1,
    borderBottomColor: '#cbd5e1'
  },
  historyLabel: {
    fontSize: 9, 
    fontWeight: 'bold', 
    color: '#64748b', 
    marginBottom: 4, 
    textTransform:'uppercase' 
  },
  historyText: {
    fontSize: 10, 
    color: '#334155',
    textAlign: 'justify',
    lineHeight: 1.4
  },

  // --- LÃ­nea de Tiempo (Consultas) ---
  timelineItem: {
    marginBottom: 20,
    paddingBottom: 15,
    borderBottomWidth: 1,
    borderBottomColor: '#f1f5f9'
  },
  consultationHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    backgroundColor: '#f1f5f9',
    paddingVertical: 6,
    paddingHorizontal: 10,
    marginBottom: 10,
    borderRadius: 4,
    alignItems: 'center'
  },
  dateBadge: {
    fontSize: 9,
    fontWeight: 'bold',
    color: '#0f766e',
    textTransform: 'uppercase'
  },
  folioBadge: {
    fontSize: 8,
    color: '#64748b'
  },
  
  // --- Estilos para el Cuerpo del Texto Formateado ---
  soapHeader: {
    fontSize: 9,
    fontWeight: 'bold',
    color: '#0f766e',
    marginTop: 8,
    marginBottom: 2,
    textTransform: 'uppercase'
  },
  soapBody: {
    fontSize: 10,
    textAlign: 'justify',
    marginBottom: 4,
    lineHeight: 1.4,
    color: '#334155'
  },
  planHeader: {
    fontSize: 9,
    fontWeight: 'bold',
    color: '#0f766e', // Mismo color de marca
    marginTop: 10,
    marginBottom: 2,
    textTransform: 'uppercase'
  },
  normalText: {
    fontSize: 10,
    marginBottom: 2
  },

  // --- Pie de PÃ¡gina Legal ---
  footer: {
    position: 'absolute',
    bottom: 30,
    left: 40,
    right: 40,
    textAlign: 'center',
    fontSize: 8,
    color: '#cbd5e1',
    borderTopWidth: 1,
    borderTopColor: '#e2e8f0',
    paddingTop: 10
  }
});

// ----------------------------------------------------------------------
// 3. INTERFACES DE DATOS (TIPADO FUERTE)
// ----------------------------------------------------------------------
interface ConsultationRecord {
  id: string;
  created_at: string;
  summary: string;
  diagnosis?: string;
}

interface ClinicalHistoryPDFProps {
  doctorProfile: {
    full_name: string;
    specialty?: string;
    license_number?: string;
    university?: string;
    address?: string;
    phone?: string;
    logo_url?: string;
  };
  patientData: {
    name: string;
    age?: string;
    gender?: string;
    history?: string; // Antecedentes generales
  };
  consultations: ConsultationRecord[];
  generatedDate: string;
}

// ----------------------------------------------------------------------
// 4. HELPER: TRADUCTOR INTELIGENTE DE SOAP
// ----------------------------------------------------------------------
const FormattedConsultationBody = ({ text }: { text: string }) => {
  const cleanText = text || "";

  // Paso 1: Normalizar saltos de lÃ­nea
  // Esto asegura que funcionemos igual en Windows/Mac/Linux
  const normalizedText = cleanText.replace(/\r\n/g, '\n');

  // Paso 2: Separar por lÃ­neas para analizar una por una
  // Evitamos regex complejos que rompan el texto si el doctor escribe "S:" dentro de una frase.
  const lines = normalizedText.split('\n');

  return (
    <View>
      {lines.map((line, index) => {
        const trimmedLine = line.trim();
        
        // Ignoramos lÃ­neas vacÃ­as para ahorrar espacio visual
        if (!trimmedLine) return null;

        // DETECCIÃ“N SEGURA DE ENCABEZADOS (Solo al inicio de la lÃ­nea)
        
        // Caso S: Subjetivo
        if (trimmedLine.startsWith("S:") || trimmedLine.startsWith("S ")) {
            return (
                <View key={index} wrap={false}>
                    <Text style={styles.soapHeader}>SÃNTOMAS Y MOTIVO:</Text>
                    <Text style={styles.soapBody}>{trimmedLine.replace(/^(S:|S )/i, '').trim()}</Text>
                </View>
            );
        }

        // Caso O: Objetivo
        if (trimmedLine.startsWith("O:") || trimmedLine.startsWith("O ")) {
            return (
                <View key={index} wrap={false}>
                    <Text style={styles.soapHeader}>EXPLORACIÃ“N FÃSICA:</Text>
                    <Text style={styles.soapBody}>{trimmedLine.replace(/^(O:|O )/i, '').trim()}</Text>
                </View>
            );
        }

        // Caso A: AnÃ¡lisis
        if (trimmedLine.startsWith("A:") || trimmedLine.startsWith("A ")) {
            return (
                <View key={index} wrap={false}>
                    <Text style={styles.soapHeader}>DIAGNÃ“STICO Y ANÃLISIS:</Text>
                    <Text style={styles.soapBody}>{trimmedLine.replace(/^(A:|A )/i, '').trim()}</Text>
                </View>
            );
        }

        // Caso P: Plan
        if (trimmedLine.startsWith("P:") || trimmedLine.startsWith("P ")) {
            return (
                <View key={index} wrap={false}>
                    <Text style={styles.soapHeader}>PLAN MÃ‰DICO:</Text>
                    <Text style={styles.soapBody}>{trimmedLine.replace(/^(P:|P )/i, '').trim()}</Text>
                </View>
            );
        }

        // Caso PLAN PACIENTE (Instrucciones)
        if (trimmedLine.startsWith("PLAN PACIENTE:")) {
            return (
                <View key={index} wrap={false}>
                    <Text style={styles.planHeader}>INDICACIONES AL PACIENTE:</Text>
                    <Text style={styles.soapBody}>{trimmedLine.replace(/^PLAN PACIENTE:/i, '').trim()}</Text>
                </View>
            );
        }

        // Caso FECHA (A veces viene en el texto)
        if (trimmedLine.startsWith("FECHA:")) {
             // Si ya mostramos la fecha en el encabezado azul, podrÃ­amos omitirla, 
             // pero si el doctor la puso, la dejamos en negrita discreta.
             return (
                 <Text key={index} style={[styles.soapBody, { fontSize: 8, color: '#94a3b8' }]}>
                     {trimmedLine}
                 </Text>
             );
        }

        // TEXTO NORMAL (LÃ­neas de continuaciÃ³n)
        return (
            <Text key={index} style={styles.soapBody}>
                {trimmedLine}
            </Text>
        );
      })}
    </View>
  );
};

// ----------------------------------------------------------------------
// 5. COMPONENTE PRINCIPAL DEL DOCUMENTO
// ----------------------------------------------------------------------
const ClinicalHistoryPDF: React.FC<ClinicalHistoryPDFProps> = ({ 
  doctorProfile, 
  patientData, 
  consultations, 
  generatedDate 
}) => {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        
        {/* --- 1. ENCABEZADO --- */}
        <View style={styles.header}>
          <View style={styles.headerLeft}>
            <Text style={styles.drName}>Dr. {doctorProfile.full_name}</Text>
            <Text style={styles.drSpecialty}>
              {doctorProfile.specialty || "Medicina General"}
            </Text>
            
            {doctorProfile.license_number && (
              <Text style={styles.drInfo}>
                CÃ©d. Prof: {doctorProfile.license_number} | {doctorProfile.university}
              </Text>
            )}
            
            {doctorProfile.address && (
              <Text style={styles.drInfo}>
                {doctorProfile.address}
              </Text>
            )}
            
            {doctorProfile.phone && (
              <Text style={styles.drInfo}>
                Tel: {doctorProfile.phone}
              </Text>
            )}
          </View>
          
          {/* Logo del Doctor (Si existe) */}
          {doctorProfile.logo_url ? (
             <Image 
                style={styles.logo} 
                src={doctorProfile.logo_url} 
             />
          ) : null}
        </View>

        {/* --- 2. FICHA DEL PACIENTE --- */}
        <View style={styles.patientSection}>
          <Text style={styles.sectionTitle}>Resumen de Historia ClÃ­nica</Text>
          
          <View style={styles.row}>
            <View style={styles.column}>
              <Text style={styles.label}>PACIENTE</Text>
              <Text style={styles.value}>{patientData.name}</Text>
            </View>
            <View style={styles.column}>
              <Text style={styles.label}>FECHA DE EMISIÃ“N</Text>
              <Text style={styles.value}>{generatedDate}</Text>
            </View>
          </View>

          <View style={styles.row}>
             <View style={styles.column}>
                <Text style={styles.label}>EDAD / GÃ‰NERO</Text>
                <Text style={styles.value}>
                  {patientData.age || "N/A"} - {patientData.gender || "N/A"}
                </Text>
             </View>
             <View style={styles.column}>
                <Text style={styles.label}>TOTAL CONSULTAS</Text>
                <Text style={styles.value}>{consultations.length} Registros</Text>
             </View>
          </View>
        </View>

        {/* --- 3. ANTECEDENTES (Si existen) --- */}
        {patientData.history && (
            <View style={styles.historySection}>
                <Text style={styles.historyLabel}>ANTECEDENTES CLÃNICOS REGISTRADOS:</Text>
                <Text style={styles.historyText}>
                    {patientData.history}
                </Text>
            </View>
        )}

        {/* --- 4. LÃNEA DE TIEMPO DE CONSULTAS --- */}
        <Text style={[styles.sectionTitle, { 
            marginTop: 10, 
            borderBottomWidth: 1, 
            borderBottomColor: '#cbd5e1', 
            paddingBottom: 5 
        }]}>
            EVOLUCIÃ“N CRONOLÃ“GICA
        </Text>

        {consultations.length === 0 ? (
            <View style={{ marginTop: 20, alignItems: 'center' }}>
                <Text style={{ color: '#94a3b8', fontSize: 10 }}>
                    -- No hay registros de consulta en este expediente --
                </Text>
            </View>
        ) : (
            consultations.map((cons, index) => (
                <View key={cons.id || index} style={styles.timelineItem} wrap={false}>
                    
                    {/* Barra Azul de Fecha y Folio */}
                    <View style={styles.consultationHeader}>
                        <Text style={styles.dateBadge}>
                            {new Date(cons.created_at).toLocaleDateString('es-MX', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            }).toUpperCase()}
                        </Text>
                        <Text style={styles.folioBadge}>
                            FOLIO: {cons.id.substring(0, 8).toUpperCase()}
                        </Text>
                    </View>
                    
                    {/* Cuerpo de la Cita (Traducido y Formateado) */}
                    <FormattedConsultationBody text={cons.summary} />
                    
                </View>
            ))
        )}

        {/* --- 5. PIE DE PÃGINA --- */}
        <Text 
          style={styles.footer} 
          render={({ pageNumber, totalPages }) => (
            `Documento generado electrÃ³nicamente por MediScribe. Confidencialidad MÃ©dico-Paciente garantizada. - PÃ¡g. ${pageNumber} de ${totalPages}`
          )} 
          fixed 
        />

      </Page>
    </Document>
  );
};

export default ClinicalHistoryPDF;

--------------------------------------------------
ðŸ“ PATH: src\components\ConsultationView.tsx
--------------------------------------------------
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { useLocation } from 'react-router-dom'; 
import { 
  Mic, Square, RefreshCw, FileText, Search, X, 
  MessageSquare, User, Send, Edit2, Check, ArrowLeft, 
  Stethoscope, Trash2, WifiOff, Save, Share2, Download, Printer,
  Paperclip, Calendar, Clock, UserCircle, Activity, ClipboardList, Brain, FileSignature, Keyboard,
  Quote, AlertTriangle, ChevronDown, ChevronUp, Sparkles, PenLine, UserPlus
} from 'lucide-react';

import { useSpeechRecognition } from '../hooks/useSpeechRecognition'; 
import { GeminiMedicalService, ChatMessage, GeminiResponse } from '../services/GeminiMedicalService';
import { supabase } from '../lib/supabase';
import { Patient, DoctorProfile, PatientInsight } from '../types';
import FormattedText from './FormattedText';
import { toast } from 'sonner';
import { pdf } from '@react-pdf/renderer';
import PrescriptionPDF from './PrescriptionPDF';
import { AppointmentService } from '../services/AppointmentService';
import QuickRxModal from './QuickRxModal';
import { DoctorFileGallery } from './DoctorFileGallery';
import { UploadMedico } from './UploadMedico';
import { InsightsPanel } from './InsightsPanel';

type TabType = 'record' | 'patient' | 'chat';

const SPECIALTIES = [
  "Medicina General", "CardiologÃ­a", "CirugÃ­a General", "CirugÃ­a de Columna", "CirugÃ­a de Mano", 
  "CirugÃ­a OncolÃ³gica", "CirugÃ­a PediÃ¡trica", "CirugÃ­a PlÃ¡stica y Reconstructiva", "DermatologÃ­a", 
  "EndocrinologÃ­a", "GastroenterologÃ­a", "GeriatrÃ­a", "GinecologÃ­a y Obstetricia", "Medicina del Deporte", 
  "Medicina Interna", "NefrologÃ­a", "NeumologÃ­a", "NeurocirugÃ­a", "NeurologÃ­a", "OftalmologÃ­a", 
  "OtorrinolaringologÃ­a", "PediatrÃ­a", "PsiquiatrÃ­a", "ReumatologÃ­a", "TraumatologÃ­a y Ortopedia", 
  "TraumatologÃ­a: Artroscopia", "UrologÃ­a", "Urgencias MÃ©dicas"
];

const ConsultationView: React.FC = () => {
  const { isListening, transcript, startListening, stopListening, resetTranscript, setTranscript, isAPISupported } = useSpeechRecognition();
  const location = useLocation(); 
  
  const [patients, setPatients] = useState<any[]>([]); 
  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null);
  const [doctorProfile, setDoctorProfile] = useState<DoctorProfile | null>(null);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null); 
  
  const [isProcessing, setIsProcessing] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [generatedNote, setGeneratedNote] = useState<GeminiResponse | null>(null);
  const [consentGiven, setConsentGiven] = useState(false);
  const [activeTab, setActiveTab] = useState<TabType>('record');
  
  const [selectedSpecialty, setSelectedSpecialty] = useState('Medicina General');
  
  const [editableInstructions, setEditableInstructions] = useState('');
  const [isEditingInstructions, setIsEditingInstructions] = useState(false);
  const [isAppointmentModalOpen, setIsAppointmentModalOpen] = useState(false);
  const [nextApptDate, setNextApptDate] = useState('');
  const [isQuickRxModalOpen, setIsQuickRxModalOpen] = useState(false); 
  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);
  const [chatInput, setChatInput] = useState('');
  const [isChatting, setIsChatting] = useState(false);
  
  const [isAttachmentsOpen, setIsAttachmentsOpen] = useState(false);
  const [isOnline, setIsOnline] = useState(navigator.onLine);

  const [isRiskExpanded, setIsRiskExpanded] = useState(false);

  const [isInsightsOpen, setIsInsightsOpen] = useState(false);
  const [patientInsights, setPatientInsights] = useState<PatientInsight | null>(null);
  const [isLoadingInsights, setIsLoadingInsights] = useState(false);
  
  const [linkedAppointmentId, setLinkedAppointmentId] = useState<string | null>(null);

  const startTimeRef = useRef<number>(Date.now());

  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const transcriptEndRef = useRef<HTMLDivElement>(null);
  const chatEndRef = useRef<HTMLDivElement>(null);
  const abortControllerRef = useRef<AbortController | null>(null);

  useEffect(() => {
    const handleOnline = () => { setIsOnline(true); toast.success("ConexiÃ³n restablecida"); };
    const handleOffline = () => { setIsOnline(false); toast.warning("Sin conexiÃ³n. Modo Offline activo."); };
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    startTimeRef.current = Date.now();

    return () => { window.removeEventListener('online', handleOnline); window.removeEventListener('offline', handleOffline); };
  }, []);

  useEffect(() => {
    let mounted = true;
    const loadInitialData = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return; 

        if (mounted) {
            setCurrentUserId(user.id); 

            // 1. Cargar Pacientes Registrados
            const { data: patientsData } = await supabase.from('patients').select('*').order('created_at', { ascending: false });
            
            // 2. Cargar Citas "Fantasmas"
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const { data: ghostAppointments } = await supabase
                .from('appointments')
                .select('id, title, start_time')
                .is('patient_id', null)
                .eq('doctor_id', user.id)
                .neq('status', 'cancelled')
                .gte('start_time', today.toISOString()) 
                .limit(20);

            const loadedPatients = patientsData || [];
            
            let combinedList = [...loadedPatients];
            
            if (ghostAppointments && ghostAppointments.length > 0) {
                const ghosts = ghostAppointments.map(apt => ({
                    id: `ghost_${apt.id}`, 
                    name: apt.title,
                    isGhost: true, 
                    appointmentId: apt.id,
                    created_at: apt.start_time
                }));
                combinedList = [...ghosts, ...loadedPatients];
            }

            setPatients(combinedList);
            
            const { data: profileData } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            if (profileData) {
                setDoctorProfile(profileData as DoctorProfile);
                if (profileData.specialty) {
                    const matchedSpecialty = SPECIALTIES.find(s => s.toLowerCase() === profileData.specialty.toLowerCase());
                    setSelectedSpecialty(matchedSpecialty || profileData.specialty);
                }
            }

            // --- LÃ“GICA DE PUENTE (DASHBOARD -> CONSULTA) ---
            if (location.state?.patientData) {
                const incoming = location.state.patientData;
                
                if (incoming.isGhost) {
                      const tempPatient = {
                          ...incoming,
                          id: `temp_${Date.now()}`, 
                          isTemporary: true, 
                          appointmentId: incoming.appointmentId || incoming.id.replace('ghost_', '')
                      };
                      setSelectedPatient(tempPatient);
                      if(incoming.appointmentId) setLinkedAppointmentId(incoming.appointmentId);
                      toast.info(`Iniciando consulta para: ${incoming.name}`);
                } else {
                      // Paciente real - buscamos en la lista cargada
                      const realPatient = loadedPatients.find(p => p.id === incoming.id);
                      if (realPatient) setSelectedPatient(realPatient);
                      else setSelectedPatient(incoming); 
                      
                      toast.success(`Paciente cargado: ${incoming.name}`);
                }

                if (location.state.linkedAppointmentId) {
                    setLinkedAppointmentId(location.state.linkedAppointmentId);
                    console.log("ðŸ”— Cita vinculada para cierre automÃ¡tico:", location.state.linkedAppointmentId);
                }
                
                window.history.replaceState({}, document.title);
            }
            else if (location.state?.patientName) {
                const incomingName = location.state.patientName;
                const existingPatient = loadedPatients.find((p: any) => p.name.toLowerCase() === incomingName.toLowerCase());

                if (existingPatient) {
                    setSelectedPatient(existingPatient);
                    toast.success(`Paciente cargado: ${incomingName}`);
                } else {
                    const tempPatient: any = { 
                        id: 'temp_' + Date.now(), 
                        name: incomingName,
                        isTemporary: true 
                    };
                    setSelectedPatient(tempPatient);
                    toast.info(`Consulta libre para: ${incomingName}`);
                }
                window.history.replaceState({}, document.title);
            } else {
                const savedDraft = localStorage.getItem(`draft_${user.id}`); 
                if (savedDraft && !transcript) { 
                    setTranscript(savedDraft); 
                    toast.info("Borrador recuperado.", { icon: <Save size={16}/> }); 
                }
            }
        }
      } catch (e) {}
    };
    loadInitialData();
    return () => { mounted = false; };
  }, [setTranscript, location.state]); 

  useEffect(() => {
    if (selectedPatient) {
        setPatientInsights(null);
        const isTemp = (selectedPatient as any).isTemporary;

        if (!isTemp && transcript && confirm("Â¿Desea limpiar el dictado anterior para el nuevo paciente?")) {
            resetTranscript();
            if (currentUserId) localStorage.removeItem(`draft_${currentUserId}`);
            setGeneratedNote(null);
            setIsRiskExpanded(false);
            startTimeRef.current = Date.now(); 
        } else if (!transcript) {
            setGeneratedNote(null);
            setIsRiskExpanded(false);
        }
    }
  }, [selectedPatient]); 

  useEffect(() => { 
    if (isListening && textareaRef.current) {
        textareaRef.current.scrollTop = textareaRef.current.scrollHeight;
    }
    if (transcript && currentUserId) {
        localStorage.setItem(`draft_${currentUserId}`, transcript);
    }
  }, [transcript, isListening, currentUserId]);

  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMessages, activeTab]);

  const filteredPatients = useMemo(() => {
    if (!searchTerm) return [];
    return patients.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
  }, [patients, searchTerm]);

  // --- ðŸ”¥ CORRECCIÃ“N: HIDRATACIÃ“N REACTIVA ---
  // Esta funciÃ³n ha sido reconstruida para garantizar que SIEMPRE tengamos el historial
  const handleSelectPatient = async (patient: any) => {
      // Caso 1: Paciente Fantasma (Sigue igual)
      if (patient.isGhost) {
          const tempPatient = {
              ...patient,
              id: `temp_${Date.now()}`,
              isTemporary: true,
              appointmentId: patient.appointmentId 
          };
          setSelectedPatient(tempPatient);
          if (patient.appointmentId) setLinkedAppointmentId(patient.appointmentId);
          toast.info(`Paciente temporal: ${patient.name} (Se registrarÃ¡ al guardar)`);
      } 
      // Caso 2: Paciente Registrado (AQUÃ ESTÃ LA MAGIA)
      else {
          // Primero, seteamos lo que ya tenemos visualmente para que se sienta rÃ¡pido
          setSelectedPatient(patient);
          setSearchTerm(''); // Limpiamos buscador

          // AHORA: HidrataciÃ³n Reactiva en segundo plano
          // Si el objeto 'patient' viene de una lista resumida, podrÃ­a no tener el 'history' completo.
          // Forzamos una bÃºsqueda fresca a la base de datos para estar seguros.
          try {
              // PequeÃ±o indicador visual de carga de datos
              const loadingHistory = toast.loading("Sincronizando historial...");
              
              const { data: fullPatientData, error } = await supabase
                  .from('patients')
                  .select('*') // Traemos TODO, incluyendo history
                  .eq('id', patient.id)
                  .single();

              toast.dismiss(loadingHistory);

              if (fullPatientData && !error) {
                  console.log("ðŸ’§ Paciente Hidratado Correctamente:", fullPatientData.name);
                  // Actualizamos el estado con los datos "frescos" y completos
                  setSelectedPatient(fullPatientData);
                  toast.success("Historial clÃ­nico cargado.");
              } else {
                  console.warn("âš ï¸ No se pudo hidratar el historial, usando datos en cachÃ©.");
              }
          } catch (e) {
              console.error("Error en hidrataciÃ³n reactiva:", e);
              // No bloqueamos, seguimos con los datos que ya tenÃ­amos
          }
      }
  };

  const handleCreateTemporary = (name: string) => {
      const tempPatient: any = { 
          id: 'temp_' + Date.now(), 
          name: name,
          isTemporary: true 
      };
      setSelectedPatient(tempPatient);
      setSearchTerm('');
      startTimeRef.current = Date.now(); 
      toast.info(`Nuevo paciente temporal: ${name} (Se guardarÃ¡ al finalizar)`);
  };

  const handleToggleRecording = () => {
    if (!isOnline) {
        toast.info("Sin internet: Use el teclado o el dictado de su dispositivo.");
        return;
    }
    if (isListening) stopListening();
    else {
      if (!isAPISupported) { toast.error("Navegador no compatible."); return; }
      if (!consentGiven) { toast.warning("Falta consentimiento."); return; }
      startListening();
    }
  };

  const handleClearTranscript = () => {
      if(confirm("Â¿Borrar borrador permanentemente?")) { 
          resetTranscript(); 
          if (currentUserId) localStorage.removeItem(`draft_${currentUserId}`); 
          setGeneratedNote(null); 
          setIsRiskExpanded(false); 
      }
  };

  const handleSoapChange = (section: 'subjective' | 'objective' | 'assessment' | 'plan', value: string) => {
      if (!generatedNote || !generatedNote.soap) return;
      setGeneratedNote(prev => {
          if (!prev || !prev.soap) return prev;
          return {
              ...prev,
              soap: {
                  ...prev.soap,
                  [section]: value
              }
          };
      });
  };

  const handleLoadInsights = async () => {
      if (!selectedPatient) return toast.error("Seleccione un paciente primero.");
      if ((selectedPatient as any).isTemporary) return toast.warning("Guarde la consulta primero para ver historial.");

      setIsInsightsOpen(true);
      if (patientInsights) return;

      setIsLoadingInsights(true);
      try {
          const { data: history } = await supabase
            .from('consultations')
            .select('summary, created_at')
            .eq('patient_id', selectedPatient.id)
            .order('created_at', { ascending: false })
            .limit(5);
          
          const consultationsText = history?.map(h => `[Fecha: ${new Date(h.created_at).toLocaleDateString()}] ${h.summary}`) || [];
          
          const analysis = await GeminiMedicalService.generatePatient360Analysis(
              selectedPatient.name, 
              selectedPatient.history || "No registrado", 
              consultationsText
          );
          
          setPatientInsights(analysis);
      } catch (error) {
          toast.error("Error analizando historial.");
          console.error(error);
          setIsInsightsOpen(false);
      } finally {
          setIsLoadingInsights(false);
      }
  };

  const handleGenerate = async () => {
    if (!transcript) return toast.error("Sin audio.");
    
    if (!isOnline) { 
        toast.warning("Modo Offline activo: La IA requiere internet.", { icon: <WifiOff/> });
        toast.info("La nota se ha guardado localmente. GenÃ©rela cuando recupere la conexiÃ³n.");
        return; 
    }

    if (abortControllerRef.current) abortControllerRef.current.abort();
    abortControllerRef.current = new AbortController();
    
    setIsProcessing(true);
    const loadingToast = toast.loading("Analizando caso clÃ­nico (RAG HÃ­brido)...");

    try {
      let fullMedicalContext = "";
      
      if (selectedPatient && !(selectedPatient as any).isTemporary) {
          
          const { data: historyData } = await supabase
              .from('consultations')
              .select('created_at, summary')
              .eq('patient_id', selectedPatient.id)
              .order('created_at', { ascending: false })
              .limit(3); 

          // AQUÃ SE USA EL DATO HIDRATADO QUE ACABAMOS DE TRAER EN handleSelectPatient
          const staticHistory = selectedPatient.history || "Sin antecedentes patolÃ³gicos registrados.";
          
          const episodicHistory = historyData && historyData.length > 0
              ? historyData.map(h => `[FECHA: ${new Date(h.created_at).toLocaleDateString()}] RESUMEN: ${h.summary.substring(0, 300)}...`).join("\n\n")
              : "Sin consultas previas en plataforma.";

          fullMedicalContext = `
            === [FUENTE A: HISTORIAL CLÃNICO CRÃTICO (VERDAD ABSOLUTA)] ===
            ${staticHistory}
            
            === [FUENTE B: EVOLUCIÃ“N RECIENTE (CONTEXTO)] ===
            ${episodicHistory}
          `;
      }

      const response = await GeminiMedicalService.generateClinicalNote(
          transcript, 
          selectedSpecialty, 
          fullMedicalContext 
      );
      
      if (!response || (!response.soap && !response.clinicalNote)) {
          throw new Error("La IA generÃ³ una respuesta vacÃ­a o invÃ¡lida.");
      }

      setGeneratedNote(response);
      setEditableInstructions(response.patientInstructions || '');
      
      // LÃ³gica de alerta inicial
      if (response.risk_analysis?.level === 'Alto') {
          setIsRiskExpanded(true);
          toast.dismiss(loadingToast);
          toast.error("âš ï¸ ALERTA: Se han detectado riesgos clÃ­nicos importantes.");
      } else if (response.risk_analysis?.level === 'Medio') {
          setIsRiskExpanded(false);
          toast.dismiss(loadingToast);
          toast.warning("AtenciÃ³n: Revise las alertas de riesgo moderado.");
      } else {
          setIsRiskExpanded(false);
          toast.dismiss(loadingToast);
          toast.success("Nota generada exitosamente.");
      }
      
      setActiveTab('record');
      
      const chatWelcome = fullMedicalContext 
          ? `He analizado la transcripciÃ³n cruzÃ¡ndola con el historial de ${selectedPatient?.name}. Â¿Desea ajustar algo?` 
          : `Nota de primera vez generada. Â¿Dudas?`;
          
      setChatMessages([{ role: 'model', text: chatWelcome }]);

    } catch (e) { 
        console.error("âŒ Error Critical en handleGenerate:", e);
        toast.dismiss(loadingToast);
        if(e instanceof Error && e.name !== 'AbortError') toast.error(`Error IA: ${e.message}`); 
    } finally { 
        setIsProcessing(false); 
    }
  };

  const handleSaveConsultation = async () => {
    if (!selectedPatient || !generatedNote) return toast.error("Faltan datos.");
    if (!isOnline) return toast.error("Requiere internet para sincronizar con la nube.");
    
    setIsSaving(true);
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("SesiÃ³n expirada");
        
        let finalPatientId = selectedPatient.id;

        if ((selectedPatient as any).isTemporary) {
            const { data: newPatient, error: createError } = await supabase.from('patients').insert({
                name: selectedPatient.name,
                doctor_id: user.id,
                history: JSON.stringify({ created_via: 'dashboard_quick_consult' })
            }).select().single();
            
            if (createError) throw createError;
            finalPatientId = newPatient.id;
            toast.success("Paciente registrado automÃ¡ticamente.");
        }

        const summaryToSave = generatedNote.soap 
            ? `FECHA: ${new Date().toLocaleDateString()}\nS: ${generatedNote.soap.subjective}\nO: ${generatedNote.soap.objective}\nA: ${generatedNote.soap.assessment}\nP: ${generatedNote.soap.plan}\n\nPLAN PACIENTE:\n${editableInstructions}`
            : (generatedNote.clinicalNote + "\n\nPLAN PACIENTE:\n" + editableInstructions);

        if (linkedAppointmentId) {
             await supabase.from('appointments')
                .update({ 
                    status: 'completed',
                    patient_id: finalPatientId 
                })
                .eq('id', linkedAppointmentId);
             console.log("âœ… Cita marcada como completada y vinculada en Dashboard");
        } else {
             await AppointmentService.markAppointmentAsCompleted(finalPatientId);
        }

        const durationSeconds = Math.round((Date.now() - startTimeRef.current) / 1000);

        const payload = {
            doctor_id: user.id, 
            patient_id: finalPatientId, 
            transcript: transcript || 'N/A', 
            summary: summaryToSave,
            status: 'completed',
            ai_analysis_data: generatedNote, 
            legal_status: 'validated',
            real_duration_seconds: durationSeconds 
        };

        const { error } = await supabase.from('consultations').insert(payload);
        
        if (error) throw error;
        
        toast.success("Nota validada y guardada en expediente");
        
        resetTranscript(); 
        if (currentUserId) localStorage.removeItem(`draft_${currentUserId}`); 
        setGeneratedNote(null); 
        setEditableInstructions(''); 
        setSelectedPatient(null); 
        setConsentGiven(false); 
        setIsRiskExpanded(false);
        setPatientInsights(null);
        setLinkedAppointmentId(null);
        startTimeRef.current = Date.now(); 

    } catch (e:any) { 
        console.error("Error guardando:", e);
        toast.error("Error al guardar: " + e.message); 
    } finally { 
        setIsSaving(false); 
    }
  };

  const handleChatSend = async (e?: React.FormEvent) => {
      e?.preventDefault();
      if (!chatInput.trim() || !generatedNote) return;
      if (!isOnline) return toast.error("Requiere internet");
      const msg = chatInput; setChatInput('');
      setChatMessages(p => [...p, { role: 'user', text: msg }]);
      setIsChatting(true);
      try {
          const soapContext = generatedNote.soap ? JSON.stringify(generatedNote.soap) : generatedNote.clinicalNote;
          const ctx = `NOTA ESTRUCTURADA: ${soapContext}\nPLAN PACIENTE: ${editableInstructions}`;
          const reply = await GeminiMedicalService.chatWithContext(ctx, msg);
          setChatMessages(p => [...p, { role: 'model', text: reply }]);
      } catch { toast.error("Error chat"); } finally { setIsChatting(false); }
  };

  const handleConfirmAppointment = async () => {
      if (!selectedPatient || !nextApptDate) return;
      try {
          await AppointmentService.createAppointment({
              patient_id: selectedPatient.id, title: "Seguimiento", start_time: new Date(nextApptDate).toISOString(),
              end_time: new Date(new Date(nextApptDate).getTime() + 30*60000).toISOString(), status: 'scheduled', notes: 'Auto-agendada'
          });
          toast.success("Cita creada"); setIsAppointmentModalOpen(false);
      } catch { toast.error("Error agendando"); }
  };

  const generatePDFBlob = async () => {
      if (!selectedPatient || !doctorProfile) return null;
      const ageDisplay = "No registrada"; 
      try {
        return await pdf(
            <PrescriptionPDF 
                doctorName={doctorProfile.full_name} 
                specialty={doctorProfile.specialty} 
                license={doctorProfile.license_number} 
                university={doctorProfile.university || "Universidad Nacional"} 
                phone={doctorProfile.phone || ""}
                address={doctorProfile.address || ""}
                logoUrl={doctorProfile.logo_url} 
                signatureUrl={doctorProfile.signature_url} 
                patientName={selectedPatient.name}
                patientAge={ageDisplay} 
                date={new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })}
                content={editableInstructions} 
            />
        ).toBlob();
      } catch (error) {
          console.error("Error generando PDF:", error);
          toast.error("Error al generar el PDF. Revise la consola.");
          return null;
      }
  };

  const handlePrint = async () => { 
      const loadingToast = toast.loading("Generando receta...");
      const blob = await generatePDFBlob(); 
      toast.dismiss(loadingToast);
      if(blob) {
          window.open(URL.createObjectURL(blob), '_blank');
      }
  };
  
  const handleShareWhatsApp = async () => { 
    if (!editableInstructions || !selectedPatient) return toast.error("No hay instrucciones.");
    const drName = doctorProfile?.full_name || 'su mÃ©dico';
    const message = `*Hola ${selectedPatient.name}, soy el Dr. ${drName}.*\n\n${editableInstructions}\n\n*Saludos.*`;
    const whatsappUrl = selectedPatient.phone && selectedPatient.phone.length >= 10 ? `https://wa.me/${selectedPatient.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}` : `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  };

  const handleQuickRx = () => {
    if (!selectedPatient) { toast.error("Seleccione paciente."); return; }
    setIsQuickRxModalOpen(true);
  };

  return (
    <div className="flex flex-col md:flex-row h-[calc(100vh-64px)] bg-slate-100 dark:bg-slate-950 relative">
      
      <div className={`w-full md:w-1/4 p-4 flex flex-col gap-4 border-r dark:border-slate-800 bg-white dark:bg-slate-900 overflow-y-auto ${generatedNote ? 'hidden md:flex' : 'flex'}`}>
        <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold dark:text-white flex items-center gap-2">
                Consulta IA
                <button onClick={() => setIsAttachmentsOpen(true)} className="p-2 ml-1 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 rounded-full text-slate-500 dark:text-slate-300 transition-colors" title="Ver archivos adjuntos"><Paperclip size={18} /></button>
            </h2>
            <div className="flex gap-2">
                {!isOnline && <span className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded font-bold flex items-center gap-1 animate-pulse"><WifiOff size={12}/> Offline</span>}
                {transcript && <button onClick={handleClearTranscript} className="text-slate-400 hover:text-red-500"><Trash2 size={18}/></button>}
            </div>
        </div>
        <div className="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg border border-indigo-100 dark:border-indigo-800">
            <div className="flex justify-between items-center mb-1">
                <label className="text-xs font-bold text-indigo-600 dark:text-indigo-300 uppercase flex gap-1"><Stethoscope size={14}/> Especialidad</label>
                {selectedPatient && !(selectedPatient as any).isTemporary && (
                    <button 
                        onClick={handleLoadInsights} 
                        className="flex items-center gap-1 text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full hover:bg-indigo-200 transition-colors"
                        title="Ver Balance 360"
                    >
                        <Sparkles size={10} /> Balance 360Â°
                    </button>
                )}
            </div>
            <select value={selectedSpecialty} onChange={(e)=>setSelectedSpecialty(e.target.value)} className="w-full bg-transparent border-b border-indigo-200 outline-none py-1 text-sm dark:text-white cursor-pointer">{SPECIALTIES.map(s=><option key={s} value={s}>{s}</option>)}</select>
        </div>
        <div className="relative z-10">
            <div className="flex items-center border rounded-lg px-3 py-2 bg-slate-50 dark:bg-slate-800 dark:border-slate-700">
                <Search className="text-slate-400 mr-2" size={18}/><input placeholder="Buscar paciente..." className="w-full bg-transparent outline-none dark:text-white text-sm" value={selectedPatient?selectedPatient.name:searchTerm} onChange={(e)=>{setSearchTerm(e.target.value);setSelectedPatient(null)}}/>
                {selectedPatient && <button onClick={()=>{setSelectedPatient(null);setSearchTerm('')}}><X size={16}/></button>}
            </div>
            {searchTerm && !selectedPatient && (
                <div className="absolute top-full left-0 w-full bg-white dark:bg-slate-800 border rounded-b-lg shadow-lg z-40 max-h-48 overflow-y-auto">
                    {filteredPatients.map(p => (
                        <div key={p.id} onClick={() => handleSelectPatient(p)} className="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b dark:border-slate-700 dark:text-white text-sm flex items-center justify-between">
                            <span>{p.name}</span>
                            {p.isGhost && <span className="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full flex items-center gap-1"><Calendar size={10}/> Cita sin registro</span>}
                        </div>
                    ))}
                    {filteredPatients.length === 0 && (
                        <div 
                            onClick={() => handleCreateTemporary(searchTerm)} 
                            className="p-3 hover:bg-teal-50 dark:hover:bg-teal-900/20 cursor-pointer border-b dark:border-slate-700 text-brand-teal font-bold text-sm flex items-center gap-2"
                        >
                            <UserPlus size={16}/>
                            <span>Crear Nuevo: "{searchTerm}"</span>
                        </div>
                    )}
                </div>
            )}
        </div>
        <div onClick={()=>setConsentGiven(!consentGiven)} className="flex items-center gap-2 p-3 rounded-lg border cursor-pointer select-none dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"><div className={`w-5 h-5 rounded border flex items-center justify-center ${consentGiven?'bg-green-500 border-green-500 text-white':'bg-white dark:bg-slate-700'}`}>{consentGiven&&<Check size={14}/>}</div><label className="text-xs dark:text-white cursor-pointer">Consentimiento otorgado.</label></div>
        
        <div className={`flex-1 border-2 border-dashed rounded-2xl flex flex-col items-center justify-center p-4 relative transition-colors min-h-[300px] ${!isOnline ? 'border-amber-300 bg-amber-50 dark:bg-amber-900/10' : (isListening?'border-red-400 bg-red-50 dark:bg-red-900/10':'border-slate-200 dark:border-slate-700')}`}>
            
            {!transcript && (
                <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-50">
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${!isOnline ? 'bg-amber-100 text-amber-500' : 'bg-slate-100 dark:bg-slate-800 text-slate-300'}`}>
                        {!isOnline ? <WifiOff size={32}/> : <Mic size={32}/>}
                    </div>
                    <p className="text-sm font-medium text-slate-400">
                        {!isOnline ? "Modo Offline" : "Listo para iniciar"}
                    </p>
                </div>
            )}

            {!isOnline && (
                <div className="relative w-full z-10 bg-white/80 dark:bg-slate-800/80 p-2 rounded-lg text-xs text-center text-amber-700 dark:text-amber-400 mb-2 border border-amber-200 dark:border-amber-800">
                    <Keyboard size={14} className="inline mr-1"/>
                    Use el micrÃ³fono de su <b>teclado</b> para dictar.
                </div>
            )}

            <textarea 
                ref={textareaRef}
                className={`w-full flex-1 bg-transparent p-2 rounded-xl text-base leading-relaxed resize-none focus:outline-none dark:text-slate-200 z-10 custom-scrollbar ${!transcript ? 'opacity-0' : 'opacity-100'}`}
                value={transcript}
                onChange={(e) => setTranscript(e.target.value)}
                placeholder="" 
            />
            
            <div ref={transcriptEndRef}/>
            
            <div className="flex w-full gap-2 mt-auto flex-col xl:flex-row z-20 pt-4">
                <button 
                    onClick={handleToggleRecording} 
                    disabled={!isOnline || !consentGiven || (!isAPISupported && !isListening)} 
                    className={`flex-1 py-3 rounded-xl font-bold flex justify-center gap-2 text-white shadow-lg text-sm transition-all ${
                        !isOnline ? 'bg-slate-300 dark:bg-slate-700 cursor-not-allowed text-slate-500' :
                        isListening ? 'bg-red-600 hover:bg-red-700' : 
                        'bg-slate-900 hover:bg-slate-800'
                    }`}
                >
                    {isListening ? <><Square size={16}/> Parar</> : <><Mic size={16}/> Grabar</>}
                </button>

                <button 
                    onClick={handleGenerate} 
                    disabled={!transcript || isListening || isProcessing} 
                    className={`flex-1 text-white py-3 rounded-xl font-bold shadow-lg flex justify-center gap-2 disabled:opacity-50 text-sm transition-all ${
                        !isOnline ? 'bg-amber-500 hover:bg-amber-600' : 
                        'bg-brand-teal hover:bg-teal-600'
                    }`}
                >
                    {isProcessing ? <RefreshCw className="animate-spin" size={16}/> : (isOnline ? <RefreshCw size={16}/> : <Save size={16}/>)} 
                    {isProcessing ? '...' : (isOnline ? 'Generar' : 'Guardar')}
                </button>
            </div>
            
            <button onClick={()=>{if(selectedPatient && doctorProfile) setIsQuickRxModalOpen(true)}} disabled={!selectedPatient} className="w-full mt-2 py-2 text-brand-teal font-bold border border-brand-teal/30 rounded-xl hover:bg-teal-50 dark:hover:bg-teal-900/20 disabled:opacity-50 transition-colors text-xs flex items-center justify-center gap-2 z-20"><FileText size={14}/> Receta RÃ¡pida</button>
        </div>
      </div>
      
      <div className={`w-full md:w-3/4 bg-slate-100 dark:bg-slate-950 flex flex-col border-l dark:border-slate-800 ${!generatedNote?'hidden md:flex':'flex h-full'}`}>
          <div className="flex border-b dark:border-slate-800 bg-white dark:bg-slate-900 shrink-0 items-center px-2">
             <button onClick={()=>setGeneratedNote(null)} className="md:hidden p-4 text-slate-500"><ArrowLeft/></button>
             {[{id:'record',icon:FileText,l:'EXPEDIENTE CLÃNICO'},{id:'patient',icon:User,l:'PLAN PACIENTE'},{id:'chat',icon:MessageSquare,l:'ASISTENTE'}].map(t=><button key={t.id} onClick={()=>setActiveTab(t.id as TabType)} disabled={!generatedNote&&t.id!=='record'} className={`flex-1 py-4 flex justify-center gap-2 text-sm font-bold border-b-4 transition-colors ${activeTab===t.id?'text-brand-teal border-brand-teal':'text-slate-400 border-transparent hover:text-slate-600'}`}><t.icon size={18}/><span className="hidden sm:inline">{t.l}</span></button>)}
          </div>
          
          <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-100 dark:bg-slate-950">
             {!generatedNote ? (
                 <div className="h-full flex flex-col items-center justify-center text-slate-400 gap-4 opacity-50">
                     <FileText size={64} strokeWidth={1}/>
                     <p className="text-lg text-center px-4">Ãrea de DocumentaciÃ³n</p>
                 </div>
             ) : (
                 <div className="min-h-full flex flex-col max-w-4xl mx-auto w-full gap-4 relative pb-8">
                      {activeTab==='record' && generatedNote.soap && (
                        <div className="bg-white dark:bg-slate-900 rounded-sm shadow-lg border border-slate-200 dark:border-slate-800 p-8 md:p-12 min-h-full h-fit pb-32 animate-fade-in-up relative">
                            <div className="sticky top-0 z-20 bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm border-b border-slate-100 dark:border-slate-800 pb-4 mb-8 -mx-2 px-2 flex flex-col gap-2">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h1 className="text-2xl font-bold text-slate-900 dark:text-white">Nota de EvoluciÃ³n</h1>
                                        <p className="text-sm text-slate-500 dark:text-slate-400 uppercase tracking-wide">{selectedSpecialty}</p>
                                    </div>
                                    <div className="flex flex-col items-end gap-2">
                                        <button onClick={handleSaveConsultation} disabled={isSaving} className="bg-brand-teal text-white px-4 py-2 rounded-lg font-bold flex gap-2 hover:bg-teal-600 shadow-md transition-all disabled:opacity-70 text-sm items-center">
                                                {isSaving?<RefreshCw className="animate-spin" size={16}/>:<Save size={16}/>} Validar y Guardar
                                        </button>
                                    </div>
                                </div>

                                {generatedNote.risk_analysis && (
                                    <div 
                                      onClick={() => setIsRiskExpanded(!isRiskExpanded)}
                                      className={`mt-2 w-full rounded-xl border cursor-pointer transition-all duration-300 overflow-hidden ${
                                          generatedNote.risk_analysis.level.toUpperCase().includes('ALTO') ? 'bg-red-50 border-red-200' :
                                          generatedNote.risk_analysis.level.toUpperCase().includes('MEDIO') ? 'bg-amber-50 border-amber-200' :
                                          'bg-green-50 border-green-200'
                                      }`}
                                    >
                                        <div className={`p-3 flex justify-between items-center ${
                                            generatedNote.risk_analysis.level.toUpperCase().includes('ALTO') ? 'text-red-700' :
                                            generatedNote.risk_analysis.level.toUpperCase().includes('MEDIO') ? 'text-amber-700' :
                                            'text-green-700'
                                        }`}>
                                            <div className="flex items-center gap-2 font-bold text-sm">
                                                <AlertTriangle size={16}/>
                                                <span>Riesgo {generatedNote.risk_analysis.level}</span>
                                                {!isRiskExpanded && <span className="opacity-70 font-normal text-xs ml-2">(Toca para ver detalles)</span>}
                                            </div>
                                            {isRiskExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                                        </div>

                                        <div className={`px-4 pb-4 text-sm leading-relaxed transition-all duration-300 ${
                                            generatedNote.risk_analysis.level.toUpperCase().includes('ALTO') ? 'text-red-800' :
                                            generatedNote.risk_analysis.level.toUpperCase().includes('MEDIO') ? 'text-amber-800' :
                                            'text-green-800'
                                        } ${isRiskExpanded ? 'block animate-fade-in' : 'hidden'}`}>
                                            <hr className={`mb-2 opacity-20 border-current`}/>
                                            {generatedNote.risk_analysis.reason}
                                        </div>
                                    </div>
                                )}

                                <div className="text-xs font-bold text-slate-800 dark:text-slate-200 self-end">
                                    {selectedPatient?.name || "Paciente no registrado"}
                                </div>
                            </div>

                            {generatedNote.conversation_log && generatedNote.conversation_log.length > 0 && (
                                <div className="mb-10 bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-6 border border-slate-100 dark:border-slate-800">
                                    <h4 className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                        <Quote size={14} className="text-indigo-500"/> TranscripciÃ³n Inteligente
                                    </h4>
                                    <div className="space-y-4 max-h-[300px] overflow-y-auto custom-scrollbar pr-2">
                                            {generatedNote.conversation_log.map((line, idx) => (
                                                <div key={idx} className={`flex ${line.speaker === 'MÃ©dico' ? 'justify-end' : 'justify-start'}`}>
                                                    <div className={`max-w-[80%] rounded-2xl p-3 text-sm ${
                                                        line.speaker === 'MÃ©dico' 
                                                            ? 'bg-blue-50 text-blue-900 dark:bg-blue-900/30 dark:text-blue-100 rounded-tr-none' 
                                                            : 'bg-white border border-slate-200 text-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-700 rounded-tl-none'
                                                    }`}>
                                                        <span className={`text-[10px] font-bold block mb-1 uppercase opacity-70 ${line.speaker === 'MÃ©dico' ? 'text-right' : 'text-left'}`}>
                                                            {line.speaker}
                                                        </span>
                                                        {line.text}
                                                    </div>
                                                </div>
                                            ))}
                                    </div>
                                </div>
                            )}
                            
                            <div className="space-y-8">
                                <div className="group relative">
                                    <h4 className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2"><Activity size={14} className="text-blue-500"/> Subjetivo <PenLine size={12} className="opacity-0 group-hover:opacity-50"/></h4>
                                    <textarea className="w-full bg-transparent text-slate-800 dark:text-slate-200 leading-7 text-base pl-1 resize-none overflow-hidden outline-none focus:ring-1 focus:ring-blue-200 rounded p-1 transition-all" value={generatedNote.soap.subjective} onChange={(e) => handleSoapChange('subjective', e.target.value)} ref={(el) => { if(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }}}/>
                                </div>
                                <hr className="border-slate-100 dark:border-slate-800" />
                                <div className="group relative">
                                    <h4 className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2"><ClipboardList size={14} className="text-green-500"/> Objetivo <PenLine size={12} className="opacity-0 group-hover:opacity-50"/></h4>
                                    <textarea className="w-full bg-transparent text-slate-800 dark:text-slate-200 leading-7 text-base pl-1 resize-none overflow-hidden outline-none focus:ring-1 focus:ring-green-200 rounded p-1 transition-all" value={generatedNote.soap.objective} onChange={(e) => handleSoapChange('objective', e.target.value)} ref={(el) => { if(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }}}/>
                                </div>
                                <hr className="border-slate-100 dark:border-slate-800" />
                                <div className="group relative">
                                    <h4 className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2"><Brain size={14} className="text-amber-500"/> AnÃ¡lisis y DiagnÃ³stico <PenLine size={12} className="opacity-0 group-hover:opacity-50"/></h4>
                                    <textarea className="w-full bg-transparent text-slate-800 dark:text-slate-200 leading-7 text-base pl-1 resize-none overflow-hidden outline-none focus:ring-1 focus:ring-amber-200 rounded p-1 transition-all" value={generatedNote.soap.assessment} onChange={(e) => handleSoapChange('assessment', e.target.value)} ref={(el) => { if(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }}}/>
                                </div>
                                <hr className="border-slate-100 dark:border-slate-800" />
                                <div className="group relative">
                                    <h4 className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2"><FileSignature size={14} className="text-purple-500"/> Plan MÃ©dico <PenLine size={12} className="opacity-0 group-hover:opacity-50"/></h4>
                                    <textarea className="w-full bg-transparent text-slate-800 dark:text-slate-200 leading-7 text-base pl-1 resize-none overflow-hidden outline-none focus:ring-1 focus:ring-purple-200 rounded p-1 transition-all" value={generatedNote.soap.plan} onChange={(e) => handleSoapChange('plan', e.target.value)} ref={(el) => { if(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }}}/>
                                </div>
                            </div>
                        </div>
                      )}

                      {activeTab==='record' && !generatedNote.soap && generatedNote.clinicalNote && (
                          <div className="bg-white dark:bg-slate-900 p-8 rounded-xl shadow-sm h-full flex flex-col border dark:border-slate-800 overflow-hidden">
                                <div className="bg-yellow-50 text-yellow-800 p-2 text-sm rounded mb-2 dark:bg-yellow-900/30 dark:text-yellow-200">Formato antiguo.</div>
                              <div className="flex-1 overflow-y-auto pr-4 custom-scrollbar"><FormattedText content={generatedNote.clinicalNote}/></div>
                              <div className="border-t dark:border-slate-800 pt-4 flex justify-end"><button onClick={handleSaveConsultation} disabled={isSaving} className="bg-brand-teal text-white px-6 py-3 rounded-xl font-bold flex gap-2 hover:bg-teal-600 shadow-lg disabled:opacity-70">{isSaving?<RefreshCw className="animate-spin"/>:<Save/>} Guardar</button></div>
                          </div>
                      )}

                      {activeTab==='patient' && (
                          <div className="bg-white dark:bg-slate-900 p-6 rounded-xl shadow-sm h-full flex flex-col border dark:border-slate-800 animate-fade-in-up">
                              <div className="flex justify-between items-center mb-4 border-b dark:border-slate-800 pb-2">
                                  <h3 className="font-bold text-lg dark:text-white flex items-center gap-2"><FileText className="text-brand-teal"/> Instrucciones</h3>
                                  <div className="flex gap-2">
                                      <button onClick={handleShareWhatsApp} className="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 dark:bg-green-900/20 dark:text-green-400"><Share2 size={18}/></button>
                                      <button onClick={handlePrint} className="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400"><Download size={18}/></button>
                                      <button onClick={()=>setIsEditingInstructions(!isEditingInstructions)} className={`p-2 rounded-lg transition-colors ${isEditingInstructions ? 'bg-brand-teal text-white' : 'bg-slate-50 text-slate-600 hover:bg-slate-100 dark:bg-slate-800 dark:text-slate-300'}`}>{isEditingInstructions?<Check size={18}/>:<Edit2 size={18}/>}</button>
                                  </div>
                              </div>
                              <div className="flex-1 overflow-y-auto custom-scrollbar p-1">
                                  {isEditingInstructions ? <textarea className="w-full h-full border dark:border-slate-700 p-4 rounded-lg bg-slate-50 dark:bg-slate-800 dark:text-white resize-none outline-none focus:ring-2 focus:ring-brand-teal font-medium" value={editableInstructions} onChange={e=>setEditableInstructions(e.target.value)}/> : <div className="prose dark:prose-invert max-w-none"><FormattedText content={editableInstructions}/></div>}
                              </div>
                          </div>
                      )}

                      {activeTab==='chat' && (
                          <div className="bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm h-full flex flex-col border dark:border-slate-800 animate-fade-in-up">
                              <div className="flex-1 overflow-y-auto mb-4 pr-2 custom-scrollbar">
                                  {chatMessages.map((m,i)=><div key={i} className={`p-3 mb-3 rounded-2xl max-w-[85%] text-sm shadow-sm ${m.role==='user'?'bg-brand-teal text-white self-end ml-auto rounded-tr-none':'bg-slate-100 dark:bg-slate-800 dark:text-slate-200 self-start mr-auto rounded-tl-none'}`}>{m.text}</div>)}
                                  <div ref={chatEndRef}/>
                              </div>
                              <form onSubmit={handleChatSend} className="flex gap-2 relative"><input className="flex-1 border dark:border-slate-700 p-4 pr-12 rounded-xl bg-slate-50 dark:bg-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-brand-teal shadow-sm" value={chatInput} onChange={e=>setChatInput(e.target.value)} placeholder="Pregunta..."/><button disabled={isChatting||!chatInput.trim()} className="absolute right-3 top-1/2 -translate-y-1/2 bg-brand-teal text-white p-2 rounded-lg hover:bg-teal-600 disabled:opacity-50 transition-all hover:scale-105 active:scale-95">{isChatting?<RefreshCw className="animate-spin" size={18}/>:<Send size={18}/>}</button></form>
                          </div>
                      )}
                 </div>
             )}
          </div>
      </div>

      {isAttachmentsOpen && selectedPatient && (
        <div className="fixed inset-0 z-50 flex justify-end">
            <div className="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity" onClick={() => setIsAttachmentsOpen(false)} />
            <div className="relative w-full max-w-2xl bg-white dark:bg-slate-900 h-full shadow-2xl p-4 flex flex-col border-l dark:border-slate-800 animate-slide-in-right">
                <div className="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-800">
                    <div><h3 className="font-bold text-lg dark:text-white flex items-center gap-2"><Paperclip size={20} className="text-brand-teal"/> Expediente Digital</h3><p className="text-xs text-slate-500">Paciente: {selectedPatient.name}</p></div>
                    <button onClick={() => setIsAttachmentsOpen(false)} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"><X size={20} className="text-slate-500"/></button>
                </div>
                <div className="flex-1 overflow-y-auto flex flex-col gap-4">
                    <div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg"><p className="text-xs font-bold text-slate-500 mb-2 uppercase">Agregar archivo:</p><UploadMedico preSelectedPatient={selectedPatient} onUploadComplete={() => { toast.success("Archivo agregado."); }} /></div>
                    <div className="flex-1"><p className="text-xs font-bold text-slate-500 mb-2 uppercase">Historial:</p><DoctorFileGallery patientId={selectedPatient.id} /></div>
                </div>
            </div>
        </div>
      )}

      {isAppointmentModalOpen && <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-slate-900 rounded-2xl p-6 max-w-sm w-full animate-fade-in-up"><h3 className="font-bold text-lg mb-4 dark:text-white">Agendar Seguimiento</h3><input type="datetime-local" className="w-full border dark:border-slate-700 p-3 rounded-xl mb-6 bg-slate-50 dark:bg-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-brand-teal" value={nextApptDate} onChange={e=>setNextApptDate(e.target.value)}/><div className="flex justify-end gap-3"><button onClick={()=>setIsAppointmentModalOpen(false)} className="text-slate-500 font-medium">Cancelar</button><button onClick={handleConfirmAppointment} className="bg-brand-teal text-white px-4 py-2 rounded-xl font-bold">Confirmar</button></div></div></div>}
      
      {isQuickRxModalOpen && selectedPatient && doctorProfile && <QuickRxModal isOpen={isQuickRxModalOpen} onClose={()=>setIsQuickRxModalOpen(false)} initialTranscript={transcript} patientName={selectedPatient.name} doctorProfile={doctorProfile}/>}
      
      {selectedPatient && (
        <InsightsPanel 
            isOpen={isInsightsOpen}
            onClose={() => setIsInsightsOpen(false)}
            insights={patientInsights}
            isLoading={isLoadingInsights}
            patientName={selectedPatient.name}
        />
      )}
    </div>
  );
};
export default ConsultationView;

--------------------------------------------------
ðŸ“ PATH: src\components\DigitalCard.tsx
--------------------------------------------------
import React, { useState, useEffect, useMemo } from 'react';
import QRCode from 'react-qr-code';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../lib/supabase';
import { 
  Share2, Users, Clock, FileText, 
  Search, BookOpen, Activity, Globe, 
  ExternalLink, Download, 
  Calendar, Stethoscope, Briefcase
} from 'lucide-react';

// IMPORTACIÃ“N DE MÃ“DULOS
import { InteractiveClinicalCase } from './InteractiveClinicalCase';
import { MedicalCalculators } from './MedicalCalculators';
import { QuickNotes } from './QuickNotes'; // <--- AQUÃ IMPORTAMOS EL BLOC

// --- TIPOS ---
interface MedicalNews {
  id?: string;
  title: string;
  summary: string;
  source: string;
  url: string;
  created_at?: string;
}

interface UserProfile {
  full_name: string;
  specialty: string;
  phone?: string;
  license_number?: string;
  logo_url?: string;
  website_url?: string;
  address?: string;
  university?: string;
  [key: string]: any;
}

const generateVCard = (profile: UserProfile | null) => {
    if (!profile) return;
    const safeName = profile.full_name || 'Doctor';
    const safeParts = safeName.split(' ');
    const lastName = safeParts.length > 1 ? safeParts.pop() : '';
    const firstName = safeParts.join(' ');

    const vCardData = [
        'BEGIN:VCARD',
        'VERSION:3.0',
        `FN:Dr. ${safeName}`,
        `N:${lastName};${firstName};Dr.;;`,
        `ORG:MediScribe AI - ${profile.university || 'Consultorio Privado'}`,
        `TITLE:${profile.specialty || 'Medicina General'}`,
        `TEL;TYPE=CELL:${profile.phone || ''}`,
        `URL:${profile.website_url || ''}`,
        `ADR;TYPE=WORK:;;${profile.address || ''};;;;`,
        `NOTE:CÃ©dula Profesional: ${profile.license_number || 'N/A'}`,
        'END:VCARD'
    ].join('\n');

    try {
        const blob = new Blob([vCardData], { type: 'text/vcard;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `Dr_${safeName.replace(/\s+/g, '_')}.vcf`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (e) {
        console.error("Error generando vCard", e);
    }
};

const DigitalCard: React.FC = () => {
  const navigate = useNavigate();
  
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [newsFeed, setNewsFeed] = useState<MedicalNews[]>([]); 
  const [stats, setStats] = useState({ patientsCount: 0, avgDuration: 0, loadingStats: true });
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');

  const STATIC_NEWS: MedicalNews[] = [
    { title: 'FDA Aprueba Voyxact', summary: 'Tratamiento para nefropatÃ­a por IgA.', source: 'FDA', url: 'https://www.fda.gov' },
    { title: 'GuÃ­as IDSA 2025', summary: 'Manejo de infecciones urinarias.', source: 'IDSA', url: 'https://www.idsociety.org' }
  ];

  useEffect(() => {
    let mounted = true;
    const init = async () => {
        await loadData();
        if(mounted) fetchNews();
    };
    init();
    return () => { mounted = false; };
  }, []);

  const fetchNews = async () => {
    try {
      const { data, error } = await supabase
        .from('medical_news')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(10);

      if (!error && data && data.length > 0) {
        setNewsFeed(data);
      } else {
        setNewsFeed(STATIC_NEWS); 
      }
    } catch (e) {
      setNewsFeed(STATIC_NEWS);
    }
  };

  const loadData = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        const { data: profileData } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        setProfile(profileData || { full_name: 'Doctor', specialty: 'Medicina General' });

        let finalCount = 0;
        const { count: countDoc } = await supabase.from('patients').select('*', { count: 'exact', head: true }).eq('doctor_id', user.id);
        if (countDoc !== null) finalCount = countDoc;
        else {
            const { count: countUser } = await supabase.from('patients').select('*', { count: 'exact', head: true }).eq('user_id', user.id);
            if (countUser !== null) finalCount = countUser;
        }

        let calculatedAvg = 0;
        const { data: consults } = await supabase.from('consultations').select('summary').eq('doctor_id', user.id).limit(50);
        if (consults && consults.length > 0) {
            const total = consults.reduce((acc, curr) => acc + (15 + Math.round((curr.summary?.length || 0)/50)), 0);
            calculatedAvg = Math.round(total / consults.length);
        } else {
             const { data: appts } = await supabase.from('appointments').select('duration_minutes').eq('doctor_id', user.id);
             if (appts && appts.length > 0) {
                 const total = appts.reduce((acc, curr) => acc + (curr.duration_minutes || 0), 0);
                 calculatedAvg = Math.round(total / appts.length);
             }
        }
        
        setStats({ patientsCount: finalCount, avgDuration: calculatedAvg, loadingStats: false });
      }
    } catch (error) { console.error(error); } finally { setLoading(false); }
  };

  const profileCompleteness = useMemo(() => {
    if (!profile) return 0;
    const fields = ['full_name', 'specialty', 'phone', 'license_number', 'logo_url', 'website_url', 'address'];
    const filled = fields.filter(f => {
        const val = profile[f];
        return typeof val === 'string' && val.trim() !== '';
    }).length;
    return Math.round((filled / fields.length) * 100);
  }, [profile]);

  const handleNewsClick = (newsItem: MedicalNews) => {
    if (newsItem.url && newsItem.url.startsWith('http')) {
        window.open(newsItem.url, '_blank');
    } else {
        const query = encodeURIComponent(newsItem.title + " medical study");
        window.open(`https://www.google.com/search?q=${query}`, '_blank');
    }
  };

  const handleSearch = (e: React.FormEvent) => {
      e.preventDefault();
      if(!searchTerm.trim()) return;
      window.open(`https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(searchTerm)}`, '_blank');
  };

  const getQRTarget = () => {
    if (profile?.website_url) return profile.website_url;
    if (profile?.phone) return `https://wa.me/${profile.phone.replace(/\D/g, '')}`;
    return window.location.href;
  };

  const handleShare = async () => {
    if (navigator.share) try { await navigator.share({ title: `Dr. ${profile?.full_name}`, url: getQRTarget() }); } catch (e) {}
    else alert("Enlace copiado manualmente.");
  };

  if (loading) return <div className="flex justify-center items-center h-full text-slate-400 gap-2"><Activity className="animate-spin"/> Cargando Hub...</div>;

  return (
    <div className="h-full overflow-y-auto p-4 md:p-6 bg-slate-50/30">
      
      <div className="mb-6 flex flex-col md:flex-row md:justify-between md:items-end gap-4">
        <div>
            <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">Hub Profesional <span className="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded-full uppercase tracking-wider">v2.1</span></h1>
            <p className="text-slate-500 text-sm">Panel de control estratÃ©gico y herramientas clÃ­nicas.</p>
        </div>
        <div className="flex gap-2">
            <button onClick={() => navigate('/consultation')} className="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-slate-50 flex items-center gap-2 transition-all"><Stethoscope size={16}/> Nueva Consulta</button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
        
        {/* COLUMNA IZQUIERDA (IDENTIDAD DIGITAL) */}
        <div className="lg:col-span-4 flex flex-col gap-4">
            <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 relative group hover:shadow-2xl transition-all duration-300">
                <div className="h-28 bg-gradient-to-br from-slate-800 via-slate-900 to-black relative">
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <div className="absolute top-4 right-4 text-white/20"><Briefcase size={24}/></div>
                </div>
                <div className="px-6 pb-6 text-center relative">
                    <div className="-mt-14 mb-4 inline-block p-1.5 bg-white rounded-2xl shadow-lg ring-4 ring-slate-50">
                        <div className="w-28 h-28 bg-slate-100 rounded-xl flex items-center justify-center overflow-hidden border border-slate-200">
                            {profile?.logo_url ? <img src={profile.logo_url} alt="Logo" className="w-full h-full object-cover"/> : <span className="text-4xl font-bold text-slate-300">{profile?.full_name?.charAt(0)}</span>}
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-900 leading-tight">{profile?.full_name}</h3>
                    <p className="text-teal-600 font-bold text-xs uppercase tracking-wide mt-1 mb-6">{profile?.specialty}</p>
                    
                    <div className="bg-white p-4 rounded-2xl border-2 border-dashed border-slate-200 inline-block mb-6 group-hover:border-teal-400 transition-colors">
                        <QRCode value={getQRTarget()} size={120} level="M" fgColor="#0f172a"/>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={handleShare} className="flex items-center justify-center gap-2 py-2.5 bg-slate-900 text-white rounded-xl text-sm font-bold hover:bg-slate-800 shadow-lg shadow-slate-900/20 active:scale-95 transition-all">
                            <Share2 size={16}/> Compartir
                        </button>
                        <button onClick={() => generateVCard(profile)} className="flex items-center justify-center gap-2 py-2.5 bg-teal-50 text-teal-700 rounded-xl text-sm font-bold hover:bg-teal-100 border border-teal-100 active:scale-95 transition-all">
                            <Download size={16}/> Guardar vCard
                        </button>
                    </div>
                </div>
            </div>
            
            {/* Barra de Progreso */}
            <div className="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm relative overflow-hidden">
                <div className="flex justify-between items-center mb-3 relative z-10">
                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wide">Perfil Profesional</span>
                    <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${profileCompleteness === 100 ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>{profileCompleteness}%</span>
                </div>
                <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden relative z-10">
                    <div className={`h-full rounded-full transition-all duration-1000 ${profileCompleteness === 100 ? 'bg-green-500' : 'bg-amber-400'}`} style={{width: `${profileCompleteness}%`}}></div>
                </div>
                {profileCompleteness < 100 && (
                    <button onClick={() => navigate('/settings')} className="mt-4 w-full text-xs font-bold text-slate-600 hover:text-teal-600 flex items-center justify-center gap-1 transition-colors relative z-10">
                        Completar InformaciÃ³n <ExternalLink size={10}/>
                    </button>
                )}
            </div>

            {/* --- INTEGRACIÃ“N BLOC DE NOTAS --- */}
            <QuickNotes />

        </div>

        {/* COLUMNA DERECHA (OPERACIONES) */}
        <div className="lg:col-span-8 flex flex-col gap-6">
            
            {/* ZONA: Herramientas ClÃ­nicas */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InteractiveClinicalCase />
                <MedicalCalculators />
            </div>

            {/* KPIs & Accesos RÃ¡pidos */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-between aspect-square md:aspect-auto md:h-28 group hover:border-blue-200 transition-colors">
                    <div className="flex justify-between items-start"><div className="p-2 bg-blue-50 text-blue-600 rounded-xl group-hover:scale-110 transition-transform"><Users size={20}/></div></div>
                    <div><span className="text-2xl font-bold text-slate-800">{stats.patientsCount}</span><p className="text-xs text-slate-500 font-medium">Pacientes</p></div>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-between aspect-square md:aspect-auto md:h-28 group hover:border-purple-200 transition-colors">
                    <div className="flex justify-between items-start"><div className="p-2 bg-purple-50 text-purple-600 rounded-xl group-hover:scale-110 transition-transform"><Clock size={20}/></div></div>
                    <div><span className="text-2xl font-bold text-slate-800">{stats.avgDuration > 0 ? stats.avgDuration + 'm' : '--'}</span><p className="text-xs text-slate-500 font-medium">Promedio</p></div>
                </div>
                <button onClick={() => navigate('/agenda')} className="bg-slate-50 hover:bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md flex flex-col justify-center items-center text-center aspect-square md:aspect-auto md:h-28 transition-all group">
                    <Calendar size={24} className="text-slate-400 group-hover:text-teal-600 mb-2 transition-colors"/>
                    <span className="text-xs font-bold text-slate-600 group-hover:text-slate-800">Agenda</span>
                </button>
                <button onClick={() => navigate('/reports')} className="bg-slate-50 hover:bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md flex flex-col justify-center items-center text-center aspect-square md:aspect-auto md:h-28 transition-all group">
                    <FileText size={24} className="text-slate-400 group-hover:text-teal-600 mb-2 transition-colors"/>
                    <span className="text-xs font-bold text-slate-600 group-hover:text-slate-800">Reportes</span>
                </button>
            </div>

            {/* Buscador de Evidencia */}
            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden p-6 relative">
                <div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none"><Search size={100}/></div>
                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Globe size={18} className="text-teal-500"/> InvestigaciÃ³n ClÃ­nica</h3>
                <form onSubmit={handleSearch} className="relative mb-6 z-10">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                    <input type="text" placeholder="Buscar artÃ­culos en PubMed, guÃ­as, dosis..." className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-teal-500 focus:bg-white transition-all shadow-inner" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                </form>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 z-10 relative">
                    {[{name:'PLM / VademÃ©cum', url:'https://www.medicamentosplm.com/', icon:BookOpen}, {name:'MDCalc', url:'https://www.mdcalc.com/', icon:Activity}, {name:'CIE-10 OMS', url:'https://icd.who.int/', icon:FileText}, {name:'CENETEC GuÃ­as', url:'https://cenetec-difusion.com/', icon:Globe}].map((t, i) => (
                        <a key={i} href={t.url} target="_blank" rel="noreferrer" className="flex items-center gap-2 p-3 rounded-xl border border-slate-100 hover:bg-teal-50 hover:border-teal-100 transition-all group">
                            <div className="p-1.5 bg-slate-100 rounded-lg group-hover:bg-white group-hover:text-teal-600 transition-colors"><t.icon size={14} className="text-slate-500 group-hover:text-teal-600"/></div>
                            <span className="text-[10px] font-bold text-slate-600 group-hover:text-slate-800 leading-tight">{t.name}</span>
                        </a>
                    ))}
                </div>
            </div>

            {/* Feed de Noticias (BLINDADO) */}
            <div className="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden flex-1 max-h-[400px] overflow-y-auto custom-scrollbar relative">
                <div className="p-4 border-b border-slate-100 bg-white/90 backdrop-blur sticky top-0 z-20 flex justify-between items-center">
                    <h3 className="font-bold text-slate-800 flex items-center gap-2"><span className="flex h-2.5 w-2.5 relative"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"></span></span> Actualizaciones MÃ©dicas</h3>
                </div>
                <div className="divide-y divide-slate-50">
                    {newsFeed.map((news, idx) => (
                        <div key={idx} onClick={() => handleNewsClick(news)} className="p-5 hover:bg-slate-50 cursor-pointer group transition-colors">
                            <div className="flex justify-between items-start mb-2">
                                <span className="text-[10px] font-bold px-2 py-0.5 rounded-md bg-slate-100 text-slate-600 group-hover:bg-teal-100 group-hover:text-teal-700 transition-colors">{news.source}</span>
                                <ExternalLink size={14} className="text-slate-300 group-hover:text-teal-500 transition-colors"/>
                            </div>
                            <h4 className="text-sm font-bold text-slate-800 mb-1 group-hover:text-teal-700 transition-colors">{news.title}</h4>
                            <p className="text-xs text-slate-500 leading-relaxed line-clamp-2">{news.summary}</p>
                        </div>
                    ))}
                </div>
            </div>

        </div>
      </div>
    </div>
  );
};

export default DigitalCard;

--------------------------------------------------
ðŸ“ PATH: src\components\DoctorFileGallery.tsx
--------------------------------------------------
import { useEffect, useState } from 'react';
import { FileText, Image as ImageIcon, ExternalLink, RefreshCw, Eye, FolderOpen } from 'lucide-react';
import { createClient } from '@supabase/supabase-js';
import { ImageViewerModal } from './ImageViewerModal';

// ConfiguraciÃ³n de Supabase
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);
const BUCKET_NAME = 'pacientes';

interface FileObject {
  name: string;
  id: string;
  updated_at: string;
  created_at: string;
  last_accessed_at: string;
  metadata: Record<string, any>;
}

// Props: Ahora recibimos el ID del paciente opcionalmente
interface DoctorFileGalleryProps {
  patientId?: string; 
}

export const DoctorFileGallery: React.FC<DoctorFileGalleryProps> = ({ patientId }) => {
  const [files, setFiles] = useState<FileObject[]>([]);
  const [loading, setLoading] = useState(false);
  
  // Estados para el Visor
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const [selectedFileName, setSelectedFileName] = useState('');

  const fetchFiles = async () => {
    // Si no hay ID de paciente, limpiamos la lista para no mostrar datos mezclados
    if (!patientId) {
        setFiles([]);
        return;
    }

    setLoading(true);
    try {
      // LISTAR DESDE LA CARPETA ESPECÃFICA DEL PACIENTE
      const { data, error } = await supabase.storage
        .from(BUCKET_NAME)
        .list(patientId, { // Usamos el ID como nombre de carpeta raÃ­z
          limit: 20,
          offset: 0,
          sortBy: { column: 'created_at', order: 'desc' },
        });

      if (error) throw error;
      setFiles(data || []);
    } catch (error) {
      console.error('Error cargando archivos:', error);
    } finally {
      setLoading(false);
    }
  };

  // Recargar automÃ¡ticamente cuando cambiamos de paciente
  useEffect(() => {
    fetchFiles();
  }, [patientId]);

  const handleViewFile = async (fileName: string) => {
    if (!patientId) return;
    
    // Crear URL firmada para la ruta: {patientId}/{fileName}
    const { data } = await supabase.storage
      .from(BUCKET_NAME)
      .createSignedUrl(`${patientId}/${fileName}`, 3600);
    
    if (data?.signedUrl) {
      // Detectar tipo de archivo
      const isImage = fileName.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i);
      
      if (isImage) {
        setSelectedImage(data.signedUrl);
        setSelectedFileName(fileName);
      } else {
        // PDFs y otros documentos se abren en pestaÃ±a nueva
        window.open(data.signedUrl, '_blank');
      }
    }
  };

  // Estado vacÃ­o si no hay paciente seleccionado
  if (!patientId) {
      return (
          <div className="p-8 text-center text-slate-400 border-2 border-dashed rounded-xl bg-slate-50 dark:bg-slate-800/50 dark:border-slate-700 h-full flex flex-col items-center justify-center">
              <FolderOpen className="mb-2 opacity-50" size={32}/>
              <p className="text-xs font-medium">Seleccione o cree un paciente<br/>para ver su expediente.</p>
          </div>
      )
  }

  return (
    <>
      <div className="bg-white dark:bg-slate-900 rounded-lg border border-gray-200 dark:border-slate-700 shadow-sm overflow-hidden h-full flex flex-col">
        <div className="p-3 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center bg-gray-50 dark:bg-slate-800/50">
          <h3 className="font-semibold text-gray-700 dark:text-slate-300 text-xs uppercase tracking-wider">
             Expediente Digital
          </h3>
          <button onClick={fetchFiles} className="text-gray-400 hover:text-brand-teal transition-colors" title="Actualizar lista">
            <RefreshCw size={14} />
          </button>
        </div>

        <div className="p-2 flex-1 overflow-y-auto min-h-[150px]">
          {loading ? (
            <div className="h-full flex items-center justify-center text-gray-400 text-xs">Cargando...</div>
          ) : files.length === 0 ? (
            <div className="h-full flex flex-col items-center justify-center text-gray-400 text-xs gap-2 py-8">
              <div className="p-2 bg-gray-100 dark:bg-slate-800 rounded-full"><FileText size={20}/></div>
              Carpeta vacÃ­a
            </div>
          ) : (
            <ul className="space-y-1">
              {files.map((file) => (
                <li 
                  key={file.id} 
                  className="flex items-center justify-between p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-md group transition-colors cursor-pointer"
                  onClick={() => handleViewFile(file.name)}
                >
                  <div className="flex items-center gap-3 overflow-hidden">
                    <div className="w-8 h-8 rounded bg-blue-50 dark:bg-blue-900/20 text-blue-500 flex items-center justify-center shrink-0">
                      {file.metadata?.mimetype?.includes('image') ? <ImageIcon size={14} /> : <FileText size={14} />}
                    </div>
                    <div className="flex flex-col min-w-0">
                      <span className="text-xs font-medium text-gray-700 dark:text-slate-300 truncate block max-w-[140px]">
                        {file.name.split('_').slice(1).join('_')}
                      </span>
                      <span className="text-[10px] text-gray-400">
                        {(file.metadata?.size / 1024).toFixed(0)} KB â€¢ {new Date(file.created_at).toLocaleDateString()}
                      </span>
                    </div>
                  </div>
                  <button className="text-gray-300 hover:text-brand-teal opacity-0 group-hover:opacity-100 transition-opacity">
                    <Eye size={16} />
                  </button>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>

      {/* Visor Modal Integrado */}
      <ImageViewerModal 
        isOpen={!!selectedImage}
        onClose={() => setSelectedImage(null)}
        imageUrl={selectedImage}
        fileName={selectedFileName}
      />
    </>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\FormattedText.tsx
--------------------------------------------------
import React from 'react';
import { 
  User, 
  Activity, 
  BrainCircuit, 
  ClipboardList, 
  FileText,
  Quote 
} from 'lucide-react';

interface FormattedTextProps {
  content: string;
  className?: string;
}

const FormattedText: React.FC<FormattedTextProps> = ({ content, className = '' }) => {
  if (!content) return null;

  // 1. PARSER INTELIGENTE: Detecta si el texto tiene estructura SOAP
  // Busca patrones como "S.", "O.", "Subjetivo:", etc. al inicio de lÃ­neas o pÃ¡rrafos.
  const parseSOAP = (text: string) => {
    // Normalizamos saltos de lÃ­nea
    const normalizedText = text.replace(/\r\n/g, '\n');
    
    // Regex para encontrar las secciones (S, O, A, P o versiones completas)
    const sections: { type: string; content: string }[] = [];
    
    // Patrones de inicio de secciÃ³n
    const patterns = {
      S: /(?:^|\n)(?:S\.|Subjetivo:?)([\s\S]*?)(?=(?:\n(?:O\.|Objetivo:?))|$)/i,
      O: /(?:^|\n)(?:O\.|Objetivo:?)([\s\S]*?)(?=(?:\n(?:A\.|AnÃ¡lisis:|AvalÃºo:?))|$)/i,
      A: /(?:^|\n)(?:A\.|AnÃ¡lisis:|AvalÃºo:?)([\s\S]*?)(?=(?:\n(?:P\.|Plan:?))|$)/i,
      P: /(?:^|\n)(?:P\.|Plan:?)([\s\S]*?)(?=$)/i
    };

    const sMatch = normalizedText.match(patterns.S);
    const oMatch = normalizedText.match(patterns.O);
    const aMatch = normalizedText.match(patterns.A);
    const pMatch = normalizedText.match(patterns.P);

    // Si encontramos al menos 2 secciones, asumimos que es una nota SOAP vÃ¡lida
    const matchCount = [sMatch, oMatch, aMatch, pMatch].filter(m => m !== null).length;

    if (matchCount >= 2) {
      if (sMatch) sections.push({ type: 'S', content: sMatch[1].trim() });
      if (oMatch) sections.push({ type: 'O', content: oMatch[1].trim() });
      if (aMatch) sections.push({ type: 'A', content: aMatch[1].trim() });
      if (pMatch) sections.push({ type: 'P', content: pMatch[1].trim() });
      return sections;
    }

    return null; // No es SOAP, retornar null para renderizado estÃ¡ndar
  };

  const soapSections = parseSOAP(content);

  // 2. RENDERIZADO DE FORMATO SOAP (DiseÃ±o Profesional)
  if (soapSections) {
    const getSectionStyle = (type: string) => {
      switch (type) {
        case 'S': return { 
          color: 'text-blue-700 dark:text-blue-300', 
          bg: 'bg-blue-50 dark:bg-blue-900/20', 
          border: 'border-blue-200 dark:border-blue-800',
          icon: <User className="w-5 h-5" />,
          label: 'SUBJETIVO (Interrogatorio)'
        };
        case 'O': return { 
          color: 'text-emerald-700 dark:text-emerald-300', 
          bg: 'bg-emerald-50 dark:bg-emerald-900/20', 
          border: 'border-emerald-200 dark:border-emerald-800',
          icon: <Activity className="w-5 h-5" />,
          label: 'OBJETIVO (ExploraciÃ³n y Signos)'
        };
        case 'A': return { 
          color: 'text-amber-700 dark:text-amber-300', 
          bg: 'bg-amber-50 dark:bg-amber-900/20', 
          border: 'border-amber-200 dark:border-amber-800',
          icon: <BrainCircuit className="w-5 h-5" />,
          label: 'ANÃLISIS (DiagnÃ³stico)'
        };
        case 'P': return { 
          color: 'text-purple-700 dark:text-purple-300', 
          bg: 'bg-purple-50 dark:bg-purple-900/20', 
          border: 'border-purple-200 dark:border-purple-800',
          icon: <ClipboardList className="w-5 h-5" />,
          label: 'PLAN (Tratamiento)'
        };
        default: return { color: 'text-gray-700', bg: 'bg-gray-50', border: '', icon: null, label: '' };
      }
    };

    return (
      <div className={`space-y-4 ${className}`}>
        {soapSections.map((section, index) => {
          const style = getSectionStyle(section.type);
          return (
            <div key={index} className={`rounded-xl border ${style.border} ${style.bg} overflow-hidden shadow-sm transition-all hover:shadow-md`}>
              {/* Encabezado de SecciÃ³n */}
              <div className={`px-4 py-2 flex items-center gap-2 font-bold text-xs tracking-wider uppercase border-b ${style.border} ${style.color} bg-white/50 dark:bg-black/20`}>
                {style.icon}
                {style.label}
              </div>
              
              {/* Contenido */}
              <div className="p-4 text-slate-700 dark:text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">
                {/* Resaltado inteligente de palabras clave dentro del texto */}
                {section.content.split(/(\*\*.*?\*\*)/g).map((part, i) => 
                  part.startsWith('**') && part.endsWith('**') ? (
                    <strong key={i} className="text-slate-900 dark:text-white font-bold">
                      {part.slice(2, -2)}
                    </strong>
                  ) : (
                    part
                  )
                )}
              </div>
            </div>
          );
        })}
      </div>
    );
  }

  // 3. RENDERIZADO ESTÃNDAR (Fallback si no es SOAP)
  // Mantiene el formato markdown bÃ¡sico (**negritas** y listas)
  return (
    <div className={`text-slate-700 dark:text-slate-300 text-sm leading-relaxed whitespace-pre-wrap ${className}`}>
      {content.split('\n').map((line, i) => (
        <div key={i} className={`${line.startsWith('-') ? 'pl-4' : ''} mb-1`}>
           {line.split(/(\*\*.*?\*\*)/g).map((part, j) => 
              part.startsWith('**') && part.endsWith('**') ? (
                <strong key={j} className="text-slate-900 dark:text-white font-bold">{part.slice(2, -2)}</strong>
              ) : (
                part
              )
            )}
        </div>
      ))}
    </div>
  );
};

export default FormattedText;

--------------------------------------------------
ðŸ“ PATH: src\components\ImageViewerModal.tsx
--------------------------------------------------
import React from 'react';
import { X, Download } from 'lucide-react';

interface ImageViewerModalProps {
  isOpen: boolean;
  onClose: () => void;
  imageUrl: string | null;
  fileName: string;
}

export const ImageViewerModal: React.FC<ImageViewerModalProps> = ({ isOpen, onClose, imageUrl, fileName }) => {
  if (!isOpen || !imageUrl) return null;

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fade-in">
      {/* BotÃ³n Cerrar */}
      <button 
        onClick={onClose}
        className="absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors"
      >
        <X size={24} />
      </button>

      {/* Contenedor de la Imagen */}
      <div className="relative max-w-5xl max-h-[90vh] w-full flex flex-col items-center">
        <img 
          src={imageUrl} 
          alt={fileName} 
          className="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl"
        />
        
        <div className="mt-4 flex gap-4 items-center">
          <span className="text-white/80 text-sm">{fileName}</span>
          <a 
            href={imageUrl} 
            download={fileName}
            className="flex items-center gap-2 px-4 py-2 bg-white text-black rounded-full text-sm font-bold hover:bg-gray-200 transition-colors"
          >
            <Download size={16} /> Descargar
          </a>
        </div>
      </div>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\ImpactMetrics.tsx
--------------------------------------------------
// ARCHIVO NUEVO: src/components/ImpactMetrics.tsx
import React, { useEffect, useState } from 'react';
import { supabase } from '../lib/supabase';
import { Loader2, UserCircle, Calendar, Activity, BarChart3 } from 'lucide-react';

export const ImpactMetrics = () => {
    const [metrics, setMetrics] = useState({ total: 0, month: 0 });
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        let isMounted = true;
        const loadMetrics = async () => {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                // 1. Total HistÃ³rico
                const { count: total } = await supabase
                    .from('patients')
                    .select('*', { count: 'exact', head: true })
                    .eq('doctor_id', user.id);

                // 2. Actividad del Mes
                const now = new Date();
                // Forzamos dÃ­a 1 del mes actual para comparar
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                
                const { count: month } = await supabase
                    .from('consultations')
                    .select('*', { count: 'exact', head: true })
                    .eq('doctor_id', user.id)
                    .gte('created_at', startOfMonth)
                    .neq('status', 'cancelled');

                if (isMounted) {
                    setMetrics({ total: total || 0, month: month || 0 });
                    setIsLoading(false);
                }
            } catch (e) {
                console.error("Error mÃ©tricas:", e);
                if (isMounted) setIsLoading(false);
            }
        };
        loadMetrics();
        return () => { isMounted = false; };
    }, []);

    return (
        <div className="bg-gradient-to-br from-white to-blue-50/50 dark:from-slate-900 dark:to-slate-900 rounded-[2rem] p-6 border border-slate-100 dark:border-slate-800 shadow-sm h-full flex flex-col justify-between transition-colors">
            <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <div className="p-2 bg-blue-50 text-blue-600 rounded-lg"><BarChart3 size={18}/></div> 
                    Rendimiento
                </h3>
                <span className="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full animate-pulse">
                    En vivo
                </span>
            </div>

            {isLoading ? (
                <div className="flex-1 flex items-center justify-center text-slate-300">
                    <Loader2 className="animate-spin" size={32} />
                </div>
            ) : (
                <div className="grid grid-cols-2 gap-4 h-full items-end">
                    {/* Tarjeta Total */}
                    <div className="col-span-2 bg-slate-900 dark:bg-slate-800 rounded-2xl p-5 text-white shadow-xl relative overflow-hidden group">
                        <div className="absolute right-[-10px] top-[-10px] opacity-10 transform rotate-12 group-hover:scale-110 transition-transform duration-500">
                            <UserCircle size={80} />
                        </div>
                        <div className="relative z-10">
                            <p className="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Expedientes Activos</p>
                            <div className="flex items-baseline gap-1">
                                <span className="text-4xl font-black tracking-tighter">{metrics.total}</span>
                                <span className="text-sm font-medium text-slate-500">pacientes</span>
                            </div>
                        </div>
                    </div>
                    {/* Tarjeta Mes */}
                    <div className="bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-2xl p-4 shadow-sm flex flex-col justify-center">
                        <div className="flex items-center gap-2 mb-2">
                            <Calendar size={14} className="text-indigo-500"/>
                            <span className="text-[10px] font-bold text-slate-400 uppercase">Este Mes</span>
                        </div>
                        <p className="text-2xl font-bold text-slate-800 dark:text-white leading-none">{metrics.month}</p>
                    </div>
                    {/* Tarjeta Estatus */}
                    <div className="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800 rounded-2xl p-4 shadow-sm flex flex-col justify-center">
                        <div className="flex items-center gap-2 mb-2">
                            <Activity size={14} className="text-emerald-600"/>
                            <span className="text-[10px] font-bold text-emerald-700/70 uppercase">Estatus</span>
                        </div>
                        <p className="text-lg font-black text-emerald-600 leading-none">Activo</p>
                    </div>
                </div>
            )}
        </div>
    );
};

--------------------------------------------------
ðŸ“ PATH: src\components\InsightsPanel.tsx
--------------------------------------------------
import React from 'react';
import { TrendingUp, Pill, AlertTriangle, ListChecks, X, Copy, ShieldAlert } from 'lucide-react';
import { toast } from 'sonner';
import { PatientInsight } from '../types';

interface InsightsPanelProps {
  insights: PatientInsight | null;
  isOpen: boolean;
  onClose: () => void;
  isLoading: boolean;
  patientName: string;
  data?: any; // Prop de compatibilidad
}

// IMPORTANTE: Usamos 'export const' aquÃ­
export const InsightsPanel: React.FC<InsightsPanelProps> = ({ insights, isOpen, onClose, isLoading, patientName, data }) => {
  if (!isOpen) return null;

  const activeData = insights || data;

  const handleCopy = (text: string, label: string) => {
      navigator.clipboard.writeText(text);
      toast.success(`${label} copiado al portapapeles`);
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
      <div className="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-800 flex flex-col max-h-[85vh]">
        
        <div className="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
          <div>
            <h3 className="font-bold text-xl text-slate-900 dark:text-white flex items-center gap-2">
              <TrendingUp className="text-brand-teal" size={24} />
              Balance ClÃ­nico 360Â°
            </h3>
            <p className="text-xs text-slate-500 mt-1">AnÃ¡lisis de evoluciÃ³n para: <span className="font-bold">{patientName}</span></p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full text-slate-500 transition-colors">
            <X size={24} />
          </button>
        </div>

        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-50/30 dark:bg-slate-950">
          {isLoading ? (
            <div className="flex flex-col items-center justify-center h-64 space-y-4">
              <div className="relative">
                <div className="w-16 h-16 border-4 border-slate-200 border-t-brand-teal rounded-full animate-spin"></div>
                <div className="absolute inset-0 flex items-center justify-center">
                    <TrendingUp size={24} className="text-brand-teal animate-pulse"/>
                </div>
              </div>
              <p className="text-slate-500 font-medium animate-pulse">Analizando historial clÃ­nico...</p>
            </div>
          ) : activeData ? (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              
              <div className="md:col-span-2 bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border-l-4 border-blue-500 relative group">
                <button onClick={() => handleCopy(activeData.evolution, 'EvoluciÃ³n')} className="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100"><Copy size={16}/></button>
                <h4 className="font-bold text-blue-700 dark:text-blue-400 mb-2 flex items-center gap-2 uppercase text-xs tracking-wider">
                  <TrendingUp size={16} /> EvoluciÃ³n CronolÃ³gica
                </h4>
                <p className="text-slate-700 dark:text-slate-300 text-sm leading-relaxed whitespace-pre-line">
                  {activeData.evolution || "Sin datos suficientes."}
                </p>
              </div>

              <div className="bg-red-50 dark:bg-red-900/10 p-5 rounded-xl border border-red-100 dark:border-red-900/30">
                <h4 className="font-bold text-red-700 dark:text-red-400 mb-3 flex items-center gap-2 uppercase text-xs tracking-wider">
                  <AlertTriangle size={16} /> Banderas Rojas
                </h4>
                <ul className="space-y-2">
                  {activeData.risk_flags && activeData.risk_flags.length > 0 ? activeData.risk_flags.map((flag: string, idx: number) => (
                    <li key={idx} className="flex items-start gap-2 text-sm text-red-800 dark:text-red-200">
                      <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0"></span>
                      {flag}
                    </li>
                  )) : <li className="text-sm text-slate-500 italic">No se detectaron riesgos crÃ­ticos.</li>}
                </ul>
              </div>

              <div className="bg-green-50 dark:bg-green-900/10 p-5 rounded-xl border border-green-100 dark:border-green-900/30 relative group">
                 <button onClick={() => handleCopy(activeData.medication_audit, 'Medicamentos')} className="absolute top-4 right-4 text-green-300 hover:text-green-600 transition-colors opacity-0 group-hover:opacity-100"><Copy size={16}/></button>
                <h4 className="font-bold text-green-700 dark:text-green-400 mb-2 flex items-center gap-2 uppercase text-xs tracking-wider">
                  <Pill size={16} /> AuditorÃ­a FarmacolÃ³gica
                </h4>
                <p className="text-slate-700 dark:text-slate-300 text-sm leading-relaxed">
                  {activeData.medication_audit || "Sin cambios recientes."}
                </p>
              </div>

              <div className="md:col-span-2 bg-amber-50 dark:bg-amber-900/10 p-5 rounded-xl border border-amber-100 dark:border-amber-900/30">
                <h4 className="font-bold text-amber-700 dark:text-amber-400 mb-3 flex items-center gap-2 uppercase text-xs tracking-wider">
                  <ListChecks size={16} /> Brechas y Pendientes
                </h4>
                <ul className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                  {activeData.pending_actions && activeData.pending_actions.length > 0 ? activeData.pending_actions.map((action: string, idx: number) => (
                    <li key={idx} className="flex items-center gap-2 text-sm text-amber-900 dark:text-amber-100 bg-white dark:bg-slate-800 px-3 py-2 rounded-lg border border-amber-100 dark:border-amber-900/50">
                      <span className="w-4 h-4 border-2 border-amber-400 rounded-full shrink-0"></span>
                      {action}
                    </li>
                  )) : <li className="text-sm text-slate-500 italic">No hay acciones pendientes.</li>}
                </ul>
              </div>

            </div>
          ) : (
            <div className="text-center text-slate-400 py-12">No hay datos de anÃ¡lisis disponibles.</div>
          )}
        </div>
        
        <div className="p-4 bg-red-50 dark:bg-red-900/20 border-t border-red-100 dark:border-red-900/30 text-center">
            <div className="flex items-center justify-center gap-2 text-red-600 dark:text-red-400 mb-1">
                <ShieldAlert size={14} />
                <span className="text-[10px] font-bold uppercase tracking-widest">Aviso de Responsabilidad</span>
            </div>
            <p className="text-[10px] text-red-500/80 dark:text-red-300/70 leading-tight max-w-lg mx-auto">
                AnÃ¡lisis generado por IA. El mÃ©dico tratante es responsable de verificar la informaciÃ³n.
            </p>
        </div>
      </div>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\InteractiveClinicalCase.tsx
--------------------------------------------------
import React, { useState } from 'react';
import { Lightbulb, CheckCircle2, RefreshCw, ChevronRight, BrainCircuit } from 'lucide-react';

interface CaseStudy {
  id: number;
  category: string;
  title: string;
  vignette: string;
  vitals: string;
  question: string;
  answer: string;
  pearl: string;
  evidenceLevel: string;
}

const CASES: CaseStudy[] = [
  {
    id: 1,
    category: 'CARDIOLOGÃA',
    title: 'Dolor TorÃ¡cico en Urgencias',
    vignette: 'Masc. 55 aÃ±os, diabÃ©tico. Dolor epigÃ¡strico urente de 2h evoluciÃ³n. ECG: ElevaciÃ³n ST en V1-V4.',
    vitals: 'TA: 150/90 | FC: 98 | SatO2: 94%',
    question: 'Â¿CuÃ¡l es el diagnÃ³stico mÃ¡s probable y la arteria afectada?',
    answer: 'IAMCEST Anterior (Infarto Anteroseptal).',
    pearl: 'La arteria descendente anterior (DA) es la culpable en el 90% de los infartos anteriores. Requiere reperfusiÃ³n inmediata.',
    evidenceLevel: 'GuÃ­as ESC 2023'
  },
  {
    id: 2,
    category: 'ENDOCRINOLOGÃA',
    title: 'Estado Hiperosmolar vs Cetoacidosis',
    vignette: 'Fem. 72 aÃ±os, letargo. Glucosa 850 mg/dL, pH 7.35, HCO3 22, Cetonas (-).',
    vitals: 'TA: 90/60 | FC: 110 | Mucosas secas +++',
    question: 'Â¿DiagnÃ³stico y primera lÃ­nea de tratamiento?',
    answer: 'Estado Hiperosmolar HiperglucÃ©mico (EHH). HidrataciÃ³n agresiva.',
    pearl: 'En EHH el dÃ©ficit de agua es de 8-10L. La insulina se inicia SOLO despuÃ©s de asegurar hidrataciÃ³n y K+ > 3.3.',
    evidenceLevel: 'ADA Standards 2024'
  },
  {
    id: 3,
    category: 'NEUMOLOGÃA',
    title: 'Disnea SÃºbita Post-QuirÃºrgica',
    vignette: 'Fem. 30 aÃ±os, 3 dÃ­as post-cesÃ¡rea. Disnea sÃºbita y dolor pleurÃ­tico. Pulmones claros.',
    vitals: 'TA: 100/60 | FC: 125 | SatO2: 88% AA',
    question: 'Â¿Estudio Gold Standard para confirmar diagnÃ³stico?',
    answer: 'AngioTAC Pulmonar (Sospecha de TEP).',
    pearl: 'La hipoxia con radiografÃ­a de tÃ³rax normal es altamente sugestiva de TEP. El DÃ­mero-D tiene bajo valor predictivo positivo en puerperio.',
    evidenceLevel: 'GuÃ­as ATS/STR'
  }
];

export const InteractiveClinicalCase = () => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);

  const activeCase = CASES[currentIndex];

  const handleNext = (e: React.MouseEvent) => {
    e.stopPropagation();
    setIsFlipped(false);
    setTimeout(() => {
      setCurrentIndex((prev) => (prev + 1) % CASES.length);
    }, 300);
  };

  return (
    <div className="perspective-1000 w-full h-[320px] group cursor-pointer" onClick={() => setIsFlipped(!isFlipped)}>
      <div className={`relative w-full h-full transition-all duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
        
        {/* CARA FRONTAL (PREGUNTA) */}
        <div className="absolute w-full h-full backface-hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 text-white shadow-xl flex flex-col justify-between border border-slate-700/50">
          <div>
            <div className="flex justify-between items-start mb-4">
              <span className="bg-indigo-500/20 text-indigo-300 text-[10px] font-bold px-2 py-1 rounded border border-indigo-500/30 tracking-wider">
                {activeCase.category}
              </span>
              <BrainCircuit className="text-slate-600 group-hover:text-indigo-400 transition-colors" size={24} />
            </div>
            
            <h3 className="text-xl font-bold mb-3 bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
              {activeCase.title}
            </h3>
            
            <div className="space-y-3">
              <p className="text-slate-300 text-sm leading-relaxed border-l-2 border-indigo-500 pl-3">
                {activeCase.vignette}
              </p>
              <div className="bg-slate-900/50 p-2 rounded-lg inline-block">
                <p className="text-xs font-mono text-emerald-400">{activeCase.vitals}</p>
              </div>
            </div>
          </div>

          <div className="mt-4">
            <p className="text-indigo-200 text-sm font-bold flex items-center gap-2 animate-pulse">
              <Lightbulb size={16} /> {activeCase.question}
            </p>
            <p className="text-center text-xs text-slate-500 mt-4 opacity-50">Toca para revelar respuesta</p>
          </div>
        </div>

        {/* CARA TRASERA (RESPUESTA) */}
        <div className="absolute w-full h-full backface-hidden rotate-y-180 bg-white rounded-3xl p-6 shadow-xl flex flex-col justify-between border border-slate-200">
          <div>
            <div className="flex items-center gap-2 mb-4 text-emerald-600">
              <CheckCircle2 size={20} />
              <span className="font-bold text-xs uppercase tracking-wide">Respuesta Correcta</span>
            </div>
            
            <h3 className="text-lg font-bold text-slate-900 mb-2">
              {activeCase.answer}
            </h3>
            
            <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100 mb-3">
              <p className="text-slate-700 text-xs leading-relaxed">
                <span className="font-bold text-indigo-700">Perla ClÃ­nica:</span> {activeCase.pearl}
              </p>
            </div>
            
            <span className="text-[10px] text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">
              {activeCase.evidenceLevel}
            </span>
          </div>

          <button 
            onClick={handleNext}
            className="w-full bg-slate-900 hover:bg-black text-white py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all active:scale-95"
          >
            Siguiente Reto <ChevronRight size={16} />
          </button>
        </div>

      </div>
      
      {/* Estilos CSS Inline para soportar 3D sin plugins extra de Tailwind si no estÃ¡n configurados */}
      <style>{`
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
      `}</style>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\MedicalCalculators.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { Calculator, Activity, Baby, ArrowRight, RotateCcw } from 'lucide-react';

type CalcType = 'BMI' | 'GFR' | 'PEDS';

export const MedicalCalculators = () => {
  const [activeTab, setActiveTab] = useState<CalcType>('GFR');
  const [result, setResult] = useState<string | null>(null);
  const [interpretation, setInterpretation] = useState<string | null>(null);

  // Estados para inputs
  const [weight, setWeight] = useState('');
  const [height, setHeight] = useState('');
  const [creatinine, setCreatinine] = useState('');
  const [age, setAge] = useState('');
  const [gender, setGender] = useState<'M'|'F'>('M');

  const calculate = () => {
    let val = 0;
    
    if (activeTab === 'BMI') {
      const w = parseFloat(weight);
      const h = parseFloat(height); // asumiendo cm
      if (w && h) {
        val = w / ((h/100) * (h/100));
        setResult(val.toFixed(1));
        if (val < 18.5) setInterpretation('Bajo Peso');
        else if (val < 25) setInterpretation('Normal');
        else if (val < 30) setInterpretation('Sobrepeso');
        else setInterpretation('Obesidad');
      }
    } 
    else if (activeTab === 'GFR') {
      // CKD-EPI 2021 Formula
      const scr = parseFloat(creatinine);
      const a = parseFloat(age);
      if (scr && a) {
        const k = gender === 'F' ? 0.7 : 0.9;
        const alpha = gender === 'F' ? -0.241 : -0.302;
        const min_val = Math.min(scr / k, 1);
        const max_val = Math.max(scr / k, 1);
        
        // eGFR = 142 * min^alpha * max^-1.2 * 0.9938^Age * 1.012(if F)
        val = 142 * Math.pow(min_val, alpha) * Math.pow(max_val, -1.200) * Math.pow(0.9938, a);
        if (gender === 'F') val *= 1.012;

        setResult(val.toFixed(0));
        if (val >= 90) setInterpretation('Estadio G1 (Normal)');
        else if (val >= 60) setInterpretation('Estadio G2 (Leve)');
        else if (val >= 45) setInterpretation('Estadio G3a (Mod-Grave)');
        else if (val >= 30) setInterpretation('Estadio G3b (Mod-Grave)');
        else if (val >= 15) setInterpretation('Estadio G4 (Grave)');
        else setInterpretation('Estadio G5 (Falla Renal)');
      }
    }
    else if (activeTab === 'PEDS') {
      const w = parseFloat(weight);
      if (w) {
        // Dosis ejemplo paracetamol 15mg/kg
        val = w * 15;
        setResult(`${val} mg`);
        setInterpretation('Dosis Paracetamol (15mg/kg)');
      }
    }
  };

  const reset = () => {
    setResult(null);
    setInterpretation(null);
    setWeight(''); setHeight(''); setCreatinine(''); setAge('');
  };

  useEffect(() => reset(), [activeTab]);

  return (
    <div className="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden h-[320px] flex flex-col">
      <div className="bg-slate-50 border-b border-slate-100 p-2 flex gap-1">
        {[
          { id: 'GFR', label: 'TFG (CKD-EPI)', icon: Activity },
          { id: 'BMI', label: 'IMC', icon: Calculator },
          { id: 'PEDS', label: 'Dosis Ped', icon: Baby },
        ].map((tab) => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id as CalcType)}
            className={`flex-1 py-2 rounded-xl text-xs font-bold flex flex-col items-center gap-1 transition-all ${
              activeTab === tab.id 
              ? 'bg-white text-teal-600 shadow-sm ring-1 ring-slate-200' 
              : 'text-slate-400 hover:text-slate-600 hover:bg-slate-100'
            }`}
          >
            <tab.icon size={16} /> {tab.label}
          </button>
        ))}
      </div>

      <div className="p-5 flex-1 flex flex-col relative">
        {activeTab === 'GFR' && (
          <div className="grid grid-cols-2 gap-3">
             <div className="col-span-2 flex bg-slate-100 rounded-lg p-1">
                <button onClick={() => setGender('M')} className={`flex-1 rounded-md text-xs py-1.5 font-bold transition-all ${gender === 'M' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>HOMBRE</button>
                <button onClick={() => setGender('F')} className={`flex-1 rounded-md text-xs py-1.5 font-bold transition-all ${gender === 'F' ? 'bg-white shadow text-pink-600' : 'text-slate-400'}`}>MUJER</button>
             </div>
             <input type="number" placeholder="Creatinina (mg/dL)" className="input-calc" value={creatinine} onChange={e => setCreatinine(e.target.value)} />
             <input type="number" placeholder="Edad (aÃ±os)" className="input-calc" value={age} onChange={e => setAge(e.target.value)} />
          </div>
        )}

        {activeTab === 'BMI' && (
           <div className="grid grid-cols-2 gap-3">
             <input type="number" placeholder="Peso (kg)" className="input-calc" value={weight} onChange={e => setWeight(e.target.value)} />
             <input type="number" placeholder="Altura (cm)" className="input-calc" value={height} onChange={e => setHeight(e.target.value)} />
           </div>
        )}

        {activeTab === 'PEDS' && (
           <div className="grid grid-cols-1 gap-3">
             <input type="number" placeholder="Peso Paciente (kg)" className="input-calc" value={weight} onChange={e => setWeight(e.target.value)} />
             <p className="text-xs text-slate-400 text-center mt-2">Calcula dosis estÃ¡ndar (15mg/kg)</p>
           </div>
        )}

        {/* RESULTADO OVERLAY */}
        {result ? (
          <div className="absolute inset-0 bg-white/95 backdrop-blur-sm z-10 flex flex-col items-center justify-center p-4 animate-in fade-in slide-in-from-bottom-4 duration-300">
             <span className="text-xs font-bold text-slate-400 uppercase mb-1">Resultado Calculado</span>
             <div className="text-4xl font-black text-slate-900 mb-1">{result} <span className="text-sm font-medium text-slate-400">{activeTab === 'GFR' ? 'ml/min' : activeTab === 'BMI' ? 'kg/mÂ²' : ''}</span></div>
             <div className={`px-3 py-1 rounded-full text-xs font-bold mb-4 ${
               activeTab === 'GFR' && parseFloat(result) < 60 ? 'bg-red-100 text-red-700' : 'bg-teal-50 text-teal-700'
             }`}>
               {interpretation}
             </div>
             <button onClick={reset} className="flex items-center gap-2 text-slate-400 hover:text-slate-600 font-bold text-xs">
               <RotateCcw size={14}/> Calcular Otro
             </button>
          </div>
        ) : (
          <button onClick={calculate} className="mt-auto w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-800 transition-colors flex justify-center items-center gap-2">
            Calcular <ArrowRight size={16}/>
          </button>
        )}
      </div>
      
      <style>{`
        .input-calc { @apply w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-teal-500 transition-all; }
      `}</style>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\MobileTabBar.tsx
--------------------------------------------------
import React from 'react';
import { NavLink } from 'react-router-dom';
import { LayoutDashboard, Calendar, Stethoscope, Users, Menu } from 'lucide-react';

// Interfaz de Props para recibir la acciÃ³n de abrir menÃº
interface MobileTabBarProps {
  onMenuClick?: () => void; 
}

const MobileTabBar: React.FC<MobileTabBarProps> = ({ onMenuClick }) => {
  
  // Definimos los items de navegaciÃ³n principal
  const tabs = [
    { path: '/', icon: LayoutDashboard, label: 'Inicio', end: true },
    { path: '/calendar', icon: Calendar, label: 'Agenda' },
    { path: '/consultation', icon: Stethoscope, label: 'Consulta', isMain: true },
    { path: '/patients', icon: Users, label: 'Pacientes' },
  ];

  return (
    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 pb-[env(safe-area-inset-bottom)] z-40 shadow-[0_-4px_10px_rgba(0,0,0,0.03)] transition-colors duration-300">
      <div className="flex justify-around items-end h-16 px-1">
        
        {/* 1. Items de NavegaciÃ³n */}
        {tabs.map((tab) => (
          <NavLink
            key={tab.path}
            to={tab.path}
            end={tab.end}
            aria-label={tab.label}
            className={({ isActive }) => `
              flex flex-col items-center justify-center w-full h-full pb-1 relative
              transition-colors duration-200 cursor-pointer select-none outline-none tap-highlight-transparent
              ${isActive && !tab.isMain ? 'text-brand-teal' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}
            `}
          >
            {({ isActive }) => (
              <>
                {tab.isMain ? (
                  // BOTÃ“N FLOTANTE CENTRAL (CONSULTA)
                  <div className="absolute -top-6 flex flex-col items-center group">
                    <div className={`
                      bg-brand-teal text-white p-3.5 rounded-full shadow-lg shadow-teal-200/50 dark:shadow-none 
                      transform transition-all duration-200 border-4 border-slate-50 dark:border-slate-900
                      ${isActive ? 'scale-110 ring-2 ring-teal-100 dark:ring-teal-900/30' : 'active:scale-95 group-hover:scale-105'}
                    `}>
                        <tab.icon size={24} strokeWidth={2.5} />
                    </div>
                    <span className={`text-[10px] font-bold mt-1 transition-colors ${isActive ? 'text-brand-teal' : 'text-slate-400'}`}>
                      Consulta
                    </span>
                  </div>
                ) : (
                  // ICONOS ESTÃNDAR
                  <>
                    <tab.icon 
                      size={22} 
                      strokeWidth={isActive ? 2.5 : 2} 
                      className={`mb-1 transition-transform duration-200 ${isActive ? 'scale-110' : ''}`}
                    />
                    <span className="text-[9px] font-medium leading-none">{tab.label}</span>
                  </>
                )}
              </>
            )}
          </NavLink>
        ))}

        {/* 2. BOTÃ“N DE MENÃš (NUEVO) - Abre el Sidebar */}
        <button
          onClick={onMenuClick}
          className="flex flex-col items-center justify-center w-full h-full pb-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 outline-none tap-highlight-transparent"
          aria-label="Abrir MenÃº"
        >
          <Menu size={22} strokeWidth={2} className="mb-1" />
          <span className="text-[9px] font-medium leading-none">MenÃº</span>
        </button>

      </div>
    </nav>
  );
};

export default MobileTabBar;

--------------------------------------------------
ðŸ“ PATH: src\components\PatientAttachments.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { Upload, File, Trash2, Eye, RefreshCw } from 'lucide-react';
import { supabase } from '../lib/supabase';
import { toast } from 'sonner';

interface PatientAttachmentsProps {
  patientId: string;
}

interface Attachment {
  name: string;
  id: string;
  created_at: string;
  url: string;
}

const PatientAttachments: React.FC<PatientAttachmentsProps> = ({ patientId }) => {
  const [files, setFiles] = useState<Attachment[]>([]);
  const [uploading, setUploading] = useState(false);

  useEffect(() => {
    fetchAttachments();
  }, [patientId]);

  const fetchAttachments = async () => {
    try {
      const { data, error } = await supabase.storage.from('patient-attachments').list(patientId);
      if (error) {
        // Silencioso si no existe el bucket aun
        return;
      }
      
      const filesWithUrl = data?.map(file => {
        const { data: urlData } = supabase.storage.from('patient-attachments').getPublicUrl(`${patientId}/${file.name}`);
        return {
          name: file.name,
          id: file.id,
          created_at: file.created_at,
          url: urlData.publicUrl
        };
      }) || [];

      setFiles(filesWithUrl);
    } catch (e) {
      console.log("Sistema de archivos no inicializado.");
    }
  };

  const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!e.target.files || e.target.files.length === 0) return;
    
    setUploading(true);
    const file = e.target.files[0];
    const fileExt = file.name.split('.').pop();
    const fileName = `${Math.random().toString(36).substring(2)}.${fileExt}`;
    const filePath = `${patientId}/${fileName}`;

    try {
      const { error } = await supabase.storage.from('patient-attachments').upload(filePath, file);
      if (error) throw error;
      toast.success("Archivo subido");
      fetchAttachments();
    } catch (error) {
      toast.error("Error al subir (Verifique Storage en Supabase)");
    } finally {
      setUploading(false);
    }
  };

  const handleDelete = async (fileName: string) => {
    if(!confirm("Â¿Eliminar archivo?")) return;
    try {
        const { error } = await supabase.storage.from('patient-attachments').remove([`${patientId}/${fileName}`]);
        if(error) throw error;
        toast.success("Eliminado");
        fetchAttachments();
    } catch(e) { toast.error("Error eliminando"); }
  };

  return (
    <div className="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
      <div className="flex justify-between items-center mb-3">
        <h4 className="font-bold text-sm text-slate-600 dark:text-slate-300 flex items-center gap-2">
            <File size={16}/> Expediente Digital
        </h4>
        <div className="relative">
            <input type="file" id="file-upload" className="hidden" onChange={handleUpload} disabled={uploading} />
            <label htmlFor="file-upload" className="cursor-pointer text-xs bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-50 flex items-center gap-1 transition-colors">
                {uploading ? <RefreshCw className="animate-spin" size={12}/> : <Upload size={12}/>} 
                {uploading ? "Subiendo..." : "Adjuntar"}
            </label>
        </div>
      </div>

      {files.length === 0 ? (
          <p className="text-xs text-slate-400 italic text-center py-2">Sin archivos adjuntos.</p>
      ) : (
          <div className="space-y-2">
              {files.map(file => (
                  <div key={file.name} className="flex items-center justify-between bg-white dark:bg-slate-800 p-2 rounded border border-slate-100 dark:border-slate-700">
                      <span className="text-xs truncate max-w-[150px] dark:text-slate-300">{file.name}</span>
                      <div className="flex gap-2">
                          <a href={file.url} target="_blank" rel="noreferrer" className="text-blue-500 hover:text-blue-600"><Eye size={14}/></a>
                          <button onClick={() => handleDelete(file.name)} className="text-red-400 hover:text-red-500"><Trash2 size={14}/></button>
                      </div>
                  </div>
              ))}
          </div>
      )}
    </div>
  );
};

// ESTA LÃNEA ES LA QUE FALTABA O ESTABA MAL:
export default PatientAttachments;

--------------------------------------------------
ðŸ“ PATH: src\components\PatientsView.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { 
  Search, UserPlus, FileText, Trash2, Edit2, Eye, Calendar, 
  Share2, Download, FolderOpen, Paperclip, MoreVertical, X, 
  FileCode, Phone, Pill, ChevronDown, ChevronUp, AlertTriangle, MessageCircle, Sparkles
} from 'lucide-react';
import { supabase } from '../lib/supabase';
import { Patient, DoctorProfile, PatientInsight } from '../types';
import { toast } from 'sonner';
import QuickRxModal from './QuickRxModal';
import FormattedText from './FormattedText'; 
import { pdf } from '@react-pdf/renderer';
import PrescriptionPDF from './PrescriptionPDF';
// ðŸ‘‡ IMPORTAMOS EL NUEVO COMPONENTE DE HISTORIAL
import ClinicalHistoryPDF from '../components/ClinicalHistoryPDF'; 
import { DoctorFileGallery } from './DoctorFileGallery';
import { PatientWizard } from './PatientWizard';
import { InsightsPanel } from './InsightsPanel'; 
import { GeminiMedicalService } from '../services/GeminiMedicalService'; 

interface PatientData extends Partial<Patient> {
  id: string;
  name: string; 
  age: number | string; 
  gender: string;
  phone?: string;
  email?: string;
  history?: string;
  created_at?: string;
  curp?: string; 
}

interface ConsultationRecord {
    id: string;
    created_at: string;
    summary: string;
    transcript: string;
}

const PatientsView: React.FC = () => {
  const [patients, setPatients] = useState<PatientData[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
    
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isHistoryOpen, setIsHistoryOpen] = useState(false);
  const [isGalleryOpen, setIsGalleryOpen] = useState(false);
    
  const [editingPatient, setEditingPatient] = useState<PatientData | null>(null);
  const [selectedPatientForRx, setSelectedPatientForRx] = useState<PatientData | null>(null);
  const [viewingPatient, setViewingPatient] = useState<PatientData | null>(null); 
    
  const [doctorProfile, setDoctorProfile] = useState<DoctorProfile | null>(null);
  const [patientHistory, setPatientHistory] = useState<ConsultationRecord[]>([]);
  const [loadingHistory, setLoadingHistory] = useState(false);

  const [expandedPatientId, setExpandedPatientId] = useState<string | null>(null);

  const [isInsightsOpen, setIsInsightsOpen] = useState(false);
  const [patientInsights, setPatientInsights] = useState<PatientInsight | null>(null);
  const [isLoadingInsights, setIsLoadingInsights] = useState(false);
  const [analyzingPatientName, setAnalyzingPatientName] = useState('');

  useEffect(() => {
    fetchPatients();
    fetchDoctorProfile();
  }, []);

  const fetchPatients = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data, error } = await supabase
      .from('patients')
      .select('*')
      .eq('doctor_id', user.id)
      .order('created_at', { ascending: false });

    if (error) { 
      console.error("Error fetching patients:", error); 
      toast.error('Error al cargar pacientes'); 
    } else { 
      setPatients((data as unknown as PatientData[]) || []); 
    }
  };

  const fetchDoctorProfile = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
        const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if (data) setDoctorProfile(data as DoctorProfile);
    }
  };

  const handleLoadInsights = async (patient: PatientData) => {
      setAnalyzingPatientName(patient.name);
      setIsInsightsOpen(true);
      setPatientInsights(null); 
      setIsLoadingInsights(true);

      try {
          const { data: history } = await supabase
            .from('consultations')
            .select('summary, created_at')
            .eq('patient_id', patient.id)
            .order('created_at', { ascending: false })
            .limit(5);
          
          const consultationsText = history?.map(h => `[Fecha: ${new Date(h.created_at).toLocaleDateString()}] ${h.summary}`) || [];
          
          const analysis = await GeminiMedicalService.generatePatient360Analysis(
              patient.name, 
              patient.history || "No registrado", 
              consultationsText
          );
          
          setPatientInsights(analysis);
      } catch (error) {
          toast.error("Error analizando historial.");
          console.error(error);
          setIsInsightsOpen(false);
      } finally {
          setIsLoadingInsights(false);
      }
  };

  const handleViewHistory = async (patient: PatientData) => {
      setViewingPatient(patient);
      setIsHistoryOpen(true);
      setIsGalleryOpen(false); 
      setLoadingHistory(true);
      setPatientHistory([]); 

      try {
          const { data, error } = await supabase.from('consultations').select('*').eq('patient_id', patient.id).order('created_at', { ascending: false });
          if (error) throw error;
          setPatientHistory(data || []);
      } catch (error) {
          console.error(error);
          toast.error("Error al cargar el expediente");
      } finally { setLoadingHistory(false); }
  };

  const handleOpenFiles = (patient: PatientData) => {
      handleViewHistory(patient); 
      setIsGalleryOpen(true);
  };

  const handleShareNoteWhatsApp = (consultation: ConsultationRecord) => {
      if (!viewingPatient) return;
      const drName = doctorProfile?.full_name || 'su mÃ©dico';
      let content = consultation.summary;
      if (content.trim().startsWith('{')) { 
          try { content = `Resumen de consulta del dÃ­a ${new Date(consultation.created_at).toLocaleDateString()}.`; } catch {}
      }
      const message = `*Historial MÃ©dico - Dr. ${drName}*\n*Paciente:* ${viewingPatient.name}\n*Fecha:* ${new Date(consultation.created_at).toLocaleDateString()}\n\n${content.substring(0, 1000)}...\n\n*Saludos.*`;
      const whatsappUrl = viewingPatient.phone && viewingPatient.phone.length >= 10 
        ? `https://wa.me/${viewingPatient.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`
        : `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
  };

  const handlePrintNote = async (consultation: ConsultationRecord) => {
      if (!viewingPatient || !doctorProfile) return;
      try {
          const blob = await pdf(
            <PrescriptionPDF 
                doctorName={doctorProfile.full_name} 
                specialty={doctorProfile.specialty} 
                license={doctorProfile.license_number} 
                phone={doctorProfile.phone} 
                university={doctorProfile.university} 
                address={doctorProfile.address} 
                logoUrl={doctorProfile.logo_url} 
                signatureUrl={doctorProfile.signature_url} 
                patientName={viewingPatient.name} 
                date={new Date(consultation.created_at).toLocaleDateString()} 
                content={consultation.summary} 
                documentTitle="NOTA DE EVOLUCIÃ“N"
            />
          ).toBlob();
          window.open(URL.createObjectURL(blob), '_blank');
      } catch (e) { toast.error("Error generando PDF"); }
  };

  // --- ðŸ”¥ NUEVA FUNCIÃ“N: DESCARGAR HISTORIAL COMPLETO ---
  const handleDownloadFullHistory = async () => {
      if (!viewingPatient || !doctorProfile || patientHistory.length === 0) {
          return toast.error("No hay datos suficientes para generar el historial.");
      }

      const toastId = toast.loading("Generando expediente completo...");

      try {
          // Preparamos los datos del paciente para el PDF
          let patientHistoryText = "No registrado";
          try {
             if (viewingPatient.history) {
                 const h = JSON.parse(viewingPatient.history);
                 patientHistoryText = h.background || h.legacyNote || "No registrado";
             }
          } catch(e) {}

          const blob = await pdf(
              <ClinicalHistoryPDF 
                  doctorProfile={{
                      full_name: doctorProfile.full_name,
                      specialty: doctorProfile.specialty,
                      license_number: doctorProfile.license_number,
                      university: doctorProfile.university,
                      address: doctorProfile.address,
                      phone: doctorProfile.phone,
                      logo_url: doctorProfile.logo_url
                  }}
                  patientData={{
                      name: viewingPatient.name,
                      age: viewingPatient.age?.toString(),
                      gender: viewingPatient.gender,
                      history: patientHistoryText
                  }}
                  consultations={patientHistory}
                  generatedDate={new Date().toLocaleDateString()}
              />
          ).toBlob();

          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `Expediente_${viewingPatient.name.replace(/\s+/g, '_')}.pdf`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          toast.success("Expediente descargado correctamente", { id: toastId });

      } catch (error) {
          console.error("Error PDF Historial:", error);
          toast.error("Error al generar el documento", { id: toastId });
      }
  };

  const handleDelete = async (id: string) => {
    if (!confirm('Â¿EstÃ¡s seguro de eliminar este paciente y todo su historial?')) return;
    try {
      const { error } = await supabase.from('patients').delete().eq('id', id);
      if (error) throw error;
      toast.success('Paciente eliminado');
      fetchPatients();
    } catch (error) {
      toast.error('Error al eliminar');
    }
  };

  const openEditModal = (patient: PatientData) => {
    setEditingPatient(patient);
    setIsModalOpen(true);
  };

  const getInitials = (name: string) => {
    return (name || '??')
      .split(' ')
      .map(word => word[0])
      .slice(0, 2)
      .join('')
      .toUpperCase();
  };

  const handleCall = (phone: string | undefined) => {
    if (phone) window.open(`tel:${phone}`, '_self');
  };

  const handleWhatsAppDirect = (phone: string | undefined) => {
      if (!phone) return;
      const cleanPhone = phone.replace(/\D/g, '');
      if (cleanPhone.length < 10) return toast.error("NÃºmero invÃ¡lido");
      window.open(`https://wa.me/${cleanPhone}`, '_blank');
  };

  const toggleExpand = (id: string) => {
    if (expandedPatientId === id) {
        setExpandedPatientId(null); 
    } else {
        setExpandedPatientId(id); 
    }
  };

  const filteredPatients = patients.filter(p => 
    (p.name || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
    (p.email || '').toLowerCase().includes(searchTerm.toLowerCase())
  );

  const renderNoteContent = (summary: string) => { return <FormattedText content={summary} />; };

  const getCriticalTags = (historyJSON: string | undefined) => {
      if (!historyJSON) return null;
      try {
          const history = JSON.parse(historyJSON);
          const allergies = history.legacyNote?.match(/alergia[s]?\s*[:]\s*([^.,\n]+)/i)?.[1] || history.allergies;
          const chronic = history.background; 
          
          if (!allergies && !chronic) return null;

          return (
              <div className="flex flex-wrap gap-1 mt-1">
                  {allergies && (
                      <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700 border border-red-200">
                          <AlertTriangle size={10} className="mr-1"/> {allergies.substring(0, 15)}...
                      </span>
                  )}
                  {chronic && (
                      <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-700 border border-blue-200">
                          Cron: {chronic.substring(0, 15)}...
                      </span>
                  )}
              </div>
          );
      } catch (e) { return null; }
  };

  return (
    <div className="p-4 md:p-6 max-w-7xl mx-auto pb-24 md:pb-6">
      
      {/* HEADER */}
      <div className="flex justify-between items-center mb-6">
        <div><h1 className="text-2xl font-bold text-slate-800 dark:text-white">Pacientes</h1><p className="text-slate-500 dark:text-slate-400 text-sm">Directorio clÃ­nico</p></div>
        <button onClick={() => { setEditingPatient(null); setIsModalOpen(true); }} className="bg-brand-teal hover:bg-teal-600 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-teal-500/20 active:scale-95"><UserPlus size={20} /> <span className="hidden sm:inline">Nuevo</span></button>
      </div>

      {/* BUSCADOR */}
      <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-4">
          <div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} /><input type="text" placeholder="Buscar paciente por nombre..." className="w-full pl-10 pr-4 py-3 bg-transparent border-none rounded-xl text-slate-700 dark:text-slate-200 focus:ring-0 placeholder:text-slate-400" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
      </div>

      <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
        
        {/* ESCRITORIO */}
        <div className="hidden md:block overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-slate-50 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400 text-xs uppercase"><th className="p-4 font-bold">Nombre / Alertas</th><th className="p-4 font-bold">Edad/Sexo</th><th className="p-4 font-bold">Contacto</th><th className="p-4 font-bold text-center">Acciones</th></tr>
            </thead>
            <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
              {filteredPatients.map(patient => (
                <tr key={patient.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors group">
                  <td className="p-4">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full bg-teal-50 text-brand-teal flex items-center justify-center font-bold text-sm border border-teal-100">
                            {getInitials(patient.name)}
                        </div>
                        <div>
                            <p className="font-bold text-slate-800 dark:text-white leading-tight">{patient.name || 'Sin Nombre'}</p>
                            {getCriticalTags(patient.history)}
                        </div>
                      </div>
                  </td>
                  <td className="p-4 text-sm text-slate-600 dark:text-slate-300">{patient.age} aÃ±os â€¢ {patient.gender}</td>
                  <td className="p-4 text-sm">
                      <div className="flex items-center gap-2">
                          <span className="text-slate-600 dark:text-slate-300">{patient.phone || 'S/N'}</span>
                          {patient.phone && (
                              <button onClick={() => handleWhatsAppDirect(patient.phone)} className="text-green-500 hover:text-green-600 bg-green-50 p-1 rounded-full"><MessageCircle size={14}/></button>
                          )}
                      </div>
                      <p className="text-xs text-slate-400 mt-0.5">{patient.email}</p>
                  </td>
                  <td className="p-4 relative text-center">
                    <div className="flex justify-center gap-2">
                          <button onClick={() => handleLoadInsights(patient)} className="p-2 text-indigo-500 hover:bg-indigo-50 rounded-lg transition-colors" title="Balance 360Â°"><Sparkles size={18}/></button>
                          <button onClick={() => handleViewHistory(patient)} className="p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Expediente"><Eye size={18}/></button>
                          <button onClick={() => setSelectedPatientForRx(patient)} className="p-2 text-teal-600 hover:bg-teal-50 rounded-lg transition-colors" title="Receta"><Pill size={18}/></button>
                          <button onClick={() => openEditModal(patient)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors" title="Editar"><Edit2 size={18}/></button>
                          <button onClick={() => handleDelete(patient.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar"><Trash2 size={18}/></button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* MÃ“VIL */}
        <div className="md:hidden divide-y divide-slate-100 dark:divide-slate-700">
             {filteredPatients.map(patient => {
                const isExpanded = expandedPatientId === patient.id;
                return (
                <div key={patient.id} className={`transition-all duration-300 ${isExpanded ? 'bg-slate-50 dark:bg-slate-800/50 pb-3' : 'bg-white dark:bg-slate-800'}`}>
                    <div 
                        className="p-4 flex items-start gap-3 cursor-pointer active:bg-slate-100 dark:active:bg-slate-700/50 transition-colors"
                        onClick={() => toggleExpand(patient.id)}
                    >
                        <div className="w-10 h-10 rounded-full bg-teal-50 dark:bg-teal-900/20 text-brand-teal dark:text-teal-400 flex items-center justify-center font-bold text-sm shrink-0 border border-teal-100 dark:border-teal-900/50 mt-1">
                            {getInitials(patient.name)}
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-center">
                                <h3 className="font-bold text-slate-900 dark:text-white text-sm truncate pr-2">
                                    {patient.name || 'Sin Nombre'}
                                </h3>
                                <ChevronDown size={16} className={`text-slate-400 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
                            </div>
                            <p className="text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5">
                                {patient.age ? `${patient.age} aÃ±os` : 'Edad N/A'} â€¢ {patient.gender || '-'}
                            </p>
                            <div className="mt-1">{getCriticalTags(patient.history)}</div>
                        </div>
                    </div>

                    {isExpanded && (
                        <div className="px-4 animate-fade-in-down">
                            <button 
                                onClick={(e) => { e.stopPropagation(); handleLoadInsights(patient); }}
                                className="w-full mb-2 py-2 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-400 border border-indigo-100 dark:border-indigo-800 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-colors"
                            >
                                <Sparkles size={16} /> Ver Balance ClÃ­nico 360Â°
                            </button>

                            <div className="grid grid-cols-4 gap-2 mb-3">
                                <button onClick={(e) => { e.stopPropagation(); handleCall(patient.phone); }} disabled={!patient.phone} className={`flex flex-col items-center justify-center py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl shadow-sm active:scale-95 transition-all ${!patient.phone && 'opacity-50 grayscale'}`}>
                                    <Phone size={18} className="text-slate-600 dark:text-slate-300 mb-1" /><span className="text-[9px] font-bold text-slate-500 dark:text-slate-400">Llamar</span>
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); handleWhatsAppDirect(patient.phone); }} disabled={!patient.phone} className={`flex flex-col items-center justify-center py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl shadow-sm active:scale-95 transition-all ${!patient.phone && 'opacity-50 grayscale'}`}>
                                    <MessageCircle size={18} className="text-green-500 mb-1" /><span className="text-[9px] font-bold text-slate-500 dark:text-slate-400">WhatsApp</span>
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); handleViewHistory(patient); }} className="flex flex-col items-center justify-center py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl shadow-sm active:scale-95 transition-all">
                                    <Eye size={18} className="text-purple-500 mb-1" /><span className="text-[9px] font-bold text-slate-500 dark:text-slate-400">Expediente</span>
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); setSelectedPatientForRx(patient); }} className="flex flex-col items-center justify-center py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl shadow-sm active:scale-95 transition-all">
                                    <Pill size={18} className="text-teal-500 mb-1" /><span className="text-[9px] font-bold text-slate-500 dark:text-slate-400">Receta</span>
                                </button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={(e) => { e.stopPropagation(); openEditModal(patient); }} className="flex-1 py-2.5 bg-slate-100 dark:bg-slate-700/50 text-xs font-bold text-slate-600 dark:text-slate-300 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                                    <Edit2 size={14} /> Editar Datos
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); handleDelete(patient.id); }} className="px-4 py-2.5 bg-red-50 dark:bg-red-900/20 text-xs font-bold text-red-600 dark:text-red-400 rounded-lg flex items-center justify-center gap-2 hover:bg-red-100 transition-colors">
                                    <Trash2 size={14} />
                                </button>
                            </div>
                        </div>
                    )}
                </div>
             );
            })}
        </div>
        {filteredPatients.length === 0 && <div className="p-10 text-center text-slate-400">No se encontraron pacientes.</div>}
      </div>

      {isModalOpen && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-0 md:p-4 backdrop-blur-sm">
          <div className="bg-white dark:bg-slate-900 w-full md:max-w-4xl h-full md:h-[90vh] md:rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up flex flex-col">
            <PatientWizard 
                initialData={editingPatient ? { 
                    name: editingPatient.name, 
                    age: editingPatient.age?.toString(), 
                    gender: editingPatient.gender, 
                    phone: editingPatient.phone, 
                    email: editingPatient.email,
                    ...(() => {
                        try {
                            const h = JSON.parse(editingPatient.history || '{}');
                            return {
                                pathological: h.background,
                                nonPathological: h.lifestyle,
                                family: h.family,
                                allergies: h.legacyNote || h.allergies,
                                obgyn: h.obgyn,
                                insurance: h.admin?.insurance,
                                rfc: h.admin?.rfc,
                                patientType: h.admin?.type
                            };
                        } catch { return {}; }
                    })()
                } : undefined}
                onClose={() => setIsModalOpen(false)}
                onSave={async (data) => {
                    try {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (!user) return;
                        
                        const fullHistoryJSON = JSON.stringify({ 
                            background: data.pathological, 
                            lifestyle: data.nonPathological, 
                            family: data.family, 
                            obgyn: data.obgyn, 
                            allergies: data.allergies, 
                            admin: { insurance: data.insurance, rfc: data.rfc, invoice: data.invoice, type: data.patientType, referral: data.referral }, 
                            legacyNote: data.allergies 
                        });

                        const patientPayload = { name: data.name, age: parseInt(data.age) || 0, gender: data.gender, phone: data.phone, email: data.email, history: fullHistoryJSON, doctor_id: user.id };

                        if (editingPatient) { 
                            const { error } = await supabase.from('patients').update(patientPayload).eq('id', editingPatient.id); 
                            if (error) throw error; 
                            toast.success('Expediente actualizado'); 
                        } else { 
                            const { error } = await supabase.from('patients').insert([patientPayload]); 
                            if (error) throw error; 
                            toast.success('Nuevo expediente creado'); 
                        }
                        
                        setIsModalOpen(false); setEditingPatient(null); fetchPatients();
                    } catch (e) { toast.error("Error al guardar expediente"); }
                }}
            />
          </div>
        </div>
      )}

      {isHistoryOpen && viewingPatient && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white dark:bg-slate-900 w-full max-w-4xl h-[85vh] rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up flex flex-col relative">
            <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
              <div><h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><FileText className="text-brand-teal"/> Expediente ClÃ­nico</h3><p className="text-sm text-slate-500 dark:text-slate-400">Paciente: <span className="font-bold">{viewingPatient.name}</span></p></div>
              <div className="flex items-center gap-2">
                  {/* ðŸ”¥ BOTÃ“N DESCARGAR HISTORIAL COMPLETO */}
                  <button onClick={handleDownloadFullHistory} className="hidden md:flex p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 dark:bg-indigo-900/20 dark:text-indigo-300 font-bold text-xs items-center gap-2 transition-colors">
                      <FileText size={16}/> Descargar Historial
                  </button>

                  <button onClick={() => setIsGalleryOpen(!isGalleryOpen)} className={`p-2 rounded-full transition-colors flex items-center gap-2 text-sm font-bold border ${isGalleryOpen ? 'bg-teal-100 text-brand-teal border-teal-200' : 'bg-white dark:bg-slate-800 text-slate-500 border-slate-200 dark:border-slate-700 hover:text-brand-teal'}`} title="Archivos"><FolderOpen size={18}/><span>Archivos</span></button>
                  <div className="h-6 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                  <button onClick={() => setIsHistoryOpen(false)} className="p-2 bg-white dark:bg-slate-800 rounded-full text-slate-400 hover:text-red-500 shadow-sm transition-colors"><X size={24}/></button>
              </div>
            </div>
            
            <div className="flex-1 overflow-hidden relative flex">
                <div className={`flex-1 overflow-y-auto p-6 bg-slate-100 dark:bg-slate-900 transition-all duration-300 ${isGalleryOpen ? 'w-1/2 opacity-50 md:opacity-100' : 'w-full'}`}>
                    {loadingHistory ? ( <div className="flex flex-col items-center justify-center h-full text-slate-400 gap-3"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-brand-teal"></div><p>Cargando historial...</p></div> ) : patientHistory.length === 0 ? ( <div className="flex flex-col items-center justify-center h-full text-slate-400 opacity-70"><FileCode size={64} strokeWidth={1} className="mb-4"/><p className="text-lg">No hay consultas registradas aÃºn.</p></div> ) : (
                        <div className="space-y-6">
                            {patientHistory.map((consultation) => (
                                <div key={consultation.id} className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                                    <div className="bg-slate-50 dark:bg-slate-950 p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                                            <div className="flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-300">
                                                <div className="flex items-center gap-1 bg-white dark:bg-slate-800 px-2 py-1 rounded border dark:border-slate-700"><Calendar size={14} className="text-brand-teal"/>{new Date(consultation.created_at).toLocaleDateString()}</div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => handleShareNoteWhatsApp(consultation)} className="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded border border-transparent hover:border-green-200 transition-colors"><Share2 size={16}/></button>
                                                <button onClick={() => handlePrintNote(consultation)} className="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded border border-transparent hover:border-blue-200 transition-colors" title="Descargar PDF"><Download size={16}/></button>
                                            </div>
                                    </div>
                                    <div className="p-5 text-sm text-slate-700 dark:text-slate-300 leading-relaxed">
                                            {renderNoteContent(consultation.summary)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                {isGalleryOpen && (<div className="w-full md:w-[400px] border-l dark:border-slate-800 bg-white dark:bg-slate-900 shadow-2xl animate-slide-in-right absolute right-0 h-full z-20 flex flex-col"><div className="p-4 border-b dark:border-slate-800 bg-slate-50 dark:bg-slate-950/50 flex justify-between items-center"><h4 className="font-bold text-slate-700 dark:text-white flex items-center gap-2"><Paperclip size={16}/> Archivos del Paciente</h4><button onClick={() => setIsGalleryOpen(false)} className="md:hidden p-1 text-slate-400"><X size={16}/></button></div><div className="flex-1 overflow-y-auto p-0"><DoctorFileGallery patientId={viewingPatient.id} /></div></div>)}
            </div>
          </div>
        </div>
      )}

      <InsightsPanel 
        isOpen={isInsightsOpen} 
        onClose={() => setIsInsightsOpen(false)} 
        insights={patientInsights} 
        isLoading={isLoadingInsights}
        patientName={analyzingPatientName}
      />
      
      {selectedPatientForRx && doctorProfile && <QuickRxModal isOpen={!!selectedPatientForRx} onClose={() => setSelectedPatientForRx(null)} initialTranscript="" patientName={selectedPatientForRx.name} doctorProfile={doctorProfile} />}
    </div>
  );
};

export default PatientsView;

--------------------------------------------------
ðŸ“ PATH: src\components\PatientWizard.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { 
  User, Calendar, Phone, MapPin, Activity, AlertTriangle, 
  Save, X, ShieldAlert, HeartPulse, Droplet, FileBadge, Shield,
  Mail, Hash, Contact
} from 'lucide-react';
import { toast } from 'sonner';

// --- TIPOS DE DATOS (MANTENIDOS) ---
export interface WizardData {
  // IdentificaciÃ³n
  name: string;
  dob: string;
  age: string;
  gender: string;
  curp: string;         // Obligatorio NOM-004
  bloodType: string;    // CrÃ­tico
  maritalStatus: string;
  
  // Contacto
  phone: string;
  email: string;
  address: string;
  occupation: string;
  emergencyContact: string; 
  
  // ClÃ­nico CrÃ­tico
  allergies: string; 
  nonCriticalAllergies: string;
  background: string; 
  notes: string; 
  
  // Estructura interna para compatibilidad (JSON en DB)
  pathological?: any;
  nonPathological?: any;
  family?: any;
  obgyn?: any;
  insurance?: string;
  rfc?: string;
  invoice?: boolean;
  patientType?: string;
  referral?: string;
}

interface PatientWizardProps {
  initialData?: Partial<WizardData>;
  onClose: () => void;
  onSave: (data: WizardData) => Promise<void>;
}

export const PatientWizard: React.FC<PatientWizardProps> = ({ initialData, onClose, onSave }) => {
  const [isSaving, setIsSaving] = useState(false);
  const [errors, setErrors] = useState<{ [key: string]: boolean }>({});
  const [activeTab, setActiveTab] = useState<'general' | 'background' | 'admin'>('general');

  const [formData, setFormData] = useState<WizardData>({
    name: '', dob: '', age: '', gender: 'Masculino', 
    curp: '', bloodType: '', 
    maritalStatus: 'Soltero/a',
    phone: '', email: '', address: '', occupation: '', emergencyContact: '',
    allergies: '', nonCriticalAllergies: '', background: '', notes: '',
    pathological: {}, nonPathological: {}, family: {}, obgyn: {},
    insurance: '', rfc: '', invoice: false, patientType: 'Nuevo', referral: ''
  });

  // Carga de datos iniciales
  useEffect(() => {
    if (initialData) {
      setFormData(prev => ({ ...prev, ...initialData }));
    }
  }, [initialData]);

  // CÃ¡lculo AutomÃ¡tico de Edad
  useEffect(() => {
    if (formData.dob) {
      const birthDate = new Date(formData.dob);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
      setFormData(prev => ({ ...prev, age: age.toString() }));
    }
  }, [formData.dob]);

  const handleChange = (field: keyof WizardData, value: any) => {
    if (field === 'curp' || field === 'rfc') value = value.toUpperCase();
    setFormData(prev => ({ ...prev, [field]: value }));
    if (errors[field]) setErrors(prev => ({ ...prev, [field]: false }));
  };

  const validateAndSave = async () => {
    const newErrors: { [key: string]: boolean } = {};
    if (!formData.name.trim()) newErrors.name = true;
    if (!formData.gender) newErrors.gender = true;

    if (Object.keys(newErrors).length > 0) {
      setErrors(newErrors);
      toast.error("Complete los campos obligatorios marcados en rojo.");
      setActiveTab('general');
      return;
    }

    setIsSaving(true);
    try {
      await onSave(formData);
    } catch (e) {
      console.error(e);
      setIsSaving(false);
    }
  };

  const tabs = [
    { id: 'general', label: 'Ficha General', icon: User },
    { id: 'background', label: 'Antecedentes', icon: Activity },
    { id: 'admin', label: 'Administrativo', icon: Shield },
  ];

  return (
    <div className="flex flex-col h-full bg-white dark:bg-slate-950 font-sans">
      
      {/* HEADER ELEGANTE */}
      <div className="bg-white dark:bg-slate-900 border-b border-slate-100 dark:border-slate-800 px-8 py-5 flex justify-between items-center shadow-sm z-20">
        <div>
          <h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
            <div className="p-2 bg-brand-teal/10 rounded-lg text-brand-teal">
                <User size={20} />
            </div>
            {initialData ? 'Expediente ClÃ­nico' : 'Alta de Paciente'}
          </h2>
          <p className="text-xs text-slate-400 mt-1 ml-12 font-medium tracking-wide">
            Cumplimiento NOM-004-SSA3-2012
          </p>
        </div>
        <button onClick={onClose} className="p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-full text-slate-400 hover:text-red-500 transition-colors">
          <X size={24} />
        </button>
      </div>

      {/* TABS DE NAVEGACIÃ“N MODERNOS */}
      <div className="flex border-b border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 px-8 sticky top-0 z-10">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id as any)}
            className={`flex items-center gap-2 px-6 py-4 text-sm font-bold border-b-2 transition-all ${
              activeTab === tab.id 
                ? 'border-brand-teal text-brand-teal' 
                : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50 dark:hover:bg-slate-800'
            }`}
          >
            <tab.icon size={16} className={activeTab === tab.id ? 'animate-pulse' : ''} /> {tab.label}
          </button>
        ))}
      </div>

      {/* BODY (BENTO GRID LAYOUT) */}
      <div className="flex-1 overflow-y-auto p-6 md:p-8 bg-slate-50/50 dark:bg-slate-950 custom-scrollbar">
        <div className="max-w-5xl mx-auto space-y-6">

          {/* --- PESTAÃ‘A 1: GENERALES (REDISEÃ‘ADA) --- */}
          {activeTab === 'general' && (
            <div className="grid grid-cols-12 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                
                {/* TARJETA 1: IDENTIDAD PRINCIPAL (Full Width Top) */}
                <div className="col-span-12 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h4 className="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <FileBadge size={14}/> IdentificaciÃ³n Principal
                    </h4>
                    
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                        {/* Nombre */}
                        <div className="md:col-span-8">
                            <label className="label-modern">Nombre Completo <span className="text-red-500">*</span></label>
                            <div className="relative group">
                                <input 
                                    className={`input-modern pl-10 text-lg font-semibold ${errors.name ? 'border-red-500 ring-red-100' : ''}`}
                                    value={formData.name} 
                                    onChange={(e) => handleChange('name', e.target.value)} 
                                    placeholder="Apellidos y Nombres" 
                                    autoFocus 
                                />
                                <User size={18} className="absolute left-3 top-3.5 text-slate-400 group-focus-within:text-indigo-500 transition-colors"/>
                            </div>
                        </div>

                        {/* GÃ©nero */}
                        <div className="md:col-span-4">
                            <label className="label-modern">GÃ©nero <span className="text-red-500">*</span></label>
                            <select className="input-modern" value={formData.gender} onChange={(e) => handleChange('gender', e.target.value)}>
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                            </select>
                        </div>

                        {/* Fecha Nacimiento */}
                        <div className="md:col-span-4">
                            <label className="label-modern">Fecha Nacimiento</label>
                            <div className="relative">
                                <input type="date" className="input-modern pl-10" value={formData.dob} onChange={(e) => handleChange('dob', e.target.value)} />
                                <Calendar size={18} className="absolute left-3 top-3 text-slate-400"/>
                            </div>
                        </div>

                        {/* Edad (Auto) */}
                        <div className="md:col-span-2">
                            <label className="label-modern">Edad</label>
                            <div className="input-modern bg-slate-100 dark:bg-slate-800 text-center font-bold text-slate-600">
                                {formData.age || '--'}
                            </div>
                        </div>

                        {/* CURP */}
                        <div className="md:col-span-6">
                            <label className="label-modern">CURP (18 Caracteres)</label>
                            <div className="relative">
                                <input className="input-modern pl-10 uppercase tracking-wide font-mono text-sm" value={formData.curp} onChange={(e) => handleChange('curp', e.target.value)} maxLength={18} placeholder="XXXX999999XXXXXX99"/>
                                <Hash size={16} className="absolute left-3 top-3 text-slate-400"/>
                            </div>
                        </div>
                    </div>
                </div>

                {/* TARJETA 2: CONTACTO (Izquierda) */}
                <div className="col-span-12 md:col-span-6 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm h-full">
                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <Phone size={14}/> Datos de Contacto
                    </h4>
                    <div className="space-y-5">
                        <div>
                            <label className="label-modern">TelÃ©fono MÃ³vil</label>
                            <div className="relative">
                                <input className="input-modern pl-10" value={formData.phone} onChange={(e) => handleChange('phone', e.target.value)} placeholder="(000) 000-0000" type="tel" />
                                <Phone size={16} className="absolute left-3 top-3 text-slate-400"/>
                            </div>
                        </div>
                        <div>
                            <label className="label-modern">Correo ElectrÃ³nico</label>
                            <div className="relative">
                                <input className="input-modern pl-10" value={formData.email} onChange={(e) => handleChange('email', e.target.value)} placeholder="paciente@email.com" type="email" />
                                <Mail size={16} className="absolute left-3 top-3 text-slate-400"/>
                            </div>
                        </div>
                        <div>
                            <label className="label-modern">Estado Civil</label>
                            <select className="input-modern" value={formData.maritalStatus} onChange={(e) => handleChange('maritalStatus', e.target.value)}>
                                <option>Soltero/a</option><option>Casado/a</option><option>Divorciado/a</option><option>Viudo/a</option><option>UniÃ³n Libre</option>
                            </select>
                        </div>
                    </div>
                </div>

                {/* TARJETA 3: UBICACIÃ“N (Derecha) */}
                <div className="col-span-12 md:col-span-6 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm h-full">
                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <MapPin size={14}/> Domicilio (INE)
                    </h4>
                    <div className="space-y-5 h-full">
                        <div className="h-full">
                            <label className="label-modern">DirecciÃ³n Completa</label>
                            <textarea 
                                className="input-modern h-32 resize-none leading-relaxed" 
                                value={formData.address} 
                                onChange={(e) => handleChange('address', e.target.value)} 
                                placeholder="Calle, NÃºmero Exterior, Interior, Colonia, C.P., Municipio, Estado."
                            />
                        </div>
                        <div>
                            <label className="label-modern">OcupaciÃ³n</label>
                            <input className="input-modern" value={formData.occupation} onChange={(e) => handleChange('occupation', e.target.value)} placeholder="Ej. Arquitecto, Estudiante..." />
                        </div>
                    </div>
                </div>

            </div>
          )}

          {/* --- PESTAÃ‘A 2: ANTECEDENTES (BENTO) --- */}
          {activeTab === 'background' && (
            <div className="grid grid-cols-12 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                
                {/* ALERTA: ALERGIAS (Destacado Rojo) */}
                <div className="col-span-12 bg-red-50 dark:bg-red-900/10 p-6 rounded-2xl border border-red-200 dark:border-red-900/30">
                    <div className="flex justify-between items-start mb-4">
                        <label className="label-modern text-red-700 dark:text-red-400 flex items-center gap-2">
                            <AlertTriangle size={16}/> Alergias CrÃ­ticas
                        </label>
                        <span className="text-[10px] font-bold bg-red-100 text-red-600 px-2 py-1 rounded uppercase">Obligatorio</span>
                    </div>
                    <textarea 
                        className={`input-modern border-red-200 focus:border-red-500 focus:ring-red-200 bg-white ${errors.allergies ? 'border-red-500' : ''}`}
                        value={formData.allergies}
                        onChange={(e) => handleChange('allergies', e.target.value)}
                        placeholder="Â¡IMPORTANTE! Escriba 'NEGADAS' si no tiene alergias conocidas."
                        rows={2}
                    />
                </div>

                {/* GRUPO SANGUÃNEO (Tarjeta PequeÃ±a) */}
                <div className="col-span-12 md:col-span-4 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800">
                    <label className="label-modern flex items-center gap-2 mb-4"><Droplet size={14} className="text-red-500"/> Tipo de Sangre</label>
                    <div className="grid grid-cols-3 gap-2">
                        {['O', 'A', 'B', 'AB'].map(type => (
                            <button 
                                key={type} 
                                onClick={() => handleChange('bloodType', type + (formData.bloodType.includes('-') ? '-' : '+'))}
                                className={`py-2 rounded-lg text-sm font-bold border transition-all ${formData.bloodType.includes(type) ? 'bg-slate-800 text-white border-slate-800' : 'bg-white border-slate-200 hover:border-slate-400 text-slate-600'}`}
                            >{type}</button>
                        ))}
                    </div>
                    <div className="grid grid-cols-2 gap-2 mt-2">
                         <button onClick={() => handleChange('bloodType', formData.bloodType.replace('-', '+').replace('++','+'))} className={`py-1 text-xs font-bold rounded ${formData.bloodType.includes('+') ? 'bg-red-100 text-red-700' : 'bg-slate-50 text-slate-400'}`}>RH +</button>
                         <button onClick={() => handleChange('bloodType', formData.bloodType.replace('+', '-').replace('--','-'))} className={`py-1 text-xs font-bold rounded ${formData.bloodType.includes('-') ? 'bg-red-100 text-red-700' : 'bg-slate-50 text-slate-400'}`}>RH -</button>
                    </div>
                </div>

                {/* APP (PatolÃ³gicos) */}
                <div className="col-span-12 md:col-span-8 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800">
                    <label className="label-modern mb-2 block">Antecedentes Personales PatolÃ³gicos (APP)</label>
                    <textarea 
                        className="input-modern h-32 resize-none bg-slate-50 border-transparent focus:bg-white" 
                        value={formData.background} 
                        onChange={(e) => handleChange('background', e.target.value)} 
                        placeholder="CirugÃ­as, CrÃ³nicos (Diabetes, HTA), Hospitalizaciones..." 
                    />
                </div>

                {/* AHF (Heredofamiliares) */}
                <div className="col-span-12 md:col-span-6 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800">
                    <label className="label-modern mb-2 block">Heredofamiliares (AHF)</label>
                    <textarea 
                        className="input-modern h-24 resize-none" 
                        value={typeof formData.family === 'string' ? formData.family : JSON.stringify(formData.family)} 
                        onChange={(e) => handleChange('family', e.target.value)} 
                        placeholder="Padres/Abuelos con CÃ¡ncer, Diabetes, CardiopatÃ­as..." 
                    />
                </div>

                {/* APNP (No PatolÃ³gicos) */}
                <div className="col-span-12 md:col-span-6 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800">
                    <label className="label-modern mb-2 block">No PatolÃ³gicos (APNP)</label>
                    <textarea 
                        className="input-modern h-24 resize-none" 
                        value={typeof formData.nonPathological === 'string' ? formData.nonPathological : JSON.stringify(formData.nonPathological)} 
                        onChange={(e) => handleChange('nonPathological', e.target.value)} 
                        placeholder="Tabaquismo, Alcoholismo, Deportes, AlimentaciÃ³n..." 
                    />
                </div>

            </div>
          )}

          {/* --- PESTAÃ‘A 3: ADMINISTRATIVO (BENTO) --- */}
          {activeTab === 'admin' && (
            <div className="grid grid-cols-12 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                
                {/* TARJETA DE SEGURO */}
                <div className="col-span-12 bg-indigo-50 dark:bg-indigo-900/10 p-6 rounded-2xl border border-indigo-100 dark:border-indigo-800">
                    <h4 className="text-xs font-bold text-indigo-600 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <Shield size={14}/> Seguro & FacturaciÃ³n
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="label-modern">Aseguradora</label>
                            <input className="input-modern bg-white" value={formData.insurance} onChange={(e) => handleChange('insurance', e.target.value)} placeholder="Nombre de la compaÃ±Ã­a / Poliza" />
                        </div>
                        <div>
                            <label className="label-modern">RFC</label>
                            <input className="input-modern bg-white uppercase font-mono" value={formData.rfc} onChange={(e) => handleChange('rfc', e.target.value)} placeholder="RFC con Homoclave" />
                        </div>
                    </div>
                </div>

                {/* MARKETING */}
                <div className="col-span-12 md:col-span-6 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800">
                    <label className="label-modern">Origen del Paciente</label>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <select className="input-modern col-span-2" value={formData.patientType} onChange={(e) => handleChange('patientType', e.target.value)}>
                            <option>Nuevo</option><option>Subsecuente</option><option>Referido</option><option>VIP</option>
                        </select>
                    </div>
                    <label className="label-modern">Referido Por</label>
                    <div className="relative">
                        <input className="input-modern pl-10" value={formData.referral} onChange={(e) => handleChange('referral', e.target.value)} placeholder="Nombre del doctor o medio" />
                        <Contact size={16} className="absolute left-3 top-3 text-slate-400"/>
                    </div>
                </div>

                {/* NOTAS PRIVADAS */}
                <div className="col-span-12 md:col-span-6 bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800">
                    <label className="label-modern flex items-center gap-2 mb-2"><HeartPulse size={14} className="text-brand-teal"/> Notas Administrativas (Internas)</label>
                    <textarea className="input-modern h-32 resize-none bg-yellow-50/50 border-yellow-100 focus:bg-white" value={formData.notes} onChange={(e) => handleChange('notes', e.target.value)} placeholder="Preferencias de pago, personalidad, observaciones..." />
                </div>

            </div>
          )}

        </div>
      </div>

      {/* FOOTER PREMIUM */}
      <div className="p-6 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 flex justify-end gap-4 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button 
            onClick={onClose} 
            className="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
        >
            Cancelar
        </button>

        <button 
            onClick={validateAndSave} 
            disabled={isSaving} 
            className="px-8 py-3 bg-brand-teal text-white rounded-xl font-bold flex items-center gap-2 hover:bg-teal-600 shadow-lg shadow-teal-500/30 transition-all hover:scale-[1.02] active:scale-95 disabled:opacity-70 disabled:scale-100"
        >
            {isSaving ? <Activity className="animate-spin" size={20}/> : <Save size={20} />} 
            Guardar Expediente
        </button>
      </div>

      {/* ESTILOS INTERNOS MEJORADOS */}
      <style>{`
        .label-modern { 
            @apply block text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5 ml-1; 
        }
        .input-modern { 
            @apply w-full px-4 py-3 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-xl text-slate-700 dark:text-white text-sm font-semibold focus:ring-2 focus:ring-brand-teal/20 focus:border-brand-teal focus:bg-white transition-all placeholder:text-slate-300 outline-none; 
        }
      `}</style>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\PrescriptionPDF.tsx
--------------------------------------------------
import React from 'react';
import { Page, Text, View, Document, StyleSheet, Image } from '@react-pdf/renderer';
import { MedicationItem } from '../types';

// Estilos corporativos unificados (Identidad "Verde")
const styles = StyleSheet.create({
  page: { padding: 40, fontFamily: 'Helvetica', fontSize: 10, color: '#333' },
  header: { flexDirection: 'row', marginBottom: 20, borderBottomWidth: 2, borderBottomColor: '#0d9488', paddingBottom: 10 },
  logoSection: { width: '20%', marginRight: 10, justifyContent: 'center' },
  logo: { width: 60, height: 60, objectFit: 'contain' },
  doctorInfo: { width: '80%', justifyContent: 'center' },
  doctorName: { fontSize: 14, fontFamily: 'Helvetica-Bold', color: '#0d9488', marginBottom: 2, textTransform: 'uppercase' },
  specialty: { fontSize: 10, fontFamily: 'Helvetica-Bold', color: '#555', marginBottom: 2, textTransform: 'uppercase' },
  detailsLegal: { fontSize: 8, color: '#444', marginBottom: 1 },
  
  // Barra de paciente estandarizada
  patientSection: { marginBottom: 20, padding: 10, backgroundColor: '#f0fdfa', borderRadius: 4, flexDirection: 'row', justifyContent: 'space-between', border: '1px solid #ccfbf1' },
  label: { fontFamily: 'Helvetica-Bold', color: '#0f766e', fontSize: 9 },
  value: { fontFamily: 'Helvetica', color: '#333', fontSize: 9 },
  
  // Cuerpo del documento
  rxSection: { flex: 1, paddingVertical: 10 },
  docTitle: { fontSize: 16, fontFamily: 'Helvetica-Bold', color: '#0d9488', textAlign: 'center', marginBottom: 20, textTransform: 'uppercase', letterSpacing: 1, textDecoration: 'underline' },
  
  // Estilos para contenido de texto (Justificantes/Certificados)
  bodyText: { fontSize: 10, lineHeight: 1.6, textAlign: 'justify', marginBottom: 10, color: '#374151' },
  
  // Estilos para lista de medicamentos (Recetas)
  medication: { marginBottom: 8, paddingBottom: 4, borderBottomWidth: 1, borderBottomColor: '#eee' },
  medName: { fontSize: 10, fontFamily: 'Helvetica-Bold', marginBottom: 2 },
  medInstructions: { fontSize: 9, fontStyle: 'italic', color: '#444' },
  
  // Secciones SOAP
  sectionBlock: { marginBottom: 10 },
  sectionTitle: { fontSize: 9, fontFamily: 'Helvetica-Bold', color: '#0f766e', marginBottom: 2, textTransform: 'uppercase' },
  
  // Pie de pÃ¡gina legal
  footer: { marginTop: 30, paddingTop: 10, borderTopWidth: 1, borderTopColor: '#ddd', flexDirection: 'row', justifyContent: 'space-between', alignItems: 'flex-end' },
  signatureSection: { alignItems: 'center', width: '40%' },
  signatureImage: { width: 100, height: 40, objectFit: 'contain', marginBottom: 5 },
  signatureLine: { width: '100%', borderTopWidth: 1, borderTopColor: '#333', marginTop: 5 },
  legalTextContainer: { width: '55%' },
  legalText: { fontSize: 6, color: '#888', marginTop: 2, textAlign: 'left', lineHeight: 1.3 },
});

interface PrescriptionPDFProps {
  doctorName: string;
  specialty: string;
  license: string;
  phone: string;
  university: string;
  address: string;
  logoUrl?: string;
  signatureUrl?: string;
  patientName: string;
  patientAge?: string; 
  date: string;
  medications?: MedicationItem[];
  content?: string; 
  documentTitle?: string; // TÃ­tulo dinÃ¡mico
}

const PrescriptionPDF: React.FC<PrescriptionPDFProps> = ({ 
  doctorName, specialty, license, phone, university, address, logoUrl, signatureUrl, 
  patientName, patientAge, date, medications = [], content,
  documentTitle = "RECETA MÃ‰DICA" 
}) => {

  // Formateador inteligente de contenido
  const formatContent = (text: string) => {
    if (!text) return null;
    const lines = text.split('\n');
    return lines.map((line, index) => {
      const trimmed = line.trim();
      if (!trimmed) return <Text key={index} style={{marginBottom: 5}}>{' '}</Text>; // Espacio vacÃ­o
      
      // DetecciÃ³n de secciones SOAP para negritas
      if (trimmed.match(/^(S:|Subjetivo:)/i)) return <View key={index} style={styles.sectionBlock}><Text style={styles.sectionTitle}>PADECIMIENTO ACTUAL (S):</Text><Text style={styles.bodyText}>{trimmed.replace(/^(S:|Subjetivo:)/i, '').trim()}</Text></View>;
      if (trimmed.match(/^(O:|Objetivo:)/i)) return <View key={index} style={styles.sectionBlock}><Text style={styles.sectionTitle}>EXPLORACIÃ“N FÃSICA (O):</Text><Text style={styles.bodyText}>{trimmed.replace(/^(O:|Objetivo:)/i, '').trim()}</Text></View>;
      if (trimmed.match(/^(A:|AnÃ¡lisis:|Dx:)/i)) return <View key={index} style={styles.sectionBlock}><Text style={styles.sectionTitle}>DIAGNÃ“STICO (A):</Text><Text style={styles.bodyText}>{trimmed.replace(/^(A:|AnÃ¡lisis:|Dx:)/i, '').trim()}</Text></View>;
      if (trimmed.match(/^(P:|Plan:)/i)) return <View key={index} style={styles.sectionBlock}><Text style={styles.sectionTitle}>PLAN Y TRATAMIENTO (P):</Text><Text style={styles.bodyText}>{trimmed.replace(/^(P:|Plan:)/i, '').trim()}</Text></View>;
      
      // PÃ¡rrafos normales
      return <Text key={index} style={styles.bodyText}>{trimmed}</Text>;
    });
  };

  // ðŸ”´ LÃ“GICA DE IDENTIDAD FORZOSA (Doble Check en Render) ðŸ”´
  const formatDoctorName = (name: string) => {
      if (!name) return 'Dr. ';
      const clean = name.trim();
      return /^(Dr\.|Dra\.)/i.test(clean) ? clean : `Dr. ${clean}`;
  };
  const finalDoctorName = formatDoctorName(doctorName);

  const isValidUrl = (url?: string) => url && (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('data:image'));

  return (
    <Document>
      <Page size="LETTER" style={styles.page}>
        
        {/* ENCABEZADO */}
        <View style={styles.header}>
          <View style={styles.logoSection}>
             {isValidUrl(logoUrl) && <Image src={logoUrl!} style={styles.logo} />}
          </View>
          <View style={styles.doctorInfo}>
            {/* Usamos finalDoctorName aquÃ­ */}
            <Text style={styles.doctorName}>{finalDoctorName}</Text>
            <Text style={styles.specialty}>{specialty}</Text>
            <Text style={styles.detailsLegal}>{university || 'InstituciÃ³n no registrada'}</Text>
            <Text style={styles.detailsLegal}>CÃ©dula Profesional: {license || 'En trÃ¡mite'}</Text>
            <Text style={styles.detailsLegal}>{address} {phone ? `| Tel: ${phone}` : ''}</Text>
          </View>
        </View>

        {/* BARRA DE DATOS DEL PACIENTE */}
        <View style={styles.patientSection}>
            <View>
                <Text style={styles.label}>PACIENTE</Text>
                <Text style={styles.value}>{patientName}</Text>
            </View>
            <View style={{flexDirection: 'row', gap: 20}}>
                {patientAge && (
                  <View>
                    <Text style={styles.label}>EDAD</Text>
                    <Text style={styles.value}>{patientAge}</Text>
                  </View>
                )}
                <View>
                  <Text style={styles.label}>FECHA</Text>
                  <Text style={styles.value}>{date}</Text>
                </View>
            </View>
        </View>

        {/* CUERPO DEL DOCUMENTO */}
        <View style={styles.rxSection}>
          <Text style={styles.docTitle}>{documentTitle}</Text>
          
          {content ? (
              // Modo Texto Libre (Justificantes, Certificados, Notas)
              <View>{formatContent(content)}</View> 
          ) : (
              // Modo Receta Estructurada (Array de medicamentos)
              medications.map((med, i) => (
              <View key={i} style={styles.medication}>
                  <Text style={styles.medName}>{i + 1}. {med.drug || med.name} <Text style={{fontSize:9, fontFamily:'Helvetica'}}>({med.details})</Text></Text>
                  <Text style={styles.medInstructions}>Tomar {med.frequency} durante {med.duration}.</Text>
                  {med.notes && <Text style={{fontSize: 8, color:'#666', marginTop:2}}>Nota: {med.notes}</Text>}
              </View>
              ))
          )}
        </View>

        {/* PIE DE PÃGINA */}
        <View style={styles.footer}>
          <View style={styles.legalTextContainer}>
             <Text style={{fontSize: 7, fontFamily: 'Helvetica-Bold', marginBottom: 2}}>AVISO LEGAL:</Text>
             <Text style={styles.legalText}>
                Este documento es un comprobante mÃ©dico privado legalmente vÃ¡lido conforme a la legislaciÃ³n sanitaria vigente (NOM-004-SSA3-2012). 
                Su falsificaciÃ³n, alteraciÃ³n o uso indebido constituye un delito sancionado por la ley.
             </Text>
             <Text style={styles.legalText}>
                Generado digitalmente vÃ­a MediScribe AI. {new Date().toISOString().split('T')[0]}
             </Text>
          </View>
          
          <View style={styles.signatureSection}>
             {isValidUrl(signatureUrl) ? (
                 <Image src={signatureUrl!} style={styles.signatureImage} />
             ) : (
                 <View style={{height: 40}} /> 
             )}
             <View style={styles.signatureLine} />
             {/* Usamos finalDoctorName aquÃ­ tambiÃ©n */}
             <Text style={{fontSize: 9, marginTop: 4, fontFamily: 'Helvetica-Bold'}}>{finalDoctorName}</Text>
             <Text style={{fontSize: 7, marginTop: 1}}>CÃ©d. Prof. {license}</Text>
          </View>
        </View>
      </Page>
    </Document>
  );
};

export default PrescriptionPDF;

--------------------------------------------------
ðŸ“ PATH: src\components\QuickDocModal.tsx
--------------------------------------------------
import React, { useState } from 'react';
import { X, Printer, FileText, User, AlignLeft, FileCheck } from 'lucide-react';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { pdf } from '@react-pdf/renderer';
import { toast } from 'sonner';
import PrescriptionPDF from './PrescriptionPDF'; // Importamos la "Impresora B"

interface QuickDocModalProps {
  isOpen: boolean;
  onClose: () => void;
  doctorProfile: any;
  defaultType?: 'justificante' | 'certificado' | 'receta';
}

export const QuickDocModal: React.FC<QuickDocModalProps> = ({ isOpen, onClose, doctorProfile, defaultType = 'justificante' }) => {
  const [docType, setDocType] = useState(defaultType);
  const [patientName, setPatientName] = useState('');
  const [age, setAge] = useState('');
  const [diagnosis, setDiagnosis] = useState('');
  const [restDays, setRestDays] = useState('1');
  const [content, setContent] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  
  const todayLong = format(new Date(), "d 'de' MMMM 'de' yyyy", { locale: es });

  const handlePrint = async () => {
    if (!patientName) return toast.error("El nombre del paciente es obligatorio");
    
    setIsGenerating(true);
    const loadingToast = toast.loading("Generando documento oficial...");

    try {
        // 1. TÃ­tulo DinÃ¡mico para el PDF
        const titleMap = {
            'justificante': 'JUSTIFICANTE MÃ‰DICO',
            'certificado': 'CERTIFICADO DE SALUD',
            'receta': 'RECETA MÃ‰DICA'
        };
        const finalTitle = titleMap[docType];

        // 2. ConstrucciÃ³n del Texto Legal (NOM-004) en Texto Plano para el PDF
        // Usamos saltos de lÃ­nea \n que PrescriptionPDF interpretarÃ¡ como pÃ¡rrafos.
        let bodyText = "";

        if (docType === 'justificante') {
            bodyText = `A QUIEN CORRESPONDA:\n\n` +
            `El que suscribe, MÃ©dico Cirujano legalmente autorizado para ejercer la profesiÃ³n, HACE CONSTAR que habiendo examinado al paciente ${patientName.toUpperCase()}${age ? ` de ${age} aÃ±os de edad`:''}, se encontrÃ³ con diagnÃ³stico clÃ­nico de:\n\n` +
            `DIAGNÃ“STICO: ${diagnosis.toUpperCase() || 'ENFERMEDAD GENERAL'}.\n\n` +
            `Por lo anterior, se determina que requiere de ${restDays} DÃAS de reposo para su recuperaciÃ³n y control mÃ©dico, abarcando el periodo a partir de la fecha de expediciÃ³n de este documento.\n\n` +
            `Se extiende la presente constancia a peticiÃ³n del interesado para los fines legales y administrativos que a este convengan.`;
        } else if (docType === 'certificado') {
            bodyText = `A QUIEN CORRESPONDA:\n\n` +
            `El que suscribe, MÃ©dico Cirujano legalmente autorizado, CERTIFICA que habiendo practicado un reconocimiento mÃ©dico exhaustivo a ${patientName.toUpperCase()}${age ? ` de ${age} aÃ±os de edad`:''}, al momento de la exploraciÃ³n lo he encontrado CLÃNICAMENTE SANO.\n\n` +
            `No se encontrÃ³ evidencia de enfermedades infectocontagiosas activas, padecimientos crÃ³nico-degenerativos descompensados ni alteraciones psicomotrices que limiten sus facultades.\n\n` +
            `El paciente se encuentra APTO para realizar las actividades fÃ­sicas, laborales o escolares requeridas.\n\n` +
            `Se extiende el presente certificado a solicitud del interesado para los usos que estime convenientes.`;
        } else {
            // Receta manual
            bodyText = content || "Sin prescripciones agregadas.";
        }

        // ðŸ”´ IDENTIDAD MÃ‰DICA: PREFIJO FORZOSO ðŸ”´
        const rawName = doctorProfile?.full_name || '';
        const doctorNameForced = /^(Dr\.|Dra\.)/i.test(rawName) ? rawName : `Dr. ${rawName}`;

        // 3. Generar el PDF usando el motor unificado
        const blob = await pdf(
            <PrescriptionPDF 
                doctorName={doctorNameForced} // Pasamos el nombre blindado
                specialty={doctorProfile?.specialty || 'Medicina General'}
                license={doctorProfile?.license_number || ''}
                university={doctorProfile?.university || ''}
                phone={doctorProfile?.phone || ''}
                address={doctorProfile?.address || ''}
                logoUrl={doctorProfile?.logo_url}
                signatureUrl={doctorProfile?.signature_url}
                patientName={patientName}
                patientAge={age || ''}
                date={todayLong}
                documentTitle={finalTitle} // <--- TÃ­tulo variable
                content={bodyText}         // <--- Contenido legal variable
            />
        ).toBlob();

        // 4. Abrir
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        toast.dismiss(loadingToast);
        toast.success("Documento generado correctamente");
        onClose();

    } catch (error) {
        console.error(error);
        toast.error("Error al generar PDF");
    } finally {
        setIsGenerating(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] ring-1 ring-slate-200">
        
        {/* Header */}
        <div className="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="p-2 bg-teal-100 rounded-lg text-teal-700"><FileCheck size={20}/></div>
            <div>
                <h3 className="font-bold text-slate-800 text-sm">Generador de Documentos</h3>
                <p className="text-[10px] text-slate-500 uppercase tracking-wide">Legalidad & DiseÃ±o Unificado</p>
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-400"><X size={20}/></button>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto flex-1 bg-white">
          <div className="flex p-1 bg-slate-100 rounded-xl mb-6">
             {['justificante', 'certificado', 'receta'].map((t) => (
               <button key={t} onClick={() => setDocType(t as any)} className={`flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all ${docType === t ? 'bg-white text-teal-700 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'}`}>
                 {t}
               </button>
             ))}
          </div>

          <div className="space-y-4">
             <div className="grid grid-cols-4 gap-4">
                 <div className="col-span-3">
                   <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Paciente</label>
                   <div className="relative">
                       <User size={16} className="absolute left-3 top-3 text-slate-400"/>
                       <input type="text" value={patientName} onChange={e => setPatientName(e.target.value)} className="w-full pl-9 pr-4 py-2.5 border border-slate-200 rounded-xl font-bold text-slate-700 focus:ring-2 focus:ring-teal-500 outline-none text-sm" placeholder="Nombre completo..."/>
                   </div>
                 </div>
                 <div className="col-span-1">
                   <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Edad (Opcional)</label>
                   <input type="text" value={age} onChange={e => setAge(e.target.value)} className="w-full px-3 py-2.5 border border-slate-200 rounded-xl font-medium text-slate-700 focus:ring-2 focus:ring-teal-500 outline-none text-sm" placeholder="Ej. 32"/>
                 </div>
             </div>

             {docType === 'justificante' && (
               <div className="bg-teal-50/50 p-4 rounded-xl border border-teal-100 grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-[10px] font-bold text-teal-700 uppercase mb-1.5 ml-1">DÃ­as de Reposo</label>
                    <input type="number" value={restDays} onChange={e => setRestDays(e.target.value)} className="w-full px-3 py-2 border border-slate-200 rounded-xl font-bold text-teal-800 text-center" />
                  </div>
                  <div>
                    <label className="block text-[10px] font-bold text-teal-700 uppercase mb-1.5 ml-1">DiagnÃ³stico (CIE-10)</label>
                    <input type="text" value={diagnosis} onChange={e => setDiagnosis(e.target.value)} className="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm" placeholder="Ej. Faringitis..."/>
                  </div>
               </div>
             )}

             {docType === 'receta' && (
                <div>
                   <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1"><AlignLeft size={12} className="inline mr-1"/>PrescripciÃ³n Manual</label>
                   <textarea value={content} onChange={e => setContent(e.target.value)} className="w-full p-4 border border-slate-200 rounded-xl h-40 text-sm leading-relaxed focus:ring-2 focus:ring-teal-500 outline-none resize-none font-mono" placeholder="Escriba medicamentos e indicaciones..."></textarea>
                </div>
             )}
          </div>
        </div>

        {/* Footer */}
        <div className="p-4 border-t border-slate-200 flex justify-end gap-3 bg-white">
           <button onClick={onClose} className="px-4 py-2.5 text-slate-500 font-bold hover:bg-white hover:shadow-sm rounded-lg transition-all text-xs">Cancelar</button>
           <button onClick={handlePrint} disabled={isGenerating} className="px-6 py-2.5 bg-teal-600 text-white font-bold rounded-xl flex items-center gap-2 hover:bg-teal-700 shadow-lg active:scale-95 transition-all text-xs disabled:opacity-70">
             {isGenerating ? <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"/> : <Printer size={16} />}
             {isGenerating ? 'GENERANDO PDF...' : 'IMPRIMIR OFICIAL'}
           </button>
        </div>
      </div>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\QuickNotes.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { PenLine, Trash2, Save, MessageCircle } from 'lucide-react';

export const QuickNotes = () => {
  const [note, setNote] = useState('');
  const [saved, setSaved] = useState(false);

  // Cargar nota al iniciar
  useEffect(() => {
    const savedNote = localStorage.getItem('mediscribe_scratchpad');
    if (savedNote) setNote(savedNote);
  }, []);

  // Auto-guardado al escribir
  const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const text = e.target.value;
    setNote(text);
    localStorage.setItem('mediscribe_scratchpad', text);
    
    // Feedback visual sutil
    setSaved(true);
    setTimeout(() => setSaved(false), 2000);
  };

  const clearNotes = () => {
    if (confirm('Â¿Borrar tus notas rÃ¡pidas?')) {
      setNote('');
      localStorage.removeItem('mediscribe_scratchpad');
    }
  };

  const shareViaWhatsApp = () => {
    if (!note.trim()) return;
    // Codificamos el texto para que viaje seguro en la URL
    const encodedText = encodeURIComponent(note);
    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
  };

  return (
    <div className="bg-white rounded-3xl p-5 border border-slate-100 shadow-sm flex flex-col h-full min-h-[250px] relative group transition-all hover:shadow-md">
      <div className="flex justify-between items-center mb-3">
        <div className="flex items-center gap-2">
            <div className="p-1.5 bg-amber-50 rounded-lg text-amber-600">
                <PenLine size={16} />
            </div>
            <span className="text-xs font-bold text-slate-500 uppercase tracking-wide">Notas RÃ¡pidas</span>
        </div>
        <div className="flex gap-2 items-center">
            {saved && <span className="text-[10px] text-teal-600 font-bold animate-pulse flex items-center gap-1 mr-2"><Save size={10}/> Guardado</span>}
            
            {/* BOTÃ“N WHATSAPP */}
            <button 
                onClick={shareViaWhatsApp} 
                className="text-slate-400 hover:text-green-500 hover:bg-green-50 p-1.5 rounded-lg transition-all"
                title="Enviar por WhatsApp"
            >
                <MessageCircle size={16} />
            </button>

            <button 
                onClick={clearNotes} 
                className="text-slate-400 hover:text-red-500 hover:bg-red-50 p-1.5 rounded-lg transition-all"
                title="Borrar notas"
            >
                <Trash2 size={16} />
            </button>
        </div>
      </div>
      
      <div className="relative flex-1">
        <textarea 
            value={note}
            onChange={handleChange}
            placeholder="Escribe recordatorios, dosis o indicaciones y envÃ­alas por WhatsApp..."
            className="w-full h-full resize-none text-sm text-slate-700 leading-relaxed outline-none bg-transparent placeholder:text-slate-300 custom-scrollbar"
            spellCheck={false}
        />
        {/* LÃ­neas de cuaderno decorativas */}
        <div className="absolute inset-0 pointer-events-none bg-[linear-gradient(transparent_27px,#f1f5f9_28px)] bg-[length:100%_28px] -z-10 opacity-50 mt-1"></div>
      </div>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\QuickRxModal.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { X, Plus, Trash2, FileText, Printer, Share2, Mic, StopCircle, Loader2, Sparkles, Edit3, Eraser } from 'lucide-react';
import { toast } from 'sonner';
import { MedicationItem, DoctorProfile } from '../types';
import { pdf } from '@react-pdf/renderer';
import PrescriptionPDF from './PrescriptionPDF';
import { GeminiMedicalService } from '../services/GeminiMedicalService';
import { useSpeechRecognition } from '../hooks/useSpeechRecognition';

interface QuickRxModalProps {
  isOpen: boolean;
  onClose: () => void;
  initialTranscript?: string;
  patientName: string;
  doctorProfile: DoctorProfile;
}

const QuickRxModal: React.FC<QuickRxModalProps> = ({ isOpen, onClose, initialTranscript = '', patientName, doctorProfile }) => {
  const [medications, setMedications] = useState<MedicationItem[]>([]);
  const [isProcessingAI, setIsProcessingAI] = useState(false);
  
  // Este es el texto que el mÃ©dico puede editar manualmente
  const [rawText, setRawText] = useState('');
  
  // Estado para el formulario manual inferior
  const [newMed, setNewMed] = useState({ name: '', details: '', frequency: '', duration: '', notes: '' });

  // Hook de voz
  const { isListening, transcript, startListening, stopListening, resetTranscript } = useSpeechRecognition();

  // 1. SINCRONIZACIÃ“N EN TIEMPO REAL: Lo que escuchas se escribe en el editor
  useEffect(() => {
    if (isListening) {
      setRawText(transcript);
    }
  }, [transcript, isListening]);

  // 2. Carga inicial si viene de otra pantalla
  useEffect(() => {
    if (isOpen && initialTranscript && !rawText) {
      setRawText(initialTranscript);
    }
  }, [isOpen, initialTranscript]);

  const handleExtractFromText = async () => {
    if (!rawText.trim()) {
      toast.error("El cuadro de texto estÃ¡ vacÃ­o. Dicte o escriba algo.");
      return;
    }
    
    setIsProcessingAI(true);
    try {
      // Enviamos el texto (ya corregido por el doctor si fue necesario)
      const extractedMeds = await GeminiMedicalService.extractMedications(rawText);
      
      if (extractedMeds && extractedMeds.length > 0) {
        setMedications(prev => [...prev, ...extractedMeds]);
        toast.success(`${extractedMeds.length} medicamentos procesados`);
        // Opcional: Limpiar el texto si fue exitoso para dictar el siguiente bloque
        // setRawText(''); 
      } else {
        toast.warning("No se detectaron medicamentos. Verifique la redacciÃ³n.");
      }
    } catch (error) {
      console.error(error);
      toast.error("Error al procesar con IA");
    } finally {
      setIsProcessingAI(false);
    }
  };

  const handleMicToggle = () => {
    if (isListening) {
      stopListening();
      // Al parar, NO procesamos automÃ¡ticamente. Dejamos que el mÃ©dico revise el texto.
    } else {
      setRawText(''); // Limpiamos para nueva grabaciÃ³n
      resetTranscript();
      startListening();
    }
  };

  const addManualMed = () => {
    if (!newMed.name || !newMed.frequency) {
      toast.error('Nombre y frecuencia son obligatorios');
      return;
    }
    const item: MedicationItem = {
      drug: newMed.name,
      ...newMed
    };
    setMedications([...medications, item]);
    setNewMed({ name: '', details: '', frequency: '', duration: '', notes: '' });
  };

  const removeMed = (index: number) => {
    setMedications(medications.filter((_, i) => i !== index));
  };

  const handlePrint = async () => {
    if (medications.length === 0) return toast.error("Agrega al menos un medicamento");
    try {
      const blob = await pdf(
        <PrescriptionPDF 
          doctorName={doctorProfile.full_name}
          specialty={doctorProfile.specialty}
          license={doctorProfile.license_number}
          phone={doctorProfile.phone}
          university={doctorProfile.university}
          address={doctorProfile.address}
          logoUrl={doctorProfile.logo_url}
          signatureUrl={doctorProfile.signature_url}
          patientName={patientName}
          date={new Date().toLocaleDateString()}
          medications={medications}
          documentTitle="RECETA MÃ‰DICA"
        />
      ).toBlob();
      window.open(URL.createObjectURL(blob), '_blank');
    } catch (e) {
      toast.error("Error generando PDF");
    }
  };

  const handleWhatsApp = () => {
    if (medications.length === 0) return;
    const text = `*Receta MÃ©dica - Dr. ${doctorProfile.full_name}*\nPaciente: ${patientName}\n\n${medications.map((m, i) => `${i+1}. ${m.drug} ${m.details || ''}\n   IndicaciÃ³n: ${m.frequency} durante ${m.duration} ${m.notes ? `(${m.notes})` : ''}`).join('\n\n')}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
      <div className="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
        
        {/* HEADER */}
        <div className="bg-teal-600 p-4 flex justify-between items-center text-white shrink-0">
          <div className="flex items-center gap-2">
            <FileText size={20} />
            <div>
              <h3 className="font-bold text-lg leading-none">Editor de Receta</h3>
              <p className="text-teal-100 text-xs mt-1">Paciente: {patientName}</p>
            </div>
          </div>
          <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-full transition-colors"><X size={20}/></button>
        </div>

        {/* BODY */}
        <div className="p-6 overflow-y-auto flex-1 bg-slate-50 dark:bg-slate-950">
          
          {/* --- ZONA PRINCIPAL: DICTADO Y EDICIÃ“N --- */}
          <div className="bg-white dark:bg-slate-900 p-5 rounded-2xl border-2 border-slate-200 dark:border-slate-800 shadow-sm mb-6 relative transition-all focus-within:border-teal-500 ring-offset-2">
             
             {/* Barra de Herramientas del Editor */}
             <div className="flex items-center justify-between mb-3 border-b border-slate-100 dark:border-slate-800 pb-2">
                <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                   <Edit3 size={14} className="text-teal-600"/> 
                   {isListening ? 'Escuchando...' : 'Editor de Texto (Corregir aquÃ­)'}
                </label>
                
                <div className="flex gap-2">
                   {rawText && (
                      <button onClick={() => setRawText('')} className="text-xs text-red-400 hover:text-red-600 flex items-center gap-1" title="Borrar texto">
                         <Eraser size={14}/> Borrar
                      </button>
                   )}
                </div>
             </div>

             {/* ÃREA DE TEXTO ENORME PARA EDITAR */}
             <div className="relative">
                <textarea
                    value={rawText}
                    onChange={(e) => setRawText(e.target.value)}
                    placeholder='Presione el micrÃ³fono y dicte: "Paracetamol 500mg cada 8 horas por 3 dÃ­as..."'
                    className="w-full bg-transparent text-lg text-slate-700 dark:text-slate-200 font-medium outline-none resize-none min-h-[100px] leading-relaxed placeholder:text-slate-300"
                    autoFocus
                />
                
                {/* BotÃ³n Flotante de MicrÃ³fono (Dentro del Ã¡rea) */}
                <button 
                   onClick={handleMicToggle}
                   className={`absolute bottom-0 right-0 p-3 rounded-full shadow-lg transition-all transform hover:scale-110 ${isListening ? 'bg-red-500 text-white animate-pulse ring-4 ring-red-200' : 'bg-teal-600 text-white hover:bg-teal-700'}`}
                   title={isListening ? "Detener grabaciÃ³n" : "Iniciar dictado"}
                >
                   {isListening ? <StopCircle size={24} /> : <Mic size={24} />}
                </button>
             </div>

             {/* BotÃ³n de AcciÃ³n Principal */}
             <div className="mt-4 pt-3 border-t border-slate-100 dark:border-slate-800">
                <button 
                    onClick={handleExtractFromText}
                    disabled={isProcessingAI || !rawText.trim()}
                    className="w-full py-3 bg-slate-800 dark:bg-slate-700 hover:bg-slate-900 text-white rounded-xl font-bold text-sm shadow-md flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {isProcessingAI ? <Loader2 size={18} className="animate-spin"/> : <Sparkles size={18} className="text-yellow-400"/>}
                    {isProcessingAI ? "IA Analizando..." : "Generar Receta Estructurada"}
                </button>
             </div>
          </div>

          {/* LISTA DE MEDICAMENTOS (RESULTADO) */}
          <div className="mb-6">
            <h4 className="text-xs font-bold text-slate-400 uppercase mb-3 px-1">Medicamentos Listos ({medications.length})</h4>
            <div className="space-y-3">
                {medications.length === 0 ? (
                <div className="text-center py-6 border border-dashed border-slate-300 dark:border-slate-700 rounded-xl bg-slate-50/50">
                    <p className="text-slate-400 text-sm">La lista estÃ¡ vacÃ­a.</p>
                </div>
                ) : (
                medications.map((med, idx) => (
                    <div key={idx} className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex justify-between items-start group hover:border-teal-200 transition-colors animate-in fade-in slide-in-from-bottom-2">
                    <div>
                        <h4 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <span className="w-6 h-6 rounded-full bg-teal-100 text-teal-700 flex items-center justify-center text-xs font-bold">{idx + 1}</span>
                        {med.drug || med.name} <span className="text-xs font-normal text-slate-500 bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded">{med.details}</span>
                        </h4>
                        <p className="text-sm text-slate-600 dark:text-slate-300 mt-2 pl-8 font-medium">
                        {med.frequency} â€¢ {med.duration}
                        </p>
                        {med.notes && <p className="text-xs text-slate-400 mt-1 pl-8 italic">"{med.notes}"</p>}
                    </div>
                    <button onClick={() => removeMed(idx)} className="text-slate-300 hover:text-red-500 transition-colors p-2"><Trash2 size={18}/></button>
                    </div>
                ))
                )}
            </div>
          </div>

          {/* FORMULARIO MANUAL (SECUNDARIO) */}
          <details className="group bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
            <summary className="p-4 cursor-pointer font-bold text-sm text-slate-600 dark:text-slate-300 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <span>Â¿Agregar manualmente?</span>
                <Plus size={16} className="text-slate-400 group-open:rotate-45 transition-transform"/>
            </summary>
            <div className="p-4 pt-0 grid grid-cols-2 gap-3 bg-slate-50/50 dark:bg-slate-900">
              <input placeholder="Medicamento" value={newMed.name} onChange={e => setNewMed({...newMed, name: e.target.value})} className="input-std col-span-2" />
              <input placeholder="Detalles (500mg)" value={newMed.details} onChange={e => setNewMed({...newMed, details: e.target.value})} className="input-std" />
              <input placeholder="Frecuencia (Cada 8h)" value={newMed.frequency} onChange={e => setNewMed({...newMed, frequency: e.target.value})} className="input-std" />
              <input placeholder="DuraciÃ³n (3 dÃ­as)" value={newMed.duration} onChange={e => setNewMed({...newMed, duration: e.target.value})} className="input-std" />
              <input placeholder="Notas adicionales..." value={newMed.notes} onChange={e => setNewMed({...newMed, notes: e.target.value})} className="input-std col-span-2" />
              <button onClick={addManualMed} className="col-span-2 w-full py-2.5 bg-slate-800 dark:bg-slate-700 text-white rounded-lg font-bold text-sm hover:bg-slate-700 flex items-center justify-center gap-2 transition-colors">
                 <Plus size={16}/> Agregar Manualmente
              </button>
            </div>
          </details>

        </div>

        {/* FOOTER */}
        <div className="p-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-3 shrink-0">
           <button onClick={handleWhatsApp} className="flex items-center gap-2 px-4 py-2 text-green-600 bg-green-50 hover:bg-green-100 rounded-lg font-bold transition-colors border border-green-200">
              <Share2 size={18} /> WhatsApp
           </button>
           <button onClick={handlePrint} className="flex items-center gap-2 px-6 py-2 bg-teal-600 text-white hover:bg-teal-700 rounded-lg font-bold transition-colors shadow-lg shadow-teal-500/20">
              <Printer size={18} /> Imprimir Receta
           </button>
        </div>

        <style>{`
          .input-std {
            @apply w-full p-2.5 bg-white dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 outline-none transition-all placeholder:text-slate-400;
          }
        `}</style>
      </div>
    </div>
  );
};

export default QuickRxModal;

--------------------------------------------------
ðŸ“ PATH: src\components\ReloadPrompt.tsx
--------------------------------------------------
import React, { useEffect } from 'react';
// @ts-ignore
import { useRegisterSW } from 'virtual:pwa-register/react';
import { RefreshCw, X, Wifi, Download } from 'lucide-react';

const ReloadPrompt: React.FC = () => {
  // ConfiguraciÃ³n del intervalo de chequeo (en milisegundos)
  // 20 segundos para pruebas. En producciÃ³n puedes ponerle 60*60*1000 (1 hora).
  const UPDATE_CHECK_INTERVAL = 20 * 1000; 

  const {
    offlineReady: [offlineReady, setOfflineReady],
    needRefresh: [needRefresh, setNeedRefresh],
    updateServiceWorker,
  } = useRegisterSW({
    onRegisteredSW(swUrl: string, r: ServiceWorkerRegistration) {
      console.log('SW Registrado en: ' + swUrl);
      
      // --- EL "LATIDO" DE ACTUALIZACIÃ“N ---
      if (r) {
        setInterval(async () => {
          if (!(!r.installing && !r.waiting)) return;
          if ('connection' in navigator && !(navigator as any).onLine) return;

          try {
            const resp = await fetch(swUrl, {
              cache: 'no-store',
              headers: {
                'cache': 'no-store',
                'cache-control': 'no-cache',
              },
            });

            if (resp?.status === 200) {
              await r.update();
            }
          } catch (e) {
            console.log('Error chequeando actualizaciones', e);
          }
        }, UPDATE_CHECK_INTERVAL);
      }
    },
  });

  const close = () => {
    setOfflineReady(false);
    setNeedRefresh(false);
  };

  // No mostrar si no hay nada
  if (!offlineReady && !needRefresh) return null;

  return (
    <div className="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 animate-fade-in-up max-w-sm w-full p-4">
      <div className="bg-slate-900 dark:bg-slate-800 text-white p-5 rounded-xl shadow-2xl border border-slate-700 flex flex-col gap-3">
        
        <div className="flex justify-between items-start">
            <div className="flex gap-3">
                <div className="mt-1 text-brand-teal">
                    {needRefresh ? <Download size={20} className="animate-bounce"/> : <Wifi size={20}/>}
                </div>
                <div>
                    <h3 className="font-bold text-sm">
                        {needRefresh ? 'Nueva VersiÃ³n Disponible' : 'Listo para Offline'}
                    </h3>
                    <p className="text-xs text-slate-300 mt-1 leading-relaxed">
                        {needRefresh 
                            ? 'Se ha detectado una mejora. Actualiza para ver los cambios.' 
                            : 'La aplicaciÃ³n funciona sin internet.'}
                    </p>
                </div>
            </div>
            <button onClick={close} className="text-slate-400 hover:text-white p-1">
                <X size={18} />
            </button>
        </div>

        {needRefresh && (
            <button 
                onClick={() => updateServiceWorker(true)}
                className="w-full bg-brand-teal hover:bg-teal-600 text-white py-2 px-4 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-colors mt-1 shadow-lg"
            >
                <RefreshCw size={16} /> Actualizar Ahora
            </button>
        )}
      </div>
    </div>
  );
};

export default ReloadPrompt;

--------------------------------------------------
ðŸ“ PATH: src\components\SettingsView.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { Save, User, Stethoscope, Hash, Phone, MapPin, BookOpen, Upload, Image as ImageIcon, PenTool, Globe, Download, FileSpreadsheet, ShieldCheck } from 'lucide-react';
import { supabase } from '../lib/supabase';
import { MedicalDataService } from '../services/MedicalDataService';
import { toast } from 'sonner';
// IMPORTACIÃ“N CRÃTICA: Traemos el componente de planes corregido
import { SubscriptionPlans } from './SubscriptionPlans';

// LISTA MAESTRA DE ESPECIALIDADES (NORMALIZACIÃ“N)
const SPECIALTIES = [
  "Medicina General", "CardiologÃ­a", "CirugÃ­a General", "CirugÃ­a de Columna", "CirugÃ­a de Mano", 
  "CirugÃ­a OncolÃ³gica", "CirugÃ­a PediÃ¡trica", "CirugÃ­a PlÃ¡stica y Reconstructiva", "DermatologÃ­a", 
  "EndocrinologÃ­a", "GastroenterologÃ­a", "GeriatrÃ­a", "GinecologÃ­a y Obstetricia", "Medicina del Deporte", 
  "Medicina Interna", "NefrologÃ­a", "NeumologÃ­a", "NeurocirugÃ­a", "NeurologÃ­a", "OftalmologÃ­a", 
  "OtorrinolaringologÃ­a", "PediatrÃ­a", "PsiquiatrÃ­a", "ReumatologÃ­a", "TraumatologÃ­a y Ortopedia", 
  "TraumatologÃ­a: Artroscopia", "UrologÃ­a", "Urgencias MÃ©dicas"
];

const SettingsView: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [downloading, setDownloading] = useState(false); 
  
  // Campos del formulario
  const [fullName, setFullName] = useState('');
  const [specialty, setSpecialty] = useState('Medicina General');
  const [license, setLicense] = useState('');
  const [phone, setPhone] = useState('');
  
  // Campos NOM-004
  const [university, setUniversity] = useState('');
  const [address, setAddress] = useState('');
  const [logoUrl, setLogoUrl] = useState('');
  const [signatureUrl, setSignatureUrl] = useState('');
  const [websiteUrl, setWebsiteUrl] = useState('');

  useEffect(() => {
    getProfile();
  }, []);

  const getProfile = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

      if (data) {
        setFullName(data.full_name || '');
        setSpecialty(data.specialty || 'Medicina General');
        setLicense(data.license_number || '');
        setPhone(data.phone || '');
        setUniversity(data.university || '');
        setAddress(data.address || '');
        setLogoUrl(data.logo_url || '');
        setSignatureUrl(data.signature_url || '');
        setWebsiteUrl(data.website_url || '');
      }
    } catch (error) {
      console.error('Error cargando perfil:', error);
    } finally {
      setLoading(false);
    }
  };

  const uploadImage = async (event: React.ChangeEvent<HTMLInputElement>, type: 'logo' | 'signature') => {
    try {
      setUploading(true);
      const file = event.target.files?.[0];
      if (!file) return;

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("No usuario");

      const fileExt = file.name.split('.').pop();
      const fileName = `${user.id}/${type}-${Date.now()}.${fileExt}`;

      const { error: uploadError } = await supabase.storage
        .from('clinic-assets')
        .upload(fileName, file, { upsert: true });

      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabase.storage
        .from('clinic-assets')
        .getPublicUrl(fileName);

      if (type === 'logo') setLogoUrl(publicUrl);
      else setSignatureUrl(publicUrl);
      
      toast.success("Imagen subida correctamente");

    } catch (error) {
      toast.error("Error subiendo imagen.");
    } finally {
      setUploading(false);
    }
  };

  const updateProfile = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("No hay sesiÃ³n");

      const updates = {
        id: user.id,
        full_name: fullName,
        specialty,
        license_number: license,
        phone,
        university,
        address,
        logo_url: logoUrl,
        signature_url: signatureUrl,
        website_url: websiteUrl,
        updated_at: new Date(),
      };

      const { error } = await supabase.from('profiles').upsert(updates);
      if (error) throw error;
      
      toast.success("Perfil actualizado correctamente");
    } catch (error) {
      toast.error("Error al guardar perfil.");
    } finally {
      setSaving(false);
    }
  };

  const handleBackup = async () => {
    if(!confirm("Â¿Desea descargar una copia completa de sus pacientes y consultas en formato Excel (CSV)?")) return;
    
    setDownloading(true);
    try {
      if (typeof MedicalDataService.downloadFullBackup === 'function') {
          const success = await MedicalDataService.downloadFullBackup();
          if(success) toast.success("Respaldo descargado correctamente.");
          else toast.info("No hay datos para respaldar aÃºn.");
      } else {
          toast.error("FunciÃ³n de respaldo no disponible aÃºn.");
      }
    } catch(e) {
      toast.error("Error al generar respaldo.");
    } finally {
      setDownloading(false);
    }
  };

  if (loading) return <div className="p-10 text-center text-slate-400">Cargando perfil...</div>;

  return (
    <div className="p-6 max-w-5xl mx-auto pb-24">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <div>
              <h2 className="text-2xl font-bold text-slate-800 dark:text-white">ConfiguraciÃ³n</h2>
              <p className="text-slate-500 dark:text-slate-400 text-sm">Datos del consultorio y cuenta.</p>
          </div>
          
          <button 
            onClick={handleBackup}
            disabled={downloading}
            className="flex items-center gap-2 px-4 py-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-lg border border-blue-200 dark:border-blue-800 hover:bg-blue-100 transition-colors text-sm font-bold disabled:opacity-50"
          >
            {downloading ? <Download className="animate-bounce" size={16}/> : <FileSpreadsheet size={16}/>}
            {downloading ? "Exportando..." : "Descargar Mis Datos"}
          </button>
      </div>
      
      <form onSubmit={updateProfile} className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
        
        {/* COLUMNA 1: DATOS TEXTO */}
        <div className="lg:col-span-2 space-y-6">
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div className="p-4 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                    <User size={18} className="text-brand-teal"/> Identidad Profesional
                </div>
                <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="col-span-2">
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Nombre Completo</label>
                        <input type="text" required value={fullName} onChange={e => setFullName(e.target.value)} className="w-full p-3 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-brand-teal outline-none dark:bg-slate-900 dark:text-white" placeholder="Dr. Juan PÃ©rez" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Especialidad</label>
                        <div className="flex items-center border border-slate-200 dark:border-slate-700 rounded-lg px-3 bg-white dark:bg-slate-900 focus-within:ring-2 focus-within:ring-brand-teal relative">
                            <Stethoscope size={16} className="text-slate-400 mr-2 pointer-events-none"/>
                            <select
                                value={specialty}
                                onChange={e => setSpecialty(e.target.value)}
                                className="w-full py-3 outline-none bg-transparent dark:text-white appearance-none cursor-pointer"
                            >
                                {SPECIALTIES.map(s => (
                                    <option key={s} value={s} className="text-slate-800 dark:text-slate-200 dark:bg-slate-800">
                                        {s}
                                    </option>
                                ))}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">CÃ©dula Prof.</label>
                        <div className="flex items-center border border-slate-200 dark:border-slate-700 rounded-lg px-3 bg-white dark:bg-slate-900 focus-within:ring-2 focus-within:ring-brand-teal">
                            <Hash size={16} className="text-slate-400 mr-2"/>
                            <input type="text" required value={license} onChange={e => setLicense(e.target.value)} className="w-full py-3 outline-none bg-transparent dark:text-white" placeholder="12345678" />
                        </div>
                    </div>
                    <div className="col-span-2">
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Universidad / InstituciÃ³n</label>
                        <div className="flex items-center border border-slate-200 dark:border-slate-700 rounded-lg px-3 bg-white dark:bg-slate-900 focus-within:ring-2 focus-within:ring-brand-teal">
                            <BookOpen size={16} className="text-slate-400 mr-2"/>
                            <input type="text" required value={university} onChange={e => setUniversity(e.target.value)} className="w-full py-3 outline-none bg-transparent dark:text-white" placeholder="Ej. UNAM" />
                        </div>
                    </div>
                </div>
            </div>

            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div className="p-4 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                    <MapPin size={18} className="text-brand-teal"/> Contacto y Web
                </div>
                <div className="p-6 space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">TelÃ©fono Consultorio</label>
                            <div className="flex items-center border border-slate-200 dark:border-slate-700 rounded-lg px-3 bg-white dark:bg-slate-900 focus-within:ring-2 focus-within:ring-brand-teal">
                                <Phone size={16} className="text-slate-400 mr-2"/>
                                <input type="text" value={phone} onChange={e => setPhone(e.target.value)} className="w-full py-3 outline-none bg-transparent dark:text-white" placeholder="55 1234 5678" />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Tarjeta Digital / Web</label>
                            <div className="flex items-center border border-slate-200 dark:border-slate-700 rounded-lg px-3 bg-white dark:bg-slate-900 focus-within:ring-2 focus-within:ring-brand-teal">
                                <Globe size={16} className="text-slate-400 mr-2"/>
                                <input type="url" value={websiteUrl} onChange={e => setWebsiteUrl(e.target.value)} className="w-full py-3 outline-none bg-transparent dark:text-white" placeholder="https://misitio.com" />
                            </div>
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">DirecciÃ³n Completa</label>
                        <textarea rows={3} value={address} onChange={e => setAddress(e.target.value)} className="w-full p-3 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-brand-teal outline-none resize-none dark:bg-slate-900 dark:text-white" placeholder="Calle, NÃºmero, Colonia..." />
                    </div>
                </div>
            </div>
        </div>

        {/* COLUMNA 2: IMÃGENES */}
        <div className="space-y-6">
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div className="p-4 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                    <ImageIcon size={18} className="text-brand-teal"/> Logo ClÃ­nica
                </div>
                <div className="p-6 flex flex-col items-center text-center">
                    <div className="w-32 h-32 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-center mb-4 overflow-hidden bg-slate-50 dark:bg-slate-900 relative group">
                        {logoUrl ? (
                            <img src={logoUrl} alt="Logo" className="w-full h-full object-contain" />
                        ) : (
                            <ImageIcon className="text-slate-300" size={40} />
                        )}
                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                            <span className="text-white text-xs font-bold">Cambiar</span>
                        </div>
                        <input 
                            type="file" 
                            accept="image/*"
                            onChange={(e) => uploadImage(e, 'logo')}
                            disabled={uploading}
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                        />
                    </div>
                    <p className="text-xs text-slate-500">PNG Transparente recomendado.</p>
                </div>
            </div>

            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div className="p-4 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                    <PenTool size={18} className="text-brand-teal"/> Firma Digital
                </div>
                <div className="p-6 flex flex-col items-center text-center">
                    <div className="w-48 h-24 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-center mb-4 overflow-hidden bg-slate-50 dark:bg-slate-900 relative group">
                        {signatureUrl ? (
                            <img src={signatureUrl} alt="Firma" className="w-full h-full object-contain" />
                        ) : (
                            <span className="text-slate-400 text-xs italic">Subir firma</span>
                        )}
                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                            <span className="text-white text-xs font-bold">Subir</span>
                        </div>
                        <input 
                            type="file" 
                            accept="image/*"
                            onChange={(e) => uploadImage(e, 'signature')}
                            disabled={uploading}
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                        />
                    </div>
                    <p className="text-xs text-slate-500">Foto de firma en hoja blanca.</p>
                </div>
            </div>

            <button 
              type="submit" 
              disabled={saving || uploading}
              className="w-full bg-slate-900 dark:bg-slate-700 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2 disabled:opacity-50"
            >
              {saving ? 'Guardando...' : <><Save size={20} /> Guardar Cambios</>}
            </button>
        </div>

      </form>
      
      {/* --- INYECCIÃ“N DE PLANES DE SUSCRIPCIÃ“N (OCULTO POR AHORA) --- */}
      {/* <div className="mb-10">
        <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
            <ShieldCheck className="text-brand-teal"/> Mi SuscripciÃ³n
        </h3>
        <SubscriptionPlans />
      </div>
      */}
      {/* ------------------------------------------------------------- */}
      
      <div className="p-4 bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-800/50 rounded-xl flex gap-3 items-start">
         <ShieldCheck className="text-amber-600 shrink-0" size={20} />
         <div>
             <p className="text-sm font-bold text-amber-800 dark:text-amber-200">Privacidad y Seguridad de Datos</p>
             <p className="text-xs text-amber-700 dark:text-amber-400 mt-1">
                 Sus datos estÃ¡n protegidos y son 100% de su propiedad. Puede descargar una copia de seguridad completa en formato Excel (.csv) cuando lo desee usando el botÃ³n de "Descargar Mis Datos" arriba.
             </p>
         </div>
      </div>
    </div>
  );
};

export default SettingsView;

--------------------------------------------------
ðŸ“ PATH: src\components\Sidebar.tsx
--------------------------------------------------
import React, { useEffect, useState } from 'react';
import { NavLink, useNavigate } from 'react-router-dom'; 
import { 
  LayoutDashboard, Stethoscope, Users, Briefcase, LogOut, X, 
  Settings, Download, Share, Calendar, Moon, Sun 
} from 'lucide-react';
import { supabase } from '../lib/supabase';
import { useTheme } from '../context/ThemeContext';
import { usePWA } from '../hooks/usePWA';

interface SidebarProps {
  isOpen: boolean;
  onClose: () => void;
  onLogout: (name?: string) => void;
}

const Sidebar: React.FC<SidebarProps> = ({ isOpen, onClose, onLogout }) => {
  const [profile, setProfile] = useState({ name: 'Doctor(a)', specialty: '' });
  const { theme, toggleTheme } = useTheme();
  const navigate = useNavigate();
  
  const { isStandalone, isIOS, installPWA, canInstall } = usePWA();
  const [showIOSInstructions, setShowIOSInstructions] = useState(false);

  useEffect(() => {
    let mounted = true;
    const fetchProfile = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user && mounted) {
          const { data } = await supabase.from('profiles').select('full_name, specialty').eq('id', user.id).single();
          if (data && mounted) {
            setProfile({ 
              name: data.full_name || 'Doctor(a)', 
              specialty: data.specialty || 'Medicina General' 
            });
          }
        }
      } catch (error) { console.error("Error perfil", error); }
    };
    fetchProfile();
    return () => { mounted = false; };
  }, []);
  
  const handleInstallClick = async () => {
    const result = await installPWA();
    if (result === 'ios_instruction') {
        setShowIOSInstructions(!showIOSInstructions);
    } else if (result === 'failed' && !isIOS) {
        alert("Si no ves la ventana de instalaciÃ³n, busca el icono (+) o 'Instalar' en la barra de direcciones de tu navegador.");
    }
  };

  const menuItems = [
    { path: '/', icon: <LayoutDashboard size={20} />, label: 'Dashboard', end: true }, 
    { path: '/consultation', icon: <Stethoscope size={20} />, label: 'Consulta IA' },
    { path: '/agenda', icon: <Calendar size={20} />, label: 'Agenda' },
    { path: '/patients', icon: <Users size={20} />, label: 'Pacientes' },
    { path: '/card', icon: <Briefcase size={20} />, label: 'Hub Profesional' },
    { path: '/settings', icon: <Settings size={20} />, label: 'ConfiguraciÃ³n' },
  ];

  return (
    <>
      {isOpen && (
        <div className="fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm" onClick={onClose} aria-hidden="true" />
      )}

      <aside className={`fixed top-0 left-0 z-50 h-screen w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 transition-transform duration-300 ease-in-out shadow-xl md:shadow-none ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 flex flex-col`}>
        
        <div className="p-6 flex items-center justify-between border-b border-slate-100 dark:border-slate-800 shrink-0">
          <div className="flex items-center space-x-3">
            <img src="/pwa-192x192.png" alt="Logo" className="h-10 w-10 rounded-xl shadow-sm object-cover bg-slate-50" />
            <span className="text-xl font-bold text-slate-800 dark:text-white tracking-tight">MediScribe</span>
          </div>
          <button onClick={onClose} className="md:hidden text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
            <X size={24} />
          </button>
        </div>

        <nav className="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
          {menuItems.map((item) => (
            <NavLink key={item.path} to={item.path} end={item.end} onClick={onClose} className={({ isActive }) => `flex items-center space-x-3 px-4 py-3 rounded-xl transition-colors duration-200 font-medium ${isActive ? 'bg-teal-50 dark:bg-teal-900/30 text-brand-teal border border-teal-100 dark:border-teal-800/50 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-700 dark:hover:text-slate-200'}`}>
              {item.icon}
              <span>{item.label}</span>
            </NavLink>
          ))}

          {/* ZONA DE TOGGLES E INSTALACIÃ“N */}
          <div className="pt-4 mt-2 border-t border-slate-100 dark:border-slate-800">
            <button onClick={toggleTheme} className="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-colors duration-200 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 font-medium">
              {theme === 'light' ? <Moon size={20} /> : <Sun size={20} />}
              <span>{theme === 'light' ? 'Modo Oscuro' : 'Modo Claro'}</span>
            </button>

            {!isStandalone && (
              <div className="mt-2">
                <button 
                  onClick={handleInstallClick} 
                  className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-colors duration-200 shadow-lg active:scale-95 ${canInstall || isIOS ? 'bg-slate-900 dark:bg-slate-800 text-white cursor-pointer' : 'bg-slate-100 text-slate-400 cursor-help'}`}
                >
                  <Download size={20} />
                  <span className="font-bold">Instalar App</span>
                </button>
                
                {showIOSInstructions && (
                  <div className="mt-3 p-3 bg-slate-100 dark:bg-slate-800 rounded-lg text-xs text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 animate-fade-in-up">
                    <p className="font-bold mb-2">Para instalar en iPhone:</p>
                    <div className="flex items-center gap-2 mb-1">1. Toca <Share size={12} className="text-blue-500"/> Compartir.</div>
                    <div>2. Selecciona <strong>"Agregar a Inicio"</strong>.</div>
                  </div>
                )}
              </div>
            )}
          </div>
        </nav>

        <div className="p-4 border-t border-slate-100 dark:border-slate-800 shrink-0 bg-white dark:bg-slate-900 z-10">
          <div className="flex items-center p-3 mb-2 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
              <div className="w-8 h-8 rounded-full bg-teal-100 dark:bg-teal-900 flex items-center justify-center text-brand-teal font-bold text-xs shrink-0">
                {profile.name.substring(0, 2).toUpperCase()}
              </div>
              <div className="ml-3 overflow-hidden">
                  <p className="text-sm font-medium text-slate-700 dark:text-slate-200 truncate">{profile.name}</p>
                  <p className="text-[10px] text-slate-500 dark:text-slate-400 truncate uppercase tracking-wide">{profile.specialty}</p>
              </div>
          </div>
          
          <button onClick={() => onLogout(profile.name)} className="flex items-center justify-center space-x-2 px-4 py-2 w-full text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors text-sm font-medium">
            <LogOut size={18} />
            <span>Cerrar SesiÃ³n</span>
          </button>

          <div className="mt-4 text-[10px] text-slate-400 text-center leading-tight opacity-70 hover:opacity-100 transition-opacity">
            <p className="font-bold">ClasificaciÃ³n: Asistente de TranscripciÃ³n</p>
            <p className="text-[9px] mt-0.5 opacity-80">No sustituye al Expediente Legal (NOM-024)</p>
            <NavLink to="/terms" className="underline hover:text-brand-teal mt-1 block">
                TÃ©rminos y Responsabilidad
            </NavLink>
          </div>
        </div>
      </aside>
    </>
  );
};

export default Sidebar;

--------------------------------------------------
ðŸ“ PATH: src\components\SplashScreen.tsx
--------------------------------------------------
import React from 'react';
import { Activity } from 'lucide-react';

const SplashScreen: React.FC = () => {
  return (
    <div className="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
      
      <div className="flex flex-col items-center animate-fade-in-up">
        <div className="relative mb-6">
            <div className="absolute inset-0 bg-brand-teal blur-xl opacity-20 rounded-full animate-pulse"></div>
            <img 
                src="/pwa-192x192.png" 
                alt="MediScribe Logo" 
                className="relative w-32 h-32 object-cover rounded-3xl shadow-2xl animate-bounce-slow"
            />
        </div>

        <h1 className="text-3xl font-bold text-slate-800 dark:text-white tracking-tight mb-2">
          MediScribe <span className="text-brand-teal">AI</span>
        </h1>
        
        <div className="flex items-center gap-2 text-slate-400 text-sm font-medium mt-4">
            <Activity size={16} className="animate-spin text-brand-teal"/>
            <span>Iniciando sistema...</span>
        </div>
      </div>

      <div className="absolute bottom-8 text-center">
        <p className="text-xs text-slate-400 uppercase tracking-widest opacity-70">Powered by</p>
        <p className="text-xs font-bold text-slate-500 dark:text-slate-300 mt-1">PixelArte Studio</p>
      </div>

    </div>
  );
};

export default SplashScreen;

--------------------------------------------------
ðŸ“ PATH: src\components\SubscriptionPlans.tsx
--------------------------------------------------
import { useState } from 'react';

export const SubscriptionPlans = () => {
  const [billingCycle, setBillingCycle] = useState<'monthly' | 'yearly'>('monthly');

  // CONFIGURACIÃ“N DE PRECIOS (Ajusta esto a tu modelo real)
  const prices = {
    monthly: { id: 'price_monthly_id', amount: '999', label: '/mes' },
    yearly: { id: 'price_yearly_id', amount: '9,990', label: '/aÃ±o' }, // 2 meses gratis aprox
  };

  const handleSubscribe = (plan: string) => {
    // AQUÃ PONDREMOS TU LINK DE STRIPE MÃS ADELANTE
    // Por ahora, simula la acciÃ³n o lleva a WhatsApp de ventas
    const message = `Hola Pixelarte, quiero contratar el plan ${plan} de MediScribe.`;
    window.open(`https://wa.me/5213347211199?text=${encodeURIComponent(message)}`, '_blank');
  };

  return (
    <div className="w-full max-w-4xl mx-auto p-6 bg-white rounded-2xl shadow-xl border border-slate-200">
      <div className="text-center mb-10">
        <h2 className="text-3xl font-bold text-slate-900">Elige tu Plan Profesional</h2>
        <p className="text-slate-500 mt-2">Recupera 2 horas de tu vida diaria por el costo de una consulta.</p>
        
        {/* Toggle Mensual/Anual */}
        <div className="flex justify-center mt-6">
          <div className="relative flex bg-slate-100 p-1 rounded-xl">
            <button
              onClick={() => setBillingCycle('monthly')}
              className={`${
                billingCycle === 'monthly' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-900'
              } relative z-10 w-32 py-2 text-sm font-bold rounded-lg transition-all duration-200`}
            >
              Mensual
            </button>
            <button
              onClick={() => setBillingCycle('yearly')}
              className={`${
                billingCycle === 'yearly' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-900'
              } relative z-10 w-32 py-2 text-sm font-bold rounded-lg transition-all duration-200`}
            >
              Anual
              <span className="absolute -top-3 -right-3 px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded-full font-bold border border-green-200">
                -20% OFF
              </span>
            </button>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-8">
        {/* PLAN ESTÃNDAR */}
        <div className="border-2 border-teal-500 rounded-2xl p-8 relative group bg-teal-50/30">
          <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-teal-500 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">
            Acceso Beta
          </div>
          
          <h3 className="text-lg font-bold text-slate-900">MÃ©dico Independiente</h3>
          <p className="text-sm text-slate-500 mb-6">Para consultorios privados.</p>
          
          <div className="flex items-baseline mb-6">
            <span className="text-4xl font-extrabold text-slate-900">${billingCycle === 'monthly' ? prices.monthly.amount : Math.round(parseInt(prices.yearly.amount.replace(',',''))/12)}</span>
            <span className="text-slate-500 ml-2">MXN / mes</span>
          </div>
          {billingCycle === 'yearly' && (
            <p className="text-xs text-green-600 font-bold mb-6 bg-green-50 inline-block px-2 py-1 rounded">
              Facturado anualmente (${prices.yearly.amount})
            </p>
          )}

          <ul className="space-y-4 mb-8">
            <li className="flex items-center text-sm text-slate-600">
              <svg className="w-5 h-5 text-teal-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
              Consultas Ilimitadas
            </li>
            <li className="flex items-center text-sm text-slate-600">
              <svg className="w-5 h-5 text-teal-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
              Formatos NOM-004
            </li>
            <li className="flex items-center text-sm text-slate-600">
              <svg className="w-5 h-5 text-teal-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
              App MÃ³vil (PWA) + Web
            </li>
          </ul>

          <button
            disabled={true}
            className="w-full py-3 px-4 bg-green-100 text-green-700 border border-green-200 font-bold rounded-xl cursor-default flex items-center justify-center gap-2"
          >
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Desbloqueado
          </button>
        </div>

        {/* PLAN CLÃNICA (Upsell) */}
        <div className="border border-slate-100 bg-slate-50 rounded-2xl p-8 opacity-75 hover:opacity-100 transition-opacity relative">
          <div className="absolute top-0 right-0 bg-slate-200 text-slate-600 text-xs font-bold px-3 py-1 rounded-bl-xl rounded-tr-xl">
            PRÃ“XIMAMENTE
          </div>
          <h3 className="text-lg font-bold text-slate-700">ClÃ­nicas & Hospitales</h3>
          <p className="text-sm text-slate-500 mb-6">Para equipos multidisciplinarios.</p>
          
          <div className="flex items-baseline mb-6">
            <span className="text-3xl font-bold text-slate-700">Cotizar</span>
          </div>

          <ul className="space-y-4 mb-8 grayscale">
            <li className="flex items-center text-sm text-slate-500">
              <svg className="w-5 h-5 text-slate-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
              Multi-usuario
            </li>
            <li className="flex items-center text-sm text-slate-500">
              <svg className="w-5 h-5 text-slate-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
              Panel Administrativo
            </li>
          </ul>

          <button
            onClick={() => window.open('mailto:contacto@pixelartestudio.art')}
            className="w-full py-3 px-4 border-2 border-slate-300 text-slate-600 font-bold rounded-xl hover:border-slate-400 hover:text-slate-800 transition-colors"
          >
            Contactar Ventas
          </button>
        </div>
      </div>
      
      <p className="text-center text-xs text-slate-400 mt-8">
        Pagos seguros procesados por Stripe. Puedes cancelar en cualquier momento.
      </p>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\TrialMonitor.tsx
--------------------------------------------------
// Archivo: src/components/TrialMonitor.tsx
import React, { useEffect, useState } from 'react';
import { X } from 'lucide-react'; 
import { supabase } from '../lib/supabase'; // <--- CORRECCIÃ“N AQUÃ (Antes decÃ­a supabase/client)
import { SubscriptionPlans } from './SubscriptionPlans';

const TRIAL_DAYS = 15;

export const TrialMonitor: React.FC = () => {
  const [daysLeft, setDaysLeft] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);
  const [isMinimized, setIsMinimized] = useState(false);

  useEffect(() => {
    checkTrialStatus();
  }, []);

  const checkTrialStatus = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    
    if (user && user.created_at) {
      const startDate = new Date(user.created_at);
      const today = new Date();
      const diffTime = Math.abs(today.getTime() - startDate.getTime());
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
      const remaining = TRIAL_DAYS - diffDays;
      setDaysLeft(remaining);
    }
    setLoading(false);
  };

  if (loading) return null;

  // ðŸ”´ CASO 1: PRUEBA TERMINADA (VENTA AGRESIVA)
  if (daysLeft !== null && daysLeft <= 0) {
    return (
      <div className="fixed inset-0 z-[9999] bg-slate-900/95 backdrop-blur-md flex items-center justify-center p-4 overflow-y-auto">
        <div className="animate-fade-in w-full max-w-4xl">
           <SubscriptionPlans />
        </div>
      </div>
    );
  }

  // ðŸŸ¢ CASO 2: PRUEBA ACTIVA (CÃPSULA FLOTANTE DISCRETA)
  if (isMinimized) return null;

  return (
    <div className="fixed z-40 bottom-20 right-4 md:bottom-4 md:right-4 animate-slide-in-right">
        {/* CÃPSULA PEQUEÃ‘A */}
        <div className="bg-slate-900/90 dark:bg-slate-800/90 backdrop-blur-sm text-white px-4 py-2 rounded-full shadow-xl border border-slate-700 flex items-center gap-3 transition-all hover:scale-105 hover:bg-slate-900">
            
            {/* Icono animado */}
            <div className="relative">
                <div className="absolute inset-0 bg-green-500 rounded-full animate-ping opacity-75"></div>
                <div className="relative w-2 h-2 bg-green-400 rounded-full"></div>
            </div>

            {/* Texto Compacto */}
            <div className="flex flex-col">
                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider leading-none mb-0.5">Modo Prueba</span>
                <span className="text-xs font-bold leading-none">Quedan <span className="text-yellow-400">{daysLeft} dÃ­as</span></span>
            </div>

            {/* BotÃ³n Cerrar (X) PequeÃ±o */}
            <button 
                onClick={() => setIsMinimized(true)}
                className="ml-2 p-1 text-slate-500 hover:text-white rounded-full transition-colors"
                title="Ocultar por esta sesiÃ³n"
            >
                <X size={14} />
            </button>
        </div>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\components\UploadMedico.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';
import imageCompression from 'browser-image-compression';
import { Search, UserPlus, Upload, X, Loader2 } from 'lucide-react';
import { PatientService } from '../services/PatientService';
import { Patient } from '../types';
import { toast } from 'sonner';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);
const BUCKET_NAME = 'pacientes';

interface UploadMedicoProps {
  preSelectedPatient?: Patient | null; // Para cuando se usa desde Consulta IA
  onUploadComplete?: () => void;
}

export const UploadMedico: React.FC<UploadMedicoProps> = ({ preSelectedPatient, onUploadComplete }) => {
  const [uploading, setUploading] = useState(false);
  
  // Estado para selecciÃ³n de paciente
  const [searchTerm, setSearchTerm] = useState('');
  const [patientsFound, setPatientsFound] = useState<Patient[]>([]);
  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(preSelectedPatient || null);
  const [isCreatingPatient, setIsCreatingPatient] = useState(false);

  // Sincronizar si cambia el paciente preseleccionado (ej. navegando en consultas)
  useEffect(() => {
    if (preSelectedPatient) {
      setSelectedPatient(preSelectedPatient);
      setSearchTerm(preSelectedPatient.name);
    }
  }, [preSelectedPatient]);

  // BÃºsqueda de pacientes con Debounce (espera a que termines de escribir)
  useEffect(() => {
    const delayDebounceFn = setTimeout(async () => {
      if (searchTerm && !selectedPatient) {
        const results = await PatientService.searchPatients(searchTerm);
        setPatientsFound(results);
      } else {
        setPatientsFound([]);
      }
    }, 300);

    return () => clearTimeout(delayDebounceFn);
  }, [searchTerm, selectedPatient]);

  const handleCreatePatient = async () => {
    if (!searchTerm) return;
    setIsCreatingPatient(true);
    try {
      const newPatient = await PatientService.createQuickPatient(searchTerm);
      if (newPatient) {
        setSelectedPatient(newPatient);
        setPatientsFound([]);
        toast.success(`Paciente "${newPatient.name}" registrado.`);
      }
    } catch (error) {
      toast.error("Error al registrar paciente.");
    } finally {
      setIsCreatingPatient(false);
    }
  };

  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    if (!selectedPatient) {
      toast.error("âš ï¸ Primero selecciona o crea un paciente.");
      event.target.value = ''; // Limpiar input
      return;
    }

    setUploading(true);

    try {
      let fileToUpload = file;

      // 1. CompresiÃ³n (Solo imÃ¡genes) para ahorrar espacio
      if (file.type.startsWith('image/')) {
        const options = {
          maxSizeMB: 0.2,
          maxWidthOrHeight: 1920,
          useWebWorker: true,
        };
        try {
          fileToUpload = await imageCompression(file, options);
        } catch (error) {
          console.warn('Fallo compresiÃ³n, subiendo original:', error);
        }
      }

      // 2. Subida a Ruta EspecÃ­fica del Paciente
      // RUTA CLAVE: {PATIENT_ID}/{TIMESTAMP}_{FILENAME}
      // Esto asegura que el archivo pertenezca solo a este paciente
      const filePath = `${selectedPatient.id}/${Date.now()}_${file.name}`;

      const { error } = await supabase.storage
        .from(BUCKET_NAME)
        .upload(filePath, fileToUpload, { upsert: false });

      if (error) {
        if (error.message.includes('row-level security')) throw new Error('LÃ­mite de almacenamiento excedido o sin permisos.');
        throw error;
      }

      toast.success("Archivo subido al expediente.");
      if (onUploadComplete) onUploadComplete();

    } catch (error: any) {
      toast.error(error.message || "Error al subir archivo");
    } finally {
      setUploading(false);
      event.target.value = ''; 
    }
  };

  return (
    <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
      
      {/* 1. SELECTOR DE PACIENTE (Solo aparece si no viene pre-seleccionado) */}
      {!preSelectedPatient && (
        <div className="mb-4 relative">
          <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Asignar a Paciente:</label>
          
          {!selectedPatient ? (
            <div className="relative">
              <input
                type="text"
                className="w-full p-2 pl-9 rounded-lg border dark:border-slate-600 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-brand-teal outline-none text-sm"
                placeholder="Buscar o escribir nombre nuevo..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
              <Search className="absolute left-3 top-2.5 text-slate-400" size={16} />
              
              {/* Lista de Resultados o Crear Nuevo */}
              {searchTerm && (
                <div className="absolute top-full left-0 w-full bg-white dark:bg-slate-800 shadow-xl rounded-b-lg border dark:border-slate-700 z-20 max-h-48 overflow-y-auto mt-1">
                  {patientsFound.map(p => (
                    <div 
                      key={p.id} 
                      onClick={() => { setSelectedPatient(p); setSearchTerm(p.name); }}
                      className="p-3 hover:bg-teal-50 dark:hover:bg-slate-700 cursor-pointer text-sm flex items-center gap-2"
                    >
                      <div className="w-6 h-6 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center text-xs font-bold">
                        {p.name.charAt(0)}
                      </div>
                      <span className="dark:text-white">{p.name}</span>
                    </div>
                  ))}
                  
                  {/* OpciÃ³n Crear Nuevo */}
                  <div 
                    onClick={handleCreatePatient}
                    className="p-3 bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 cursor-pointer text-sm text-blue-700 dark:text-blue-300 flex items-center gap-2 border-t dark:border-slate-700"
                  >
                    {isCreatingPatient ? <Loader2 className="animate-spin" size={16}/> : <UserPlus size={16} />}
                    <span className="font-bold">Crear nuevo: "{searchTerm}"</span>
                  </div>
                </div>
              )}
            </div>
          ) : (
            // Paciente Seleccionado
            <div className="flex items-center justify-between bg-white dark:bg-slate-900 p-2 rounded-lg border border-teal-200 dark:border-teal-900">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-brand-teal text-white flex items-center justify-center font-bold">
                  {selectedPatient.name.charAt(0)}
                </div>
                <div>
                  <p className="text-sm font-bold text-slate-800 dark:text-white">{selectedPatient.name}</p>
                  <p className="text-[10px] text-slate-500">Expediente activo</p>
                </div>
              </div>
              <button onClick={() => { setSelectedPatient(null); setSearchTerm(''); }} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-400">
                <X size={16} />
              </button>
            </div>
          )}
        </div>
      )}

      {/* 2. ZONA DE SUBIDA */}
      <div className="relative">
        <label className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-xl cursor-pointer transition-all ${
          !selectedPatient ? 'opacity-50 cursor-not-allowed bg-slate-100 border-slate-300' : 
          uploading ? 'bg-slate-50 border-slate-300' : 'border-brand-teal bg-teal-50/30 hover:bg-teal-50 dark:hover:bg-teal-900/10'
        }`}>
          <div className="flex flex-col items-center justify-center pt-5 pb-6">
            {uploading ? (
              <div className="flex flex-col items-center text-brand-teal animate-pulse">
                <Loader2 className="animate-spin mb-2" size={24} />
                <p className="text-xs font-bold">Procesando...</p>
              </div>
            ) : (
              <>
                <Upload className={`w-8 h-8 mb-2 ${selectedPatient ? 'text-brand-teal' : 'text-slate-400'}`} />
                <p className="text-xs text-slate-500 font-medium">Clic para adjuntar</p>
              </>
            )}
          </div>
          <input 
            type="file" 
            className="hidden" 
            onChange={handleFileChange}
            disabled={uploading || !selectedPatient}
            accept="image/*,application/pdf"
          />
        </label>
      </div>
    </div>
  );
};

--------------------------------------------------
ðŸ“ PATH: src\context\ThemeContext.tsx
--------------------------------------------------
import React, { createContext, useContext, useEffect, useState } from 'react';

type Theme = 'light' | 'dark';

interface ThemeContextType {
  theme: Theme;
  toggleTheme: () => void;
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

export const ThemeProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  // 1. Verificar preferencia guardada o del sistema
  const [theme, setTheme] = useState<Theme>(() => {
    if (typeof window !== 'undefined') {
      const savedTheme = localStorage.getItem('theme') as Theme;
      if (savedTheme) return savedTheme;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    return 'light';
  });

  // 2. Aplicar la clase 'dark' al HTML
  useEffect(() => {
    const root = window.document.documentElement;
    if (theme === 'dark') {
      root.classList.add('dark');
    } else {
      root.classList.remove('dark');
    }
    localStorage.setItem('theme', theme);
  }, [theme]);

  const toggleTheme = () => {
    setTheme((prev) => (prev === 'light' ? 'dark' : 'light'));
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
};

export const useTheme = () => {
  const context = useContext(ThemeContext);
  if (context === undefined) {
    throw new Error('useTheme must be used within a ThemeProvider');
  }
  return context;
};

--------------------------------------------------
ðŸ“ PATH: src\hooks\usePWA.ts
--------------------------------------------------
import { useState, useEffect } from 'react';

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed'; platform: string }>;
}

export function usePWA() {
  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [isStandalone, setIsStandalone] = useState(false);
  const [isIOS, setIsIOS] = useState(false);

  useEffect(() => {
    // 1. Detectar si ya estÃ¡ instalada
    const checkStandalone = () => {
      const isApp = window.matchMedia('(display-mode: standalone)').matches || (window.navigator as any).standalone === true;
      setIsStandalone(isApp);
    };
    
    // 2. Detectar iOS
    const checkIOS = () => {
      const isDeviceIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !(window as any).MSStream;
      setIsIOS(isDeviceIOS);
    };

    checkStandalone();
    checkIOS();

    // 3. Capturar el evento de instalaciÃ³n (CRÃTICO)
    const handler = (e: Event) => {
      e.preventDefault(); // Evitar que Chrome muestre su mini-barra automÃ¡tica
      setDeferredPrompt(e as BeforeInstallPromptEvent);
      console.log("ðŸ“² Evento de instalaciÃ³n capturado exitosamente");
    };

    window.addEventListener('beforeinstallprompt', handler);

    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);

  const installPWA = async () => {
    if (!deferredPrompt) {
        if (isIOS) return 'ios_instruction'; // Retorno especial para mostrar instrucciones iOS
        return 'failed';
    }

    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      setDeferredPrompt(null);
      return 'accepted';
    }
    return 'dismissed';
  };

  return { isStandalone, isIOS, installPWA, canInstall: !!deferredPrompt };
}

--------------------------------------------------
ðŸ“ PATH: src\hooks\useSpeechRecognition.ts
--------------------------------------------------
import { useState, useEffect, useRef, useCallback } from 'react';

// Interfaz para extender Window y evitar errores de TS
interface IWindow extends Window {
  webkitSpeechRecognition: any;
  SpeechRecognition: any;
}

// --- ALGORITMO ANTI-ECO OPTIMIZADO ---
// Compara el final del texto A con el inicio del texto B para eliminar solapamientos
function getOverlapLength(a: string, b: string) {
  if (b.length === 0 || a.length === 0) return 0;
  // OptimizaciÃ³n: Solo mirar los Ãºltimos 50 caracteres para rendimiento
  const maxCheck = Math.min(a.length, b.length, 50); 
  for (let len = maxCheck; len > 0; len--) {
    if (a.slice(-len) === b.slice(0, len)) return len;
  }
  return 0;
}

export const useSpeechRecognition = () => {
  const [isListening, setIsListening] = useState(false);
  const [transcript, setTranscript] = useState('');
  
  // DetecciÃ³n de MÃ³vil Robusta (Android/iOS)
  const isMobile = useRef(/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent));

  // DetecciÃ³n de Soporte API
  const [isAPISupported] = useState(() => {
    if (typeof window === 'undefined') return false;
    const { webkitSpeechRecognition, SpeechRecognition } = window as unknown as IWindow;
    return !!(SpeechRecognition || webkitSpeechRecognition);
  });
  
  const recognitionRef = useRef<any>(null);
  const isUserInitiatedStop = useRef(false);
  const wakeLockRef = useRef<any>(null);
  
  // Refs para mantener el estado del texto sin depender del ciclo de render de React
  const finalTranscriptRef = useRef('');

  // --- GESTIÃ“N DE ENERGÃA (WAKE LOCK) ---
  // Evita que la pantalla se apague mientras el mÃ©dico dicta (CrÃ­tico en MÃ³vil)
  const requestWakeLock = useCallback(async () => {
    if ('wakeLock' in navigator) {
      try { 
          wakeLockRef.current = await (navigator as any).wakeLock.request('screen'); 
      } catch (err) {
          console.warn('Wake Lock error:', err);
      }
    }
  }, []);

  const releaseWakeLock = useCallback(async () => {
    if (wakeLockRef.current) {
      try { 
          await wakeLockRef.current.release(); 
          wakeLockRef.current = null; 
      } catch (err) {
          console.warn('Wake Lock release error:', err);
      }
    }
  }, []);

  // Re-aplicar Wake Lock si la app vuelve a primer plano (tab switch)
  useEffect(() => {
    const handleVisibilityChange = async () => {
      if (wakeLockRef.current !== null && document.visibilityState === 'visible') {
        await requestWakeLock();
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
  }, [requestWakeLock]);

  // --- LÃ“GICA DE RECONOCIMIENTO OPTIMIZADA ---
  const startListening = useCallback(() => {
    if (!isAPISupported) return;

    // Limpieza de instancia previa si existe
    if (recognitionRef.current) {
       try { recognitionRef.current.stop(); } catch(e) {}
    }

    const { webkitSpeechRecognition, SpeechRecognition } = window as unknown as IWindow;
    const SpeechAPI = SpeechRecognition || webkitSpeechRecognition;
    const recognition = new SpeechAPI();

    // CONFIGURACIÃ“N HÃBRIDA (LA CLAVE DEL FIX)
    // Desktop: continuous = true (Mejor experiencia, fluido)
    // MÃ³vil: continuous = false (Evita el bug de duplicaciÃ³n de Android) + Reinicio Manual
    recognition.continuous = !isMobile.current; 
    
    recognition.interimResults = true;          // Ver texto en tiempo real
    recognition.lang = 'es-MX';                 // Forzar espaÃ±ol latino
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      setIsListening(true);
      isUserInitiatedStop.current = false;
      requestWakeLock();
      
      // Feedback HÃ¡ptico (VibraciÃ³n) solo en mÃ³viles
      if (isMobile.current && navigator.vibrate) {
          navigator.vibrate(50);
      }
    };

    recognition.onresult = (event: any) => {
      let interimChunk = '';
      let finalChunk = '';

      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const res = event.results[i];
        
        // HACK DE ANDROID: A veces envÃ­a confianza 0 en duplicados fantasmas
        if (isMobile.current && res[0].confidence === 0) continue;

        if (res.isFinal) {
          finalChunk += res[0].transcript;
        } else {
          interimChunk += res[0].transcript;
        }
      }

      // Procesamiento de Texto Final
      if (finalChunk) {
        const cleanFinal = finalChunk.trim();
        const currentFinal = finalTranscriptRef.current.trim();
        
        // Algoritmo Anti-Eco: Verifica si lo nuevo ya estÃ¡ al final de lo viejo
        const overlap = getOverlapLength(currentFinal, cleanFinal);
        const newPart = cleanFinal.slice(overlap).trim();
        
        if (newPart) {
            // CapitalizaciÃ³n inteligente (si no es continuaciÃ³n de palabra)
            const prefix = (currentFinal && !currentFinal.endsWith(' ')) ? ' ' : '';
            const formatted = newPart.charAt(0).toUpperCase() + newPart.slice(1);
            finalTranscriptRef.current = currentFinal + prefix + formatted;
        }
      }

      // ActualizaciÃ³n visual inmediata
      const displayText = (finalTranscriptRef.current + (interimChunk ? ' ' + interimChunk : '')).trim();
      setTranscript(displayText);
    };

    recognition.onerror = (event: any) => {
      // Ignoramos 'no-speech' para evitar parpadeos visuales
      if (event.error === 'no-speech') return; 
      
      console.warn('Speech Error:', event.error);

      // Si el error es de permisos o bloqueo, paramos todo
      if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
        setIsListening(false);
        isUserInitiatedStop.current = true;
        releaseWakeLock();
      }
    };

    recognition.onend = () => {
      // LÃ“GICA "STICKY RESTART" (CRÃTICA PARA MÃ“VIL)
      // Si el usuario NO le dio a stop, significa que el navegador cortÃ³ (por silencio o bug).
      // Lo reiniciamos inmediatamente para simular continuidad infinita.
      if (!isUserInitiatedStop.current) {
          // PequeÃ±o delay para no saturar la pila de llamadas del navegador
          setTimeout(() => {
              if (!isUserInitiatedStop.current) {
                  try { 
                      recognition.start(); 
                  } catch(e) {
                      console.log('Reinicio rÃ¡pido fallÃ³, reintentando...', e);
                  }
              }
          }, 50); // 50ms es imperceptible para el humano
      } else {
        // Apagado real y voluntario
        setIsListening(false);
        releaseWakeLock();
        if (isMobile.current && navigator.vibrate) {
            navigator.vibrate([50, 50, 50]); // Doble vibraciÃ³n al apagar
        }
      }
    };

    recognitionRef.current = recognition;
    try { recognition.start(); } catch (e) { setIsListening(false); }
  }, [isAPISupported, requestWakeLock, releaseWakeLock]);

  const stopListening = useCallback(() => {
    isUserInitiatedStop.current = true; // Bandera: "Yo quise pararlo"
    
    if (recognitionRef.current) {
        try { recognitionRef.current.stop(); } catch(e) {}
    }
    
    // Al detener, aseguramos que el texto final quede guardado
    setTranscript(finalTranscriptRef.current);
    setIsListening(false);
    releaseWakeLock();
  }, [releaseWakeLock]);

  const resetTranscript = useCallback(() => {
    finalTranscriptRef.current = '';
    setTranscript('');
  }, []);

  // Permite editar el texto manualmente desde el textarea y que la IA siga desde ahÃ­
  const setTranscriptManual = useCallback((text: string) => {
      finalTranscriptRef.current = text;
      setTranscript(text);
  }, []);

  // Limpieza de recursos al desmontar el componente
  useEffect(() => {
    return () => {
        isUserInitiatedStop.current = true;
        if (recognitionRef.current) try { recognitionRef.current.stop(); } catch(e) {}
        releaseWakeLock();
    };
  }, [releaseWakeLock]);

  return { 
    isListening, 
    transcript, 
    startListening, 
    stopListening, 
    resetTranscript, 
    setTranscript: setTranscriptManual, 
    isAPISupported 
  };
};

--------------------------------------------------
ðŸ“ PATH: src\index.css
--------------------------------------------------
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Fondo persistente para evitar flashes en dark mode */
html, body, #root {
  height: 100%;
  background-color: #f8fafc; /* slate-50 */
  margin: 0;
  padding: 0;
}

html.dark, html.dark body, html.dark #root {
  background-color: #020617; /* slate-950 */
}

/* Ajuste para iPhone Notch y Home Bar */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .pb-safe-area-inset-bottom {
    padding-bottom: env(safe-area-inset-bottom);
  }
}

/* Estilos globales de Scrollbar (Base para toda la app) */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}
.dark ::-webkit-scrollbar-thumb {
  background: #334155;
}
::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* --- NUEVA UTILIDAD AGREGADA v3.8 --- */
@layer utilities {
  /* Scrollbar fino y elegante para contenedores internos (Hub, MenÃºs) */
  .custom-scrollbar::-webkit-scrollbar {
    width: 5px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    @apply bg-slate-300 rounded-full hover:bg-slate-400;
  }
  
  .dark .custom-scrollbar::-webkit-scrollbar-thumb {
    @apply bg-slate-700 hover:bg-slate-600;
  }
}

--------------------------------------------------
ðŸ“ PATH: src\lib\supabase.ts
--------------------------------------------------
import { createClient } from '@supabase/supabase-js';

// Accedemos a las variables de entorno de Vite
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

// ValidaciÃ³n Estricta: Si faltan llaves, la app no debe iniciar (Fail Fast)
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('ðŸš¨ CRÃTICO: Faltan las variables de entorno de Supabase. Verifique .env');
}

/**
 * CLIENTE SUPABASE (SINGLETON)
 * Configurado para PWA con persistencia de sesiÃ³n y soporte RLS.
 */
export const supabase = createClient(
  supabaseUrl,
  supabaseAnonKey,
  {
    auth: {
      persistSession: true, // Mantiene al mÃ©dico logueado aunque cierre el navegador
      autoRefreshToken: true, // Renueva el token de seguridad automÃ¡ticamente
      detectSessionInUrl: true, // Necesario para los links de "Recuperar ContraseÃ±a"
      storage: window.localStorage // Explicita el almacenamiento local del navegador
    },
    db: {
      schema: 'public'
    }
  }
);

--------------------------------------------------
ðŸ“ PATH: src\main.tsx
--------------------------------------------------
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import './index.css'
// Importamos el registro de la PWA (Esto activa la instalaciÃ³n en Android)
import { registerSW } from 'virtual:pwa-register'

// ConfiguraciÃ³n de actualizaciÃ³n automÃ¡tica
const updateSW = registerSW({
  onNeedRefresh() {
    // Si hay una nueva versiÃ³n, preguntamos al usuario o actualizamos
    if (confirm('Nueva versiÃ³n de MediScribe disponible. Â¿Actualizar?')) {
      updateSW(true);
    }
  },
  onOfflineReady() {
    console.log('App lista para trabajar offline');
  },
});

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

--------------------------------------------------
ðŸ“ PATH: src\pages\AgendaView.tsx
--------------------------------------------------
import React, { useState, useEffect } from 'react';
import { 
  format, 
  addMonths, 
  subMonths, 
  startOfMonth, 
  endOfMonth, 
  eachDayOfInterval, 
  isSameDay, 
  getDay,
  isToday,
  parseISO,
  setHours,
  setMinutes,
  addDays,
  startOfWeek,
  endOfWeek
} from 'date-fns';
import { es } from 'date-fns/locale';
import { 
  ChevronLeft, 
  ChevronRight, 
  Plus, 
  X, 
  Clock, 
  User, 
  Trash2,
  Loader2,
  UserPlus,
  List,
  Calendar as CalendarIcon,
  Settings,
  CheckCircle2,
  Download,
  ExternalLink,
  AlignJustify,
  Grid
} from 'lucide-react';
import { supabase } from '../lib/supabase';
import { toast } from 'sonner';

// --- TIPOS ---
type AppointmentType = 'consulta' | 'urgencia' | 'seguimiento';
type CalendarProvider = 'google' | 'outlook' | 'apple';
type ViewType = 'month' | 'week' | 'day';

interface Appointment {
  id: string;
  patient_id?: string;
  patient_name?: string; 
  date_time: string; 
  type: AppointmentType;
  notes?: string;
  duration_minutes: number;
}

interface Patient {
  id: string;
  name: string;
}

// --- UTILIDAD: GENERADOR DE LINKS ---
const getCalendarLink = (appt: any, provider: CalendarProvider) => {
  const startDate = new Date(appt.start_time || appt.date_time);
  const duration = appt.duration_minutes || 30;
  const endDate = new Date(startDate.getTime() + duration * 60000);
  
  const title = `Consulta: ${appt.title || appt.patient_name}`;
  const description = `Tipo: ${appt.type}\nNotas: ${appt.notes || ''}\n---\nGenerado por MediScribe AI`;
  const location = 'Consultorio';
  const formatDate = (date: Date) => date.toISOString().replace(/-|:|\.\d\d\d/g, "");

  if (provider === 'google') {
    const params = new URLSearchParams({
      action: 'TEMPLATE',
      text: title,
      dates: `${formatDate(startDate)}/${formatDate(endDate)}`,
      details: description,
      location: location,
    });
    return { url: `https://calendar.google.com/calendar/render?${params.toString()}`, type: 'link' };
  }
  
  if (provider === 'outlook') {
    const params = new URLSearchParams({
      path: '/calendar/action/compose',
      rru: 'addevent',
      startdt: startDate.toISOString(),
      enddt: endDate.toISOString(),
      subject: title,
      body: description,
      location: location
    });
    return { url: `https://outlook.live.com/calendar/0/deeplink/compose?${params.toString()}`, type: 'link' };
  }

  if (provider === 'apple') {
    const icsContent = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'BEGIN:VEVENT',
      `DTSTART:${formatDate(startDate)}`,
      `DTEND:${formatDate(endDate)}`,
      `SUMMARY:${title}`,
      `DESCRIPTION:${description.replace(/\n/g, '\\n')}`,
      `LOCATION:${location}`,
      'END:VEVENT',
      'END:VCALENDAR'
    ].join('\n');
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    return { url: URL.createObjectURL(blob), type: 'download', filename: 'cita.ics' };
  }

  return { url: '#', type: 'link' };
};

// --- MODAL DE CONFIGURACIÃ“N ---
const SyncConfigModal = ({ isOpen, onClose, currentProvider, setProvider }: { isOpen: boolean; onClose: () => void; currentProvider: CalendarProvider; setProvider: (p: CalendarProvider) => void }) => {
  if (!isOpen) return null;

  const providers = [
    { id: 'google', name: 'Google Calendar', icon: 'G', color: 'bg-blue-100 text-blue-600', desc: 'Abre web/app de Google.' },
    { id: 'outlook', name: 'Outlook / Office 365', icon: 'O', color: 'bg-cyan-100 text-cyan-600', desc: 'Para usuarios corporativos.' },
    { id: 'apple', name: 'Apple Calendar (iCal)', icon: 'A', color: 'bg-slate-100 text-slate-600', desc: 'Descarga archivo .ics.' },
  ];

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg border border-slate-100 overflow-hidden">
        <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
          <h3 className="font-bold text-slate-800 flex items-center gap-2">
            <Settings size={20} className="text-teal-600"/> 
            Conectividad Inteligente
          </h3>
          <button onClick={onClose}><X size={20} className="text-slate-400 hover:text-slate-600"/></button>
        </div>
        
        <div className="p-6">
          <div className="mb-6 bg-teal-50 border border-teal-100 rounded-lg p-4 text-sm text-teal-800">
            <p className="font-bold mb-1">Â¿CÃ³mo funciona?</p>
            <p className="opacity-90 leading-relaxed">
              MediScribe genera enlaces inteligentes para exportar tus citas. 
              Selecciona tu ecosistema preferido para que el botÃ³n de "Sincronizar" se adapte a tu flujo de trabajo diario.
            </p>
          </div>

          <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-3">Tu Ecosistema</label>
          
          <div className="space-y-3">
            {providers.map((p) => (
              <button
                key={p.id}
                onClick={() => setProvider(p.id as CalendarProvider)}
                className={`w-full flex items-center gap-4 p-3 rounded-xl border transition-all text-left ${
                  currentProvider === p.id 
                    ? 'border-teal-500 bg-teal-50 ring-1 ring-teal-500' 
                    : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'
                }`}
              >
                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${p.color}`}>
                  {p.icon}
                </div>
                <div className="flex-1">
                  <div className="flex justify-between items-center">
                    <span className="font-bold text-slate-800 text-sm">{p.name}</span>
                    {currentProvider === p.id && <CheckCircle2 size={16} className="text-teal-600"/>}
                  </div>
                  <p className="text-[10px] text-slate-500">{p.desc}</p>
                </div>
              </button>
            ))}
          </div>
        </div>

        <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-end">
          <button onClick={onClose} className="px-6 py-2 bg-slate-900 text-white rounded-lg font-medium hover:bg-slate-800 transition-colors text-sm">
            Guardar Preferencia
          </button>
        </div>
      </div>
    </div>
  );
};

// --- MODAL DE CITA ---
const AppointmentModal = ({ isOpen, onClose, onSave, onDelete, initialDate, existingAppt, patients, loading, provider }: any) => {
  const [isManual, setIsManual] = useState(false);
  const [formData, setFormData] = useState({ patient_id: '', manual_name: '', type: 'consulta', duration_minutes: 30, notes: '' });
  const [dateStr, setDateStr] = useState('');
  const [timeStr, setTimeStr] = useState('09:00');

  useEffect(() => {
    if (isOpen) {
      if (existingAppt) {
        const isApptManual = !existingAppt.patient_id;
        setIsManual(isApptManual);
        setFormData({
          patient_id: existingAppt.patient_id || '',
          manual_name: isApptManual ? (existingAppt.patient_name || '') : '',
          type: existingAppt.type || 'consulta',
          duration_minutes: existingAppt.duration_minutes || 30,
          notes: existingAppt.notes || ''
        });
        const dt = parseISO(existingAppt.date_time);
        setDateStr(format(dt, 'yyyy-MM-dd'));
        setTimeStr(format(dt, 'HH:mm'));
      } else {
        setIsManual(false);
        setFormData({ patient_id: '', manual_name: '', type: 'consulta', duration_minutes: 30, notes: '' });
        setDateStr(format(initialDate, 'yyyy-MM-dd'));
        setTimeStr(format(new Date(), 'HH:mm'));
      }
    }
  }, [isOpen, existingAppt, initialDate]);

  if (!isOpen) return null;

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const dateTimeString = `${dateStr}T${timeStr}:00`;
    const finalDate = new Date(dateTimeString); 
    let titleToSave = isManual ? formData.manual_name : (patients.find((p:any) => p.id === formData.patient_id)?.name || 'Cita');

    onSave({
      id: existingAppt?.id,
      patient_id: isManual ? null : formData.patient_id,
      start_time: finalDate.toISOString(),
      title: titleToSave,
      status: 'scheduled',
      type: formData.type,
      duration_minutes: formData.duration_minutes,
      notes: formData.notes
    });
  };

  const syncData = existingAppt ? getCalendarLink({
      start_time: existingAppt.date_time,
      duration_minutes: existingAppt.duration_minutes,
      title: existingAppt.patient_name,
      type: existingAppt.type,
      notes: existingAppt.notes
  }, provider) : null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-100">
        <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
          <h3 className="font-semibold text-slate-800 flex items-center gap-2">
            {existingAppt ? 'Editar Cita' : 'Nueva Cita'}
          </h3>
          <button onClick={onClose}><X size={20} className="text-slate-400 hover:text-slate-600"/></button>
        </div>
        
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div>
            <div className="flex justify-between items-center mb-1">
                <label className="text-xs font-bold text-slate-500 uppercase">Paciente</label>
                <button type="button" onClick={() => setIsManual(!isManual)} className="text-[10px] text-teal-600 font-bold bg-teal-50 px-2 py-0.5 rounded transition-colors hover:bg-teal-100">
                    {isManual ? <><List size={10} className="inline mr-1"/> Seleccionar Lista</> : <><UserPlus size={10} className="inline mr-1"/> Ingresar Manual</>}
                </button>
            </div>
            <div className="relative">
                <User className="absolute left-3 top-2.5 text-slate-400" size={18} />
                {isManual ? (
                    <input type="text" required placeholder="Nombre del paciente..." className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg outline-none focus:border-teal-500 transition-all" value={formData.manual_name} onChange={e => setFormData({...formData, manual_name: e.target.value})} />
                ) : (
                    <select required className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg outline-none focus:border-teal-500 transition-all appearance-none bg-white" value={formData.patient_id} onChange={e => setFormData({...formData, patient_id: e.target.value})}>
                        <option value="">Seleccione...</option>
                        {patients.map((p:any) => <option key={p.id} value={p.id}>{p.name}</option>)}
                    </select>
                )}
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
                <label className="text-xs font-bold text-slate-500 uppercase">Fecha</label>
                <div className="relative">
                    <CalendarIcon className="absolute left-3 top-2.5 text-slate-400" size={18}/>
                    <input type="date" required className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-teal-500" value={dateStr} onChange={e => setDateStr(e.target.value)} />
                </div>
            </div>
            <div>
                <label className="text-xs font-bold text-slate-500 uppercase">Hora</label>
                <div className="relative">
                    <Clock className="absolute left-3 top-2.5 text-slate-400" size={18}/>
                    <input type="time" required className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-teal-500" value={timeStr} onChange={e => setTimeStr(e.target.value)} />
                </div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
             <div><label className="text-xs font-bold text-slate-500 uppercase">Tipo</label><select className="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-teal-500" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value as any})}><option value="consulta">Consulta</option><option value="seguimiento">Seguimiento</option><option value="urgencia">Urgencia</option></select></div>
             <div><label className="text-xs font-bold text-slate-500 uppercase">Minutos</label><input type="number" min="5" step="5" className="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-teal-500" value={formData.duration_minutes} onChange={e => setFormData({...formData, duration_minutes: parseInt(e.target.value)})} /></div>
          </div>
          
          <textarea className="w-full p-3 border border-slate-200 rounded-lg text-sm resize-none outline-none focus:border-teal-500" rows={2} placeholder="Notas adicionales..." value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} />
          
          <div className="pt-2 flex gap-3">
             {existingAppt && onDelete && (
                 <button type="button" onClick={() => onDelete(existingAppt.id)} className="p-2.5 text-red-500 bg-red-50 rounded-lg hover:bg-red-100 transition-colors" title="Eliminar"><Trash2 size={20}/></button>
             )}
             
             {existingAppt && syncData && (
               <a 
                 href={syncData.url}
                 target={syncData.type === 'link' ? "_blank" : undefined}
                 download={syncData.type === 'download' ? syncData.filename : undefined}
                 rel="noopener noreferrer"
                 className={`p-2.5 rounded-lg transition-colors flex items-center justify-center ${
                   provider === 'google' ? 'bg-blue-50 text-blue-600 hover:bg-blue-100' :
                   provider === 'outlook' ? 'bg-cyan-50 text-cyan-600 hover:bg-cyan-100' :
                   'bg-slate-100 text-slate-600 hover:bg-slate-200'
                 }`}
                 title={`Sincronizar con ${provider}`}
               >
                 {provider === 'apple' ? <Download size={20} /> : <ExternalLink size={20} />}
               </a>
             )}

             <button type="submit" disabled={loading} className="flex-1 bg-teal-600 text-white font-medium py-2.5 rounded-lg shadow-md hover:bg-teal-700 flex justify-center items-center gap-2 disabled:opacity-70">
                {loading ? <Loader2 className="animate-spin" size={18}/> : (existingAppt ? 'Guardar Cambios' : 'Agendar Cita')}
             </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// --- VISTA PRINCIPAL ---
const AgendaView = () => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [patients, setPatients] = useState<Patient[]>([]);
  const [view, setView] = useState<ViewType>('month');
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  
  const [calendarProvider, setCalendarProvider] = useState<CalendarProvider>('google');
  const [isConfigOpen, setIsConfigOpen] = useState(false);
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [editingAppt, setEditingAppt] = useState<Appointment | null>(null);

  useEffect(() => { fetchData(); }, [currentDate, view]);

  const fetchData = async () => {
    try {
        setIsLoading(true);
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: patientsData } = await supabase.from('patients').select('id, name').eq('doctor_id', user.id);
        if (patientsData) setPatients(patientsData);

        let start, end;
        if (view === 'day') {
            start = new Date(currentDate); start.setHours(0,0,0,0);
            end = new Date(currentDate); end.setHours(23,59,59,999);
        } else if (view === 'week') {
            start = startOfWeek(currentDate, { weekStartsOn: 1 });
            end = endOfWeek(currentDate, { weekStartsOn: 1 });
        } else {
            start = startOfMonth(subMonths(currentDate, 1));
            end = endOfMonth(addMonths(currentDate, 1));
        }

        const { data: apptsData } = await supabase
            .from('appointments')
            .select(`id, start_time, duration_minutes, notes, status, title, patient:patients (name, id)`)
            .eq('doctor_id', user.id)
            .gte('start_time', start.toISOString())
            .lte('start_time', end.toISOString());

        if (apptsData) {
            const mappedAppts: Appointment[] = apptsData.map((a: any) => ({
                id: a.id,
                patient_id: a.patient?.id,
                patient_name: a.patient?.name || a.title || 'Sin Nombre',
                date_time: a.start_time,
                type: (a.title?.toLowerCase().includes('urgencia') ? 'urgencia' : 'consulta') as AppointmentType,
                notes: a.notes,
                duration_minutes: a.duration_minutes
            }));
            setAppointments(mappedAppts);
        }
    } catch (e) { console.error(e); } finally { setIsLoading(false); }
  };

  const handlePrev = () => setCurrentDate(view === 'day' ? addDays(currentDate, -1) : view === 'week' ? addDays(currentDate, -7) : subMonths(currentDate, 1));
  const handleNext = () => setCurrentDate(view === 'day' ? addDays(currentDate, 1) : view === 'week' ? addDays(currentDate, 7) : addMonths(currentDate, 1));
  
  const handleDayClick = (day: Date) => { setSelectedDate(day); setEditingAppt(null); setIsModalOpen(true); };
  const handleApptClick = (e: React.MouseEvent, appt: Appointment) => { e.stopPropagation(); setSelectedDate(parseISO(appt.date_time)); setEditingAppt(appt); setIsModalOpen(true); };

  const saveAppointment = async (apptData: any) => {
    setIsSaving(true);
    try {
        const { data: { user } } = await supabase.auth.getUser();
        const payload: any = {
            doctor_id: user?.id,
            start_time: apptData.start_time,
            title: apptData.title,
            status: apptData.status,
            notes: apptData.notes,
            duration_minutes: apptData.duration_minutes,
            patient_id: apptData.patient_id || null
        };

        if (apptData.id) await supabase.from('appointments').update(payload).eq('id', apptData.id);
        else await supabase.from('appointments').insert([payload]);
        
        await fetchData(); setIsModalOpen(false); toast.success("Cita guardada");
    } catch (error: any) { toast.error("Error al guardar"); } finally { setIsSaving(false); }
  };

  const deleteAppointment = async (id: string) => {
    if(!confirm('Â¿Eliminar cita?')) return;
    await supabase.from('appointments').delete().eq('id', id);
    toast.success("Eliminada");
    setAppointments(prev => prev.filter(a => a.id !== id));
    setIsModalOpen(false);
  };

  const renderView = () => {
    // VISTA DÃA
    if (view === 'day') {
        const sortedAppts = [...appointments].sort((a, b) => new Date(a.date_time).getTime() - new Date(b.date_time).getTime());
        return (
            <div className="flex-1 overflow-y-auto p-4 bg-white min-h-[500px]">
                {sortedAppts.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                        <Clock size={48} className="mb-2 opacity-50"/>
                        <p>No hay citas para hoy.</p>
                        <button onClick={() => handleDayClick(currentDate)} className="mt-4 text-teal-600 font-bold hover:underline">Agregar Cita</button>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {sortedAppts.map(appt => (
                            <div key={appt.id} onClick={(e) => handleApptClick(e, appt)} className="flex items-center p-4 bg-slate-50 hover:bg-white border border-slate-200 rounded-xl shadow-sm cursor-pointer transition-all hover:shadow-md hover:border-teal-200">
                                <div className="w-20 text-center border-r border-slate-200 pr-4 mr-4">
                                    <span className="block text-lg font-bold text-slate-700">{format(parseISO(appt.date_time), 'HH:mm')}</span>
                                    <span className="text-xs text-slate-400">{appt.duration_minutes} min</span>
                                </div>
                                <div>
                                    <h4 className="font-bold text-slate-800">{appt.patient_name}</h4>
                                    <span className={`text-xs px-2 py-0.5 rounded-full uppercase font-bold ${appt.type === 'urgencia' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>{appt.type}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }
    // VISTA SEMANA
    if (view === 'week') {
        const days = eachDayOfInterval({ start: startOfWeek(currentDate, { weekStartsOn: 1 }), end: endOfWeek(currentDate, { weekStartsOn: 1 }) });
        return (
            <div className="flex-1 grid grid-cols-7 min-h-[500px] bg-white divide-x divide-slate-100">
                {days.map(day => {
                    const dayAppts = appointments.filter(a => isSameDay(parseISO(a.date_time), day));
                    return (
                        <div key={day.toString()} className={`flex flex-col ${isToday(day) ? 'bg-teal-50/30' : ''}`}>
                            <div className="p-2 text-center border-b border-slate-100">
                                <span className="block text-xs font-bold text-slate-400 uppercase">{format(day, 'EEE', { locale: es })}</span>
                                <span className={`block text-lg font-bold ${isToday(day) ? 'text-teal-600' : 'text-slate-700'}`}>{format(day, 'd')}</span>
                            </div>
                            <div className="flex-1 p-1 space-y-1 overflow-y-auto" onClick={() => handleDayClick(day)}>
                                {dayAppts.map(appt => (
                                    <div key={appt.id} onClick={(e) => handleApptClick(e, appt)} className="p-1.5 bg-white border border-slate-200 rounded-lg shadow-sm text-[10px] cursor-pointer hover:border-teal-400">
                                        <div className="font-bold text-slate-700">{format(parseISO(appt.date_time), 'HH:mm')}</div>
                                        <div className="truncate text-slate-500">{appt.patient_name}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                })}
            </div>
        );
    }
    // VISTA MES (Con Mejora MÃ³vil: DOTS)
    const firstDay = startOfMonth(currentDate);
    const startDayIndex = getDay(firstDay) === 0 ? 6 : getDay(firstDay) - 1;
    const daysInMonth = eachDayOfInterval({ start: firstDay, end: endOfMonth(currentDate) });

    return (
        <div className="bg-white flex-1 overflow-hidden flex flex-col">
            <div className="grid grid-cols-7 border-b border-slate-100 bg-slate-50/80 backdrop-blur">
                {['lun', 'mar', 'miÃ©', 'jue', 'vie', 'sÃ¡b', 'dom'].map(d => <div key={d} className="py-4 text-center text-xs font-bold text-slate-400 uppercase">{d}</div>)}
            </div>
            <div className="grid grid-cols-7 auto-rows-fr flex-1 bg-slate-50/20 overflow-y-auto">
                {Array.from({ length: startDayIndex }).map((_, i) => <div key={`empty-${i}`} className="bg-slate-50/50 border-b border-r border-slate-100/50" />)}
                {daysInMonth.map(day => {
                    const dayAppts = appointments.filter(a => isSameDay(parseISO(a.date_time), day));
                    return (
                    <div key={day.toString()} onClick={() => handleDayClick(day)} className={`relative min-h-[100px] p-2 border-b border-r border-slate-100 hover:bg-white transition-all group cursor-pointer ${isToday(day) ? 'bg-teal-50/30' : ''}`}>
                        <div className="flex justify-between items-start mb-2">
                            <span className={`text-sm font-semibold w-8 h-8 flex items-center justify-center rounded-full ${isToday(day) ? 'bg-teal-600 text-white shadow-md' : 'text-slate-500 group-hover:bg-slate-200'}`}>{format(day, 'd')}</span>
                            <button className="opacity-0 group-hover:opacity-100 text-teal-500"><Plus size={16} /></button>
                        </div>
                        
                        {/* --- MEJORA UX MÃ“VIL: DOTS INDICATORS --- */}
                        <div className="md:hidden flex flex-wrap gap-1 mt-1 justify-center">
                            {dayAppts.slice(0, 5).map(app => (
                                <div 
                                    key={app.id} 
                                    className={`w-1.5 h-1.5 rounded-full ${app.type === 'urgencia' ? 'bg-red-500' : 'bg-teal-500'}`}
                                />
                            ))}
                            {dayAppts.length > 5 && <span className="text-[8px] text-slate-400 leading-none">+</span>}
                        </div>

                        {/* --- VISTA ESCRITORIO: LISTA DETALLADA --- */}
                        <div className="hidden md:flex flex-col gap-1 overflow-y-auto max-h-[80px] custom-scrollbar">
                            {dayAppts.map(app => (
                                <div key={app.id} onClick={(e) => handleApptClick(e, app)} className={`px-2 py-1 text-[10px] rounded border truncate ${app.type === 'urgencia' ? 'bg-red-50 border-red-100 text-red-700' : 'bg-teal-50 border-teal-100 text-teal-700'}`}>
                                    <b>{format(parseISO(app.date_time), 'HH:mm')}</b> {app.patient_name}
                                </div>
                            ))}
                        </div>
                    </div>
                    )
                })}
            </div>
        </div>
    );
  };

  return (
    <div className="flex flex-col h-full bg-slate-50/50 p-4 md:p-6 relative">
      <div className="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">Agenda MÃ©dica</h1>
          <p className="text-slate-500 text-sm">Organiza tu prÃ¡ctica y sincroniza con el exterior.</p>
        </div>
        <div className="flex gap-3">
          <button onClick={() => setIsConfigOpen(true)} className="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-bold border border-slate-200 shadow-sm flex items-center gap-2"><Settings size={18}/> <span className="hidden sm:inline">Conectividad</span></button>
          <button onClick={() => { setSelectedDate(new Date()); setEditingAppt(null); setIsModalOpen(true); }} className="bg-teal-600 hover:bg-teal-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg flex items-center gap-2"><Plus size={18}/> Nueva Cita</button>
        </div>
      </div>

      <div className="bg-white rounded-t-2xl border border-slate-200 p-4 flex flex-col sm:flex-row justify-between items-center shadow-sm gap-4">
        <div className="flex items-center gap-4 w-full sm:w-auto justify-between">
          <div className="flex items-center bg-slate-100 rounded-lg p-1">
            <button onClick={handlePrev} className="p-1.5 hover:bg-white rounded-md text-slate-600"><ChevronLeft size={20} /></button>
            <button onClick={() => setCurrentDate(new Date())} className="px-4 py-1.5 text-sm font-bold text-slate-700 hover:text-teal-600">Hoy</button>
            <button onClick={handleNext} className="p-1.5 hover:bg-white rounded-md text-slate-600"><ChevronRight size={20} /></button>
          </div>
          <h2 className="text-lg font-bold text-slate-800 capitalize min-w-[140px] text-center sm:text-left">
            {format(currentDate, view === 'day' ? "d 'de' MMMM" : 'MMMM yyyy', { locale: es })}
          </h2>
        </div>
        
        <div className="flex bg-slate-100 rounded-lg p-1 text-sm">
          {[
            { id: 'month', label: 'Mes', icon: Grid },
            { id: 'week', label: 'Semana', icon: AlignJustify },
            { id: 'day', label: 'DÃ­a', icon: List }
          ].map((v) => (
            <button
              key={v.id}
              onClick={() => setView(v.id as ViewType)}
              className={`flex items-center gap-2 px-4 py-1.5 rounded-md transition-all font-medium ${
                view === v.id 
                  ? 'bg-white text-teal-700 shadow-sm font-bold' 
                  : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              <v.icon size={14} className="hidden sm:block"/>
              {v.label}
            </button>
          ))}
        </div>
      </div>

      <div className="flex-1 border-x border-b border-slate-200 rounded-b-2xl shadow-sm overflow-hidden flex flex-col relative bg-white">
         {renderView()}
      </div>

      <SyncConfigModal isOpen={isConfigOpen} onClose={() => setIsConfigOpen(false)} currentProvider={calendarProvider} setProvider={setCalendarProvider} />
      <AppointmentModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} initialDate={selectedDate} existingAppt={editingAppt} onSave={saveAppointment} onDelete={deleteAppointment} patients={patients} loading={isSaving} provider={calendarProvider} />
    </div>
  );
};

export default AgendaView;

--------------------------------------------------
ðŸ“ PATH: src\pages\Dashboard.tsx
--------------------------------------------------
import React, { useEffect, useState, useMemo, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { 
  Calendar, MapPin, ChevronRight, Sun, Moon, Cloud, 
  Upload, X, Bot, Mic, Square, Loader2, CheckCircle2,
  Stethoscope, UserCircle, AlertTriangle, FileText,
  Clock, UserPlus, Activity, Search,
  CalendarX, Repeat, Ban, PlayCircle, PenLine, Calculator, Sparkles,
  BarChart3, FileSignature, Microscope, StickyNote, FileCheck, Printer,
  Sunrise, Sunset, MoonStar
} from 'lucide-react';
import { supabase } from '../lib/supabase';
import { format, isToday, isTomorrow, parseISO, startOfDay, endOfDay, addDays, isPast } from 'date-fns';
import { es } from 'date-fns/locale';
import { getTimeOfDayGreeting } from '../utils/greetingUtils';
import { toast } from 'sonner';

import { useSpeechRecognition } from '../hooks/useSpeechRecognition';
import { AssistantService } from '../services/AssistantService';
import { AgentResponse } from '../services/GeminiAgent';
import { UploadMedico } from '../components/UploadMedico';
import { DoctorFileGallery } from '../components/DoctorFileGallery';

import { QuickNotes } from '../components/QuickNotes';
import { MedicalCalculators } from '../components/MedicalCalculators';
import { QuickDocModal } from '../components/QuickDocModal';

import { ImpactMetrics } from '../components/ImpactMetrics';

// --- Interfaces ---
interface DashboardAppointment {
  id: string; title: string; start_time: string; status: string;
  patient?: { id: string; name: string; history?: string; };
  criticalAlert?: string | null;
}

interface PendingItem {
   id: string; type: 'note' | 'lab' | 'appt'; title: string; subtitle: string; date: string;
}

// --- Assistant Modal ---
const AssistantModal = ({ isOpen, onClose, onActionComplete }: { isOpen: boolean; onClose: () => void; onActionComplete: () => void }) => {
  const { isListening, transcript, startListening, stopListening, resetTranscript } = useSpeechRecognition();
  const [status, setStatus] = useState<'idle' | 'listening' | 'processing' | 'confirming'>('idle');
  const [aiResponse, setAiResponse] = useState<AgentResponse | null>(null);
  const navigate = useNavigate(); 
  
  useEffect(() => { 
      if (isOpen) {
          resetTranscript(); 
          setStatus('listening'); 
          startListening();
          setAiResponse(null);
      } else {
          stopListening();
      }
  }, [isOpen]);

  const handleExecute = async () => {
    if (!aiResponse) return;
    switch (aiResponse.intent) {
      case 'CREATE_APPOINTMENT':
        try {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) throw new Error("No autenticado");
          const { error } = await supabase.from('appointments').insert({
            doctor_id: user.id, title: aiResponse.data.patientName || "Cita Agendada",
            start_time: aiResponse.data.start_time, duration_minutes: aiResponse.data.duration_minutes || 30,
            status: 'scheduled', notes: aiResponse.data.notes || "Agendado por Voz", patient_id: null 
          });
          if (error) throw error;
          toast.success("âœ… Cita agendada"); onActionComplete(); onClose();
        } catch (e: any) { toast.error("Error: " + e.message); }
        break;
      case 'NAVIGATION':
        const dest = aiResponse.data.destination?.toLowerCase();
        onClose();
        if (dest.includes('agenda')) navigate('/agenda');
        else if (dest.includes('paciente')) navigate('/patients');
        else if (dest.includes('config')) navigate('/settings');
        else navigate('/');
        toast.success(`Navegando a: ${dest}`);
        break;
      case 'MEDICAL_QUERY': toast.info("Consulta mÃ©dica resuelta"); break;
      default: toast.info("No entendÃ­ la acciÃ³n"); setStatus('idle'); resetTranscript();
    }
  };
  
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-in fade-in duration-200">
      <div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden border border-white/20 ring-1 ring-black/5">
        <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-8 text-white text-center relative overflow-hidden">
          <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
          <Bot size={48} className="mx-auto mb-3 relative z-10 drop-shadow-lg" />
          <h3 className="text-2xl font-black relative z-10 tracking-tight">Copiloto ClÃ­nico</h3>
          <p className="text-indigo-100 text-sm relative z-10 font-medium">Escuchando Ã³rdenes mÃ©dicas...</p>
        </div>
        <div className="p-8">
          {status !== 'confirming' && (
            <div className="flex flex-col items-center gap-8">
               <div className={`text-center text-xl font-medium leading-relaxed ${transcript ? 'text-slate-800 dark:text-white' : 'text-slate-400'}`}>
                 "{transcript || 'Diga un comando...'}"
               </div>
               {status === 'processing' ? (
                 <div className="flex items-center gap-2 text-indigo-600 font-bold animate-pulse">
                   <Loader2 className="animate-spin" /> Procesando...
                 </div>
               ) : (
                 <button 
                   onClick={status === 'listening' ? () => {stopListening(); setStatus('processing'); setTimeout(() => handleExecute(), 1500);} : () => {startListening(); setStatus('listening');}} 
                   className={`w-20 h-20 rounded-full flex items-center justify-center shadow-2xl transition-all transform active:scale-95 ${status === 'listening' ? 'bg-red-500 text-white animate-pulse ring-8 ring-red-100' : 'bg-slate-900 text-white hover:bg-black hover:scale-105'}`}
                 >
                   {status === 'listening' ? <Square size={28} fill="currentColor"/> : <Mic size={28} />}
                 </button>
               )}
            </div>
          )}
          {status === 'confirming' && aiResponse && (
            <div className="animate-in slide-in-from-bottom-4 fade-in">
              <div className="bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl p-5 border border-indigo-100 dark:border-indigo-800 mb-6">
                <h4 className="font-bold text-slate-800 dark:text-white text-lg">AcciÃ³n Detectada</h4>
                <p className="text-slate-600 dark:text-slate-300 text-sm mt-1">{aiResponse.message}</p>
              </div>
              <div className="flex gap-3">
                <button onClick={() => { setStatus('idle'); resetTranscript(); }} className="flex-1 py-3.5 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors">Cancelar</button>
                <button onClick={handleExecute} className="flex-1 py-3.5 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 active:scale-95 flex items-center justify-center gap-2">Ejecutar</button>
              </div>
            </div>
          )}
        </div>
        <div className="bg-slate-50 p-4 text-center"><button onClick={onClose} className="text-slate-400 text-xs font-bold uppercase tracking-wider hover:text-slate-600">CERRAR</button></div>
      </div>
    </div>
  );
};

// --- Widgets ---
// CORREGIDO: StatusWidget ahora calcula su propia hora/noche para evitar errores de props
const StatusWidget = ({ weather, totalApts, pendingApts, location }: any) => {
    const [time, setTime] = useState(new Date());
    useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []);
    
    // CÃ¡lculo seguro interno
    const completed = totalApts - pendingApts;
    const progress = totalApts > 0 ? (completed / totalApts) * 100 : 0;
    
    // Definimos isNight internamente basado en la hora local del widget
    const hour = time.getHours();
    const isNight = hour >= 19 || hour < 6;
    
    return (
        <div className="bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl rounded-[2rem] p-6 border border-white/50 dark:border-slate-700 shadow-xl h-full flex flex-col justify-between relative overflow-hidden">
             <div className="absolute inset-0 bg-gradient-to-br from-white via-transparent to-blue-50/50 opacity-50"></div>
             <div className="flex justify-between items-start z-10 relative">
                 <div>
                     <div className="flex items-baseline gap-1">
                        <p className="text-4xl font-black text-slate-800 dark:text-white tracking-tighter">{format(time, 'h:mm')}</p>
                        <span className="text-sm font-bold text-slate-400">{format(time, 'a')}</span>
                     </div>
                     <p className="text-xs font-bold text-indigo-500 uppercase tracking-widest mt-1 flex items-center gap-1"><MapPin size={12} /> {location}</p>
                 </div>
                 <div className="text-right bg-white/50 p-2 rounded-2xl backdrop-blur-sm"><span className="text-2xl font-bold text-slate-700">{weather.temp}Â°</span></div>
             </div>
             <div className="mt-4 z-10 relative">
                 <div className="flex justify-between text-xs font-bold mb-2"><span className="text-slate-500">Progreso</span><span className="text-indigo-600">{completed}/{totalApts} Pacientes</span></div>
                 <div className="h-3 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-indigo-400 to-purple-500 transition-all duration-1000" style={{width: `${progress}%`}}></div></div>
             </div>
        </div>
    );
};

const QuickDocs = ({ openModal }: { openModal: (type: 'justificante' | 'certificado' | 'receta') => void }) => (
    <div className="bg-gradient-to-br from-white to-pink-50/50 dark:from-slate-900 dark:to-slate-900 rounded-[2rem] p-6 border border-slate-100 dark:border-slate-800 shadow-sm h-full">
        <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-4">
            <div className="p-2 bg-pink-50 text-pink-600 rounded-lg"><FileCheck size={18}/></div>
            Documentos RÃ¡pidos
        </h3>
        <div className="grid grid-cols-2 gap-3">
            <button onClick={() => openModal('justificante')} className="p-3 bg-white hover:bg-pink-50/50 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-100 dark:border-slate-700 hover:shadow-md rounded-xl text-left transition-all group">
                <FileText size={20} className="text-slate-400 group-hover:text-teal-500 mb-2"/>
                <p className="text-xs font-bold text-slate-700 dark:text-slate-200">Justificante</p>
                <p className="text-[10px] text-slate-400">Generar PDF</p>
            </button>
            <button onClick={() => openModal('certificado')} className="p-3 bg-white hover:bg-pink-50/50 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-100 dark:border-slate-700 hover:shadow-md rounded-xl text-left transition-all group">
                <FileSignature size={20} className="text-slate-400 group-hover:text-blue-500 mb-2"/>
                <p className="text-xs font-bold text-slate-700 dark:text-slate-200">Certificado</p>
                <p className="text-[10px] text-slate-400">Salud</p>
            </button>
            <button onClick={() => openModal('receta')} className="col-span-2 p-3 bg-white hover:bg-pink-50/50 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-100 dark:border-slate-700 hover:shadow-md rounded-xl text-left transition-all group flex items-center gap-3">
                <div className="p-2 bg-slate-50 dark:bg-slate-900 rounded-lg shadow-sm group-hover:scale-110 transition-transform">
                    <Printer size={20} className="text-indigo-500"/>
                </div>
                <div>
                    <p className="text-xs font-bold text-slate-700 dark:text-slate-200">Receta Simple</p>
                    <p className="text-[10px] text-slate-400">ImpresiÃ³n Directa</p>
                </div>
            </button>
        </div>
    </div>
);

const ActionRadar = ({ items, onItemClick }: { items: PendingItem[], onItemClick: (item: PendingItem) => void }) => {
    if (items.length === 0) return (
        <div className="bg-gradient-to-br from-white to-amber-50/50 dark:from-slate-900 dark:to-slate-900 rounded-[2rem] p-6 border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col items-center justify-center text-center h-48">
            <CheckCircle2 size={40} className="text-green-500 mb-2 opacity-50"/>
            <p className="font-bold text-slate-600 dark:text-slate-300">Todo en orden</p>
            <p className="text-xs text-slate-400">No hay pendientes urgentes.</p>
        </div>
    );
    return (
        <div className="bg-gradient-to-br from-white to-amber-50/50 dark:from-slate-900 dark:to-slate-900 rounded-[2rem] p-6 border border-slate-100 dark:border-slate-800 shadow-sm">
            <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-4">
                <div className="p-2 bg-amber-50 text-amber-600 rounded-lg"><AlertTriangle size={18}/></div>
                Radar de Pendientes
            </h3>
            <div className="space-y-3 max-h-60 overflow-y-auto custom-scrollbar">
                {items.map(item => (
                    <div key={item.id} onClick={() => onItemClick(item)} className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 cursor-pointer hover:bg-amber-50 dark:hover:bg-slate-700 hover:shadow-md transition-all group">
                        <div className={`w-2 h-2 rounded-full ${item.type === 'note' ? 'bg-red-500' : 'bg-amber-500'}`}></div>
                        <div className="flex-1">
                            <p className="text-sm font-bold text-slate-700 dark:text-slate-200">{item.title}</p>
                            <p className="text-xs text-slate-400">{item.subtitle}</p>
                        </div>
                        {item.type === 'note' ? <StickyNote size={16} className="text-slate-300"/> : <Clock size={16} className="text-slate-300"/>}
                    </div>
                ))}
            </div>
        </div>
    );
};

const MorningBriefing = ({ greeting, message, weather, systemStatus, onOpenAssistant, insights }: any) => {
    const hour = new Date().getHours();
    
    let theme = { gradient: "from-orange-400 via-amber-500 to-yellow-500", icon: Sunrise, label: "Buenos DÃ­as", text: "text-amber-50", shadow: "shadow-orange-200/50" };
    if (hour >= 12 && hour < 18) theme = { gradient: "from-blue-500 via-cyan-500 to-teal-400", icon: Sun, label: "Buenas Tardes", text: "text-blue-50", shadow: "shadow-blue-200/50" };
    else if (hour >= 18 && hour < 22) theme = { gradient: "from-indigo-600 via-purple-600 to-pink-500", icon: Sunset, label: "Buenas Noches", text: "text-indigo-100", shadow: "shadow-indigo-200/50" };
    else if (hour >= 22 || hour < 5) theme = { gradient: "from-slate-900 via-slate-800 to-blue-950", icon: MoonStar, label: "Guardia Nocturna", text: "text-slate-400", shadow: "shadow-slate-800/50" };

    return (
        <div className={`relative w-full rounded-[2.5rem] bg-gradient-to-r ${theme.gradient} p-8 shadow-2xl ${theme.shadow} dark:shadow-none text-white overflow-hidden mb-8 transition-all duration-1000 ease-in-out`}>
            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
            <div className="absolute -right-20 -top-20 w-96 h-96 bg-white/10 rounded-full blur-[100px] animate-pulse"></div>
            
            <div className="relative z-10 flex flex-col lg:flex-row justify-between items-end gap-6">
                <div className="flex-1 w-full">
                    <div className="flex items-center gap-2 mb-3 opacity-90">
                        <div className="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm">
                            <theme.icon size={16} className="text-white" />
                        </div>
                        <span className="text-xs font-bold uppercase tracking-widest opacity-80">Resumen Operativo</span>
                    </div>
                    
                    <h1 className="text-3xl md:text-4xl font-black tracking-tight mb-6 drop-shadow-sm leading-tight">
                        {greeting}
                    </h1>

                    {insights && (
                        <div className="flex flex-wrap gap-3">
                            <div className="flex items-center gap-3 bg-white/15 border border-white/10 px-4 py-2 rounded-xl backdrop-blur-md">
                                <div className="bg-white/20 p-1.5 rounded-lg"><Clock size={16}/></div>
                                <div>
                                    <p className="text-[10px] uppercase font-bold opacity-70">PrÃ³xima Cita</p>
                                    <p className="text-sm font-bold">{insights.nextTime || "Libre"}</p>
                                </div>
                            </div>

                            <div className="flex items-center gap-3 bg-white/15 border border-white/10 px-4 py-2 rounded-xl backdrop-blur-md">
                                <div className={`${insights.pending > 0 ? 'bg-amber-400/80 text-amber-900' : 'bg-white/20'} p-1.5 rounded-lg`}>
                                    <AlertTriangle size={16}/>
                                </div>
                                <div>
                                    <p className="text-[10px] uppercase font-bold opacity-70">AtenciÃ³n</p>
                                    <p className="text-sm font-bold">{insights.pending} Acciones</p>
                                </div>
                            </div>

                            <div className="flex items-center gap-3 bg-white/15 border border-white/10 px-4 py-2 rounded-xl backdrop-blur-md hidden sm:flex">
                                <div className="bg-white/20 p-1.5 rounded-lg"><Activity size={16}/></div>
                                <div>
                                    <p className="text-[10px] uppercase font-bold opacity-70">Progreso Hoy</p>
                                    <p className="text-sm font-bold">{insights.done}/{insights.total} Pacientes</p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                
                <div className="flex gap-4 shrink-0">
                    <div className="flex items-center gap-6 bg-white/10 backdrop-blur-md p-4 rounded-2xl border border-white/20 shadow-inner">
                        <div className="text-right">
                            <p className="text-3xl font-bold leading-none">{weather.temp}Â°</p>
                            <p className="text-[10px] opacity-80 uppercase font-bold mt-1">Clima</p>
                        </div>
                        <div className="h-10 w-px bg-white/20"></div>
                        <div>
                            <div className="flex items-center gap-2">
                                <div className={`w-2.5 h-2.5 rounded-full ${systemStatus ? 'bg-emerald-400 shadow-[0_0_10px_#34d399] animate-pulse' : 'bg-red-500'}`}></div>
                                <span className="font-bold text-sm tracking-tight">{systemStatus ? 'Online' : 'Offline'}</span>
                            </div>
                            <p className="text-[10px] opacity-80 mt-1 font-medium">{format(new Date(), "EEEE d", { locale: es })}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- COMPONENTE PRINCIPAL ---
const Dashboard: React.FC = () => {
  const navigate = useNavigate();
  const [doctorProfile, setDoctorProfile] = useState<any>(null); 
  const [appointments, setAppointments] = useState<DashboardAppointment[]>([]);
  
  // NUEVO: Estado para conteo de citas completadas hoy
  const [completedTodayCount, setCompletedTodayCount] = useState(0);

  const [pendingItems, setPendingItems] = useState<PendingItem[]>([]); 
  const [weather, setWeather] = useState({ temp: '--', code: 0 });
  const [locationName, setLocationName] = useState('Localizando...');
  const [systemStatus, setSystemStatus] = useState(true); 
  
  const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);
  const [isAssistantOpen, setIsAssistantOpen] = useState(false);
  const [isDocModalOpen, setIsDocModalOpen] = useState(false);
  const [docType, setDocType] = useState<'justificante' | 'certificado' | 'receta'>('justificante');
  const [toolsTab, setToolsTab] = useState<'notes' | 'calc'>('notes');
  
  const formattedDocName = useMemo(() => {
    if (!doctorProfile?.full_name) return '';
    const raw = doctorProfile.full_name.trim();
    return /^(Dr\.|Dra\.)/i.test(raw) ? raw : `Dr. ${raw}`;
  }, [doctorProfile]);

  const dynamicGreeting = useMemo(() => getTimeOfDayGreeting(formattedDocName || ''), [formattedDocName]);

  const fetchData = useCallback(async () => {
      try {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) { setSystemStatus(false); return; }
          setSystemStatus(true);
          const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
          setDoctorProfile(profile);
          
          const todayStart = startOfDay(new Date()); 
          const nextWeekEnd = endOfDay(addDays(new Date(), 7));
          
          // 1. Citas PENDIENTES (Futuras o de hoy)
          const { data: aptsData } = await supabase.from('appointments').select(`id, title, start_time, status, patient:patients (id, name, history)`).eq('doctor_id', user.id).gte('start_time', todayStart.toISOString()).lte('start_time', nextWeekEnd.toISOString()).neq('status', 'cancelled').neq('status', 'completed').order('start_time', { ascending: true }).limit(10);
          
          if (aptsData) {
              const formattedApts: DashboardAppointment[] = aptsData.map((item: any) => ({
                  id: item.id, title: item.title, start_time: item.start_time, status: item.status, patient: item.patient, criticalAlert: null 
              }));
              setAppointments(formattedApts);
          }

          // 2. NUEVO: Conteo de citas COMPLETADAS HOY para mÃ©tricas reales
          const { count: completedCount } = await supabase
              .from('appointments')
              .select('*', { count: 'exact', head: true })
              .eq('doctor_id', user.id)
              .eq('status', 'completed')
              .gte('start_time', todayStart.toISOString())
              .lte('start_time', endOfDay(new Date()).toISOString());
          
          setCompletedTodayCount(completedCount || 0);

          const radar: PendingItem[] = [];
          const { data: openConsults } = await supabase.from('consultations').select('id, created_at, patient_name').eq('doctor_id', user.id).eq('status', 'in_progress').limit(3);
          if (openConsults) { openConsults.forEach(c => radar.push({ id: c.id, type: 'note', title: 'Nota Incompleta', subtitle: `${c.patient_name || 'Sin nombre'} â€¢ ${format(parseISO(c.created_at), 'dd/MM')}`, date: c.created_at })); }
          const { data: lostApts } = await supabase.from('appointments').select('id, title, start_time').eq('doctor_id', user.id).eq('status', 'scheduled').lt('start_time', new Date().toISOString()).limit(3);
          if (lostApts) { lostApts.forEach(a => radar.push({ id: a.id, type: 'appt', title: 'Cita por Cerrar', subtitle: `${a.title} â€¢ ${format(parseISO(a.start_time), 'dd/MM HH:mm')}`, date: a.start_time })); }
          setPendingItems(radar);
      } catch (e) { setSystemStatus(false); console.error(e); }
  }, []);

  useEffect(() => {
    fetchData();
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(async (position) => {
            try {
                const { latitude, longitude } = position.coords;
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&timezone=auto`);
                const data = await res.json();
                setWeather({ temp: Math.round(data.current.temperature_2m).toString(), code: data.current.weather_code });
                const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=es`);
                const geoData = await geoRes.json();
                if(geoData.city || geoData.locality) setLocationName(geoData.city || geoData.locality);
            } catch (e) { setLocationName("MÃ©xico"); }
        }, () => setLocationName("UbicaciÃ³n n/a"));
    }
  }, [fetchData]);

  const openDocModal = (type: 'justificante' | 'certificado' | 'receta') => { setDocType(type); setIsDocModalOpen(true); };
  const nextPatient = useMemo(() => appointments.find(a => a.status === 'scheduled') || null, [appointments]);
  const groupedAppointments = useMemo(() => appointments.reduce((acc, apt) => {
    const day = isToday(parseISO(apt.start_time)) ? 'Hoy' : format(parseISO(apt.start_time), 'EEEE d', { locale: es });
    if (!acc[day]) acc[day] = []; acc[day].push(apt); return acc;
  }, {} as Record<string, DashboardAppointment[]>), [appointments]);

  const handleStartConsultation = (apt: DashboardAppointment) => {
      const patientData = apt.patient ? { id: apt.patient.id, name: apt.patient.name } : { id: `ghost_${apt.id}`, name: apt.title, isGhost: true };
      navigate('/consultation', { state: { patientData, linkedAppointmentId: apt.id } });
  };

  const handleRadarClick = (item: PendingItem) => {
      if (item.type === 'note') {
          navigate('/consultation', { state: { consultationId: item.id, isResume: true } });
      } else if (item.type === 'appt') {
           const patientName = item.subtitle.split('â€¢')[0].trim();
           navigate('/consultation', { 
               state: { 
                   linkedAppointmentId: item.id,
                   patientData: { id: 'radar_temp', name: patientName, isGhost: true } 
               } 
           });
      }
  };

  // CÃLCULO REAL DE LA JORNADA
  const appointmentsToday = appointments.filter(a => isToday(parseISO(a.start_time))).length;
  const totalDailyLoad = completedTodayCount + appointmentsToday;

  return (
    <div className="min-h-screen bg-[#F8FAFC] dark:bg-slate-950 font-sans w-full pb-32 md:pb-8 relative overflow-hidden">
      
      <div className="md:hidden px-5 py-4 flex justify-between items-center bg-white sticky top-0 z-30 shadow-sm">
        <span className="font-bold text-lg text-indigo-700">MediScribe</span>
        <div className="h-8 w-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-xs">{formattedDocName ? formattedDocName.charAt(0) : 'D'}</div>
      </div>

      <div className="px-4 md:px-8 pt-4 md:pt-8 max-w-[1600px] mx-auto w-full">
         
         <MorningBriefing 
            greeting={dynamicGreeting.greeting} 
            message={dynamicGreeting.message} 
            weather={weather} 
            systemStatus={systemStatus} 
            onOpenAssistant={() => setIsAssistantOpen(true)}
            
            insights={{
                nextTime: nextPatient ? format(parseISO(nextPatient.start_time), 'h:mm a') : null,
                pending: pendingItems.length,
                total: totalDailyLoad, // TOTAL REAL (Completados + Pendientes)
                done: completedTodayCount // PROGRESO REAL
            }}
         />

         <div className="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
             
             <div className="xl:col-span-8 flex flex-col gap-8">
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-auto md:h-64">
                     <div className="bg-gradient-to-br from-white to-emerald-50/50 dark:from-slate-900 dark:to-slate-900 rounded-[2rem] p-1 shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-800 relative overflow-hidden group">
                        <div className={`absolute top-0 left-0 w-2 h-full ${nextPatient ? 'bg-emerald-500' : 'bg-slate-300'}`}></div>
                        <div className="p-8 flex flex-col justify-between h-full relative z-10">
                             <div className="flex justify-between items-start mb-4">
                                <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${nextPatient ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}`}>{nextPatient ? 'En Espera' : 'Libre'}</span>
                                {nextPatient && <span className="text-2xl font-bold text-slate-800">{format(parseISO(nextPatient.start_time), 'h:mm a')}</span>}
                             </div>
                             <div>
                                <h2 className="text-3xl font-black text-slate-800 dark:text-white leading-tight mb-1">{nextPatient ? nextPatient.title : 'Agenda Despejada'}</h2>
                                <p className="text-slate-500 text-sm">{nextPatient ? (nextPatient.patient ? 'Expediente Activo' : 'Primera Vez') : 'No hay pacientes en cola inmediata.'}</p>
                             </div>
                             {nextPatient && <button onClick={() => handleStartConsultation(nextPatient)} className="mt-6 w-full py-3 bg-slate-900 hover:bg-black text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all"><PlayCircle size={18}/> INICIAR CONSULTA</button>}
                        </div>
                     </div>
                     <StatusWidget 
                        weather={weather} 
                        totalApts={totalDailyLoad} // DATO REAL
                        pendingApts={appointmentsToday} // DATO REAL
                        location={locationName} 
                     />
                 </div>

                 <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div className="bg-gradient-to-br from-white to-indigo-50/50 dark:from-slate-900 dark:to-slate-900 rounded-[2rem] p-6 border border-slate-100 dark:border-slate-800 shadow-sm min-h-[300px]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2"><Calendar size={20} className="text-indigo-600"/> Agenda</h3>
                            <button onClick={() => navigate('/calendar')} className="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full">Ver Todo</button>
                        </div>
                        {appointments.length === 0 ? (
                            <div className="text-center py-10 text-slate-400 text-sm">Sin citas programadas hoy.</div>
                        ) : (
                            <div className="space-y-4">
                                {Object.entries(groupedAppointments).slice(0, 1).map(([day, apts]) => (
                                    apts.slice(0,3).map(apt => (
                                        <div key={apt.id} className="flex items-center gap-4 p-3 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors cursor-pointer group" onClick={() => handleStartConsultation(apt)}>
                                            <div className="font-bold text-slate-500 text-xs w-10 text-right">{format(parseISO(apt.start_time), 'HH:mm')}</div>
                                            <div className="w-1 h-8 bg-indigo-200 rounded-full group-hover:bg-indigo-500 transition-colors"></div>
                                            <div className="flex-1"><p className="font-bold text-slate-800 dark:text-white text-sm truncate">{apt.title}</p></div>
                                            <ChevronRight size={16} className="text-slate-300"/>
                                        </div>
                                    ))
                                ))}
                            </div>
                        )}
                     </div>
                     <div className="flex flex-col gap-6 h-full">
                         <div className="flex-1"><QuickDocs openModal={openDocModal} /></div>
                         <div className="h-40"><ImpactMetrics /></div>
                     </div>
                 </div>
             </div>

             <div className="xl:col-span-4 flex flex-col gap-8">
                 <ActionRadar items={pendingItems} onItemClick={handleRadarClick} />
                 
                 <div className="bg-gradient-to-br from-white to-slate-100 dark:from-slate-900 dark:to-slate-900 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-xl shadow-slate-200/50 dark:shadow-none flex-1 flex flex-col min-h-[400px]">
                      <div className="flex p-2 gap-2 bg-slate-50/50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700">
                          <button onClick={() => setToolsTab('notes')} className={`flex-1 py-3 rounded-xl text-xs font-bold uppercase transition-all ${toolsTab === 'notes' ? 'bg-white dark:bg-slate-700 text-indigo-600 shadow-sm' : 'text-slate-400'}`}><PenLine size={14} className="inline mr-2"/> Notas</button>
                          <button onClick={() => setToolsTab('calc')} className={`flex-1 py-3 rounded-xl text-xs font-bold uppercase transition-all ${toolsTab === 'calc' ? 'bg-white dark:bg-slate-700 text-indigo-600 shadow-sm' : 'text-slate-400'}`}><Calculator size={14} className="inline mr-2"/> Calc</button>
                      </div>
                      <div className="p-0 flex-1 relative bg-white dark:bg-slate-900">
                          {toolsTab === 'notes' ? <div className="absolute inset-0 p-2"><QuickNotes /></div> : <div className="absolute inset-0 p-2 overflow-y-auto"><MedicalCalculators /></div>}
                      </div>
                 </div>
                 <div className="grid grid-cols-2 gap-4">
                     <button onClick={() => navigate('/patients')} className="p-4 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-2xl font-bold text-xs flex flex-col items-center gap-2 border border-indigo-100 dark:bg-indigo-900/20 dark:border-indigo-800 dark:text-indigo-300"><UserPlus size={20}/> Nuevo Paciente</button>
                     <button onClick={() => setIsUploadModalOpen(true)} className="p-4 bg-slate-50 hover:bg-slate-100 text-slate-700 rounded-2xl font-bold text-xs flex flex-col items-center gap-2 border border-slate-200 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300"><Upload size={20}/> Subir Archivos</button>
                 </div>
             </div>
         </div>
      </div>

      {isUploadModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
          <div className="bg-white w-full max-w-md rounded-[2rem] p-6 shadow-2xl relative">
             <button onClick={() => setIsUploadModalOpen(false)} className="absolute top-4 right-4 p-2 bg-slate-100 rounded-full"><X size={16}/></button>
             <h3 className="font-bold text-lg mb-4">GestiÃ³n Documental</h3>
             <UploadMedico onUploadComplete={() => {}}/>
             <div className="mt-4 pt-4 border-t"><DoctorFileFileGallery /></div>
          </div>
        </div>
      )}

      <QuickDocModal isOpen={isDocModalOpen} onClose={() => setIsDocModalOpen(false)} doctorProfile={doctorProfile} defaultType={docType} />
      <AssistantModal isOpen={isAssistantOpen} onClose={() => setIsAssistantOpen(false)} onActionComplete={fetchData} />
    </div>
  );
};
        
export default Dashboard;

--------------------------------------------------
ðŸ“ PATH: src\pages\PrivacyPolicy.tsx
--------------------------------------------------
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { ChevronLeft, Shield, Lock, FileText } from 'lucide-react';

const PrivacyPolicy: React.FC = () => {
  const navigate = useNavigate();

  return (
    <div className="p-4 lg:p-8 max-w-4xl mx-auto animate-fade-in-up font-sans">
      <button 
        onClick={() => navigate(-1)} 
        className="flex items-center gap-2 text-slate-500 hover:text-slate-800 mb-6 transition-colors font-medium"
      >
        <ChevronLeft size={20} /> Volver
      </button>

      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        
        <div className="bg-slate-50 p-8 border-b border-slate-100">
            <div className="flex items-center gap-4 mb-2">
                <div className="p-3 bg-white rounded-xl shadow-sm text-teal-600">
                    <Shield size={32} />
                </div>
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Aviso de Privacidad Simplificado</h1>
                    <p className="text-slate-500 text-sm">Ãšltima actualizaciÃ³n: Noviembre 2025</p>
                </div>
            </div>
        </div>

        <div className="p-8 text-slate-700 leading-relaxed space-y-6">
            <p className="text-lg font-medium text-slate-800">
                <strong>PixelArte Studio</strong>, con domicilio en MÃ©xico, es el responsable del uso y protecciÃ³n de sus datos personales.
            </p>

            <div>
                <h3 className="flex items-center gap-2 text-slate-800 font-bold text-lg mb-3">
                    <FileText size={20} className="text-teal-600"/> 1. Finalidades del Tratamiento (NOM-004)
                </h3>
                <p className="mb-2">
                    Los datos personales y <strong>datos personales sensibles (referentes al estado de salud)</strong> que recabamos a travÃ©s de la plataforma <strong>MediScribe AI</strong>, son utilizados para:
                </p>
                <ul className="list-disc pl-5 space-y-2 bg-slate-50 p-4 rounded-lg border border-slate-100">
                    <li>GestiÃ³n de agenda mÃ©dica y administraciÃ³n de expedientes clÃ­nicos conforme a la <strong>NOM-004-SSA3-2012</strong>.</li>
                    <li>GeneraciÃ³n automatizada de notas clÃ­nicas y recetas mediante Inteligencia Artificial.</li>
                    <li>Almacenamiento seguro, encriptado y confidencial de su historial mÃ©dico y el de sus pacientes.</li>
                </ul>
            </div>

            <div>
                <h3 className="flex items-center gap-2 text-slate-800 font-bold text-lg mb-3">
                    <Lock size={20} className="text-teal-600"/> 2. Seguridad y Derechos ARCO
                </h3>
                <p>
                    La informaciÃ³n estÃ¡ protegida con <strong>Seguridad a Nivel de Fila (RLS)</strong>. El MÃ©dico Usuario es el <strong>Responsable del Expediente ClÃ­nico</strong> ante sus pacientes. Para ejercer sus derechos ARCO (Acceso, RectificaciÃ³n, CancelaciÃ³n y OposiciÃ³n), por favor contactar a: <a href="mailto:contacto@pixelartestudio.art" className="text-teal-600 hover:underline font-bold">contacto@pixelartestudio.art</a>
                </p>
            </div>
        </div>

        <div className="bg-slate-900 text-slate-400 p-8 text-center text-xs mt-4">
            <p className="mb-2">
                Â© {new Date().getFullYear()} <span className="text-white font-bold">MediScribe AI</span>. Desarrollado por PixelArte Studio.
            </p>
            <p>Todos los derechos reservados. v2.4 Golden.</p>
        </div>

      </div>
    </div>
  );
};

export default PrivacyPolicy;

--------------------------------------------------
ðŸ“ PATH: src\pages\ReportsView.tsx
--------------------------------------------------
import React from 'react';
import { LayoutDashboard, FileBarChart, Calendar } from 'lucide-react';

// Hemos removido InsightsPanel temporalmente porque ahora es un mÃ³dulo de Pacientes.
// En el futuro, restauraremos reportes generales aquÃ­.

const ReportsView: React.FC = () => {
  return (
    <div className="p-6 max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
            <LayoutDashboard className="text-brand-teal"/> Reportes Generales
        </h1>
        <p className="text-slate-500 dark:text-slate-400">Resumen de actividad clÃ­nica.</p>
      </div>

      <div className="bg-white dark:bg-slate-800 p-10 rounded-2xl shadow-sm text-center border border-slate-200 dark:border-slate-700">
          <div className="w-20 h-20 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
              <FileBarChart size={32}/>
          </div>
          <h3 className="text-xl font-bold text-slate-700 dark:text-white mb-2">MÃ³dulo en Mantenimiento</h3>
          <p className="text-slate-500 max-w-md mx-auto">
              Estamos actualizando los reportes generales para incluir las nuevas mÃ©tricas de Inteligencia Artificial.
              <br/><br/>
              Por ahora, utiliza el <b>Balance ClÃ­nico 360Â°</b> directamente en el perfil de cada paciente.
          </p>
      </div>
    </div>
  );
};

export default ReportsView;

--------------------------------------------------
ðŸ“ PATH: src\pages\TermsOfService.tsx
--------------------------------------------------
// Archivo: src/pages/TermsOfService.tsx
import React, { useState } from 'react';
import { 
  Shield, Scale, FileText, Download, CheckCircle, 
  AlertTriangle, Lock, Server, FileJson 
} from 'lucide-react';

const TermsOfService = () => {
  const [activeTab, setActiveTab] = useState<'dossier' | 'terms'>('dossier');

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans">
      
      {/* HEADER */}
      <div className="max-w-5xl mx-auto mb-8">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <div className="flex items-center gap-2 mb-2 text-teal-700">
               <Shield size={24} />
               <span className="text-sm font-bold uppercase tracking-wider">Compliance & Trust</span>
            </div>
            <h1 className="text-3xl font-bold text-slate-900">Centro de Transparencia y Legalidad</h1>
            <p className="text-slate-500 mt-1">Marco normativo, seguridad tÃ©cnica y tÃ©rminos de uso de MediScribe AI.</p>
          </div>
          <button className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-slate-900 hover:border-slate-300 shadow-sm transition-all">
            <Download size={18} />
            <span className="text-sm font-bold">Descargar PDF</span>
          </button>
        </div>
      </div>

      {/* TABS DE NAVEGACIÃ“N */}
      <div className="max-w-5xl mx-auto mb-8">
        <div className="flex border-b border-slate-200">
          <button
            onClick={() => setActiveTab('dossier')}
            className={`flex items-center gap-2 px-6 py-3 text-sm font-bold border-b-2 transition-colors ${
              activeTab === 'dossier' 
                ? 'border-teal-500 text-teal-700' 
                : 'border-transparent text-slate-400 hover:text-slate-600'
            }`}
          >
            <Server size={18} />
            DOSSIER TÃ‰CNICO Y NORMATIVO
          </button>
          <button
            onClick={() => setActiveTab('terms')}
            className={`flex items-center gap-2 px-6 py-3 text-sm font-bold border-b-2 transition-colors ${
              activeTab === 'terms' 
                ? 'border-teal-500 text-teal-700' 
                : 'border-transparent text-slate-400 hover:text-slate-600'
            }`}
          >
            <Scale size={18} />
            TÃ‰RMINOS Y RESPONSABILIDAD
          </button>
        </div>
      </div>

      {/* CONTENIDO */}
      <div className="max-w-5xl mx-auto">
        
        {/* --- PESTAÃ‘A 1: DOSSIER TÃ‰CNICO (AQUÃ ESTÃ EL CAMBIO) --- */}
        {activeTab === 'dossier' && (
          <div className="space-y-6 animate-fade-in">
            
            {/* RESUMEN EJECUTIVO */}
            <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
              <div className="absolute top-0 left-0 w-1 h-full bg-teal-500"></div>
              <h3 className="text-xl font-bold text-slate-900 mb-4">Resumen Ejecutivo</h3>
              <p className="text-slate-600 leading-relaxed text-sm md:text-base">
                **MediScribe AI (v4.0)** es una plataforma de **Inteligencia Ambiental ClÃ­nica** diseÃ±ada para mitigar el *burnout* mÃ©dico. 
                Opera bajo una arquitectura **Offline-First** segura y cumple con las normativas **NOM-004** y **NOM-024** como 
                Software de Apoyo a la GestiÃ³n Administrativa, garantizando la soberanÃ­a de datos y la responsabilidad clÃ­nica humana.
              </p>

              <div className="mt-8 space-y-4">
                <div className="flex gap-3 items-start">
                   <div className="mt-1"><CheckCircle size={18} className="text-teal-500" /></div>
                   <div>
                      <h4 className="font-bold text-slate-800 text-sm">1. ClasificaciÃ³n Regulatoria (MÃ©xico)</h4>
                      <p className="text-slate-500 text-xs mt-1 leading-relaxed">
                        MediScribe AI se clasifica estrictamente como <strong>Software de GestiÃ³n Administrativa y Documental</strong>. 
                        <strong> NO es un Dispositivo MÃ©dico (SaMD):</strong> No realiza diagnÃ³sticos autÃ³nomos ni dosifica medicamentos sin supervisiÃ³n.
                        <br/><br/>
                        <strong>Cumplimiento NOM-004-SSA3-2012:</strong> Integra la Ficha de IdentificaciÃ³n completa (CURP, Tipo de Sangre) y respeta el orden de la Historia ClÃ­nica.
                        <br/><br/>
                        {/* --- AQUÃ EL CAMBIO LEGAL CRÃTICO --- */}
                        <strong>Cumplimiento NOM-024-SSA3-2010:</strong> Garantiza confidencialidad, integridad (Audit Trail) y disponibilidad de la informaciÃ³n mediante <strong>formatos portables estructurados (JSON/PDF)</strong>.
                      </p>
                   </div>
                </div>
              </div>
            </div>

            {/* ARQUITECTURA Y SEGURIDAD */}
            <div className="grid md:grid-cols-2 gap-6">
               <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                  <div className="flex items-center gap-2 mb-3">
                     <Server size={20} className="text-indigo-500"/>
                     <h4 className="font-bold text-slate-700 text-sm uppercase tracking-wider">Motor de IA</h4>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                    Google Vertex AI + <strong>Gemini 1.5 Flash</strong>. Ventana de 1 MillÃ³n de tokens para anÃ¡lisis contextual profundo. 
                    Protocolo "Radar" para alta disponibilidad (99.9%).
                  </p>
                  <div className="mt-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100 text-xs text-indigo-800 font-medium">
                    Privacidad de IA: Los datos NO se utilizan para entrenar los modelos pÃºblicos de Google.
                  </div>
               </div>

               <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                  <div className="flex items-center gap-2 mb-3">
                     <Lock size={20} className="text-emerald-500"/>
                     <h4 className="font-bold text-slate-700 text-sm uppercase tracking-wider">Seguridad de Datos</h4>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                    EncriptaciÃ³n <strong>AES-256</strong> en reposo y <strong>TLS 1.3</strong> en trÃ¡nsito. Seguridad a Nivel de Fila (RLS) en base de datos PostgreSQL.
                    Arquitectura Single-Tenant lÃ³gica para aislamiento de pacientes.
                  </p>
               </div>
            </div>

            {/* SOBERANÃA Y GARANTÃA */}
            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
               <div className="flex items-center gap-2 mb-3">
                  <FileJson size={20} className="text-orange-500"/>
                  <h4 className="font-bold text-slate-700 text-sm uppercase tracking-wider">3. SoberanÃ­a de Datos</h4>
               </div>
               <p className="text-sm text-slate-600 mb-4">
                 El mÃ©dico y la instituciÃ³n retienen la <strong>propiedad absoluta</strong> de la informaciÃ³n. MediScribe AI evita el "secuestro de datos" (*Vendor Lock-in*), permitiendo la exportaciÃ³n completa en cualquier momento.
               </p>
               
               <div className="bg-amber-50 border border-amber-200 rounded-xl p-4">
                  <h5 className="font-bold text-amber-800 text-sm flex items-center gap-2 mb-2">
                    <AlertTriangle size={16}/> Disclaimer MÃ©dico (Responsabilidad)
                  </h5>
                  <ul className="list-disc list-inside text-xs text-amber-900/80 space-y-1 ml-1">
                    <li><strong>Herramienta de Apoyo:</strong> El software es un asistente de borrador, no un sustituto del mÃ©dico.</li>
                    <li><strong>Responsabilidad Final:</strong> La validaciÃ³n y firma de la nota clÃ­nica es responsabilidad exclusiva del profesional de la salud licenciado.</li>
                    <li><strong>SupervisiÃ³n Humana:</strong> El mÃ©dico debe verificar la exactitud de la transcripciÃ³n antes de integrarla al expediente legal.</li>
                  </ul>
               </div>
            </div>

          </div>
        )}

        {/* --- PESTAÃ‘A 2: TÃ‰RMINOS LEGALES --- */}
        {activeTab === 'terms' && (
          <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 animate-fade-in">
            <h3 className="text-xl font-bold text-slate-900 mb-6">TÃ©rminos y Condiciones de Uso</h3>
            <p className="text-xs text-slate-400 mb-6 uppercase">Ãšltima actualizaciÃ³n: Noviembre 2025</p>

            <div className="space-y-6 text-sm text-slate-600">
              <section>
                <h4 className="font-bold text-slate-800 mb-2">1. AceptaciÃ³n de los TÃ©rminos</h4>
                <p>Al acceder y utilizar MediScribe AI, usted acepta cumplir con estos tÃ©rminos. El servicio estÃ¡ destinado exclusivamente a profesionales de la salud debidamente acreditados.</p>
              </section>

              <section>
                <h4 className="font-bold text-slate-800 mb-2">2. Responsabilidad del Usuario</h4>
                <p>El usuario reconoce que MediScribe AI es una herramienta de asistencia para la documentaciÃ³n. El usuario es el Ãºnico responsable de revisar, editar y aprobar la exactitud de cualquier nota clÃ­nica generada antes de guardarla en el expediente oficial del paciente.</p>
              </section>

              <section>
                <h4 className="font-bold text-slate-800 mb-2">3. Privacidad y Datos</h4>
                <p>Nos comprometemos a proteger la privacidad de los datos de salud (PHI). Sin embargo, el usuario es responsable de obtener el consentimiento informado del paciente para el uso de herramientas de grabaciÃ³n y transcripciÃ³n durante la consulta.</p>
              </section>

              <section>
                <h4 className="font-bold text-slate-800 mb-2">4. LimitaciÃ³n de Responsabilidad</h4>
                <p>MediScribe AI no serÃ¡ responsable por decisiones mÃ©dicas, diagnÃ³sticos o tratamientos realizados basÃ¡ndose en la documentaciÃ³n generada por el sistema. El juicio clÃ­nico humano prevalece en todo momento.</p>
              </section>
            </div>
          </div>
        )}

      </div>
    </div>
  );
};

export default TermsOfService;

--------------------------------------------------
ðŸ“ PATH: src\pages\UpdatePassword.tsx
--------------------------------------------------
import React from 'react';
import AuthView from '../components/AuthView';
import { supabase } from '../lib/supabase';

interface UpdatePasswordProps {
  onSuccess?: () => void;
}

const UpdatePassword: React.FC<UpdatePasswordProps> = ({ onSuccess }) => {
  return (
    // Renderizamos AuthView forzando el modo de reseteo
    // Esto mantiene tu diseÃ±o original (Split Screen) pero mostrando el form correcto
    <AuthView 
      authService={{ supabase }} 
      onLoginSuccess={() => {}} 
      forceResetMode={true} 
      onPasswordResetSuccess={() => {
          // Al terminar, mandamos al usuario a la raÃ­z
          window.location.href = '/';
      }}
    />
  );
};

export default UpdatePassword;

--------------------------------------------------
ðŸ“ PATH: src\services\AnalyticsService.ts
--------------------------------------------------
import { supabase } from '../lib/supabase';
// Importamos solo lo necesario para formateo visual, la lÃ³gica serÃ¡ nativa
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

// --- Interfaces Originales ---
export interface InactivePatient {
  id: string;
  name: string;
  phone: string | null;
  lastVisit: string;
  daysSince: number;
}

export interface DiagnosisTrend {
  topic: string;
  count: number;
  percentage: number;
}

export interface WeeklyStats {
  labels: string[]; 
  values: number[]; 
  rawCounts: number[]; 
  growth: number; 
}

export const AnalyticsService = {

  // =================================================================
  // 1. PACIENTES INACTIVOS (CÃ“DIGO ORIGINAL RESTAURADO)
  // =================================================================
  async getInactivePatients(monthsThreshold: number = 6): Promise<InactivePatient[]> {
    const { data: patients, error } = await supabase
      .from('patients')
      .select('id, name, phone, created_at, consultations(created_at)');

    if (error || !patients) return [];

    const now = new Date();
    const opportunities: InactivePatient[] = [];

    patients.forEach(patient => {
      let lastDate = new Date(patient.created_at);
      if (patient.consultations && patient.consultations.length > 0) {
        const dates = patient.consultations.map((c: any) => new Date(c.created_at).getTime());
        lastDate = new Date(Math.max(...dates));
      }
      const diffTime = Math.abs(now.getTime() - lastDate.getTime());
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      const diffMonths = diffDays / 30;

      if (diffMonths >= monthsThreshold) {
        opportunities.push({
          id: patient.id,
          name: patient.name,
          phone: patient.phone,
          lastVisit: lastDate.toLocaleDateString(),
          daysSince: diffDays
        });
      }
    });
    return opportunities.sort((a, b) => b.daysSince - a.daysSince).slice(0, 5);
  },

  // =================================================================
  // 2. TENDENCIAS (CÃ“DIGO ORIGINAL RESTAURADO)
  // =================================================================
  async getDiagnosisTrends(): Promise<DiagnosisTrend[]> {
    const { data: consultations } = await supabase
      .from('consultations')
      .select('summary')
      .limit(50)
      .order('created_at', { ascending: false });

    if (!consultations) return [];

    const wordMap: Record<string, number> = {};
    let totalValidWords = 0;
    const stopWords = ['el', 'la', 'los', 'las', 'un', 'una', 'de', 'del', 'a', 'ante', 'con', 'en', 'por', 'para', 'y', 'o', 'que', 'se', 'su', 'sus', 'es', 'al', 'lo', 'no', 'si', 'paciente', 'refiere', 'presenta', 'acude', 'dolor', 'diagnostico', 'tratamiento', 'nota', 'clinica', 'soap'];

    consultations.forEach(c => {
        if (!c.summary) return;
        const words = c.summary.toLowerCase()
            .replace(/[.,/#!$%^&*;:{}=\-_`~()]/g, "")
            .split(/\s+/);

        words.forEach(word => {
            if (word.length > 3 && !stopWords.includes(word)) {
                wordMap[word] = (wordMap[word] || 0) + 1;
                totalValidWords++;
            }
        });
    });

    return Object.keys(wordMap)
        .map(key => ({
            topic: key.charAt(0).toUpperCase() + key.slice(1),
            count: wordMap[key],
            percentage: Math.round((wordMap[key] / totalValidWords) * 100) * 5
        }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 4);
  },

  // =================================================================
  // 3. ACTIVIDAD SEMANAL (PLAN A: LÃ“GICA NATIVA DE TEXTO + ANCLAJE)
  // =================================================================
  async getWeeklyActivity(): Promise<WeeklyStats> {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return emptyStats();

        // 1. Traemos las Ãºltimas 100 consultas (Datos Crudos)
        // Pedimos muchas para encontrar tus datos de Diciembre 2025
        const { data, error } = await supabase
            .from('consultations')
            .select('created_at')
            .eq('doctor_id', user.id)
            .neq('status', 'cancelled')
            .order('created_at', { ascending: false })
            .limit(100);

        if (error || !data || data.length === 0) return emptyStats();

        // 2. DEFINIR EL "HOY" DE LA GRÃFICA
        // En lugar de usar la fecha de la computadora, usamos la fecha del ÃšLTIMO DATO encontrado.
        // Si tu Ãºltimo paciente fue el 9 de Dic 2025, la grÃ¡fica terminarÃ¡ el 9 de Dic 2025.
        const anchorDate = new Date(data[0].created_at); // Fecha del registro mÃ¡s reciente

        const counts = [0, 0, 0, 0, 0, 0, 0];
        const labels = [];

        // 3. Loop de 7 dÃ­as hacia atrÃ¡s desde la fecha ancla
        for (let i = 6; i >= 0; i--) {
            const d = new Date(anchorDate);
            d.setDate(anchorDate.getDate() - i);
            
            // Etiqueta visual: "LUN", "MAR"
            const dayName = format(d, 'eeeee', { locale: es }).toUpperCase();
            labels.push(dayName);

            // CLAVE DEL PLAN A: Convertimos a string "YYYY-MM-DD" local
            // Esto evita cualquier error de hora o zona horaria. Coincidencia exacta.
            // Usamos 'sv' (Suecia) porque da formato ISO yyyy-mm-dd estÃ¡ndar
            const targetDateString = d.toLocaleDateString('sv'); 

            // Filtramos contando coincidencias de texto
            const count = data.filter(item => {
                const itemDateString = new Date(item.created_at).toLocaleDateString('sv');
                return itemDateString === targetDateString;
            }).length;

            counts[6 - i] = count; 
        }

        // 4. Calcular Alturas
        const maxVal = Math.max(...counts, 1);
        const values = counts.map(c => Math.round((c / maxVal) * 100));

        return {
            labels,
            values,
            rawCounts: counts,
            growth: 0 
        };

    } catch (e) {
        console.error("Error en WeeklyActivity:", e);
        return emptyStats();
    }
  }
};

// Helper seguro para retornar vacÃ­o sin romper la app
const emptyStats = (): WeeklyStats => ({
  labels: ['L', 'M', 'M', 'J', 'V', 'S', 'D'],
  values: [0,0,0,0,0,0,0],
  rawCounts: [0,0,0,0,0,0,0], 
  growth: 0 
});

--------------------------------------------------
ðŸ“ PATH: src\services\AppointmentService.ts
--------------------------------------------------
import { supabase } from '../lib/supabase';
import { Appointment } from '../types';

export const AppointmentService = {
  
  // Obtener citas
  async getAppointments(): Promise<Appointment[]> {
    const { data, error } = await supabase
      .from('appointments')
      .select(`
        *,
        patient:patients(name)
      `)
      .order('start_time', { ascending: true });

    if (error) throw error;
    return data || [];
  },

  // Crear nueva cita (CORREGIDO: Inyecta doctor_id explÃ­citamente)
  async createAppointment(appointment: Partial<Appointment>): Promise<Appointment> {
    // 1. Obtener el usuario actual
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Usuario no autenticado");

    // 2. Insertar asegurando el doctor_id
    const { data, error } = await supabase
      .from('appointments')
      .insert([{ 
        ...appointment, 
        doctor_id: user.id 
      }])
      .select()
      .single();

    if (error) {
      console.error("Error Supabase:", error);
      throw error;
    }
    return data;
  },

  // Actualizar cita
  async updateAppointment(id: string, updates: Partial<Appointment>): Promise<void> {
    const { error } = await supabase
      .from('appointments')
      .update(updates)
      .eq('id', id);

    if (error) throw error;
  },

  // Eliminar cita
  async deleteAppointment(id: string): Promise<void> {
    const { error } = await supabase
      .from('appointments')
      .delete()
      .eq('id', id);

    if (error) throw error;
  },

  // --- NUEVO: CIERRE DE CICLO AUTOMÃTICO ---
  // Busca si el paciente tiene cita hoy y la marca como completada
  async markAppointmentAsCompleted(patientId: string): Promise<void> {
    try {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date();
        todayEnd.setHours(23, 59, 59, 999);

        // 1. Buscar cita ABIERTA de HOY para este paciente
        const { data, error } = await supabase
            .from('appointments')
            .select('id')
            .eq('patient_id', patientId)
            .eq('status', 'scheduled') // Solo las pendientes
            .gte('start_time', todayStart.toISOString())
            .lte('start_time', todayEnd.toISOString())
            .limit(1);

        if (error) throw error;

        // 2. Si existe, ciÃ©rrala
        if (data && data.length > 0) {
            const appointmentId = data[0].id;
            await this.updateAppointment(appointmentId, { status: 'completed' });
            console.log(`âœ… Cierre de ciclo: Cita ${appointmentId} completada automÃ¡ticamente.`);
        }
    } catch (e) {
        console.warn("No se pudo autocompletar la cita en agenda (No crÃ­tico).", e);
    }
  }
};

--------------------------------------------------
ðŸ“ PATH: src\services\AssistantService.ts
--------------------------------------------------
import { geminiAgent, AgentResponse } from './GeminiAgent';

/**
 * SERVICIO PÃšBLICO:
 * La UI llama a este servicio. Este servicio llama al Agente.
 */
export const AssistantService = {
  
  async processCommand(transcript: string): Promise<AgentResponse> {
    // Validaciones bÃ¡sicas antes de gastar tokens de IA
    if (!transcript || transcript.trim().length < 2) {
      return {
        intent: 'UNKNOWN',
        originalText: transcript,
        confidence: 0,
        message: "No escuchÃ© nada."
      };
    }

    // Delegamos la inteligencia al Agente Central
    return await geminiAgent.processCommand(transcript);
  }
};

--------------------------------------------------
ðŸ“ PATH: src\services\GeminiAgent.ts
--------------------------------------------------
import { GoogleGenerativeAI } from "@google/generative-ai";

const API_KEY = import.meta.env.VITE_GEMINI_API_KEY || "";

// TIPOS EXPANDIDOS (V4.0)
export type AgentIntent = 'CREATE_APPOINTMENT' | 'MEDICAL_QUERY' | 'NAVIGATION' | 'PATIENT_SEARCH' | 'UNKNOWN';

export interface AgentResponse {
  intent: AgentIntent;
  data?: any; // Puede ser datos de cita, respuesta mÃ©dica, o destino de navegaciÃ³n
  originalText: string;
  confidence: number;
  message?: string; // Mensaje amigable para el UI
}

class GeminiAgentService {
  
  // TU ESTRATEGIA RADAR (INTEGRADA Y MEJORADA)
  private async getBestModel(): Promise<string> {
    try {
      // 1. Intentamos listar modelos
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
      if (!response.ok) return "gemini-1.5-flash"; // Fallback moderno por defecto
      
      const data = await response.json();
      const models = data.models || [];

      // 2. Prioridad: Flash (Velocidad para voz)
      const flashModel = models.find((m: any) => m.name.includes("flash"));
      if (flashModel) return flashModel.name.replace('models/', '');

      // 3. Fallback: Pro (Potencia)
      const proModel = models.find((m: any) => m.name.includes("pro"));
      if (proModel) return proModel.name.replace('models/', '');

      return "gemini-pro";
    } catch (e) {
      console.warn("Radar fallÃ³, usando fallback seguro.");
      return "gemini-1.5-flash";
    }
  }

  /**
   * PROCESO CENTRAL DE INTELIGENCIA
   */
  async processCommand(text: string): Promise<AgentResponse> {
    if (!API_KEY) throw new Error("Falta API Key de Gemini");

    try {
      // 1. Radar: Elegir el mejor cerebro
      const modelName = await this.getBestModel();
      console.log(`ðŸ§  Cerebro activo: ${modelName}`);

      const genAI = new GoogleGenerativeAI(API_KEY);
      const model = genAI.getGenerativeModel({ 
        model: modelName,
        generationConfig: { responseMimeType: "application/json" } 
      });

      // 2. Contexto Temporal (Vital para citas)
      const now = new Date();
      const contextDate = now.toLocaleString('es-MX', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
        hour: '2-digit', minute: '2-digit', hour12: false 
      });

      // 3. Prompt de IngenierÃ­a (Router de Intenciones V4.0)
      const prompt = `
        ACTÃšA COMO: Asistente ClÃ­nico y Router de Intenciones.
        FECHA ACTUAL: ${contextDate} (ISO: ${now.toISOString()})

        TU TAREA: Analizar el comando de voz y clasificarlo en una de 4 categorÃ­as.

        1. "CREATE_APPOINTMENT": El usuario quiere agendar.
           - Extrae: patientName, title, start_time (ISO), duration_minutes.
           - Regla: Si no dice hora, usa 09:00 AM. Si dice "maÃ±ana", suma 1 dÃ­a.

        2. "MEDICAL_QUERY": Pregunta clÃ­nica, dosis, interacciÃ³n o duda mÃ©dica.
           - Extrae: query (la pregunta limpia).
           - Genera: "answer" (Una respuesta BREVE y profesional de mÃ¡ximo 2 oraciones).

        3. "NAVIGATION": Quiere ir a una pantalla (Pacientes, Agenda, Dashboard, ConfiguraciÃ³n).
           - Extrae: destination (dashboard | agenda | patients | settings).

        4. "PATIENT_SEARCH": Quiere buscar datos de un paciente.
           - Extrae: patientName.

        INPUT DEL MÃ‰DICO: "${text}"

        RESPONDE SOLO JSON:
        {
          "intent": "CREATE_APPOINTMENT" | "MEDICAL_QUERY" | "NAVIGATION" | "PATIENT_SEARCH" | "UNKNOWN",
          "data": { ... },
          "confidence": 0.9,
          "message": "Texto corto confirmando la acciÃ³n o la respuesta mÃ©dica"
        }
      `;

      const result = await model.generateContent(prompt);
      const response = await result.response;
      const jsonText = response.text();
      
      // 4. Parsing Seguro
      const parsed = JSON.parse(jsonText) as AgentResponse;
      
      // Inyectamos el texto original por si acaso
      parsed.originalText = text;

      return parsed;

    } catch (error) {
      console.error("Error en GeminiAgent:", error);
      return {
        intent: 'UNKNOWN',
        originalText: text,
        confidence: 0,
        message: "No pude conectar con el servidor de IA."
      };
    }
  }
}

export const geminiAgent = new GeminiAgentService();

--------------------------------------------------
ðŸ“ PATH: src\services\GeminiMedicalService.ts
--------------------------------------------------
import { GoogleGenerativeAI } from "@google/generative-ai";
// Importamos interfaces locales para evitar errores de compilaciÃ³n
import { GeminiResponse, PatientInsight, MedicationItem, FollowUpMessage } from '../types';

console.log("ðŸš€ V-ULTIMATE: MODO PRO (FacturaciÃ³n + Inteligencia Completa + Hybrid Retrieval)");

// ==========================================
// 1. CONFIGURACIÃ“N ROBUSTA
// ==========================================
const API_KEY = import.meta.env.VITE_GEMINI_API_KEY || import.meta.env.VITE_GOOGLE_GENAI_API_KEY || "";

if (!API_KEY) console.error("â›” FATAL: API Key no encontrada. Revisa tu archivo .env");

// LISTA DE COMBATE (Failover System)
const MODELS_TO_TRY = [
  "gemini-1.5-flash-002",    // 1. La versiÃ³n mÃ¡s inteligente y actual (Prioridad)
  "gemini-1.5-flash",        // 2. La versiÃ³n estÃ¡ndar estable
  "gemini-1.5-pro",          // 3. Respaldo de alta potencia
  "gemini-2.0-flash-exp"     // 4. Ãšltimo recurso
];

// ==========================================
// 2. UTILIDADES DE INTELIGENCIA
// ==========================================

const cleanJSON = (text: string) => {
  let clean = text.replace(/```json/g, '').replace(/```/g, '');
  const firstCurly = clean.indexOf('{');
  const lastCurly = clean.lastIndexOf('}');
  if (firstCurly !== -1 && lastCurly !== -1) {
    clean = clean.substring(firstCurly, lastCurly + 1);
  }
  return clean.trim();
};

/**
 * MOTOR DE CONEXIÃ“N BLINDADO (FAILOVER)
 */
async function generateWithFailover(prompt: string, jsonMode: boolean = false): Promise<string> {
  const genAI = new GoogleGenerativeAI(API_KEY);
  let lastError: any = null;

  for (const modelName of MODELS_TO_TRY) {
    try {
      const model = genAI.getGenerativeModel({ 
        model: modelName,
        generationConfig: jsonMode ? { responseMimeType: "application/json" } : undefined
      });
      
      const result = await model.generateContent(prompt);
      const text = result.response.text();

      if (text) return text; // Â¡Ã‰xito!
    } catch (error: any) {
      console.warn(`âš ï¸ Modelo ${modelName} fallÃ³/ocupado. Cambiando al siguiente...`);
      lastError = error;
      continue; 
    }
  }
  throw lastError || new Error("Todos los modelos de IA fallaron. Verifica tu conexiÃ³n.");
}

/**
 * MOTOR DE PERFILES (PERSONALIDAD CLÃNICA)
 */
const getSpecialtyPromptConfig = (specialty: string) => {
  const configs: Record<string, any> = {
    "CardiologÃ­a": {
      role: "CardiÃ³logo Intervencionista",
      focus: "Hemodinamia, ritmo, presiÃ³n arterial, perfusiÃ³n, soplos y riesgo cardiovascular.",
      bias: "Prioriza el impacto hemodinÃ¡mico. Traduce sÃ­ntomas vagos a equivalentes cardiolÃ³gicos."
    },
    "TraumatologÃ­a y Ortopedia": {
      role: "Cirujano Ortopedista",
      focus: "Sistema musculoesquelÃ©tico, arcos de movilidad, estabilidad, fuerza y marcha.",
      bias: "Describe la biomecÃ¡nica de la lesiÃ³n."
    },
    "DermatologÃ­a": {
      role: "DermatÃ³logo",
      focus: "MorfologÃ­a de lesiones cutÃ¡neas (tipo, color, bordes), anejos y mucosas.",
      bias: "Usa terminologÃ­a dermatolÃ³gica precisa."
    },
    "PediatrÃ­a": {
      role: "Pediatra",
      focus: "Desarrollo, crecimiento, hitos, alimentaciÃ³n y vacunaciÃ³n.",
      bias: "EvalÃºa todo en contexto de la edad. Usa tono adecuado para padres."
    },
    "GinecologÃ­a y Obstetricia": {
      role: "GinecÃ³logo Obstetra",
      focus: "Salud reproductiva, ciclo menstrual, embarazo, vitalidad fetal.",
      bias: "Enfoque en bienestar materno-fetal."
    },
    "Medicina General": {
      role: "MÃ©dico de Familia",
      focus: "VisiÃ³n integral, semiologÃ­a general y referencia oportuna.",
      bias: "Enfoque holÃ­stico y preventivo."
    },
    "Urgencias MÃ©dicas": {
        role: "UrgenciÃ³logo Senior",
        focus: "ABCDE, estabilizaciÃ³n. CRÃTICO: Detectar errores fatales antes de tratar.",
        bias: "Primero NO hacer daÃ±o (Primum non nocere). Verifica contraindicaciones antes de recetar."
    }
  };

  return configs[specialty] || {
    role: `Especialista en ${specialty}`,
    focus: `PatologÃ­as y terminologÃ­a de ${specialty}.`,
    bias: `Criterios clÃ­nicos estÃ¡ndar de ${specialty}.`
  };
};

// ==========================================
// 3. SERVICIO PRINCIPAL
// ==========================================
export const GeminiMedicalService = {

  // --- A. NOTA CLÃNICA (V5.4 - PROTOCOLO OBSTETRA BLINDADO) ---
  async generateClinicalNote(transcript: string, specialty: string = "Medicina General", patientHistory: string = ""): Promise<GeminiResponse> {
    try {
      const now = new Date();
      const profile = getSpecialtyPromptConfig(specialty);

      // Prompt Reforzado v5.4
      const prompt = `
        ROL: Eres "MediScribe AI", Auditor de Seguridad ClÃ­nica en Tiempo Real.
        ESPECIALIDAD: ${profile.role}.
        ENFOQUE: ${profile.focus}
        
        ðŸ”¥ðŸ”¥ FASE 1: EXTRACCIÃ“N DE DATOS ðŸ”¥ðŸ”¥
        1. Identifica al MÃ©dico y al Paciente (DiarizaciÃ³n).
        2. Extrae ANAMNESIS DE LA TRANSCRIPCIÃ“N: Â¿QuÃ© medicamentos o condiciones menciona el paciente?
           - *Nota:* Si el paciente dice "tomÃ© X ayer/anoche", asume que estÃ¡ ACTIVO en su sistema.

        ðŸ’€ðŸ’€ FASE 2: PROTOCOLO DE CONTEXTO CRÃTICO Y BLOQUEO FARMACOLÃ“GICO ðŸ’€ðŸ’€
        Tu deber es detectar dos tipos de riesgo: Urgencia Vital (Grim Reaper) y DaÃ±o Irreversible Fetal (OBSTETRA).

        A. ðŸš¨ REGLA DE EMBARAZO ACTIVO (TERATOGENICIDAD):
        - Si la transcripciÃ³n menciona "embarazo", "bebÃ©", "feto" o "semanas de gestaciÃ³n", ESTE CONTEXTO ES MÃXIMA PRIORIDAD.
        - ANÃLISIS DE RIESGO TERATOGÃ‰NICO (MÃXIMO):
          - SI se menciona **Warfarina** o **Enalapril** (IECA), u otro fÃ¡rmaco de CategorÃ­a X/D...
          - ...Y la paciente estÃ¡ embarazada...
          - > ESTO ES RIESGO MORTAL FETAL IRREVERSIBLE.
        - 'risk_analysis.level' DEBE SER "Alto" (OBLIGATORIO) por encima del diagnÃ³stico materno.

        B. ðŸš¨ REGLA DE INTERACCIÃ“N FARMACOLÃ“GICA (Grim Reaper):
        - REGLA DE LAS 48 HORAS: Sildenafil/Tadalafil + Nitratos (Isosorbide/Nitroglicerina) = PELIGRO MORTAL.
        
        SI HAY BLOQUEO ACTIVO (PUNTO A o B):
        1. ðŸ›‘ El 'risk_analysis.level' es "Alto" y la 'reason' explica la contraindicaciÃ³n absoluta.
        2. ðŸ›‘ BLOQUEO DE INSTRUCCIONES: En 'patientInstructions', TIENES PROHIBIDO escribir la orden del mÃ©dico de tomar el medicamento peligroso.
           - DEBES escribir: "âš ï¸ ALERTA DE SEGURIDAD MÃXIMA: El sistema ha bloqueado la administraciÃ³n de [FÃ¡rmacos de Riesgo] por riesgo de muerte/teratogenicidad. NO ADMINISTRAR."

        ðŸ”¥ðŸ”¥ FASE 3: GENERACIÃ“N ESTRUCTURADA ðŸ”¥ðŸ”¥
        Asegura que el 'plan' en SOAP refleje la acciÃ³n de seguridad si el bloqueo se activa.

        DATOS DE ENTRADA:
        - Historial Previo: "${patientHistory || "Sin datos"}"
        - TranscripciÃ³n Actual: "${transcript.replace(/"/g, "'").trim()}"

        GENERA JSON EXACTO (GeminiResponse):
        {
          "clinicalNote": "Resumen narrativo...",
          "soap": {
            "subjective": "Incluye OBLIGATORIAMENTE el contexto de embarazo y los medicamentos mencionados...",
            "objective": "Hallazgos...",
            "assessment": "DiagnÃ³stico...",
            "plan": "Pasos a seguir (Suspender fÃ¡rmacos prohibidos si aplica)...",
            "suggestions": ["Sugerencia 1"]
          },
          "patientInstructions": "Instrucciones SEGURAS (Filtradas por Protocolo de Bloqueo)...",
          "risk_analysis": {
            "level": "Bajo" | "Medio" | "Alto",
            "reason": "Si hay bloqueo, describe el peligro absoluto aquÃ­."
          },
          "actionItems": {
             "urgent_referral": boolean,
             "lab_tests_required": ["..."]
          },
          "conversation_log": [
             { "speaker": "MÃ©dico", "text": "..." },
             { "speaker": "Paciente", "text": "..." }
          ]
        }
      `;

      const rawText = await generateWithFailover(prompt, true);
      return JSON.parse(cleanJSON(rawText)) as GeminiResponse;

    } catch (error) {
      console.error("âŒ Error Nota ClÃ­nica:", error);
      throw error;
    }
  },

  // --- B. BALANCE 360 ---
  async generatePatient360Analysis(patientName: string, historySummary: string, consultations: string[]): Promise<PatientInsight> {
    try {
      const contextText = consultations.length > 0 
          ? consultations.join("\n\n--- CONSULTA PREVIA ---\n\n") 
          : "Sin historial previo.";

      const prompt = `
          ACTÃšA COMO: Auditor MÃ©dico Senior.
          PACIENTE: "${patientName}".
          HISTORIAL: ${historySummary || "No registrado"}
          CONSULTAS: ${contextText}

          SALIDA JSON (PatientInsight):
          {
            "evolution": "Resumen...",
            "medication_audit": "Busca duplicidades o interacciones...",
            "risk_flags": ["Riesgo 1"],
            "pending_actions": ["AcciÃ³n 1"]
          }
      `;

      const rawText = await generateWithFailover(prompt, true);
      return JSON.parse(cleanJSON(rawText));
    } catch (e) {
      return { evolution: "No disponible", medication_audit: "", risk_flags: [], pending_actions: [] };
    }
  },

  // --- C. EXTRACCIÃ“N MEDICAMENTOS ---
  async extractMedications(text: string): Promise<MedicationItem[]> {
    if (!text) return [];
    try {
      const prompt = `
        ACTÃšA COMO: FarmacÃ©utico. Extrae medicamentos del texto: "${text.replace(/"/g, "'")}".
        SALIDA JSON ARRAY (MedicationItem[]):
        [{ "drug": "...", "details": "...", "frequency": "...", "duration": "...", "notes": "..." }]
      `;
      const rawText = await generateWithFailover(prompt, true);
      const res = JSON.parse(cleanJSON(rawText));
      return Array.isArray(res) ? res : [];
    } catch (e) { return []; }
  },

  // --- D. AUDITORÃA CALIDAD ---
  async generateClinicalNoteAudit(noteContent: string): Promise<any> {
    try {
      const prompt = `
        ACTÃšA COMO: Auditor de Calidad. EvalÃºa nota: "${noteContent}".
        SALIDA JSON: { "riskLevel": "...", "score": 85, "analysis": "...", "recommendations": ["..."] }
      `;
      const rawText = await generateWithFailover(prompt, true);
      return JSON.parse(cleanJSON(rawText));
    } catch (e) { return { riskLevel: "Medio", score: 0, analysis: "", recommendations: [] }; }
  },

  // --- E. WHATSAPP ---
  async generateFollowUpPlan(patientName: string, clinicalNote: string, instructions: string): Promise<FollowUpMessage[]> {
    try {
      const prompt = `
        ACTÃšA COMO: Asistente. Redacta 3 mensajes WhatsApp para ${patientName}.
        Contexto: "${clinicalNote}". Instrucciones: "${instructions}".
        SALIDA JSON ARRAY: [{ "day": 1, "message": "..." }, { "day": 3, "message": "..." }, { "day": 7, "message": "..." }]
      `;
      const rawText = await generateWithFailover(prompt, true);
      const res = JSON.parse(cleanJSON(rawText));
      return Array.isArray(res) ? res : [];
    } catch (e) { return []; }
  },

  // --- F. CHAT ---
  async chatWithContext(context: string, userMessage: string): Promise<string> {
    try {
       const prompt = `CONTEXTO: ${context}. PREGUNTA: ${userMessage}. RESPUESTA CORTA:`;
       return await generateWithFailover(prompt, false);
    } catch (e) { return "Error conexiÃ³n."; }
  },

  // --- HELPERS ---
  async generatePatientInsights(p: string, h: string, c: string[]): Promise<any> { return this.generatePatient360Analysis(p, h, c); },
  async generateQuickRxJSON(t: string, p: string): Promise<MedicationItem[]> { return this.extractMedications(t); },
  async generatePrescriptionOnly(t: string): Promise<string> { return "Use extractMedications."; }
};

--------------------------------------------------
ðŸ“ PATH: src\services\MedicalDataService.ts
--------------------------------------------------
import { supabase } from '../lib/supabase';
import { Patient, Consultation } from '../types';

export class MedicalDataService {
  
  // --- PACIENTES (CRM) ---

  static async searchPatients(query: string): Promise<Patient[]> {
    if (!query || query.length < 2) return [];
    const { data, error } = await supabase.from('patients').select('*').ilike('name', `%${query}%`).limit(5);
    if (error) return [];
    return data || [];
  }

  static async getPatients(): Promise<Patient[]> {
    const { data, error } = await supabase.from('patients').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    return data || [];
  }

  static async createPatient(patient: Omit<Patient, 'id' | 'created_at' | 'doctor_id'>): Promise<Patient> {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("No hay sesiÃ³n activa.");
    const { data, error } = await supabase.from('patients').insert([{ ...patient, doctor_id: session.user.id }]).select().single();
    if (error) throw error;
    return data;
  }

  static async deletePatient(id: string): Promise<void> {
    const { error } = await supabase.from('patients').delete().eq('id', id);
    if (error) throw error;
  }

  // --- CONSULTAS ---

  static async createConsultation(consultation: Omit<Consultation, 'id' | 'created_at' | 'doctor_id'>): Promise<Consultation> {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("No hay sesiÃ³n activa.");
    const { data, error } = await supabase.from('consultations').insert([{ ...consultation, doctor_id: session.user.id }]).select().single();
    if (error) throw new Error(error.message);
    return data;
  }

  // --- NUEVO: EXPORTACIÃ“N CSV (SOBERANÃA DE DATOS) ---
  static async downloadFullBackup(): Promise<boolean> {
    try {
      // 1. Bajar pacientes
      const { data: patients, error: errPat } = await supabase.from('patients').select('*');
      if (errPat) throw errPat;
      if (!patients || patients.length === 0) return false;

      // 2. Bajar consultas
      const { data: consultations, error: errCons } = await supabase.from('consultations').select('*');
      if (errCons) throw errCons;

      // 3. Construir CSV
      let csv = "\uFEFF"; // BOM para Excel en espaÃ±ol
      csv += "ID_Paciente,Nombre,Edad,Genero,Telefono,Email,Fecha_Registro,ID_Consulta,Fecha_Consulta,Resumen_Consulta,Transcripcion\n";

      patients.forEach(p => {
        const pConsults = consultations?.filter(c => c.patient_id === p.id) || [];
        
        if (pConsults.length === 0) {
             csv += `"${p.id}","${p.name}",${p.age},"${p.gender}","${p.phone||''}","${p.email||''}","${p.created_at}","N/A","N/A","N/A","N/A"\n`;
        } else {
             pConsults.forEach(c => {
                 const cleanSum = c.summary ? c.summary.replace(/(\r\n|\n|\r)/gm, " | ").replace(/"/g, '""') : "";
                 const cleanTran = c.transcript ? c.transcript.replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""') : "";
                 csv += `"${p.id}","${p.name}",${p.age},"${p.gender}","${p.phone||''}","${p.email||''}","${p.created_at}","${c.id}","${c.created_at}","${cleanSum}","${cleanTran}"\n`;
             });
        }
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `MediScribe_Backup_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return true;
    } catch (e) {
      console.error("Error backup:", e);
      throw e;
    }
  }
}

--------------------------------------------------
ðŸ“ PATH: src\services\PatientService.ts
--------------------------------------------------
import { supabase } from '../lib/supabase';
import { Patient } from '../types';

export const PatientService = {
  /**
   * Busca pacientes por nombre (bÃºsqueda parcial)
   */
  async searchPatients(term: string): Promise<Patient[]> {
    if (!term) return [];
    
    const { data, error } = await supabase
      .from('patients')
      .select('*')
      .ilike('name', `%${term}%`)
      .limit(5);

    if (error) {
      console.error('Error buscando pacientes:', error);
      return [];
    }
    return data || [];
  },

  /**
   * Crea un paciente nuevo rÃ¡pidamente solo con el nombre.
   * Supabase genera el UUID automÃ¡ticamente.
   */
  async createQuickPatient(name: string): Promise<Patient | null> {
    const { data, error } = await supabase
      .from('patients')
      .insert([{ name: name }]) // Asumiendo que tu tabla permite nulls en otros campos o tiene defaults
      .select()
      .single();

    if (error) {
      console.error('Error creando paciente:', error);
      throw error;
    }
    return data;
  },

  async getPatientById(id: string): Promise<Patient | null> {
    const { data, error } = await supabase
      .from('patients')
      .select('*')
      .eq('id', id)
      .single();
      
    if (error) return null;
    return data;
  }
};

--------------------------------------------------
ðŸ“ PATH: src\services\StorageService.ts
--------------------------------------------------
import { supabase } from '../lib/supabase';
import { PatientAttachment } from '../types';

export const StorageService = {
  
  // 1. Obtener lista de archivos de un paciente
  async getAttachments(patientId: string): Promise<PatientAttachment[]> {
    const { data, error } = await supabase
      .from('patient_attachments')
      .select('*')
      .eq('patient_id', patientId)
      .order('created_at', { ascending: false });

    if (error) throw error;
    return data || [];
  },

  // 2. Subir archivo (Storage + DB)
  async uploadAttachment(patientId: string, file: File): Promise<void> {
    const user = await supabase.auth.getUser();
    const userId = user.data.user?.id;
    if (!userId) throw new Error("Usuario no autenticado");

    // a. Generar ruta Ãºnica: userId/patientId/timestamp_nombre
    const cleanName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
    const filePath = `${userId}/${patientId}/${Date.now()}_${cleanName}`;

    // b. Subir al Bucket Privado
    const { error: uploadError } = await supabase.storage
      .from('patient-secure-docs')
      .upload(filePath, file);

    if (uploadError) throw uploadError;

    // c. Registrar en la Base de Datos
    const { error: dbError } = await supabase
      .from('patient_attachments')
      .insert({
        patient_id: patientId,
        name: file.name,
        file_path: filePath,
        file_type: file.type,
        size_bytes: file.size,
        doctor_id: userId
      });

    if (dbError) {
      // Si falla la DB, intentamos limpiar el archivo huÃ©rfano (best effort)
      await supabase.storage.from('patient-secure-docs').remove([filePath]);
      throw dbError;
    }
  },

  // 3. Obtener URL temporal para visualizar (obligatorio para buckets privados)
  async getSignedUrl(filePath: string): Promise<string | null> {
    const { data, error } = await supabase.storage
      .from('patient-secure-docs')
      .createSignedUrl(filePath, 3600); // VÃ¡lido por 1 hora

    if (error) {
      console.error("Error obteniendo URL firmada:", error);
      return null;
    }
    return data.signedUrl;
  },

  // 4. Eliminar archivo
  async deleteAttachment(id: string, filePath: string): Promise<void> {
    // a. Borrar de Storage
    const { error: storageError } = await supabase.storage
      .from('patient-secure-docs')
      .remove([filePath]);

    if (storageError) throw storageError;

    // b. Borrar de Base de Datos
    const { error: dbError } = await supabase
      .from('patient_attachments')
      .delete()
      .eq('id', id);

    if (dbError) throw dbError;
  }
};

--------------------------------------------------
ðŸ“ PATH: src\services\supabaseService.ts
--------------------------------------------------
import { createClient, SupabaseClient, User } from '@supabase/supabase-js';
import { DatabaseRecord, Patient } from '../types';

/**
 * SECURITY ARCHITECTURE (RLS - Row Level Security)
 * The database ensures via SQL Policies that 'auth.uid()' matches the 'user_id' column.
 */

// CORRECCIÃ“N: Usamos las variables VITE para que Netlify las lea bien
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || '';
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY || '';

export class MedicalDataService {
  public supabase: SupabaseClient | null = null;

  constructor() {
    if (supabaseUrl && supabaseAnonKey) {
      this.supabase = createClient(supabaseUrl, supabaseAnonKey);
    } else {
      console.warn("Supabase credentials missing. Storage will be local-only.");
    }
  }

  // --- AUTHENTICATION METHODS ---

  async signUp(email: string, pass: string) {
    if (!this.supabase) return { error: { message: 'No database connection' } };
    return await this.supabase.auth.signUp({ email, password: pass });
  }

  async signIn(email: string, pass: string) {
    if (!this.supabase) return { error: { message: 'No database connection' } };
    return await this.supabase.auth.signInWithPassword({ email, password: pass });
  }

  async signOut() {
    if (!this.supabase) return;
    return await this.supabase.auth.signOut();
  }

  async getCurrentUser(): Promise<User | null> {
    if (!this.supabase) return null;
    const { data } = await this.supabase.auth.getUser();
    return data.user;
  }

  // --- DATA METHODS (RLS Protected) ---

  async getPatients(): Promise<Patient[]> {
    if (!this.supabase) return [];
    
    // RLS Policy: "MÃ©dicos ven solo sus pacientes" automatically filters this query
    const { data, error } = await this.supabase
      .from('patients')
      .select('*')
      .order('name');
      
    if (error) {
      console.error("Error fetching patients:", error);
      return [];
    }
    
    // Map DB columns to Frontend types if necessary (snake_case to camelCase)
    return data.map((p: any) => ({
      id: p.id,
      name: p.name,
      phone: p.phone,
      lastVisit: new Date(p.last_visit).toLocaleDateString(), // Convert timestamp
      condition: p.condition,
      avatarUrl: p.avatar_url || `https://ui-avatars.com/api/?name=${p.name}&background=random`
    }));
  }

  async createPatient(patientData: Omit<Patient, 'id' | 'lastVisit'>) {
    if (!this.supabase) return { error: 'No DB' };
    
    const { data: { user } } = await this.supabase.auth.getUser();
    if (!user) return { error: 'Not authenticated' };

    const { data, error } = await this.supabase
      .from('patients')
      .insert({
        user_id: user.id, // REQUIRED for RLS Insert Policy
        name: patientData.name,
        phone: patientData.phone,
        condition: patientData.condition,
        avatar_url: patientData.avatarUrl,
        last_visit: new Date().toISOString()
      })
      .select()
      .single();

    return { data, error };
  }

  async saveConsultation(record: DatabaseRecord): Promise<{ success: boolean; error?: string }> {
    if (!this.supabase) return { success: false, error: "Database not configured" };

    const { data: { user } } = await this.supabase.auth.getUser();
    if (!user) return { success: false, error: "User not authenticated" };

    const { error } = await this.supabase
      .from('consultations')
      .insert({
        user_id: user.id,
        patient_id: record.patientId, // Ensure this UUID exists in 'patients' table
        soap_data: record.soapData,
        transcript_summary: record.summary,
        encrypted_key_ref: record.encryptedKeyRef,
        created_at: new Date().toISOString()
      });

    if (error) {
      console.error("RLS Error:", error);
      return { success: false, error: error.message };
    }

    return { success: true };
  }
}


--------------------------------------------------
ðŸ“ PATH: src\types.ts
--------------------------------------------------
// --- PERFILES DE USUARIO ---
export interface DoctorProfile {
  id: string;
  full_name: string | null;
  specialty: string | null;
  license_number: string | null;
  phone: string | null;
  university: string | null;
  address: string | null;
  logo_url: string | null;
  signature_url: string | null;
  website_url?: string | null;
  updated_at: string | null;
}

// --- PACIENTES ---
export interface Patient {
  id: string;
  created_at: string;
  name: string;
  doctor_id: string;
  age?: number;
  gender?: string;
  phone?: string;
  email?: string;
  history?: string; // JSON Stringified con antecedentes
}

// --- CONSULTAS E HISTORIAL ---
export interface Consultation {
  id: string;
  created_at: string;
  doctor_id: string;
  patient_id: string;
  transcript: string;
  summary: string;
  status: 'pending' | 'completed' | 'archived';
}

// --- MEDICAMENTOS (RECETA) ---
export interface MedicationItem {
  id?: string;
  drug: string;
  details: string;
  frequency: string;
  duration: string;
  notes: string;
}

// --- ESTRUCTURA SOAP (V4) ---
export interface SOAPHeaders {
    date: string;
    time: string;
    patientName?: string;
    patientAge?: string;
    patientGender?: string;
}

export interface SOAPData {
    headers: SOAPHeaders;
    subjective: string;
    objective: string;
    analysis: string;
    plan: string;
}

// --- RESPUESTA IA GENERAL ---
export interface GeminiResponse {
  clinicalNote: string; 
  soapData?: SOAPData; 
  patientInstructions: string;
  actionItems?: {
    next_appointment?: string | null;
    urgent_referral?: boolean;
    lab_tests_required?: string[];
  };
}

// --- NUEVO: BALANCE CLÃNICO (INSIGHTS) ---
export interface PatientInsight {
    evolution: string;       // Resumen cronolÃ³gico
    medication_audit: string; // QuÃ© ha tomado y quÃ© funcionÃ³
    risk_flags: string[];    // Alertas rojas
    pending_actions: string[]; // Cosas que se quedaron en el aire
}

export interface FollowUpMessage {
  role: 'user' | 'model';
  text: string;
}

export interface Appointment {
  id?: string;
  patient_id: string;
  doctor_id?: string;
  title: string;
  start_time: string;
  end_time?: string;
  duration_minutes?: number;
  status: 'scheduled' | 'completed' | 'cancelled' | 'no_show';
  notes?: string;
  created_at?: string;
}


--------------------------------------------------
ðŸ“ PATH: src\utils\calendarUtils.ts
--------------------------------------------------
// Utilidad para formatear fechas al estÃ¡ndar universal (YYYYMMDDTHHMMSSZ)
const formatToICSDate = (isoString: string): string => {
    if (!isoString) return '';
    const date = new Date(isoString);
    // Formato UTC compactado
    return date.toISOString().replace(/-|:|\.\d\d\d/g, "");
};
  
interface CalendarEvent {
    title: string;
    description?: string;
    startTime: string;
    endTime: string;
    location?: string;
}
  
// 1. Generar URL para Google Calendar
export const generateGoogleCalendarUrl = ({ title, description, startTime, endTime }: CalendarEvent): string => {
    const start = formatToICSDate(startTime);
    const end = formatToICSDate(endTime);
    const details = encodeURIComponent(description || '');
    const text = encodeURIComponent(title);
    
    return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
};
  
// 2. Generar y Descargar archivo .ICS (Apple, Outlook, Samsung)
export const downloadIcsFile = ({ title, description, startTime, endTime }: CalendarEvent, fileName: string = 'cita') => {
    const start = formatToICSDate(startTime);
    const end = formatToICSDate(endTime);
    
    const icsContent = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "BEGIN:VEVENT",
      `DTSTART:${start}`,
      `DTEND:${end}`,
      `SUMMARY:${title}`,
      `DESCRIPTION:${description || ''}`,
      "END:VEVENT",
      "END:VCALENDAR"
    ].join("\n");
  
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.setAttribute('download', `${fileName}.ics`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

--------------------------------------------------
ðŸ“ PATH: src\utils\greetingUtils.ts
--------------------------------------------------
// Interfaces para tipado estricto
export interface GreetingData {
    greeting: string;
    message: string;
}
  
// --- BANCO DE MENSAJES ---
const morningMessages = [
    "Un buen cafÃ© y a cambiar vidas. Â¡Que tengas una excelente jornada!",
    "Tu dedicaciÃ³n marca la diferencia en la salud de tus pacientes.",
    "Revisemos la agenda: hoy es un gran dÃ­a para ser productivos.",
    "La prevenciÃ³n empieza con una buena maÃ±ana. Â¡Ãnimo, Doctor(a)!",
    "Cada consulta es una oportunidad para escuchar y sanar."
];

const afternoonMessages = [
    "Ya pasamos la mitad del dÃ­a. Un respiro y a continuar con energÃ­a.",
    "Tu precisiÃ³n aumenta con la energÃ­a restaurada. MantÃ©n el ritmo.",
    "Excelente momento para revisar notas clÃ­nicas y pendientes.",
    "La tarde avanza, pero tu compromiso sigue intacto.",
    "Recuerda hidratarte entre paciente y paciente."
];

const eveningMessages = [
    "Hora de reflexiÃ³n: Â¿QuÃ© logramos hoy y quÃ© priorizamos para maÃ±ana?",
    "Un dÃ­a productivo termina con el expediente cerrado. Â¡Buen trabajo!",
    "Asegura que todas las notas estÃ©n guardadas. La medicina no descansa, pero tÃº sÃ­ debes hacerlo.",
    "Gracias por tu servicio hoy. El descanso es parte del rendimiento.",
    "Cierra ciclos por hoy. MaÃ±ana serÃ¡ otro dÃ­a de Ã©xitos."
];

// --- FUNCIÃ“N PRINCIPAL ---
export const getTimeOfDayGreeting = (doctorName: string | null): GreetingData => {
    const date = new Date();
    const hour = date.getHours();
    const name = doctorName || "Doctor(a)"; // Fallback si no hay nombre

    let timeOfDay: 'morning' | 'afternoon' | 'evening';
    let greetingTitle = "";
    let messagesArray: string[] = [];

    // 1. Determinar franja horaria
    if (hour >= 5 && hour < 12) {
        timeOfDay = 'morning';
        greetingTitle = `Buenos dÃ­as, ${name}`;
        messagesArray = morningMessages;
    } else if (hour >= 12 && hour < 19) {
        timeOfDay = 'afternoon';
        greetingTitle = `Buenas tardes, ${name}`;
        messagesArray = afternoonMessages;
    } else {
        timeOfDay = 'evening';
        greetingTitle = `Buenas noches, ${name}`;
        messagesArray = eveningMessages;
    }

    // 2. SelecciÃ³n aleatoria (MatemÃ¡tica simple)
    // Usamos el dÃ­a del mes para variar un poco o totalmente random
    const randomIndex = Math.floor(Math.random() * messagesArray.length);
    const selectedMessage = messagesArray[randomIndex];

    return {
        greeting: greetingTitle,
        message: selectedMessage
    };
};

--------------------------------------------------
ðŸ“ PATH: src\vite-env.d.ts
--------------------------------------------------
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_GEMINI_API_KEY: string;
  readonly VITE_SUPABASE_URL: string;
  readonly VITE_SUPABASE_ANON_KEY: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}

--------------------------------------------------
ðŸ“ PATH: supabase\functions\gemini-proxy\index.ts
--------------------------------------------------
// RUTA DEL ARCHIVO: supabase/functions/gemini-proxy/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  // 1. Manejo de CORS (Permite que el frontend llame a esta funciÃ³n)
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    // 2. Obtener datos del Request y la API Key del entorno seguro
    const { action, payload } = await req.json();
    const API_KEY = Deno.env.get("GEMINI_API_KEY");

    if (!API_KEY) {
      throw new Error("CRÃTICO: GEMINI_API_KEY no configurada en Supabase Secrets.");
    }

    // 3. ConfiguraciÃ³n del modelo (Centralizado)
    const MODEL = "gemini-1.5-flash"; 
    const BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;

    let prompt = "";
    let isJsonExpected = false;

    // 4. Selector de Acciones (Switch)
    switch (action) {
      case "generate_clinical_note":
        isJsonExpected = true;
        prompt = `
          ActÃºa como un MÃ©dico Especialista en ${payload.specialty || "Medicina General"}.
          Transforma el siguiente dictado en un JSON estructurado (Nota SOAP).
          
          DICTADO: "${payload.transcript}"

          Responde ÃšNICAMENTE con este JSON vÃ¡lido (sin markdown, sin explicaciones):
          {
            "clinicalNote": "Texto completo de la nota clÃ­nica en formato SOAP. Usa terminologÃ­a tÃ©cnica de ${payload.specialty}.",
            "patientInstructions": "Lista de instrucciones claras para el paciente.",
            "actionItems": {
              "next_appointment": "Fecha sugerida o null",
              "urgent_referral": false,
              "lab_tests_required": ["lista", "de", "tests"]
            }
          }
        `;
        break;

      case "generate_quick_rx":
        prompt = `
          ActÃºa como mÃ©dico. Genera una receta mÃ©dica en TEXTO PLANO (No JSON, No Markdown) para: 
          "${payload.transcript}".
          
          Formato requerido:
          - Nombre del Medicamento
          - Dosis y Frecuencia
          - DuraciÃ³n
          - Recomendaciones breves
        `;
        break;

      case "chat_context":
        prompt = `
          CONTEXTO MÃ‰DICO PREVIO:
          ${payload.context}

          PREGUNTA DEL USUARIO:
          "${payload.userMessage}"

          Responde brevemente y profesionalmente.
        `;
        break;

      default:
        throw new Error(`AcciÃ³n no reconocida: ${action}`);
    }

    // 5. Llamada a Google Gemini
    const response = await fetch(BASE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error("Error en Gemini API:", errorText);
      throw new Error(`Error proveedor IA: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;

    if (!rawText) {
      throw new Error("La IA respondiÃ³ pero no generÃ³ texto.");
    }

    // 6. Procesamiento de respuesta (Limpieza JSON)
    let finalResponse = rawText;

    if (isJsonExpected) {
      // Eliminar bloques de cÃ³digo markdown si la IA los incluye
      const cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
      try {
        finalResponse = JSON.parse(cleanJson);
      } catch (e) {
        console.error("Fallo al parsear JSON de IA:", rawText);
        throw new Error("La IA no generÃ³ un JSON vÃ¡lido. Intenta de nuevo.");
      }
    }

    // 7. Respuesta exitosa al Frontend
    return new Response(JSON.stringify({ data: finalResponse }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  } catch (error) {
    // 8. Manejo de Errores Global
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});

--------------------------------------------------
ðŸ“ PATH: supabase\functions\gemini-proxy\notify-admin\index.ts
--------------------------------------------------
// Archivo: supabase/functions/notify-admin/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { Resend } from "npm:resend@2.0.0"

const resend = new Resend(Deno.env.get("RESEND_API_KEY"))
// Archivo: supabase/functions/notify-admin/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { Resend } from "npm:resend@2.0.0"

const resend = new Resend(Deno.env.get("RESEND_API_KEY"))

serve(async (req) => {
  try {
    const { record } = await req.json()
    const emailUsuario = record.email

    console.log("Procesando alerta para:", emailUsuario)

    const { data, error } = await resend.emails.send({
      from: "MediScribe Alerta <onboarding@resend.dev>",
      // CAMBIA ESTO POR TU CORREO REAL:
      to: ["contacto@pixelartestudio.art"], 
      subject: "ðŸš¨ Nuevo Usuario Registrado en MediScribe",
      html: `
        <h1>Nuevo Registro Detectado</h1>
        <p>Un nuevo mÃ©dico se ha unido a la plataforma.</p>
        <ul>
          <li><strong>Email:</strong> ${emailUsuario}</li>
          <li><strong>Fecha:</strong> ${new Date().toLocaleString()}</li>
        </ul>
        <p>Revisar en el panel de Supabase para mÃ¡s detalles.</p>
      `,
    })

    if (error) {
      console.error("Error enviando correo:", error)
      return new Response(JSON.stringify({ error }), { status: 400 })
    }

    return new Response(JSON.stringify(data), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    })
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { "Content-Type": "application/json" },
    })
  }
})

--------------------------------------------------
ðŸ“ PATH: supabase\functions\notify-admin\index.ts
--------------------------------------------------
// Archivo: supabase/functions/notify-admin/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

// Esta funciÃ³n recibirÃ¡ los datos cuando un usuario se registre
serve(async (req) => {
  try {
    // 1. Obtenemos los datos del usuario nuevo (el "payload")
    const { record } = await req.json()

    // 2. AquÃ­ imprimimos en los logs de Supabase quiÃ©n llegÃ³ (para verificar)
    console.log("Â¡NUEVO USUARIO REGISTRADO!", record.email)

    // NOTA: AquÃ­ mÃ¡s adelante conectaremos el servicio de email (Resend)
    // Para no complicarte ahora, primero aseguramos que la funciÃ³n suba correctamente.

    return new Response(
      JSON.stringify({ message: "NotificaciÃ³n procesada", user: record.email }),
      { headers: { "Content-Type": "application/json" } },
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 400, headers: { "Content-Type": "application/json" } },
    )
  }
})

--------------------------------------------------
ðŸ“ PATH: tailwind.config.js
--------------------------------------------------
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  darkMode: 'class', // <--- ESTA LÃNEA ES LA CLAVE
  theme: {
    extend: {
      colors: {
        brand: {
          teal: '#0d9488', 
          dark: '#111827', // Color de fondo para modo oscuro
          darker: '#0f172a', // Color para paneles en modo oscuro
        }
      },
      animation: {
        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
      },
      keyframes: {
        fadeInUp: {
          '0%': { opacity: '0', transform: 'translateY(20px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        }
      }
    },
  },
  plugins: [],
}

--------------------------------------------------
ðŸ“ PATH: tsconfig.json
--------------------------------------------------
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}

--------------------------------------------------
ðŸ“ PATH: vite.config.ts
--------------------------------------------------
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { VitePWA } from 'vite-plugin-pwa';
import path from 'path';

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      // ESTRATEGIA SIMPLE: ActualizaciÃ³n automÃ¡tica sin complicaciones
      registerType: 'autoUpdate',
      
      includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'mask-icon.svg'],
      
      // ELIMINAMOS "WORKBOX": Dejamos que Vite use la configuraciÃ³n estÃ¡ndar de Google
      manifest: {
        name: 'MediScribe AI',
        short_name: 'MediScribe', // Regresamos al nombre corto original
        description: 'Asistente MÃ©dico Inteligente',
        theme_color: '#0d9488',
        background_color: '#0f172a',
        display: 'standalone',
        orientation: 'portrait',
        scope: '/',
        start_url: '/',
        icons: [
          {
            src: '/pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png',
            purpose: 'any'
          },
          {
            src: '/pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable'
          }
        ]
      },
      // ACTIVAR MODO DEBUG (Para que si falla, nos diga por quÃ© en la consola)
      devOptions: {
        enabled: true
      }
    })
  ],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  // MANTENEMOS TU ESTRATEGIA DE BUILD (Esto no afecta la instalaciÃ³n y es bueno para velocidad)
  build: {
    outDir: 'dist',
    sourcemap: false,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom', 'react-router-dom'],
          ui: ['lucide-react', 'sonner', 'date-fns'],
          db: ['@supabase/supabase-js'],
          pdf: ['@react-pdf/renderer'],
          ai: ['@google/generative-ai']
        }
      }
    }
  }
});
